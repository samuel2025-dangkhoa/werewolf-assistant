<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="RyYI1D4fytaPnB3dJ_bwJRKE2qxGE0iKDVuzDKWyIRU" />
  <title>Werewolf Assistant | Wev Hổ Trợ Quản Trò Ma Sói</title>
  <style>
    :root{
      --bg: #0f1222;
      --bg-elev: #171b33;
      --text: #eef2ff;
      --muted:#a5b4fc;
      --accent:#7c5cff;
      --accent-2:#22d3ee;
      --danger:#ef4444;
      --ok:#10b981;
      --card: #141832;
      --border:#283056;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      /* Lưới phần “Thiết lập vai trò” */
      --roles-cols: 1.2fr .6fr 120px auto;
    }

    *{ box-sizing:border-box }

    /* Ngăn mọi tràn ngang, giữ kích cỡ chữ hệ */
    html, body{
      height:100%;
      max-width:100%;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    body{
      margin:0;
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1400px 900px at 15% -10%, #2a3b77 0%, #18203f 58%),
        radial-gradient(1100px 700px at 110% 30%, rgba(124,92,255,.25), rgba(34,211,238,0) 70%),
        linear-gradient(180deg, #0e1430 0%, #0a0f22 100%);
    }

    /* ===== HEADER full-bleed, KHÔNG bo góc ===== */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      overflow: visible;
      isolation: isolate; /* để ::before/::after nằm trên nền nhưng dưới nội dung */
    }

/* Hiển thị đủ chữ trên các nút Điền tên, Xáo trộn, Xóa người chơi */
#autoFillNames,
#shuffleNames,
#removeEmptyNames {
  white-space: normal !important;   /* cho xuống dòng nếu thiếu chỗ */
  text-overflow: unset !important;  /* bỏ dấu "..." */
  overflow: visible !important;     /* hiển thị đủ nội dung */
  max-width: none !important;       /* không giới hạn chiều ngang */
  min-width: 120px;                 /* tối thiểu 120px cho đủ chữ */
  flex: 1;                          /* chia đều mỗi nút nếu cùng hàng */
}

#playerSetupRow > .row {
  display: flex;
  justify-content: space-between; /* các nút cách đều nhau */
  gap: 8px;                       /* khoảng cách giữa nút */
}

    /* Tấm mờ toàn bề ngang */
    header::before{
      content:"";
      position:absolute;
      inset:0;                               /* theo chiều cao header */
      margin-left:  calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      background: linear-gradient(0deg, rgba(15,18,34,.20), rgba(15,18,34,.60));
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index:-1;
      border-radius:0;
    }
    /* Hiệu ứng sáng */
    header::after{
      content:"";
      position:absolute;
      inset:0;
      margin-left:  calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      pointer-events:none;
      background:
        radial-gradient(900px 280px at 25% 40%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        radial-gradient(700px 240px at 70% 60%, rgba(255,255,255,.08), rgba(255,255,255,0) 70%);
      opacity:.9;
      z-index:-1;
      border-radius:0;
    }
    /* Nếu máy hỗ trợ viewport động, vẫn đảm bảo full-bleed mà không sinh thanh trượt */
    @supports (width: 100dvw){
      header::before, header::after{ width:100dvw; left:50%; transform:translateX(-50%); margin:0; }
    }

    /* Nội dung tiêu đề */
    header .title{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      max-width:1200px; margin:0 auto;
    }
    header .title .top-row{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap }
    header .title h1{
      margin:0; font-weight:800; letter-spacing:.3px; white-space:nowrap;
      font-size:clamp(20px,5vw,34px); line-height:1.1;
    }
    .logo{ width:32px; height:32px }
    .logo img{ width:100%; height:100%; object-fit:cover; border-radius:10px }

    /* ===== Layout ===== */
    .container{ position:relative; z-index:1; max-width:1200px; margin:20px auto; padding:0 16px }
    .container::after{
      content:""; position:fixed; right:-6vw; top:240px; width:88vw; height:1200px;
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 60px rgba(124,92,255,.18), 0 0 120px rgba(34,211,238,.12);
      opacity:.45; pointer-events:none; z-index:0;
    }

    .grid{ display:grid; gap:16px }
    @media (min-width:980px){ .grid{ grid-template-columns:1.2fr .8fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; position:relative; z-index:1; max-width:100%;
    }
    .card h2{ margin:6px 6px 14px; font-size:20px }

    label{ display:block; margin:10px 6px 6px; color:var(--muted); font-size:13px }
    input[type="number"], input[type="text"], select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
      background:#0c0f1f; color:var(--text); outline:none; transition:.2s border,.2s box-shadow
    }
    input:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(124,92,255,.15) }
    /* Tự giãn: bỏ thanh cuộn bên trong */
textarea{
  min-height:160px;
  resize:none;          /* không cần kéo tay nữa */
  overflow:hidden;      /* ẩn scrollbar bên trong */
}

    .row{ display:flex; gap:10px; align-items:center }
    .row.wrap{ flex-wrap:wrap }
    .grow{ flex:1 }

    .btn{
      padding:10px 14px; border:1px solid var(--border); color:var(--text); background:#11152b;
      border-radius:12px; cursor:pointer; transition:.15s transform,.2s background,.2s border-color
    }
    .btn:hover{ transform:translateY(-1px); background:#171c36 }
    .btn:active{ transform:translateY(0) }
    .btn.primary{ background:linear-gradient(135deg, var(--accent) 0%, #5f44ff 100%); border:none }
    .btn.ghost{ background:transparent }
    .btn.danger{ background:#2a0f12; border-color:#5e1a22; color:#ffb4b4 }
    .btn.ok{ background:#0d2a22; border-color:#13493b; color:#c7ffee }

    .hint{ font-size:12px; color:#c7cfff; opacity:.9 }
    .chip{ display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; background:#0c0f1f; border:1px solid var(--border) }

    /* Danh sách tên người chơi – 2 cột không tràn */
    .names{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:10px; width:100%;
    }

    /* Tiêu đề section */
    .section-title{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:6px }
    .section-title h2{ margin:0 }

    /* Header khu vai trò */
    .section-title.roles-head{
      display:grid; grid-template-columns: var(--roles-cols); align-items:end; gap:8px
    }
    .section-title.roles-head h2{ grid-column:1 / span 2; margin:0 }
    .section-title.roles-head .chip{ grid-column:3; justify-self:start }

    /* Bảng vai trò (grid, không tràn) */
    .roles{
      display:grid; grid-template-columns: var(--roles-cols); gap:8px; align-items:center; width:100%;
    }
    .roles .header{ font-size:12px; color:var(--muted); opacity:.8; padding:0 6px }
    .roles .item{ display:contents }
    .roles input[type="number"]{ width:120px }

    /* Khu thêm vai trò */
    #customRoleName{ flex:1 1 320px; min-width:200px }
    #customRoleCount{ width:90px; text-align:center }
    #customRoleActions{ width:100%; display:flex; justify-content:center; gap:10px; margin-top:8px }
    #customRoleActions .btn{ min-width:140px }

    .pill{ font-size:12px; opacity:.9; padding:4px 8px; border-radius:999px; border:1px dashed #334; display:inline-flex; gap:6px; align-items:center; width:max-content }

    /* Danh sách phân vai – fit màn hình */
    .assignments table{ width:100%; border-collapse:collapse; table-layout:fixed }
    .assignments th,.assignments td{ border-bottom:1px solid #2a315a; padding:10px; text-align:left; }
    .assignments tr.revealed td.role{ filter:none }
    .assignments td.role.hidden{ filter:blur(8px); opacity:.7 }
    .assignments th, .assignments td{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

    /* Công cụ */
    .tools{ display:grid; gap:10px; margin-top:12px; grid-template-columns:repeat(2,1fr) }
    .tools .btn.primary{ grid-column:1 / -1 }
    .tools .btn{ width:100%; text-align:center; white-space:normal; justify-content:center }
    @media (min-width:640px){ .tools{ grid-template-columns:repeat(3,1fr) } }
    @media (min-width:960px){ .tools{ grid-template-columns:repeat(4,1fr) } }

    .kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; background:#0b0e1d; border:1px solid var(--border); padding:2px 6px; border-radius:6px }

    .timer-big{ font-variant-numeric:tabular-nums; font-weight:800; font-size:clamp(36px,11vw,48px); letter-spacing:1px; text-align:center; margin:8px 0 12px }
    .timer-controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }

    .footer{ opacity:.6; text-align:center; font-size:12px; padding:12px }

    /* Print */
    @media print{
      header, .no-print{ display:none !important }
      body{ background:#fff; color:#000 }
      .card{ box-shadow:none; border:1px solid #ccc }
      .assignments td.role.hidden{ filter:none }
    }
    #rolesList{ display:contents }

    /* ===== Modal vai trò ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:9999; padding:16px;
    }
    .modal-backdrop.show{ display:flex }
    /* Bo viền toàn bộ modal và cắt (clip) mọi hiệu ứng mờ bị tràn */
.modal{
  border-radius:12px;
  overflow:hidden;                 /* QUAN TRỌNG: không cho dải mờ tràn ra */
}

/* Header modal: đã bo góc trên, vẫn giữ overflow để không bị leak */
.modal header{
  position:relative;
  overflow:hidden;
  border-radius:12px 12px 0 0;     /* bo 2 góc trên */
}

/* Phần nội dung: bo 2 góc dưới để khớp với khung modal */
.modal .content{
  padding:16px;
  border-radius:0 0 12px 12px;     /* bo 2 góc dưới */
  overflow:hidden;                 /* phòng khi có hiệu ứng mờ bên trong */
}

/* Nền tối của phần mô tả – chỉ bo góc dưới (trên đã do header đảm nhiệm) */
#roleModalBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;    /* chỉ bo 2 góc dưới */
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: pre-wrap; text-align: justify; text-wrap: pretty; hyphens: auto;
}

/* Thân modal kho lưu – cùng phong cách với roleModal */
#notesArchiveBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: normal;
}

/* Danh sách bản lưu */
.archive-list{ display:flex; flex-direction:column; gap:12px; }
.archive-item{ border:1px solid var(--border); border-radius:10px; padding:10px; background:#0c0f1f; }
.archive-meta{ font-size:12px; color:#a5b4fc; margin-bottom:6px; }
.archive-content{
  white-space:pre-wrap;              /* giữ xuống dòng */
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background:#0b0e1d; border:1px solid var(--border);
  padding:10px; border-radius:8px;
}

/* Hàng nút ở đáy modal */
.archive-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    .modal .close{ border:1px solid var(--border); background:#11152b; color:var(--text); border-radius:10px; padding:8px 12px; cursor:pointer }

.archive-list{display:grid;gap:10px;max-height:50vh;overflow:auto}
.archive-item{background:#0c0f1f;border:1px solid var(--border);border-radius:10px;padding:10px}
.archive-meta{font-size:12px;color:var(--muted)}
.archive-content{white-space:pre-wrap}
.archive-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* Label “Số người chơi” không bẻ dòng */
    label[for="playerCount"]{ white-space:nowrap }

    /* Căn đều cột mô tả */
    .roles .item div:nth-child(2){ text-align:justify; text-justify:inter-word }

    /* Co giãn cho màn nhỏ – xử lý triệt để việc bị “khuyết” bên phải */
    @media (max-width:420px){
      .container{ padding:0 10px }
      .card{ padding:12px; border-radius:14px }
      .section-title{ gap:4px }
      .chip{ padding:5px 8px; font-size:12px }
      .btn{ padding:8px 12px; font-size:14px }
      .btn.primary{ font-size:15px }
      input[type="number"], input[type="text"], select, textarea{ padding:10px; border-radius:10px; font-size:15px; max-width:100% }

      /* Tên người chơi 2 cột chắc chắn vừa */
      .names{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) }

      /* Bảng vai trò: thu cột số lượng, tránh tràn */
      :root{ --roles-cols: 1fr .6fr 90px auto }
      .roles input[type="number"]{ width:90px }

      /* Bảng phân vai: cho wrap nội dung */
      .assignments th, .assignments td{ padding:8px; font-size:13px; white-space:normal; word-break:break-word }
      .assignments td .btn{ padding:6px 10px }

      /* Bộ đếm thời gian */
      #timerMin, #timerSec{ width:90px !important }
      .card, .card *{ max-width:100% }
    }

    /* Thêm chút co lại cho màn rất nhỏ */
    @media (max-width:360px){
      .names{ grid-template-columns: 1fr }  /* 1 cột */
    }

    /* Co nhẹ header trên màn rất hẹp */
    @media (max-width:400px){
      header{ padding:12px 16px }
      header .title h1{ font-size:clamp(18px,4.8vw,30px) }
      .logo{ width:30px; height:30px }
    }

/* Mobile: đưa cụm nút xuống dưới input "Số người chơi", căn giữa và rút khoảng cách */
@media (max-width: 480px){

  /* hàng chứa input + cụm nút */
  .row.wrap{
    align-items:flex-end;
  }

  /* cụm 2 nút thành 1 hàng full-width, nằm dưới và căn giữa */
  .row.wrap > .row{
    flex: 0 0 100%;                 /* xuống dòng dưới */
    justify-content:center;         /* căn giữa 2 nút */
    margin-top: 6px;                /* rút khoảng cách */
    gap: 8px;                       /* nút sát hơn */
  }

  /* tinh gọn kích thước nút */
  #autoFillNames, #shuffleNames{
    padding:8px 12px;
    font-size:14px;
    min-width:unset;
  }

  /* input số người chơi không quá to */
  #playerCount{ max-width: 220px; }
}

/* Tinh chỉnh bảng “Danh sách phân vai” */
.assignments table th:nth-child(2),
.assignments table td:nth-child(2), /* Cột Tên người chơi */
.assignments table th:nth-child(3),
.assignments table td:nth-child(3)  /* Cột Vai trò */
{
  padding-left: 6px;        /* giảm padding trái */
  text-align: left;         /* căn thẳng lề trái */
}

/* Tuỳ chọn: chỉnh cột số thứ tự sát trái luôn */
.assignments table th:first-child,
.assignments table td:first-child{
  padding-left: 4px;
  text-align: center;
  width: 28px;              /* hẹp lại cột # */
}

/* Chỉnh lại cột Tiết lộ để cột Vai trò thoáng hơn */
.assignments table th:last-child,
.assignments table td:last-child {
  text-align: center;   /* căn giữa nút Ẩn/Hiện */
  width: 70px;          /* cố định chiều rộng hẹp lại */
  padding-left: 4px;
  padding-right: 4px;
}

/* Cột Vai trò dịch trái, không bị thụt */
.assignments table th:nth-child(3),
.assignments table td:nth-child(3) {
  padding-left: 6px;
  text-align: left;
}

/* Nút + Thêm vai trò -> xanh đồng bộ với "Hiện" và "Bắt đầu" */
#addCustomRole {
  background: #0d2a22 !important;   /* xanh đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;
}

/* Nút Mặc định -> xám tối hơn */
#resetRoles {
  background: #1a1c2b !important;   /* xám tối */
  border-color: #2a2d40 !important;
  color: #d1d5db !important;        /* chữ xám nhạt dễ đọc */
}

/* Gom ô nhập + 2 nút vào cùng hàng */
#playerCount {
  max-width: 100px;      /* thu nhỏ ô nhập */
  text-align: center;    /* canh giữa số */
}

/* Bố cục: input và 2 nút thẳng hàng */
#playerCount, 
#autoFillNames, 
#shuffleNames {
  display: inline-block;
  vertical-align: middle;
  margin-top: 0;         /* bỏ khoảng cách thừa */
}

#autoFillNames, #shuffleNames {
  padding: 8px 12px;
  font-size: 14px;
  margin-left: 6px;      /* cách nhẹ sang phải */
}

/* === Số người chơi + 2 nút nằm CÙNG HÀNG (mọi cỡ màn) === */
.row.wrap { align-items: flex-end; }

/* Đừng để .grow chiếm hết chiều ngang */
.row.wrap .grow{ 
  flex: 0 0 auto;          /* vừa đủ nội dung */
  margin-right: 8px;
}

/* Cụm hai nút ở ngay bên phải, không xuống dòng */
.row.wrap > .row{
  flex: 0 0 auto;
  gap: 8px;
  margin-top: 0;           /* bỏ khoảng cách thừa */
}

/* Bỏ wrapper + label rỗng của hai nút để canh thẳng hàng đẹp */
.row.wrap > .row > div{ display: contents; }
.row.wrap > .row label{ display: none; }

/* Thu nhỏ và canh giữa số người chơi */
#playerCount{ 
  width: 100px;            /* hoặc 110px tuỳ bạn */
  max-width: 100px;
  text-align: center;
}

/* Nút tinh gọn chút để vừa hàng */
#autoFillNames, #shuffleNames{
  padding: 8px 12px;
  font-size: 14px;
}

/* Fallback màu nền đặc khi gradient chưa kịp render */
html, body{
  background-color:#0a0f22;   /* trùng tông nền cuối của bạn */
}

/* Card dùng nền đặc (ít trong suốt) để không lộ nền trắng khi cuộn */
.card{
  background: var(--card) !important;         /* #141832 */
  /* Nếu muốn vẫn có cảm giác kính mờ:
  background: linear-gradient(180deg, rgba(20,24,50,.98), rgba(20,24,50,.96)) !important;
  */
}

/* Trên thiết bị di động: bỏ blur để tránh jank/flash trắng khi cuộn nhanh */
@media (max-width: 600px){
  header::before{
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    background: rgba(15,18,34,.60) !important; /* vẫn có lớp mờ tối */
  }
  header::after{ opacity:.6 !important; } /* nhẹ hiệu ứng sáng để giảm paint */
}

/* Đưa các khối lớn lên compositing layer để hạn chế checkerboard */
.container,
.card,
.assignments table{
  will-change: transform;
  transform: translateZ(0);
}

.assignments th,
.assignments td{ background-color: rgba(12,15,31,.98); }

/* Header của modal: căn tiêu đề bên trái, nút Đóng bên phải */
.modal header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 16px;           /* có thể giữ như cũ nếu bạn đã set */
  overflow: hidden;              /* giữ theo thiết kế ban đầu */
  border-radius: 12px 12px 0 0;  /* đảm bảo bo góc trên */
}

/* Tiêu đề co giãn và cắt ... khi dài */
#roleModalTitle{
  margin: 0;
  font-size: 18px;
  line-height: 1.2;
  flex: 1 1 auto;                /* chiếm phần còn lại */
  min-width: 0;                  /* để text-overflow hoạt động trong flex */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Nút Đóng giữ kích thước gọn và không xuống dòng */
.modal .close{
  flex: 0 0 auto;
  white-space: nowrap;
  margin-left: 8px;
}

/* Căn giữa 2 nút "Điền tên mặc định" và "Xáo trộn danh sách" */
.row.wrap > .row{
  flex: 0 0 100%;        /* chiếm toàn bộ chiều ngang */
  justify-content: center;
  margin-top: 6px;       /* khoảng cách nhẹ so với ô nhập số */
}

/* Nút "Điền tên mặc định" -> xám đậm */
#autoFillNames{
  background: #1a1c2b !important;   /* xám tối */
  border-color: #2a2d40 !important;
  color: #d1d5db !important;        /* chữ xám nhạt dễ đọc */
}

/* Nút "Xáo trộn tên" -> xanh (giống Hiện/Bắt đầu) */
#shuffleNames{
  background: #0d2a22 !important;   /* xanh đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;        /* chữ xanh nhạt */
}

/* Căn giữa label và ô nhập "Số người chơi" */
#playerCount{
  margin: 0 auto;        /* đưa input vào giữa */
  display: block;
  text-align: center;
}

label[for="playerCount"]{
  display: block;
  text-align: center;    /* căn chữ "Số người chơi" giữa */
}

/* === Căn giữa "Số người chơi" + input + 2 nút, chỉ ở hàng playerSetupRow === */
#playerSetupRow{
  align-items: flex-end;
  flex-wrap: wrap;
}

/* Label + input ở giữa, nằm trên cùng một cột */
#playerSetupRow .grow{
  flex: 0 0 100%;
  text-align: center;
}
#playerSetupRow label[for="playerCount"]{
  display: block;
  margin: 10px 0 6px;       /* tạo khoảng cách với dòng Mẹo */
}
#playerSetupRow #playerCount{
  display: block;
  margin: 0 auto;           /* giữa ngang */
  width: 110px;
  max-width: 110px;
  text-align: center;
}

/* Hai nút ở dòng dưới, căn giữa */
#playerSetupRow > .row{
  flex: 0 0 100%;
  justify-content: center;
  gap: 8px;
  margin-top: 6px;
}
/* bỏ label trống bọc nút */
#playerSetupRow > .row > div{ display: contents; }
#playerSetupRow > .row label{ display: none; }

/* Highlight theo phe – CHỈ khi đã bấm Hiện */
.assignments tr.revealed.hl-wolf    td { background: rgba(239,68,68,.10); }   /* Phe sói */
.assignments tr.revealed.hl-village td { background: rgba(59,130,246,.10); }  /* Phe dân */
.assignments tr.revealed.hl-flip    td { background: rgba(16,185,129,.10); }  /* Đổi phe */
.assignments tr.revealed.hl-third   td { background: rgba(234,179,8,.10); }   /* Phe 3 & custom */

/* --- Nút cho khu Ghi chú --- */
.notes-tools{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
.notes-tools .btn{ min-width:140px }

/* Ẩn vai trò: để TRỐNG, không blur, vẫn giữ chiều cao ô */
.assignments td.role.hidden{
  filter: none !important;
  opacity: 1 !important;
  color: transparent !important;
  text-shadow: none !important;
}

/* Highlight theo phe – CHỈ khi đã bấm Hiện */
.assignments tr.revealed.f-wolf  td { background: rgba(239,68,68,.10); }  /* Phe sói */
.assignments tr.revealed.f-vil   td { background: rgba(59,130,246,.10); } /* Phe dân */
.assignments tr.revealed.f-swap  td { background: rgba(16,185,129,.10); } /* Đổi phe */
.assignments tr.revealed.f-third td { background: rgba(234,179,8,.10); }  /* Phe 3 & custom */

/* ===== Chết / bị loại: tô đen đậm, đè lên mọi highlight ===== */
.assignments tr.dead td{
  background: #0a0c14 !important;   /* đen xanh đậm hơn (#0a0c14) */
  color: #8f97a8;                   /* chữ xám nhạt hơn để nổi bật */
}
.assignments tr.dead td .btn{
  opacity: .8;
  filter: brightness(0.9);          /* nút cũng tối đi chút */
}

/* Ẩn hiệu ứng trang trí gây tràn trên màn nhỏ / vừa */
@media (max-width: 1024px){
  .container::after{ display:none !important; }
}

/* Bảng/ô không tràn ngang */
.assignments table{
  table-layout: fixed;
  width: 100%;
}
.assignments th, .assignments td{
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* Giữ Phút + Giây cùng hàng */
#timerMin, #timerSec {
  width: 90px !important;     /* co nhỏ chút để chắc chắn vừa */
  min-width: 70px;            /* không nhỏ quá */
  display: inline-block;
}

#timerMin, #timerSec {
  box-sizing: border-box;
}

/* Bố cục hàng timer: ép không xuống dòng */
#timerMin, #timerSec {
  flex: 0 0 auto;             /* giữ cố định, không co kéo */
}

#timerSec {
  margin-left: 8px;           /* tạo khoảng cách với ô phút */
}

.timer-row {
  display: flex;
  flex-wrap: nowrap !important; /* ép luôn ngang */
  gap: 8px;
}

/* Làm ô "Chế độ" rộng hơn một chút */
#timerMode{
  width: 160px;          /* bạn có thể đổi 170–180px nếu thích */
  min-width: 150px;
  display: inline-block;
}

/* Căn CẢ 3 ô (Chế độ / Phút / Giây) vào chính giữa hàng */
.timer-row{
  display: flex;
  justify-content: center;   /* Ctrl + E */
  gap: 12px;                 /* khoảng cách giữa các ô */
}

/* Đừng để .grow đẩy lệch sang trái trong hàng timer */
.timer-row .grow{
  flex: 0 0 auto;            /* chỉ vừa nội dung */
  text-align: center;        /* label và select đều giữa */
}

/* Cho đẹp: căn giữa label + input của 2 cột Phút/Giây */
.timer-row > div{
  text-align: center;
}

/* Giữ Phút/Giây không xuống hàng (nếu bạn chưa có) */
#timerMin, #timerSec{
  width: 110px !important;
  min-width: 90px;
  flex: 0 0 auto;
}

/* Căn giữa 2 nút "Xóa tất cả" và "Soạn mẫu nhanh" */
.notes-tools{
  display: flex;
  justify-content: center;  /* Ctrl + E */
  gap: 12px;                /* khoảng cách giữa nút */
  margin: 8px 0 10px;
}

/* Cho các nút đồng đều */
.notes-tools .btn{
  min-width: 140px;
  text-align: center;
}

/* Chữ "– BỊ LOẠI" */
.assignments td .eliminated {
  color: #ff6b6b;       /* đỏ nhạt cảnh báo */
  font-weight: 600;
  margin-left: 6px;
  font-size: 0.9em;
  opacity: 0.9;
}

/* td giữ kiểu bảng, không flex */
.assignments td.name-cell{
  display: table-cell !important;   /* ép về table-cell để không phá layout */
  vertical-align: middle;
  padding-left: 6px;
}

/* wrapper bên trong chia 2 phía: Tên | – BỊ LOẠI */
.assignments td.name-cell .name-wrap{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  width: 100%;
  min-width: 0;
}

/* Tên cắt ... khi dài */
.assignments td.name-cell .player-name{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Nhãn – BỊ LOẠI */
.assignments td.name-cell .eliminated{
  color: #ff6b6b;
  font-weight: 700;
  font-size: .92em;
  white-space: nowrap;
  margin-left: 12px;
}

/* Chữ BỊ LOẠI nổi bật */
.assignments td .eliminated {
  color: #ff6b6b;
  font-weight: 600;
  font-size: 0.9em;
  white-space: nowrap;
}

/* td giữ kiểu bảng, không flex */
.assignments td.name-cell {
  vertical-align: middle;
  padding-left: 6px;  /* tuỳ chỉnh */
}

/* wrapper mới bên trong để chia 2 bên */
.assignments td.name-cell .name-wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  width: 100%;
  min-width: 0;
}

/* Tên bị cắt ... nếu dài */
.assignments td.name-cell .player-name {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Nhãn BỊ LOẠI */
.assignments td.name-cell .eliminated {
  color: #ff6b6b;
  font-weight: 700;
  font-size: .92em;
  white-space: nowrap;
  margin-left: 12px;
}

/* --- MOBILE HARDEN KIT: chống tràn & co giãn an toàn --- */

/* 1) Các item trong flex/grid mặc định được phép co lại */
.grid > *, .row > *, .section-title > *, .tools > *,
.roles .item > *, .assignments table th, .assignments table td {
  min-width: 0;
}

/* 2) Văn bản dài có thể xuống dòng & cắt ... khi cần */
:where(h1,h2,h3,h4,h5,p,div,span,button,td,th,label){
  overflow-wrap: anywhere;
  word-break: break-word;
  text-wrap: balance;        /* đẹp trên trình duyệt mới */
}

/* 3) Hình/ SVG không vượt chiều ngang */
img, svg, video, canvas { max-width: 100%; height: auto; }

/* 4) Không cho phần tử nào tạo thanh cuộn ngang ngoài ý muốn */
html, body, .container { overflow-x: hidden; }

/* 5) Header & container tôn trọng safe-area (tai thỏ iPhone) */
header {
  padding-left: calc(16px + env(safe-area-inset-left, 0px));
  padding-right: calc(16px + env(safe-area-inset-right, 0px));
}
.container {
  padding-left: calc(16px + env(safe-area-inset-left, 0px));
  padding-right: calc(16px + env(safe-area-inset-right, 0px));
}

/* 6) Vai trò (grid) luôn “lọt” màn – cho cột số lượng co nhỏ */
:root { --roles-cols: 1.1fr .8fr 110px auto; }
@media (max-width: 480px){
  :root { --roles-cols: 1fr .8fr 90px auto; }
  .roles input[type="number"]{ max-width: 90px; }
}

/* 7) Tên người chơi – lưới không tràn */
.names { grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); }
@media (max-width: 360px){ .names { grid-template-columns: 1fr; } }

/* 8) Bảng phân vai: cho phép wrap & ép cột nút hẹp hơn trên màn nhỏ */
.assignments table { table-layout: fixed; width: 100%; }
.assignments th, .assignments td { white-space: normal; }   /* cho xuống dòng khi cần */
@media (max-width: 420px){
  .assignments table th:last-child,
  .assignments table td:last-child { width: 60px; }          /* nút nhỏ hơn chút */
  .assignments td .btn{ padding:6px 8px; font-size:13px; }
}

/* 9) Hàng timer: co đều, không đẩy tràn */
.timer-row { flex-wrap: nowrap; gap: 8px; }
.timer-row > * { min-width: 0; }          /* cho phép co */
#timerMode, #timerMin, #timerSec { width: auto; }
@media (max-width: 360px){
  #timerMode{ min-width: 120px; }
  #timerMin, #timerSec{ min-width: 84px; }
}

/* 10) Nút dài/nhãn dài vẫn co gọn */
.btn { max-width: 100%; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }

/* 11) Trang trí nền không gây tràn (đã ẩn <=1024, nhưng chặn thêm) */
.container::after { pointer-events:none; max-width: 100dvw; }

/* 12) Trường hợp cực đoan (<340px): bọc bảng để không tạo tràn toàn trang */
@media (max-width: 340px){
  .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .table-wrap table{ min-width: 440px; }  /* chỉ cuộn ngang bên trong khi RẤT hẹp */
}

/* === Thu nhỏ ô nhập Phút & Giây === */
#timerMin,
#timerSec {
  width: 70px !important;    /* nhỏ hơn (trước bạn để 90–110px) */
  max-width: 80px;
  text-align: center;
  padding: 6px 8px;          /* giảm padding bên trong */
  font-size: 15px;           /* chữ nhỏ gọn vừa mắt */
}

/* Mobile: ép nhỏ hơn nữa nếu màn rất hẹp */
@media (max-width: 420px) {
  #timerMin,
  #timerSec {
    width: 60px !important;
    font-size: 14px;
  }
}

/* === Thu gọn cột Mô tả & Số lượng để nhường chỗ cho Vai trò === */
.roles {
  grid-template-columns: 1.2fr 0.6fr 80px auto; /* Vai trò | Mô tả | Số lượng | (xóa) */
  gap: 8px;
}

/* Ô nhập số lượng nhỏ lại */
.roles input[type="number"] {
  width: 70px !important;   /* gọn hơn (trước là 120px) */
  max-width: 80px;
  text-align: center;
  padding: 4px 6px;
  font-size: 15px;
}

/* Nút "Hiện" trong cột Mô tả */
.roles .item button {
  min-width: 70px;          /* nút nhỏ hơn */
  padding: 6px 10px;
  font-size: 14px;
  text-align: center;
}

/* Trên màn hẹp hơn 480px, ép nhỏ hơn nữa */
@media (max-width: 480px) {
  .roles {
    grid-template-columns: 1fr 0.6fr 60px auto;
  }
  .roles input[type="number"] {
    width: 60px !important;
    font-size: 14px;
  }
  .roles .item button {
    min-width: 60px;
    font-size: 13px;
    padding: 5px 8px;
  }
}

/* Căn giữa dòng ghi chú */
.hint {
  text-align: center;
}

/* Ẩn ô Mẹo ở các section bình thường, KHÔNG ẩn ở header vai trò */
.section-title:not(.roles-head) .chip {
  display: none !important;
}

/* ==== TIMER: 3 ô thẳng hàng, cao bằng nhau, không tràn phải ==== */

/* Bỏ mọi width cứng trước đó */
#timerMode,
#timerMin,
#timerSec{
  width: 100% !important;   /* để cột quyết định bề ngang */
  min-width: 0 !important;
  max-width: 100% !important;
}

/* ==== TIMER: 3 ô thẳng hàng, cao bằng nhau, Giây sát Phút ==== */
.timer-row{
  display: grid !important;
  grid-template-columns: minmax(160px,1fr) 80px 80px; /* chế độ | phút | giây */
  grid-template-areas: "mode min sec";
  column-gap: 8px;          /* khoảng cách chung */
  align-items: end;
}

.timer-row > div:nth-child(2){ grid-area: min; }
.timer-row > div:nth-child(3){ grid-area: sec; }

/* Thu hẹp khoảng cách giữa Phút và Giây */
.timer-row > div:nth-child(2),
.timer-row > div:nth-child(3){
  margin-right: 0;          /* không có dư bên phải */
}
.timer-row > div:nth-child(2){ margin-right: 4px; } /* chỉ cách nhẹ giữa Phút và Giây */

.timer-row select,
.timer-row input[type="number"]{
  height: 44px;
  padding: 10px 12px;
  border-radius: 12px;
  text-align: center;
  box-sizing: border-box;
}

.timer-row label{
  display:block;
  margin: 6px 2px;
  text-align:center;
}

/* Màn nhỏ */
@media (max-width: 400px){
  .timer-row{
    grid-template-columns: minmax(140px,1fr) 70px 70px;
    column-gap: 6px;        /* hẹp hơn nữa */
  }
  .timer-row select,
  .timer-row input[type="number"]{ height: 40px; font-size: 15px; }
}

/* Căn giữa nhãn + input của cột Giây */
.timer-row > div:nth-child(3) {
  text-align: center;    /* nhãn Giây căn giữa */
  justify-self: center;  /* ô nhập liệu Giây căn giữa theo cột */
}

/* Đảm bảo input không bị kéo lệch */
#timerSec {
  margin-left: 0 !important;
}
/* Màu viền theo phe khi đã chọn */
#customRoleFaction.f-village { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15); }
#customRoleFaction.f-wolf    { border-color:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
#customRoleFaction.f-swap    { border-color:#10b981; box-shadow:0 0 0 3px rgba(16,185,129,.15); }
#customRoleFaction.f-third   { border-color:#eab308; box-shadow:0 0 0 3px rgba(234,179,8,.15); }

/* ỦNG HỘ: xếp dọc – QR trên, info dưới, căn giữa */
.donate .wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}

/* QR vuông, bo góc, căn giữa */
.donate .qr{
  width:220px;            /* thích 180–240 tuỳ bạn */
  aspect-ratio:1/1;
  object-fit:contain;
  background:#0c0f1f;
  border:1px solid #283056;
  border-radius:12px;
  padding:8px;
}

/* Info bên dưới căn giữa */
.donate .info{ text-align:center; }

/* Mỗi dòng info là một hàng gọn */
.donate .row{ display:inline-flex; align-items:center; gap:8px; }
.donate .label{ color:var(--muted); font-weight:600; }

/* MB BANK ở giữa hàng */
.donate .bank-name{ font-weight:700; letter-spacing:.2px; }

/* Không xuống dòng cho SỐ TK / TÊN TK */
.donate .nowrap{ white-space:nowrap; }

@media (max-width:420px){
  .donate .qr{ width:180px; }
}

/* Promo handmade: ảnh trái, 2 dòng phải */
.donate-promo{
  display:flex; align-items:center; gap:12px;
  margin-top:12px;
  background:#0c0f1f; border:1px solid var(--border);
  border-radius:12px; padding:10px;
}
.donate-promo .promo-photo{
  width:140px; aspect-ratio:4/3; object-fit:cover;
  border-radius:10px; flex:0 0 auto;
}
.donate-promo .promo-text{ flex:1 1 auto; }
.donate-promo .promo-text p{ margin:0 0 6px; line-height:1.5; }
.donate-promo a{
  color:#dbeafe; text-decoration:underline;
  overflow-wrap:anywhere;
}

/* Nếu màn rất hẹp, vẫn giữ bố cục trái–phải gọn */
@media (max-width:420px){
  .donate-promo .promo-photo{ width:120px; }
  .donate-promo .promo-text p{ font-size:15px; }
}

/* Center + màu giống "NGÂN HÀNG TMCP QUÂN ĐỘI" */
.donate-promo .promo-text { text-align: center; }

.donate-promo .promo-title{
  margin: 0 0 6px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: var(--muted);          /* cùng màu label ngân hàng */
}

.donate-promo .promo-line{
  margin: 0;
  line-height: 1.5;
  text-align: center;
}

.donate-promo .promo-link{ margin: 6px 0 0; }
.donate-promo .promo-link a{
  color: var(--muted) !important; /* link trung màu với tiêu đề ngân hàng */
  text-decoration: underline;
}

/* Ảnh cao hơn một chút */
.donate-promo .promo-photo{
  width: 160px;
  height: 140px;               /* tăng chiều cao */
  aspect-ratio: auto !important;/* vô hiệu tỉ lệ cũ 4/3 */
  object-fit: cover;
  border-radius: 10px;
  flex: 0 0 auto;
}

@media (max-width: 420px){
  .donate-promo .promo-photo{
    width: 140px;
    height: 120px;
  }
}

/* Xếp dọc & căn giữa toàn bộ khối */
.donate-promo{
  display: flex;
  flex-direction: column;   /* <- đổi từ hàng sang cột */
  align-items: center;
  gap: 10px;
  text-align: center;       /* mọi dòng chữ căn giữa */
}

/* Dòng tiêu đề – đậm, cùng màu với “NGÂN HÀNG TMCP QUÂN ĐỘI” */
.donate-promo .promo-title{
  margin: 0;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: var(--muted);
}

/* Dòng mô tả dưới tiêu đề */
.donate-promo .promo-line{ margin: 0; line-height: 1.5; }

/* Ảnh: căn giữa và cao hơn chút */
.donate-promo .promo-photo{
  display: block;
  width: 240px;          /* có thể chỉnh 220–280 tuỳ thích */
  height: 160px;         /* “cao hơn xíu” */
  object-fit: cover;
  border-radius: 12px;
  margin: 4px auto 0;
}

/* Link: căn giữa + màu giống tiêu đề ngân hàng */
.donate-promo .promo-link{ margin: 0; }
.donate-promo .promo-link a{
  color: var(--muted) !important;
  text-decoration: underline;
  word-break: break-word;
}

@media (max-width: 420px){
  .donate-promo .promo-photo{ width: 210px; height: 145px; }
}

/* === Donate promo: tweak per request === */

/* 1) Tiêu đề: lớn hơn ~2 cỡ, giữ màu như "NGÂN HÀNG TMCP QUÂN ĐỘI" */
.donate-promo .promo-title{
  font-size: clamp(22px, 5.2vw, 24px); /* tăng size */
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: #ba0000;                 /* màu giống dòng ngân hàng */
  text-align: center;
  margin: 0;
}

/* 2) Dòng mô tả: căn giữa (Ctrl + E), đọc dễ hơn */
.donate-promo .promo-line{
  margin: 0 auto 6px;
  text-align: justify;                  /* căn giữa */
  max-width: 640px;                    /* giới hạn độ dài để dễ đọc */
  line-height: 1.6;
}

/* 3) Ảnh: rộng hơn một xíu */
.donate-promo .promo-photo{
  width: 280px;                        /* trước ~240px -> nới rộng */
  height: 180px;                       /* giữ tỉ lệ, có thể chỉnh 170–190 */
  object-fit: cover;
  border-radius: 12px;
  display: block;
  margin: 4px auto 0;                  /* luôn căn giữa */
}

/* Mobile vẫn to hơn chút nhưng vừa màn */
@media (max-width: 420px){
  .donate-promo .promo-photo{
    width: 260px;
    height: 172px;
  }
}

/* Link: đã căn giữa sẵn, giữ màu giống tiêu đề ngân hàng */
.donate-promo .promo-link{ margin: 0; text-align: center; }
.donate-promo .promo-link a{
  color: var(--muted) !important;
  text-decoration: underline;
  word-break: break-word;
}

/* --- Header "Thiết lập vai trò" gọn trên mobile --- */
@media (max-width: 560px){
  .section-title.roles-head{
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "title title"
      "slots total";
    row-gap: 8px;
    column-gap: 8px;
    align-items: end;
  }
  .section-title.roles-head h2{
    grid-area: title;
    margin: 0;
    white-space: nowrap;          /* giữ tiêu đề không xuống dòng */
  }
  /* 2 chip nằm hàng dưới, trái | phải */
  .section-title.roles-head .chip{
    grid-column: auto !important; /* ghi đè mọi grid-column cũ */
  }
  .section-title.roles-head .chip:first-of-type{  /* Còn trống */
    grid-area: slots;
    justify-self: start;
  }
  .section-title.roles-head .chip:last-of-type{   /* Tổng */
    grid-area: total;
    justify-self: end;
  }
}
/* Tiêu đề 2 dòng + 2 tim hai bên, tim nằm giữa hai dòng */
.donate-title{
  display:flex;
  align-items:center;          /* tim canh giữa theo chiều dọc khối 2 dòng */
  justify-content:center;
  gap:12px;
  margin:0 0 10px;
  text-align:center;
}
.donate-title .heart{
  font-size:22px;
  line-height:1;
}
.donate-title .lines{ line-height:1.25 }
.donate-title .line1{
  font-size:20px;
  font-weight:800;
}
.donate-title .line2{
  font-size:18px;
  font-weight:700;
  opacity:.95;
}
@media (max-width:420px){
  .donate-title .line1{ font-size:18px }
  .donate-title .line2{ font-size:16px }
}
/* Header "Thiết lập vai trò": title trái, 2 chip phải – luôn cùng hàng */
.section-title.roles-head{
  display: grid !important;
  grid-template-columns: 1fr auto !important; /* 2 cột: title | chips */
  align-items: center;
  gap: 8px;
}

.section-title.roles-head h2{
  margin: 0;
  white-space: nowrap;         /* không xuống dòng */
  overflow: hidden;
  text-overflow: ellipsis;     /* thiếu chỗ thì … */
  min-width: 0;                /* cho phép co */
}

/* Nhóm 2 chip đứng cạnh nhau */
.section-title.roles-head .chips{
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
.section-title.roles-head .chip{ white-space: nowrap; }

/* Mobile vẫn giữ 1 hàng, chỉ thu nhỏ khoảng cách/chữ nếu cần */
@media (max-width: 560px){
  .section-title.roles-head{ grid-template-columns: 1fr auto !important; }
  .section-title.roles-head .chips{ gap: 6px; }
  .section-title.roles-head h2{ font-size: 18px; }  /* tuỳ thích */
}
/* Header "Thiết lập vai trò": tiêu đề trái, 2 chip dạt phải */
.section-title.roles-head{
  display: flex !important;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
.section-title.roles-head h2{
  margin: 0;
  white-space: nowrap;         /* không xuống dòng */
  overflow: hidden;
  text-overflow: ellipsis;     /* thiếu chỗ thì … */
  flex: 1 1 auto;              /* nhường chỗ cho 2 chip bên phải */
  min-width: 0;
}
.section-title.roles-head .chip{
  flex: 0 0 auto;
  white-space: nowrap;
}
/* đẩy CẶP chip sang phải */
.section-title.roles-head .chip:first-of-type{
  margin-left: auto;
}

/* Ghi đè rule mobile cũ từng đẩy chip xuống dòng */
@media (max-width: 560px){
  .section-title.roles-head{
    display: flex !important;
    flex-wrap: nowrap !important;
  }
  .section-title.roles-head .chip:first-of-type{
    margin-left: auto !important;
  }
}
/* Dòng ngăn cách giữa các phe trong bảng vai trò */
.roles .sep{
  grid-column: 1 / -1;      /* chiếm cả 4 cột */
  text-align: center;
  color: #a5b4fc;
  opacity: .9;
  padding: 6px 0 2px;
  font-weight: 700;
  letter-spacing: .2px;
}

/* === Ghi chú: màu riêng cho 2 nút === */
#quickTemplateBtn{
  background: #0f1f3a !important;   /* xanh lam đậm */
  border-color: #244b8a !important;
  color: #dbeafe !important;
}
#quickTemplateBtn:hover{
  background: #152a57 !important;
  border-color: #2e60b3 !important;
}

#saveNotesBtn{
  background: #0d2a22 !important;   /* xanh lục đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;
}
#saveNotesBtn:hover{
  background: #123628 !important;
  border-color: #17604e !important;
}
/* Nút "Cứu" trong hàng đã bị loại: xanh lục + không mờ */
.assignments tr.dead td .btn{
  background: #0d2a22 !important;   /* xanh lục đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;
  opacity: 1 !important;            /* bỏ làm mờ */
  filter: none !important;          /* bỏ giảm sáng */
}
.assignments tr.dead td .btn:hover{
  background: #123628 !important;
  border-color: #17604e !important;
}

@media (max-width: 480px){
  .promo-title{ font-size: clamp(22px, 5.4vw, 28px); } /* mobile to hơn */
}
/* === FAB '!!' mở bảng Thứ tự kêu dậy === */
.fab-night{
  position: fixed;
  right: 16px; 
  bottom: 16px;
  width: 56px; height: 56px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: linear-gradient(135deg, var(--accent) 0%, #5f44ff 100%);
  color: #fff; font-weight: 900; font-size: 20px;
  box-shadow: var(--shadow);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 1000;
}
.fab-night:hover{ transform: translateY(-1px); }

/* Thân modal nội dung 'Thứ tự kêu dậy' */
#nightOrderBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.7;
  white-space: normal;                 /* dùng danh sách, không cần pre-wrap */
}
#nightOrderBody .intro{ color:#c7cfff; margin: 0 0 8px }
#nightOrderBody ol{ margin: 6px 0 10px; padding-left: 1.4em }
#nightOrderBody li + li{ margin-top: 4px }
#nightOrderBody .note{ opacity:.9; font-size:.95em }
#nightOrderBody .sub{ color:#a5b4fc; font-size:.95em; margin:.25em 0 .5em }
#nightOrderBody .section{
  text-align:center; margin:10px 0 6px; color:var(--muted); font-weight:700
}

/* Ẩn khi in */
@media print{ .fab-night{ display:none !important } }
/* Cho thân modal cuộn khi nội dung dài */
.modal{
  width: min(720px, 95vw);
  max-height: calc(100dvh - 32px);
  display: flex;
  flex-direction: column;
}
.modal header{
  flex: 0 0 auto;
}
.modal .content{
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto !important;            /* <- cho phép cuộn */
  -webkit-overflow-scrolling: touch;    /* mượt trên mobile */
}
/* Modal 'Thứ tự kêu dậy' — căn giữa 2 dòng mở đầu */
#nightOrderBody .intro{
  color:#c7cfff;
  margin:0 0 8px;
  text-align:center;            /* căn giữa */
  text-wrap:balance;
}

/* Mục số 4 của danh sách đầu tiên: căn đều (Ctrl+J) */
#nightOrderBody ol:first-of-type > li:nth-child(4){
  text-align: justify;
  text-justify: inter-word;
  hyphens: auto;
}

/* Dòng phụ bên trong mục 4 vẫn căn trái bình thường */
#nightOrderBody ol:first-of-type > li:nth-child(4) .sub{
  text-align: left;
}
/* Mục 4: 2 dòng .sub căn giữa + đỏ + đậm */
#nightOrderBody ol:first-of-type > li:nth-child(4) .sub{
  text-align: center !important;
  color: var(--danger, #ef4444) !important; /* đỏ đồng bộ theme */
  font-weight: 700 !important;
}
/* Đỏ + đậm cho dòng "Kêu dậy 1 lần đêm đầu tiên ..." trong modal */
#nightOrderBody .section{
  color: var(--danger, #ef4444) !important;
  font-weight: 800 !important;
}
/* Thu nhỏ header 2 modal: Kho lưu trữ & Thứ tự kêu dậy */
#notesArchiveModal header,
#nightOrderModal header{
  padding: 12px 16px;     /* cùng padding như modal mô tả vai */
}

/* H3 không còn margin mặc định -> header thấp lại đúng bằng nhau */
#notesArchiveModal header h3,
#nightOrderModal header h3{
  margin: 0;              /* quan trọng: bỏ top/bottom margin mặc định */
  font-size: 18px;        /* đồng bộ kích thước */
  line-height: 1.2;
}

/* Nút đóng gọn lại một chút cho cân đối (tuỳ chọn) */
#notesArchiveModal .close,
#nightOrderModal .close{
  padding: 6px 10px;
  font-size: 14px;
  line-height: 1.2;
}
/* ===== Modal Nhân bản: nền đậm, căn giữa tên, highlight ===== */

/* Nền tối (mờ) cho phần nội dung modal Nhân bản – giống các modal khác */
#doppelTargetBody{
  background: rgba(8,12,28,.80);         /* đậm hơn để dễ đọc */
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;           /* chỉ bo 2 góc dưới như các modal còn lại */
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.7;
  white-space: normal;
}

/* Bảng trong modal Nhân bản */
#doppelTargetBody table{ width:100%; border-collapse:collapse; table-layout:fixed; }
#doppelTargetBody th, #doppelTargetBody td{ padding:8px; border-bottom:1px solid #2a315a; }
#doppelTargetBody th.num,  #doppelTargetBody td.num  { width:54px;  text-align:center; }
#doppelTargetBody th.name-col, #doppelTargetBody td.name-col{ text-align:center; } /* 👈 căn giữa cột Tên */
#doppelTargetBody th.pick, #doppelTargetBody td.pick{ width:68px;  text-align:center; }

/* Highlight: xanh cho holder 👥, đỏ cho người đang được chọn */
#doppelTargetBody tr.is-holder td{ background: rgba(59,130,246,.18); }  /* xanh (Dân) */
#doppelTargetBody tr.is-picked td{ background: rgba(239,68,68,.20); }   /* đỏ  (Sói/đang target) */

/* Làm lớp phủ nền phía sau modal này đậm hơn (dễ đọc hơn) */
#doppelTargetModal.modal-backdrop{ background: rgba(0,0,0,.70); }
/* Thu nhỏ header 3 modal: Kho lưu, Thứ tự, Nhân bản */
#notesArchiveModal header,
#nightOrderModal header,
#doppelTargetModal header{
  padding: 12px 16px;
}

#notesArchiveModal header h3,
#nightOrderModal header h3,
#doppelTargetModal header h3{
  margin: 0;
  font-size: 18px;
  line-height: 1.2;
}
/* ===== Modal: Chọn mục tiêu cho 👥 Nhân bản ===== */

/* Nền mờ phía sau modal này đậm hơn để dễ đọc */
#doppelTargetModal.modal-backdrop{ background: rgba(0,0,0,.72); }

/* Header modal cao vừa bằng các modal khác */
#doppelTargetModal .modal header{ padding:12px 16px; }

/* Căn giữa cột Tên người chơi trong bảng của modal */
.doppel-table th:nth-child(2),
.doppel-table td:nth-child(2){ text-align:center; }

/* Highlight: xanh cho người đang giữ vai Nhân bản, đỏ cho người đang được chọn */
#doppelTargetModal tbody tr.hl-holder td{ background: rgba(59,130,246,.14) !important; }
#doppelTargetModal tbody tr.hl-picked td{ background: rgba(239,68,68,.14) !important; }

/* Nút “Xác nhận” màu lục */
#doppelConfirmBtn{
  background:#0d2a22 !important;
  border-color:#13493b !important;
  color:#c7ffee !important;
}
#doppelConfirmBtn:hover{ background:#123628 !important; border-color:#17604e !important; }

/* Nút 🎯 trong cột hành động có cùng bề ngang với nút “Giết” phía dưới */
.assignments td .btn.doppel,
.assignments td .btn[data-open-doppel]{
  width:100%;                   /* đầy ô – bằng nút Giết */
  display:block;
  padding:8px 10px;             /* cùng cảm giác bấm */
  margin-bottom:6px;            /* tách với nút Giết */
}
#doppelTargetModal tbody tr.is-dead td{
  opacity:.45; color:#aab; text-decoration:line-through;
}
#doppelTargetModal tbody tr.is-dead input[type="radio"]{ pointer-events:none; }
#notesArchiveBody, #nightOrderBody{
  text-align: justify;
  text-justify: inter-word;
  hyphens: auto;
}
/* 🎯 Nút Nhân bản: kích thước y hệt nút Giết/Cứu */
.assignments td .btn[data-doppel],
.assignments td .btn[data-open-doppel],
.assignments td .btn.doppel{
  /* KHÔNG set width/display/padding để kế thừa từ .btn */
  margin-bottom: 6px; /* chỉ tạo khoảng cách với nút Giết/Cứu bên dưới */
}
/* Tiêu đề modal mô tả vai: cho phép kèm chip và tự xuống dòng */
#roleModalTitle{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: unset !important;
}

/* Chip thông tin trong tiêu đề modal */
#roleModalTitle .meta-chip{
  font-size: 12px;
  color: var(--muted);
  background:#0c0f1f;
  border:1px solid var(--border);
  border-radius:999px;
  padding:4px 8px;
}

/* Cụm 2 select nhỏ trong cột “Mô tả” của bảng vai trò */
.roles .flags{
  display:inline-flex;
  gap:6px;
  margin-left:8px;
  flex-wrap:wrap;
}
.roles .flags select{
  background:#0c0f1f;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 8px;
  font-size:13px;
}
/* Nút LƯU TRỮ DANH SÁCH (màu lục) */
#autoFillNames{
  background:#0d2a22 !important;
  border-color:#13493b !important;
  color:#c7ffee !important;
}

/* Nút KHO LƯU TRỮ (giống style nút Kho lưu trữ của Ghi chép) */
#shuffleNames{
  background:#11152b !important;
  border-color: var(--border) !important;
  color: var(--text) !important;
}

/* Thân modal kho lưu danh sách người chơi */
#playersArchiveBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: normal;
}
/* “· Phe: …” hiển thị cùng style với tiêu đề */
#roleModalTitle .faction-inline{
  color: inherit;           /* cùng màu với tiêu đề */
  font: inherit;            /* cùng cỡ & font */
  white-space: nowrap;      /* cố giữ trên 1 dòng với tên vai */
  opacity: .95;             /* nhẹ nhàng 1 chút */
}

/* Giữ tên + phe trên 1 dòng, chips có thể xuống dòng */
#roleModalTitle{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
#roleModalTitle .role-label{
  white-space:nowrap;
  flex: 1 1 auto;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;  /* nếu quá dài thì “…” nhưng vẫn ưu tiên nằm 1 dòng */
}
/* Icon ảnh cho vai trò (trước tên) */
.role-icon{
  width: 20px;
  height: 20px;
  vertical-align: -3px;   /* canh hàng với chữ */
  margin-right: 6px;
  border-radius: 4px;     /* bo nhẹ cho PNG/JPG, SVG thì không cần */
  display: inline-block;
  object-fit: contain;
  filter: drop-shadow(0 0 1px rgba(0,0,0,.25));
}

  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="top-row">
        <div class="logo" aria-hidden="true">
          <img src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/logo.png" alt="Logo Sói">
        </div>
        <h1>Werewolf Assistant 🐺🎲</h1>
      </div>
      <div class="chip" title="Dữ liệu được lưu tự động trong trình duyệt">Created by Dang Khoa ❤️</div>
    </div>
  </header>

  <div class="container grid">
    <!-- LEFT: SETUP + ASSIGNMENT -->
    <section class="card">
      <div class="section-title">
        <h2>👤 Thiết lập người chơi</h2>
        <div class="chip">Mẹo: <span class="kbd">Tab</span> để chuyển nhanh giữa các ô tên trên máy tính.</div>
      </div>

      <div class="row wrap" id="playerSetupRow">
        <div class="grow">
          <label for="playerCount">Số người chơi</label>
          <input id="playerCount" type="number" min="3" max="151" value="10" />
        </div>
        <div class="row" style="gap:8px; align-items:flex-end">
          <div>
            <label>&nbsp;</label>
            <button class="btn ok" id="autoFillNames">💾 Lưu</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="shuffleNames">📁 Kho</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn danger" id="removeEmptyNames">🗑️ Xóa</button>
          </div>
        </div>
      </div>

      <label>Danh sách tên người chơi</label>
      <div id="names" class="names"></div>

      <hr style="border-color:#28305633; margin:16px 0">

      <!-- Header khu vai trò -->
      <div class="section-title roles-head">
  <h2>🃏 Thiết lập vai trò</h2>
  <div class="chips">
    <div class="chip">Trống: <b id="slotsLeft">0</b></div>
    <div class="chip">Tổng: <b id="rolesTotal">0</b></div>
  </div>
</div>

      <div class="roles" role="table" aria-label="Bảng vai trò">
        <div class="header">Vai trò</div>
        <div class="header">Mô tả</div>
        <div class="header">Số lượng</div>
        <div class="header">&nbsp;</div>
        <div id="rolesList"></div>
      </div>

      <div class="row wrap" style="margin-top:8px" id="customRoleRow">
        <div class="grow row">
          <input id="customRoleName" type="text" placeholder="Thêm vai trò mới (ví dụ: Bị nguyền rủa)" />
          <input id="customRoleCount" type="number" min="1" value="1" />
<select id="customRoleFaction" title="Chọn phe cho vai trò tùy chỉnh.">
    <option value="" selected disabled>— Chọn phe —</option>
    <option value="village">Dân làng</option>
    <option value="wolf">Ma sói</option>
    <option value="swap">Đổi phe</option>
    <option value="third">Phe thứ 3</option>
  </select>
        </div>
        <div id="customRoleActions" class="row">
          <button class="btn" id="addCustomRole">+ Thêm vai trò</button>
          <button class="btn ghost" id="resetRoles" title="Đưa thiết lập vai trò về 'Mặc định' dành cho 10 người chơi.">Mặc định: 10👤</button>
        </div>
      </div>

      <div class="hint" style="margin:6px">Nếu tổng vai trò vượt quá số người, bạn sẽ được nhắc điều chỉnh. Ô trống sẽ tự lấp bằng vai trò <b>Dân làng</b>.</div>

      <div class="tools no-print" style="margin-top:12px">
        <button class="btn primary" id="assignBtn">🎲 Chia vai trò ngẫu nhiên</button>
        <button class="btn" id="reshuffleBtn">🧹 Gỡ toàn bộ</button>
        <button class="btn" id="revealAllBtn" disabled>👁️‍🗨️ Hiện/Ẩn tất cả</button>
        <button class="btn" id="copyBtn" disabled>📋 Sao chép</button>
        <!-- Đổi nút In thành nút Sắp xếp -->
        <button class="btn" id="sortBtn" disabled>↕️ Sắp xếp</button>
      </div>

      <div class="assignments" id="assignments" style="margin-top:8px"></div>
    </section>

    <!-- RIGHT: TIMER + NOTES -->
    <aside class="card">
      <div class="section-title">
        <h2>⏳️ Bộ đếm thời gian</h2>
        <div class="row">
          <label class="chip" style="cursor:pointer"><input id="soundToggle" type="checkbox" checked style="margin-right:8px">Chuông</label>
        </div>
      </div>

      <div class="row wrap timer-row">
  <div class="grow">
    <label>Chế độ</label>
    <select id="timerMode">
      <option value="down">Đếm ngược</option>
      <option value="up">Đếm xuôi</option>
    </select>
  </div>
  <div>
    <label>Phút</label>
    <input id="timerMin" type="number" min="0" value="2">
  </div>
  <div>
    <label>Giây</label>
    <input id="timerSec" type="number" min="0" max="59" value="0">
  </div>
</div>

      <div class="timer-big" id="timerDisplay">02:00</div>
      <div class="timer-controls no-print">
        <button class="btn ok" id="startPauseBtn">▶︎ Bắt đầu</button>
        <button class="btn" id="resetTimerBtn">⟲ Đặt lại</button>
        <button class="btn" data-preset="30">Biện hộ (30s)</button>
        <button class="btn" data-preset="120">Thảo luận (2’)</button>
        <button class="btn" data-preset="180">Thảo luận (3’)</button>
        <button class="btn" data-preset="300">Thảo luận (5’)</button>
      </div>

      <hr style="border-color:#28305633; margin:18px 0">

      <h2>🗒️ Ghi chú</h2>
      <!-- Nút mới cho ghi chú -->
      <div class="notes-tools no-print">
        <button class="btn danger" id="clearNotesBtn">🗑️ Xóa tất cả</button>
        <button class="btn" id="quickTemplateBtn">✍️ Soạn mẫu nhanh</button>
        <button class="btn" id="saveNotesBtn">💿️ Lưu</button>
        <button class="btn" id="openArchiveBtn">📁 Kho lưu trữ</button>
      </div>
      <textarea id="notes" placeholder="Ghi chú: ai bị treo cổ, ai bị sói cắn, lá phiếu, v.v."></textarea>

<!-- ỦNG HỘ TÔI -->
<div class="donate no-print">
  <div class="donate-title" role="heading" aria-level="2">
  <div class="lines">
    <div class="line1">❤ ỦNG HỘ TÔI VÀI GÓI MÌ TÔM ❤</div>
    <div class="line2">(nếu bạn muốn)</div>
  </div>
</div>
  <div class="wrap">
    <!-- NHỚ đúng đuôi file: .jpg (hoặc link raw GitHub) -->
    <img class="qr" src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/qr.jpg" alt="QR MB Bank 0332807382">

    <div class="info">
      <div class="row bank-row">
        <span class="label">NGÂN HÀNG TMCP QUÂN ĐỘI</span>
        <span class="bank-name">- MB BANK</span>
      </div>
      <div class="row nowrap">
        <span class="label">SỐ TK:</span><span class="value">0332807382</span>
      </div>
      <div class="row nowrap">
        <span class="label">TÊN TK:</span><span class="value">NGUYEN DINH DANG KHOA</span>
      </div>
    </div>
  </div>
<div class="donate-promo">
  <div class="promo-text">
    <p class="promo-title">❤ HOẶC ỦNG HỘ BẰNG CÁCH ❤</p>
    <p class="promo-line">Order các đồ len Handmade siêu xinh và cực kì đáng iu với giá cả vô cùng yêu thương ở link Facebook phía dưới:</p>
  </div>

  <!-- ẢNH: căn giữa -->
  <img class="promo-photo" src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/pr.png" alt="Đồ len handmade dễ thương">

  <!-- LINK: căn giữa + màu như tiêu đề ngân hàng -->
  <p class="promo-link">
    <a href="https://www.facebook.com/phuoc.hanh.543792" target="_blank" rel="noopener">
      facebook.com/phuoc.hanh.543792
    </a>
  </p>
</div>
  </div>
</div>

    </aside>
  </div>

  <div class="footer no-print">Created by Dang Khoa ❤️ – Lưu tự động, hoạt động offline.</div>
  <div class="footer no-print">Phiên bản cập nhật mới nhất: 23:45 22/09/2025</div>
  <!-- Modal xem mô tả vai -->
  <div id="roleModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <h3 id="roleModalTitle">Vai trò</h3>
        <button class="close" id="roleModalClose">❌️</button>
      </header>
      <div class="content" id="roleModalBody"></div>
    </div>
  </div>

<!-- Modal kho lưu ghi chép -->
<div id="notesArchiveModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="notesArchiveTitle">📁 Kho ghi chú</h3>
      <button class="close" id="notesArchiveClose">❌️</button>
    </header>
    <div class="content" id="notesArchiveBody">
      <!-- Nội dung render bằng JS -->
    </div>
  </div>
</div>
<!-- Modal kho lưu DANH SÁCH NGƯỜI CHƠI -->
<div id="playersArchiveModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="playersArchiveTitle">📁 Kho danh sách</h3>
      <button class="close" id="playersArchiveClose">❌️</button>
    </header>
    <div class="content" id="playersArchiveBody"></div>
  </div>
</div>
<!-- NÚT '!!' nổi -->
<button class="fab-night no-print" id="nightOrderBtn" aria-label="Thứ tự kêu dậy">!!</button>

<!-- Modal: Thứ tự kêu dậy -->
<div id="nightOrderModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="nightOrderTitle">🌙 Thứ tự kêu dậy mỗi đêm</h3>
      <button class="close" id="nightOrderClose">❌️</button>
    </header>
    <div class="content" id="nightOrderBody"></div>
  </div>
</div>
<!-- Modal: Chọn mục tiêu cho 👥 Nhân bản -->
<div id="doppelTargetModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="doppelTargetTitle">🎯 Chọn mục tiêu</h3>
      <button class="close" id="doppelTargetClose">❌️</button>
    </header>
    <div class="content" id="doppelTargetBody"></div>
  </div>
</div>

<script>
(function(){
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
    const esc = s => String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
  function auraLabel(v){ return Number(v)===1 ? 'Ác' : 'Thiện'; }
  function funcLabel(v){ return Number(v)===1 ? '0' : 'Có'; }
  const $ = {
    playerCount: qs('#playerCount'),
    namesWrap: qs('#names'),
    autoFillNames: qs('#autoFillNames'),
    shuffleNames: qs('#shuffleNames'),
    removeEmptyNames: qs('#removeEmptyNames'),
    rolesList: qs('#rolesList'),
    slotsLeft: qs('#slotsLeft'),
    addCustomRole: qs('#addCustomRole'),
    customRoleName: qs('#customRoleName'),
    customRoleCount: qs('#customRoleCount'),
    resetRoles: qs('#resetRoles'),
    customRoleFaction: qs('#customRoleFaction'),

    assignBtn: qs('#assignBtn'),
    reshuffleBtn: qs('#reshuffleBtn'),
    revealAllBtn: qs('#revealAllBtn'),
    copyBtn: qs('#copyBtn'),
    sortBtn: qs('#sortBtn'),
    assignments: qs('#assignments'),

    // Timer
    timerMode: qs('#timerMode'),
    timerMin: qs('#timerMin'),
    timerSec: qs('#timerSec'),
    timerDisplay: qs('#timerDisplay'),
    startPauseBtn: qs('#startPauseBtn'),
    resetTimerBtn: qs('#resetTimerBtn'),
    soundToggle: qs('#soundToggle'),

    // Notes buttons
    clearNotesBtn: qs('#clearNotesBtn'),
    quickTemplateBtn: qs('#quickTemplateBtn'),
    saveNotesBtn: qs('#saveNotesBtn'),        
    openArchiveBtn: qs('#openArchiveBtn'),
  };

  // ===== Modal helpers =====
// ===== Modal vai trò =====
const modal = {
  wrap: document.getElementById('roleModal'),
  title: document.getElementById('roleModalTitle'),
  body: document.getElementById('roleModalBody'),
  btnClose: document.getElementById('roleModalClose'),

  open(title, text, opts = {}) {
    const { key, custom } = opts;

    // Chip Hào quang/Chức năng như cũ
    let chips = '';
    if (custom) {
      chips = `
        <span class="chip">Hào quang: Tùy chỉnh</span>
        <span class="chip">Chức năng: Tùy chỉnh</span>`;
    } else if (key && ROLE_META[key]) {
      const { aura = 0, func = 0 } = ROLE_META[key];
      const auraLabel = v => Number(v)===1 ? 'Ác' : 'Thiện';
      const funcLabel = v => Number(v)===1 ? '0' : 'Có';
      chips = `
        <span class="chip">Hào quang: ${auraLabel(aura)}</span>
        <span class="chip">Chức năng: ${funcLabel(func)}</span>`;
    }

    // ---- TÍNH "Phe" để gắn vào tiêu đề ----
    const cls2name = {
      'f-wolf' : 'Ma sói',
      'f-vil'  : 'Dân làng',
      'f-swap' : 'Đổi phe',
      'f-third': 'Phe thứ 3'
    };
    const code2name = {
      wolf:'Ma sói', village:'Dân làng', swap:'Đổi phe', third:'Phe thứ 3'
    };

    let factionLabel = 'Phe thứ 3'; // fallback an toàn

    try{
      if (custom) {
        // title của custom đang là "🧩 Tên"; lấy tên thô để dò trong STATE.customRoles
        const rawName = String(title||'').replace(/^🧩\s*/,'').trim();
        const fcode = STATE?.customRoles?.[rawName]?.faction || 'third';
        factionLabel = code2name[fcode] || 'Phe thứ 3';
      } else {
        // Vai mặc định: dò theo tên hiển thị (có emoji) bằng hàm factionOf
        // (hàm này đã có sẵn và hoisted)
        const display = title || (DEFAULT_ROLES.find(r=>r.key===key)?.name) || '';
        const f = factionOf(display); // -> {order, cls: 'f-wolf' | 'f-vil' | ...}
        factionLabel = cls2name[f?.cls] || 'Phe thứ 3';
      }
    }catch{}

    // ---- Gắn tiêu đề: Icon + Tên + “· Phe: …” (inline), sau đó mới tới các chip ----
const safeTitle = (title && title.replace)
  ? title.replace(/</g,'&lt;').replace(/>/g,'&gt;')
  : 'Vai trò';

// --- Tạo tiêu đề có icon ảnh (nếu có) + tên + · Phe: ---
const plainTitle = stripLeadingEmoji(title||'');            // "Giáo chủ"
const leadingEmoji = (title||'').match(/^[^\p{L}\p{N}]+/u)?.[0] || ''; // "🦹"
const iconHTML = key
  ? roleIconHTMLByKey(key, leadingEmoji, plainTitle)
  : leadingEmoji;  // custom thì chưa có key -> giữ emoji gốc

this.title.innerHTML = `
  ${iconHTML}<span class="role-label">${esc(plainTitle || 'Vai trò')} <span class="faction-inline">· Phe: ${esc(factionLabel)}</span></span>
  ${chips ? `<span style="margin-left:10px;display:inline-flex;gap:8px;vertical-align:middle">${chips}</span>` : ''}`;

    this.body.textContent = text || '';
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
}
};

modal.btnClose.addEventListener('click', ()=> modal.close());
modal.wrap.addEventListener('click', (e)=> { if (e.target === modal.wrap) modal.close(); });
document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') modal.close(); });
  
  // ===== Modal: Chọn mục tiêu cho 👥 Nhân bản =====
const doppelModal = {
  wrap: document.getElementById('doppelTargetModal'),
  title: document.getElementById('doppelTargetTitle'),
  body: document.getElementById('doppelTargetBody'),
  btnClose: document.getElementById('doppelTargetClose'),
  holderIndex: null,   // index của người đang giữ vai "Nhân bản"
  open(holderIndex){
  this.holderIndex = holderIndex;
  const list = (STATE.assignments || []);
  const holder = list[holderIndex];
  if (!holder) return;

  const currentPickName = (STATE.doppelTargets || {})[holder.name] || null;

  const ascii = s => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').toLowerCase();
const isEliminated = (p) => {
  if (!p) return true;
  const forcedGhost = ascii(p.role||'').includes('con ma'); // 👻 luôn bị loại
  return !!(STATE.dead && STATE.dead[p.name]) || forcedGhost;
};

  // --- Sắp xếp A→Z theo TÊN Ở CUỐI (trùng tên mới so tiếp phần còn lại) ---
  const coll = new Intl.Collator('vi', { sensitivity:'base', numeric:true });
  const split = s => String(s||'').trim().split(/\s+/);
  const keyParts = (name) => {
    const parts = split(name);
    const last = parts.pop() || '';
    const rest = parts.join(' ');     // họ + tên lót
    return { last, rest };
  };

  const items = list
    .map((p, idx) => ({ p, idx }))
    .sort((a, b) => {
      const ka = keyParts(a.p.name), kb = keyParts(b.p.name);
      const c1 = coll.compare(ka.last, kb.last); // so theo tên ở cuối
      if (c1 !== 0) return c1;
      return coll.compare(ka.rest, kb.rest);     // trùng tên -> so phần còn lại
    });

  // --- Render bảng ---
  const rows = items.map(({p, idx}, line) => {
    const dead = isEliminated(p);
    const disabled = (idx === holderIndex || dead) ? 'disabled' : '';
    const checked  = (currentPickName && currentPickName === p.name) ? 'checked' : '';
    const trCls = [
      (idx === holderIndex) ? 'hl-holder' : '',
      checked ? 'hl-picked' : '',
      dead ? 'is-dead' : ''
    ].filter(Boolean).join(' ');

    return `
      <tr class="${trCls}">
        <td style="text-align:center">${String(line+1).padStart(2,'0')}</td>
        <td class="name" style="text-align:center">${escapeHtml(p.name)}</td>
        <td style="text-align:center">
          <input type="radio" name="doppelPick" value="${idx}" ${disabled} ${checked}>
        </td>
      </tr>`;
  }).join('');

  this.body.innerHTML = `
    <div style="margin:0 0 8px;color:#c7cfff">
      Người chơi: <b>${escapeHtml(holder.name)}</b> (👥 Nhân bản)
    </div>
    <div class="table-wrap">
      <table class="doppel-table" style="width:100%;border-collapse:collapse;table-layout:fixed">
        <thead>
          <tr>
            <th style="width:54px;text-align:center">#</th>
            <th>Tên người chơi</th>
            <th style="width:68px;text-align:center">Chọn</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="archive-actions">
      <button class="btn" id="doppelConfirmBtn">Xác nhận</button>
      <button class="btn" id="doppelCancelBtn">Hủy</button>
    </div>`;

  // Sự kiện
  this.body.querySelector('#doppelConfirmBtn')?.addEventListener('click', () => {
    const pick = this.body.querySelector('input[name="doppelPick"]:checked');
    if (!pick) { alert('Vui lòng chọn một người chơi.'); return; }
    const pickIndex = Number(pick.value);
    const pickPlayer = STATE.assignments[pickIndex];
    if (!pickPlayer) return;
    if (isEliminated(pickPlayer)) {
   alert('Người này đã BỊ LOẠI, Nhân bản chỉ được chọn người còn sống.');
   return;
   }
   if (pickIndex === holderIndex) {
     alert('Nhân bản không thể chọn chính mình.');
     return;
   }

    STATE.doppelTargets = STATE.doppelTargets || {};
    STATE.doppelTargets[holder.name] = pickPlayer.name;
    save();
    renderAssignments();
    this.close();
  });
  this.body.querySelector('#doppelCancelBtn')?.addEventListener('click', () => this.close());

  this.wrap.classList.add('show');
  this.wrap.setAttribute('aria-hidden','false');
  this.btnClose?.focus();
},
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
    this.holderIndex = null;
  }
};
doppelModal.btnClose?.addEventListener('click', ()=> doppelModal.close());
doppelModal.wrap?.addEventListener('click', (e)=>{ if(e.target===doppelModal.wrap) doppelModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') doppelModal.close(); });

  // ====== STATE ======
  const STORAGE_KEY = 'werewolf_mod_state_v1';
  let STATE = {
    playerCount: 10,
    names: [],
    roles: {},          // {key: count}
    customRoles: {},    // {name: count}
    assignments: null,
    reveal: {},         // {index: bool}
    dead: {},
    toughGuyPending: {},   // { [playerName]: true } nếu Lực sĩ đã bị sói cắn (chết trễ)
    doppelTargets: {},        // { holderName: targetName } — mục tiêu đã “khóa” của 👥 Nhân bản
    notes: '',
    notesArchive: [],   // mảng các bản lưu {id, timeISO, content}
    notesSaveSeq: 0,    // số lần đã lưu (đánh số #)
    playersArchive: [],    // các bản lưu danh sách người chơi
    playersSaveSeq: 0,     // đếm số lần lưu danh sách
    doppelTargets: {},        // { holderName: targetName }
    apprenticePromoted: false, 
    firstKillPromptShown: false,

    alphaCanInfect: false,
    alphaUsedOrLost: false,
    roleFlags: {},
    timer: {mode:'down', min:2, sec:0, running:false, left:120, sound:true},
  };

  // Default roles
  const DEFAULT_ROLES = [
// PHE MA SÓI
{ key:'werewolf', name:'🐺 Ma Sói', hint:'Vào mỗi đêm, Ma Sói sẽ tỉnh dậy cùng Bầy Sói và thống nhất giết 1 người chơi. Bầy sói có thể không giết người nào và không được giết các sói khác. Ma Sói chiến thắng khi số Dân Làng < hoặc = số Ma Sói và không còn Sói Trắng.', color:'#ef4444' },
{ key:'werecub', name:'🐺 Sói Con', hint:'Sói Con thức dậy cùng bầy sói mỗi đêm. Nếu Sói Con bị giết, Ma Sói còn lại sẽ giết 2 người vào đêm hôm sau. Bầy Sói có thể chọn giết Sói con như 1 sự hy sinh (Tất cả Bầy Sói bao gồm cả Sói Con đều đồng ý việc đó) khi đó Bầy Sói có thể lập tức giết 2 người chơi khác vào đêm hôm đó. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'minion', name:'🎭️ Kẻ Phản Bội', hint:'Kẻ Phản Bội thức dậy cùng Bầy Sói. Tham gia cùng Bầy Sói để giết Dân Làng. Tuy nhiên Tiên Tri khi soi vào Kẻ Phản Bội thì vẫn là Dân Làng. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'pssoi', name:'☄️ Sói Phù Thủy', hint:'Vào mỗi đêm, Sói Phù Thủy thức dậy và sẽ đi tìm kiếm Tiên Tri bằng cách chỉ thị 1 người chơi, Quản Trò sẽ cho biết đó có phải là Tiên Tri hay không. Ma Sói không được biết Sói Phù Thủy là ai và Sói Phù Thủy cũng không biết Ma Sói là ai. Tiên Tri sẽ soi Sói Phù Thủy là Dân Làng. Sói Phù Thủy có thể từ bỏ chức năng để trở thành Ma Sói và tham gia với Bầy Sói. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'scuong', name:'💢 Sói Điên Cuồng', hint:'Một lần trong trò chơi, kể từ đêm thứ hai, Sói Điên Cuồng có thể sử dụng tiếng còi cuồng nộ. Khi Bầy Sói ở trạng thái cuồng nộ, nạn nhân bị Bầy Sói tấn công không thể sống sót (các lượt bảo vệ không phải từ Hiệp Sĩ, đều sẽ chết theo nạn nhân). Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'soidc', name:'☠️ Sói Đầu Đàn', hint:'Thức dậy cùng Ma sói. Chừng nào Sói Đầu Đàn còn tồn tại trong trò chơi thì mỗi đêm phe Ma Sói có thể giết 2 người chơi, miễn là 2 người chơi đó ngồi cạnh nhau. Tuy nhiên phe Ma Sói sẽ không biết ai là Sói Đầu Đàn. Đêm đầu tiên, Sói Đầu Đàn sẽ thức dậy một mình để cho Quản Trò biết được người đó là ai. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'soituyet', name:'❄️ Sói Tuyết', hint:'Sói Tuyết thức dậy cùng Bầy Sói. Đêm đầu tiên thức dậy, Sói Tuyết lựa chọn một người chơi khác làm bạn đồng hành. Nếu Sói Tuyết chết người chơi đó cũng chết theo. Nếu người chơi đó chết thì Sói Tuyết không chết. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'alpha', name:'🐱 Sói Mèo Con', hint:'Một lần trong trò chơi, sau khi một Ma Sói khác bị treo cổ vào ban ngày, vào đêm tiếp theo, Sói Mèo Con có thể biến mục tiêu của phe Ma Sói thành Ma sói thay vì bị giết. Nếu người chơi này được bảo vệ bởi một nguyên nhân nào đó thì vết cắn của Sói Mèo Con sẽ không có tác dụng. Khi đó Sói Mèo Con sẽ được cắn thêm một lần khác vào đêm sau. Nhưng nếu cắn trúng Sói Phù Thủy và các vai tro giết người thuộc phe Thứ 3 thì sẽ mất tác dụng vĩnh viễn. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'acmong', name:'🎃 Sói Ác Mộng', hint:'Một lần trong trò chơi, vào ban đêm, Sói Ác Mộng có thể gieo cơn ác mộng cho một người chơi và khiến chức năng của người đó bị vô hiệu trong đêm. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'spsu', name:'🐺 Sói Pháp Sư', hint:'Hai lần trong trò chơi, vào ban đêm, Sói Pháp Sư có thể yểm phép vào 1 người chơi, các vai trò thông tin thuộc phe Dân Làng và phe Thứ 3 khi kiểm tra người chơi đó đều được kết quả ngược lại.  Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'shve', name:'🐺 Sói Hộ Vệ', hint:'Một lần trong trò chơi, vào ban đêm, Sói Hộ Vệ có thể chọn ra một Ma Sói trong bầy để bảo vệ, Ma Sói đó sẽ không bị treo cổ vào buổi sáng. Chức năng sẽ không tiêu hao khi Ma Sói đó không bị treo cổ. Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'stthuat', name:'🐺 Sói Tà Thuật', hint:'Hai lần trong trò chơi, vào ban đêm, Sói Tà Thuật có thể làm câm lặng một người chơi, chặn họ nói chuyện và bỏ phiếu (người vi phạm sẽ bị loại ngay lập tức) Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'shbinh', name:'🐺 Sói Hòa Bình', hint:'Một lần trong trò chơi, vào ban đêm, Sói Hòa Bình có thể ngăn chặn cuộc bỏ phiếu vào buổi sáng hôm sau. Quản Trò sẽ thông báo "Người Yêu Hòa Bình đã chặn cuộc bỏ phiếu vào hôm nay.". Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'sdto', name:'🐺 Sói Độc Tố', hint:'Hai lần trong trò chơi, vào ban đêm, Sói Độc Tốt có thể đầu độc 1 người chơi, người chơi đó sẽ bị Bầy Sói tấn công bỏ qua các lượt bảo vệ (trừ lượt bảo vệ từ Hiệp Sĩ).  Điều kiện thắng: Thắng cùng phe Ma Sói.', color:'#ef4444' },
{ key:'sptach', name:'🐺 Sói Phân Tách', hint:'Một lần trong trò chơi, vào ban đêm, Sói ác mộng có thể gieo cơn ác mộng cho một người chơi và khiến chức năng của người đó bị vô hiệu trong đêm.', color:'#ef4444' },
// PHE DÂN LÀNG
{ key:'seer', name:'🔮 Thầy Bói', hint:'Mỗi đêm, Thầy Bói chỉ tay vào một người. Quản trò sẽ cho biết người đó có hào quang là Thiện hay Ác. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'witch', name:'🧙‍♂️ Phù Thuỷ', hint:'Phù Thủy sẽ có hai bình thuốc. Một bình thuốc để cứu 1 người và một bình thuốc để giết 1 người. Trong đêm, Quản Trò sẽ cho biết ai sẽ bị giết trong đêm và hỏi xem Phù Thủy có muốn sử dụng quyền năng nào hay không. Có thể dùng cả hai bình thuốc này vào cùng 1 đêm, nhưng mỗi bình chỉ dùng một lần. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'hunter', name:'🏹 Thợ Săn Quái Thú', hint:'Nếu Thợ Săn Quái Thú chết, hắn lập tức được phép nhắm vào một người chơi và người chơi này sẽ chết theo hắn. Nếu Thợ Săn Quái Thú chết trong đêm, Quản Trò sẽ đụng vai để báo cho Thợ Săn Quái Thú nhắm bắn. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'guard', name:'🛡️ Bảo Vệ', hint:'Mỗi đêm, Bảo Vệ có thể chọn một người khác nhau để bảo vệ. Người chơi này sẽ được an toàn vào đêm đó (nhưng không thể bảo vệ khỏi Phù thủy). Bảo Vệ có tổng cộng 2 mạng, nếu chặn được sói, Bảo Vệ sẽ mất đi 1 mạng. Bảo Vệ luôn tự bảo vệ mình. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'spellcaster', name:'🔇 Bà Già Khó Tính', hint:'Mỗi đêm, Bà Già Khó Tính sẽ được phép chỉ định 1 người không được nói chuyện và bỏ phiếu vào hôm sau (nếu người bị câm lỡ nói thì sẽ bị loại ngay lập tức). Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'village', name:'👨🏻‍🌾 Dân Làng', hint:'Không có chức năng đặc biệt nào cả, ngủ suốt đêm và tham gia biểu quyết tìm Ma Sói vào ban ngày. Dân Làng thắng khi tiêu diệt được toàn bộ Ma Sói và các vai trò giết người thuộc phe Thứ 3.', color:'#3b82f6' },
{ key:'prince', name:'👑 Công Chúa', hint:'Công Chúa không thể bị treo cổ chết. Vào lần bị vote chết và chuẩn bị treo cổ, người này sẽ lật lá bài lên để mọi người được thấy và không phải chịu treo cổ. Tất cả người chơi lập tức đi ngủ. Lá bài này đi kèm với Hiệp Sĩ. Điều kiện thắng: Thắng cùng phe Dân Làng. ', color:'#3b82f6' },
{ key:'elder', name:'👴 Già Làng', hint:'Già Làng có 2 mạng sống. Nếu chết cả 2 lần thì các quyền năng (Tiên tri, Bảo vệ,…) của nhân vật khác sẽ mất đi trong đêm tiếp theo. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'tough guy', name:'💪 Lực Sĩ', hint:'Nếu bị Ma Sói cắn, Lực Sĩ sẽ được Quản Trò khều dậy riêng để cho biết con sói cắn mình và Lực Sĩ sẽ chết vào đêm tiếp theo chứ không phải ngay tại đêm đó. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'mayor', name:'⭐ Thị Trưởng', hint:'Phiếu biểu quyết của Thị Trưởng được tính là 2 phiếu khi biểu quyết treo cổ. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'hbi', name:'✨ Tiên Tri', hint:'Mỗi đêm, Tiên Tri sẽ tỉnh dậy và chỉ định một người. Quản Trò sẽ cho Tiên Tri biết chính xác người chơi này là chức năng gì. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'dbom', name:'💣️ Kẻ Đánh Bom', hint:'Nếu Kẻ Đánh Bom  bị loại, thì hai người chơi bên trái và phải của người chơi này sẽ cùng bị loại (không tính những người chơi đã bị loại rồi). Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'tvan', name:'🔭 Nhà Thiên Văn Học', hint:'Mỗi đêm, Nhà Thiên Văn Học sẽ tỉnh dậy và có thể chỉ vào một người chơi để gọi mưa sao băng. Nếu người chơi đó là Ma Sói, người đó sẽ bị loại. Nếu không, Nhà Thiên Văn Học sẽ bị loại. Ngoài ra, nếu trong ván có Sói Điên Cuồng hoặc Sói Độc Tố, Nhà Thiên Văn Học có 1 lần gọi trăng khuyết để vô hiệu mọi chức năng của phe Ma Sói. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'lgac', name:'⚔️ Người Canh Gác', hint:'Một lần trong trò chơi, kể từ đêm thứ hai, Người Canh Gác có thể chỉ định giết một người chơi nếu nghi ngờ. Ngoài ra, Người Canh Gác còn có 1 lần kiểm tra vai trò thật của 1 người chơi vào ban đêm. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'gsu',  name:'👨‍🏫 Thám Tử', hint:'Mỗi Đêm, Thám Tử tỉnh dậy và chỉ định hai người chơi. Quản Trò sẽ cho biết hai người chơi này có cùng phe với nhau hay không. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'tsu', name:'🔮 Tiên Tri Tập Sự', hint:'Nếu vai trò thông tin thuộc phe dân chết, Tiên Tri Tập Sự sẽ trở thành vai trò thông tin đó mới. Tiên tri Tập sự được thông báo trong đêm, vào lượt gọi của vai trò thông tin đó, Quản trò đụng vào vai của Tiên Tri Tập Sự để gọi dậy. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'hquang', name:'🧿 Tiên Tri Hào Quang', hint:'Tiên Tri Hào Quang thức dậy mỗi đêm để kiểm tra người chơi có chức năng hay không (Chức năng: Có/0). Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'nbenh', name:'🤒 Người Bệnh', hint:'Nếu Người Bệnh bị Ma Sói cắn, thì Ma Sói sẽ không thể cắn người nào vào đêm tiếp theo do bị bệnh. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'cma', name:'👻 Con Ma', hint:'Con Ma bị chết ngay vào đêm đầu tiên. Mỗi đêm( bao gồm cả đêm đầu tiên), Con ma có thể liên hệ với những người chơi khác bằng cách viết 1 chữ lên 1 tờ giấy nhưng không được viết tên hay viết tắt tên, mà thay vào đó là đưa ra các gợi ý thú vị. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'hbinh', name:'🤝 Người Yêu Hòa Bình', hint:'Một lần trong trò chơi, vào ban đêm, Người Yêu Hòa Bình có thể chặn cuộc bỏ phiếu vào ngày hôm sau. Quản Trò sẽ thông báo "Người Yêu Hòa Bình đã chặn cuộc bỏ phiếu vào hôm nay.". Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'ttu', name:'🕵‍♂ Cảnh Sát Trưởng', hint:'Một lần trong trò chơi, vào ban đêm, Cảnh Sát Trưởng sẽ được gọi dậy và được phép chọn 1 một người. Quản Trò sẽ cho Cảnh Sát Trưởng biết người đó hoặc hai người bên cạnh người đó có phải là Ma Sói hay không. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'hsi', name:'💂‍♂ Hiệp Sĩ', hint:'Một lần trong trò chơi, vào ban đêm, Hiệp Sĩ có thể chọn một người chơi để được bảo vệ. Miễn là Hiệp Sĩ còn sống, người chơi này sẽ bất tử vào tất cả các đêm. Chỉ bị loại bởi các lí do vào ban ngày. ( như bị treo cổ). Hiệp Sí sẽ tự treo cổ nếu vai trò Công Chúa bị giết. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'blang', name:'🐆 Kẻ Phá Rối', hint:'Mỗi đêm, Quản trò sẽ hỏi “Kẻ Phá Rối có muốn quậy phá không?”. Nếu đồng ý, Kẻ Phá Rối sẽ tỉnh dậy và ra hiệu bằng cách gật đầu. Ngày hôm sau, sẽ có 2 lượt biểu quyết treo cổ. Kẻ Phá Rối chỉ thực hiện được 1 lần quậy phá trong suốt cả ván chơi. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'nsi', name:'🐆 Nghệ Sĩ Vĩ Cầm', hint:'Hai lần trong một trò chơi, vào ban đêm, Nghệ Sĩ Vĩ Cầm sẽ chọn 1 người chơi để biết người đó có khóc thương tiếc cho cái chết của người chết đầu tiên không. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'nldo', name:'🐆 Người Lái Đò', hint:'Hai lần trong trò chơi, vào ban đêm, Người Lái Đò sẽ chọn ra 2 người chơi để đưa lên đò, nếu 1 trong 2 người chết thì vẫn sẽ được sống hết ngày hôm sau. Nếu cả 2 người trên đò đều chết, họ vẫn sẽ được sống hết ngày hôm sau nhưng bạn sẽ chết vào chính đêm đó. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'hbcon', name:'🐆 Hoa Bé Con', hint:'Một lần trong trò chơi, bạn sẽ có thể cứu 1 người khỏi bị treo cổ bằng cách biểu quyết - Cứu người đó. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'ngdem', name:'🐆 Người Gác Đêm', hint:'Người Gác Đêm có 2 lần bảo vệ, vào ban đêm, Người Gác Đêm có thể biết những ai đã được bảo vệ, khi 2 lần bảo vệ của Người Gác Đêm sử dụng hết thì sẽ không còn biết những ai đã được bảo vệ nữa. Trường hợp không có ai được bảo vệ, Người Gác Đêm bắt buộc phải sử dụng lần bảo vệ của mình. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'mnu', name:'🐆 Ma Nữ', hint:'Mỗi đêm, Ma Nữ có thể ghé thăm 1 người chơi, nếu Ma Nữ bị tấn công trong lúc ghé thăm người khác, Ma Nữ sẽ không chết. Nhưng nếu người được ghé thăm bị tấn công, Ma Nữ sẽ chặn lượt tấn công đó và linh hồn của Ma Nữ và người chơi được ghé thăm sẽ liên kết với nhau. 1 trong 2 chết, người kia cũng sẽ chết theo. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'txa', name:'🐆 Thiện Xạ', hint:'Thiện Xạ có 2 mũi tên, vào mỗi đêm, Thiện Xạ có thể lựa chọn chọn mục tiêu hoặc bắn, mục tiêu khi được chọn có thể thay đổi nhưng chọn mục tiêu và bắn phải cách nhau 1 đêm. Nếu chọn trúng Dân Làng, mũi tên sẽ quay ngược lại giết chết Xạ Thủ. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'tphan', name:'🐆 Thẩm Phán', hint:'Hai lần trong trò chơi, vào buổi sáng, nếu cuộc bỏ phiếu không thể chọn ra người bị treo cổ, Thẩm Phản sẽ được chọn 1 người để kết tội và treo cổ. Nếu đó là Dân Làng, Thẩm Phản cũng sẽ chết theo. Lần kết tội đầu tiên sẽ làm lộ danh tính của Thẩm Phán. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'nptich', name:'🐆 Nhà Phân Tích', hint:'Mỗi đêm, Nhà Phân Tích chọn ra 2 người chơi để kiểm tra hào quang của họ, nếu ra cùng kết quả, Nhà Phân Tích sẽ bị vỡ kính và không thể kiểm tra hào quang vào đêm hôm sau. Nếu bị vỡ kính 2 lần, Nhà Phân Tích sẽ mất đi chức năng của mình. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'nncam', name:'🐆 Nhà Ngoại Cảm', hint:'Mỗi đêm, Nhà Ngoại Cảm sẽ chọn ra 2 người chơi, nếu 1 trong 2 hoặc cả 2 đều giết người trong đêm trước, Quản Trò sẽ cho Nhà Ngoại Cảm màu đỏ, ngược lại Quản Trò sẽ cho màu xanh. Đêm đầu tiên, kết quả luôn là màu xanh. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'cbac', name:'🐆 Con Bạc', hint:'Mỗi đêm, Con Bạc có thể kiểm tra 1 người để xem người đó có thuộc Dân Làng/Ma Sói/Đổi Phe/Phe Thứ 3 không. Phe Thứ 3 bao gồm cả vai trò giết người và bỏ phiếu. Con Bạc chỉ có 2 lần kiểm tra có thuộc Dân Làng hay không. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'py', name:'🐆 Pháp Y', hint:'2 lần trong trò chơi, vào ban đêm, Pháp Y có thể chọn ra 1 người đã chết, sau đó chọn liên tiếp 3 nghi phạm, nếu trong 3 nghi phạm có ít nhất 1 người liên quan đến cái chết của người được chọn, Quản Trò sẽ ra hiệu cho Pháp Y. Nếu người chết bị giết bởi phe Thứ 3, Quản Trò sẽ cho Pháp Y chọn 4 nghi phạm. Mỗi lần sử dụng chức năng sẽ cách nhau 1 đêm. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'nghon', name:'🐆 Người Gọi Hồn', hint:'Hai lần trong trò chơi, kể từ đêm thứ hai, Quản Trò sẽ hỏi Người Gọi Hồn có muốn sử dụng chức năng hay không. Nếu đồng ý, Quản Trò sẽ cho Người Gọi Hồn được sử dụng chức năng của Dân Làng đã chết sớm hơn đến hết buổi sáng hôm sau. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'tlbanh', name:'🐆 Thợ Làm Bánh', hint:'Mỗi đêm, Thợ Làm Bánh sẽ phát bánh cho 1 người chơi, và phiếu bầu của người đó vào hôm sau sẽ được x2. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'tren', name:'🐆 Thợ Rèn', hint:'Thợ Rèn có thể rèn ra 2 loại vũ khí gồm: 2 tấm khiên và 1 thanh kiếm, thời gian rèn 1 vũ khí là 1 ngày (tức đến đêm hôm sau, khi chọn rèn), 2 loại vũ khí này đều phải trao đi cho người khác trước khi rèn vũ khí khác. Thợ Rèn không thể giữ vũ khí cho riêng mình. Người được nhẫn vũ khí sẽ sử dụng chúng vào ban đêm lượt của họ. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
{ key:'bsi', name:'🐆 Bác Sĩ', hint:'Mỗi đêm, bạn có thể chọn ra một người để che chở (không liên tiếp 2 đêm), người đó sẽ được an toàn vào đêm đó (nhưng không thoát khỏi Phù Thủy), Bác Sĩ không tự che chở cho bản thân mình được. Điều kiện thắng: Thắng cùng phe Dân Làng.', color:'#3b82f6' },
// PHE ĐỔI PHE
{ key:'cupid', name:'💘 Thần Tình Yêu', hint:'Thức dậy vào đêm đầu tiên và chọn ra 2 người chơi để ghép đôi( được phép chọn cả mình). Hai người được chọn sẽ thức dậy, nhận diện và trao đổi vai trò cho nhau nhưng không biết ai là người ghép đôi( trừ khi chính Thần Tinh Yêu chọn bản thân là người được ghép đôi). Nếu một trong hai người này chết, người còn lại cũng sẽ chết theo. Nếu ghép trúng 2 phe trái nhau thì 2 người chơi sẽ trở thành phe thứ 3 hoàn toàn mới và dành chiến thắng khi họ là người cuối cùng còn sống sót. Điều kiện thắng: Thắng cùng phe Dân Làng hoặc thắng theo phe couple.', color:'#10b981' },
{ key:'doppelganger', name:'👥 Nhân Bản', hint:'Vào đêm đầu tiên, Nhân Bản tỉnh dậy và lựa chọn một người chơi. Nếu người chơi kia chết, Nhân Bản sẽ bí mật lấy chức năng của người đó. Trước khi có chức năng mới, Nhân Bản theo phe dân. Sau khi có chức năng mới, Nhân Bản theo phe của chức năng này. Điều kiện thắng: Thắng cùng phe Dân Làng hoặc thắng cùng phe đã nhân bản.', color:'#10b981' },
{ key:'cursed', name:'🌑 Bán Sói', hint:'Bán Sói ban đầu là người, Tiên Tri soi cũng ra người. Nếu Bán Sói bị Ma Sói cắn thì sẽ không chết, mà từ đêm tiếp theo sẽ biến thành Ma Sói, đồng thời nếu Tiên Tri sói thì cũng sẽ là Sói. Điều kiện thắng: Thắng cùng phe Dân Làng hoặc thắng cùng phe Ma Sói.', color:'#10b981' },
// PHE THỨ 3
{ key:'tanner', name:'😓 Thằng Ngố', hint:'Thằng Ngố chỉ thắng khi anh ta bị treo cổ vào ban ngày. Các điều kiện thắng khác cũng được áp dụng. Chức năng này đi chung với lá bài Yêu hòa bình.', color:'#eab308' },
{ key:'gchu', name:'🦹 Giáo Chủ', hint:'Mỗi đêm, Giáo chủ sẽ phải tỉnh dậy và thêm 1 người chơi vào giáo phái của mình. Nếu tất cả những người còn sống đều là người của giáo phái mình, Giáo chủ sẽ là người chiến thắng. Các điều kiện thắng khác cũng được áp dụng.', color:'#eab308' },
{ key:'dgau', name:'🐻 Du Côn', hint:' Vào đêm đầu tiên Du Côn có thể chọn 3 người để dụ dỗ gia nhập cùng mình, nếu đồng ý gia nhập, những người được dụ dỗ sẽ được khều dậy, vứt bỏ chức năng cũ và trở thành các Du Côn. Nếu chỉ còn 1 Du Côn, Du Côn sẽ được giết 1 người mỗi đêm. Du Côn chiến thắng khi còn lại cuối cùng.', color:'#eab308' },
{ key:'mcr', name:'🧛 Ma Cà Rồng', hint:'Là 1 thế lực mạnh thứ 3 ngoài phe Ma Sói và phe Dân Làng. Mỗi đêm, Ma Cà Rồng sẽ chọn 1 người chơi là nạn nhân. Nếu nạn nhân của Ma Cà Rồng bị từ 2 người chơi trở lên (không tính Ma Cà Rồng) nghi ngơ  trong cuộc thảo luận ở buổi sáng thì nạn nhân sẽ chết khi đến giờ biểu quyết. Ma Cà Rồng không thể bị giết bởi Ma Sói vào ban đêm (trừ lượt tấn công của Sói Trắng).', color:'#eab308' },
{ key:'strang', name:'🐺 Sói Trắng', hint:'Sói Trắng thức dậy cùng Bầy Sói và tham gia cùng Bầy Sói để giết Dân Làng. Sau đó, Sói Trắng sẽ thức dậy thêm một lần nữa để tiếp tục chọn mục tiêu để giết. Sói Trắng dành chiến thắng khi còn lại cuối cùng.', color:'#eab308' },
{ key:'ttama', name:'🐺 Thám Tử Ác Ma', hint:'Mỗi đêm, Thám Tử Ác Ma có thể lựa chọn hai người chơi, bao gồm bản thân. Nếu hai người chơi đó ở hai phe khác nhau, cả hai bọn họ sẽ chết, còn không thì phe của họ sẽ bị tiết lộ với Thám Tử Ác Ma. Nếu lựa chọn bản thân thì chỉ người còn lại sẽ chết.', color:'#eab308' },
{ key:'snhloat', name:'🐺 Sát Nhân', hint:'Mỗi đêm, Sát Nhân thức dậy và giết 1 người. Sát Nhân không thể bị giết bởi Ma Sói vào ban đêm (trừ lượt tấn công của Sói Trắng). Sát Nhân chiến thắng khi còn lại cuối cùng.', color:'#eab308' },
{ key:'tsnguoi', name:'🐺 Thợ Săn Người', hint:'Vào đêm đầu tiên, Thợ Săn Người sẽ thức dậy để Quản Trò cho biết mục tiêu săn lùng. Thợ Săn Người chiến thắng khi mục tiêu săn lùng bị treo cổ vào buổi sáng. Nếu mục tiêu săn lùng chết vì lí do khác, Thợ Săn Người sẽ gia nhập vào Dân Làng và chiến thắng với Dân Làng.', color:'#eab308' },
{ key:'kphoa', name:'🐺 Kẻ Phóng Hỏa', hint:'Mỗi đêm, Kẻ Phóng Hỏa sẽ chọn 2 người gần nhau để tẩm xăng hoặc đốt những người đã tẩm xăng, nếu 2 đêm liên tiếp Kẻ Phóng Hóa đều chọn tẩm xăng thì 4 người bị tẩm xăng bắt buộc phải là 4 người ngồi liền kề nhau. Tẩm xăng có thể bị chặn bởi các lượt bảo vệ. Kẻ Phóng Hỏa thắng khi còn lại cuối cùng.', color:'#eab308' },
{ key:'ttac', name:'🐺 Tin Tặc', hint:'Mỗi đêm, Tin Tặc sẽ chọn 1 người chơi. Người chơi đó sẽ không được nói chuyện hay tham gia vào biểu quyết. Đến giờ vote treo cổ, người chơi đó sẽ chết. Tin Tặc không thể bị giết bởi Ma Sói vào ban đêm (trừ lượt tấn công của Sói Trắng). Tin Tặc chiến thắng khi còn lại cuối cùng.', color:'#eab308' },
{ key:'ngkim', name:'🐺 Nhà Giả Kim', hint:'Mỗi đêm, Nhà Giả Kim sẽ đưa 2 bình thuốc cho 2 người chơi khác nhau, 1 bình đỏ và 1 bình đen. Người được đưa bình thuốc đen sẽ chết vào cuộc bỏ phiếu sáng hôm sau, còn người nhận bình đỏ phải nhận đến bình đỏ thứ 2 mới chết vào cuộc bỏ phiếu sáng hôm sau. Các lượt bảo vệ có thể ngăn chặn bình thuốc đen nhưng không thể ngăn chặn bình thuốc đỏ (trừ lượt bảo vệ của Hiệp Sĩ). Nhà Giả Kim chiến thắng khi còn lại cuối cùng.', color:'#eab308' },
{ key:'mnngu', name:'🐺 Nhân Ngư', hint:'Mỗi đêm, Nhân Ngư có thể chọn ra 3 người để mê hoặc, hoặc có thể giết tối đa 2 người đã mê hoặc. Nếu Nhân Ngư chết thì những người bị mê hoặc cũng sẽ chết theo. Việc mê hoặc vượt qua mọi lượt bảo vệ (trừ Hiệp sĩ và lượt bảo vệ của Hiệp Sĩ). Nhân Ngư chiến thắng khi đã mê hoặc toàn bộ người chơi hoặc còn lại cuối cùng.', color:'#eab308' },
  ];

// Chuẩn hoá dữ liệu customRoles: cho phép dạng {name:{count,faction}}
function normalizeCustomRoles(){
  const cr = STATE.customRoles || {};
  const fixed = {};
  Object.entries(cr).forEach(([name, val])=>{
    if (typeof val === 'number') {
      fixed[name] = { count: val, faction: 'third' }; // mặc định phe 3 cho dữ liệu cũ
    } else {
      const c = Number(val.count||0);
      fixed[name] = { count: c, faction: val.faction || 'third' };
    }
  });
  STATE.customRoles = fixed;
}
// Hiển thị icon ảnh + tên vai cho chuỗi hiển thị (có thể là "🧩 Tên" hoặc "🐺 Ma sói")
function renderRoleLabelHTML(displayName){
  const plain = stripLeadingEmoji(displayName);
  const ascii = s => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  // Thử dò vai mặc định theo tên (bỏ emoji & bỏ dấu)
  const found = DEFAULT_ROLES.find(r => ascii(stripLeadingEmoji(r.name)) === ascii(plain));

  // Emoji đầu (nếu không có icon URL)
  const leadingEmoji = (displayName.match(/^[^\p{L}\p{N}]+/u)?.[0]) || '';

  // Nếu là vai custom (đang lưu đúng key trong STATE.customRoles) -> giữ tiền tố 🧩
  const isCustom = !!(STATE.customRoles && Object.prototype.hasOwnProperty.call(STATE.customRoles, plain));
  const label = isCustom ? `🧩 ${plain}` : plain;

  const iconHTML = found
    ? roleIconHTMLByKey(found.key, leadingEmoji, plain)      // ưu tiên icon URL
    : (leadingEmoji ? `<span class="role-icon" aria-hidden="true" style="width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center">${leadingEmoji}</span>` : '');

  return `${iconHTML}${esc(label)}`;
}

// ====== META cho 40 vai (0/1 để bạn sửa trực tiếp trong file) ======
// Quy ước: aura: 0=Thiện, 1=Ác  |  func: 0=Có, 1=Không
const ROLE_META = {
  // Ma sói & phe sói
  werewolf:{aura:1, func:1},
  werecub:{aura:1, func:0},
  minion:{aura:0, func:1},
  pssoi:{aura:0, func:0},      // ☄️ Sói phù thủy
  soidc:{aura:1, func:0},      // ☠️ Sói đầi đàn
  soituyet:{aura:1, func:0},   // ❄️ Sói tuyết
  alpha:{aura:1, func:0},      // 🐱 Sói mèo con
  acmong:{aura:1, func:0},     // 🎃 Ác mộng
  scuong:{aura:1, func:0},     // 💢 Sói cuồng
  shbinh:{aura:1, func:0},
  sdto:{aura:1, func:0},
  shve:{aura:1, func:0},
  spsu:{aura:1, func:0},
  sptach:{aura:1, func:0},
  
  // Dân làng & phe dân
  seer:{aura:0, func:0},           // 🔮 Thầy bói
  witch:{aura:0, func:0},          // 🧙‍♂️ Phù thủy
  hunter:{aura:0, func:0},         // 🏹 Thợ săn
  guard:{aura:0, func:0},          // 🛡️ Bảo vệ
  spellcaster:{aura:0, func:0},    // 🔇 Bà già khó tính
  prince:{aura:0, func:1},         // 👑 Công chúa
  elder:{aura:0, func:1},          // 👴 Già làng
  "tough guy":{aura:0, func:1},    // 💪 Lực sĩ  
  mayor:{aura:0, func:1},          // ⭐ Thị trưởng
  hbi:{aura:0, func:0},            // ✨ Tiên tri
  dbom:{aura:0, func:1},           // 💣️ Kẻ đánh bom
  tvan:{aura:0, func:0},           // 🔭 Thiên văn
  lgac:{aura:0, func:0},           // ⚔️ Lính gác
  gsu:{aura:0, func:0},            // 👨‍🏫 Giáo sư
  tsu:{aura:0, func:1},            // 🔮 Tập sự
  hquang:{aura:0, func:0},         // 🧿 Hào quang
  nbenh:{aura:0, func:1},          // 🤒 Người bệnh
  cma:{aura:0, func:1},            // 👻 Con ma
  hbinh:{aura:0, func:0},          // 🤝 Hòa bình
  ttu:{aura:0, func:0},            // 🕵‍♂ Thám tử
  hsi:{aura:0, func:0},            // 💂‍♂ Hiệp sĩ
  blang:{aura:0, func:0},          // 🐆 Báo làng
  village:{aura:0, func:1},        // 👨🏻‍🌾 Dân làng (không chức năng)
  tren:{aura:0, func:0},
  tlbanh:{aura:0, func:0},
  nghon:{aura:0, func:0},
  py:{aura:0, func:0},
  cbac:{aura:0, func:0},
  nncam:{aura:0, func:0},
  nptich:{aura:0, func:0},
  tphan:{aura:0, func:0},
  txa:{aura:0, func:0},
  mnu:{aura:0, func:0},
  ngdem:{aura:0, func:0},
  hbcon:{aura:0, func:0},
  nldo:{aura:0, func:0},
  nsi:{aura:0, func:0},
  bsi:{aura:0, func:0},

  // “Đổi phe”
  cupid:{aura:0, func:0},          // 💘 Cupid
  doppelganger:{aura:0, func:0},   // 👥 Nhân bản
  cursed:{aura:0, func:1},         // 🌑 Bị nguyền

  // Phe thứ 3
  tanner:{aura:0, func:1},         // 😓 Chán đời
  gchu:{aura:0, func:0},           // 🦹 Giáo chủ
  dgau:{aura:1, func:0},           // 🐻 Đầu gấu
  strang:{aura:1, func:0},         // 🐺 Sói trắng
  ttama:{aura:1, func:0},
  tsnguoi:{aura:0, func:1},
  ttac:{aura:1, func:0},
  snhloat:{aura:1, func:0},
  kphoa:{aura:1, func:0},
  ngkim:{aura:1, func:0},
  mnngu:{aura:1, func:0},
  mcr:{aura:1, func:0}             // 🧛 Ma cà rồng
};

// URL icon tuỳ biến cho 1 số vai (ưu tiên cao hơn emoji)
const ROLE_ICON_URL = {
  gchu: 'https://www.wolvesville.com/static/media/icon_sect_leader_filled.d7886d346c5906063136.svg' // 🦹 Giáo chủ
};
Object.assign(ROLE_ICON_URL, {
  cupid: 'https://www.wolvesville.com/static/media/icon_cupid_filled.5a152d6f57204abcbba8.svg',
  werewolf: 'https://www.wolvesville.com/static/media/icon_werewolf_filled.ae752e6e4c098343f51f.svg',
  werecub: 'https://www.wolvesville.com/static/media/icon_junior_werewolf_filled.118d63fe2617f43b4fc7.svg',
  seer: 'https://www.wolvesville.com/static/media/icon_aura_seer_filled.0dfd01b695fbf2dcf839.svg',
  witch: 'https://www.wolvesville.com/static/media/icon_witch_filled.baa5bea117d4c6955055.svg',
  hunter: 'https://www.wolvesville.com/static/media/icon_beast_hunter_filled.8f57b3aafd979562e744.svg',
  guard: 'https://www.wolvesville.com/static/media/icon_bodyguard_filled.f0e44ef3c82404a0cbcf.svg',
  spellcaster: 'https://www.wolvesville.com/static/media/icon_grumpy_grandma_filled.4cbc5d802a69f41d39f4.svg',
  tanner: 'https://www.wolvesville.com/static/media/icon_fool_filled.ab621444cb0413a541c0.svg',
  village: 'https://www.wolvesville.com/static/media/icon_villager_filled.bf9f7a2cfd5ce009de0f.svg',
  'tough guy': 'https://www.wolvesville.com/static/media/icon_tough_guy_filled.380bd44d80f0afe555e7.svg',
  scuong: 'https://www.wolvesville.com/static/media/icon_werewolf_berserk_filled.12ee2ec4c540ab7349c0.svg',
  soidc: 'https://www.wolvesville.com/static/media/icon_alpha_werewolf_filled.74166752110af0b83bea.svg',
  doppelganger: 'https://www.wolvesville.com/static/media/icon_grave_robber_filled.412f6ac1536a173e633e.svg',
  cursed: 'https://www.wolvesville.com/static/media/icon_cursed_human_filled.4175d58fa5f364f6983b.svg',
  prince: 'https://static.wikia.nocookie.net/werewolf-online/images/f/fb/Ghost_Lady_Fairytale.png/revision/latest?cb=20230521182800',
  elder: 'https://cdn.wolvesville.com/roleIcons/travel-priest.png',
  mayor: 'https://www.wolvesville.com/static/media/icon_mayor_filled.93d08f42621aa71d9ece.svg',
  pssoi: 'https://www.wolvesville.com/static/media/icon_sorcerer_filled.8c8c679df285c6f122b9.svg',
  soituyet: 'https://www.wolvesville.com/static/media/icon_ghost_wolf_filled.fc3131b2365cdd1f5557.svg',
  alpha: 'https://www.wolvesville.com/static/media/icon_kitten_wolf_filled.0f568776b7ca8d5d50a1.svg',
  minion: 'https://www.wolvesville.com/static/media/icon_shapeshifter_filled.047e52d078f13cf809d4.svg',
  acmong: 'https://www.wolvesville.com/static/media/icon_nightmare_werewolf_filled.eb9ba67a16a2d7afc1ba.svg',
  hbi: 'https://www.wolvesville.com/static/media/icon_seer_filled.2dbdbb9f7e32df7a0d6e.svg',
  dbom: 'https://www.wolvesville.com/static/media/icon_bomber_filled.a86d8d7a84e34f47907c.svg',
  tvan: 'https://www.wolvesville.com/static/media/icon_astronomer_filled.1e78dbcd9db03835ca37.svg',
  lgac: 'https://www.wolvesville.com/static/media/icon_vigilante_filled.040b4792dabf660c3560.svg',
  gsu: 'https://www.wolvesville.com/static/media/icon_detective_filled.6f58542f98bb0bad55e9.svg',
  tsu: 'https://www.wolvesville.com/static/media/icon_seer_apprentice_filled.81480673499f6d53b00c.svg',
  hquang: 'https://static.wikia.nocookie.net/werewolf-online/images/0/03/Seer_Dark_Love_icon.png/revision/latest?cb=20230703152439',
  nbenh: 'https://cdn.wolvesville.com/roleIcons/icon_halloween_forger.png',
  bsi: 'https://www.wolvesville.com/static/media/icon_doctor_filled.20fa62bd956fdf7277aa.svg',
  cma: 'https://static.wikia.nocookie.net/werewolf-online/images/4/40/Nightmare_Werewolf_Selected.png/revision/latest?cb=20200611170014',
  hbinh: 'https://www.wolvesville.com/static/media/icon_pacifist_filled.c38071e2243a144974af.svg',
  ttu: 'https://www.wolvesville.com/static/media/icon_sheriff_filled.3495e4dbfc1660ade952.svg',
  hsi: 'https://static.wikia.nocookie.net/werewolf-online/images/e/ef/Avenger_Fairy_Tales.png/revision/latest?cb=20230503200804',
  blang: 'https://www.wolvesville.com/static/media/icon_anarchist_filled.f0729c00f750b8a0e4f2.svg',
  dgau: 'https://www.wolvesville.com/static/media/icon_bandit_filled.f57904efc4774eeec349.svg',
  mcr: 'https://static.wikia.nocookie.net/werewolf-online/images/9/9a/Bandit_Halloween_icon.webp/revision/latest?cb=20240101010102&path-prefix=fr',
  spsu: 'https://www.wolvesville.com/static/media/icon_wolf_shaman_filled.92475ab32fdb1da1dded.svg',
  shve: 'https://www.wolvesville.com/static/media/icon_guardian_wolf_filled.eae71fbc3fa823f34617.svg',
  stthuat: 'https://www.wolvesville.com/static/media/icon_voodoo_werewolf_filled.55507f3e2aeea6f05780.svg',
  sdto: 'https://www.wolvesville.com/static/media/icon_toxic_wolf_filled.0ebe6f78eede12ad2d2f.svg',
  shbinh: 'https://www.wolvesville.com/static/media/icon_wolf_pacifist_filled.97ae2918aaaafd5210f8.svg',
  tsnguoi: 'https://www.wolvesville.com/static/media/icon_headhunter_filled.8ddca10eccf8bc99b185.svg',
  snhloat: 'https://www.wolvesville.com/static/media/icon_serial_killer_filled.c147edf428d21b027a29.svg',
  ttac: 'https://www.wolvesville.com/static/media/icon_corruptor_filled.aeab23f48ccdafc9e168.svg',
  ngkim: 'https://www.wolvesville.com/static/media/icon_alchemist_filled.7558c5b995cf04dcbff7.svg',
  mnngu: 'https://www.wolvesville.com/static/media/icon_siren_filled.23983744832a9679f423.svg',
  ttama: 'https://www.wolvesville.com/static/media/icon_evil_detective_filled.1cf2936d73c2000131f9.svg',
  kphoa: 'https://www.wolvesville.com/static/media/icon_arsonist_filled.a1b7f7f34bbbc98314ae.svg',
  hbcon: 'https://www.wolvesville.com/static/media/icon_flower_child_filled.2baaf5b46448690f1374.svg',
  ngdem:  'https://www.wolvesville.com/static/media/icon_night_watchman_filled.c05b807c2175b21d4a62.svg',
  mnu: 'https://www.wolvesville.com/static/media/icon_ghost_lady_filled.55288cd98460f1223690.svg',
  txa: 'https://www.wolvesville.com/static/media/icon_marksman_filled.c7db2c55e0c213757ebb.svg',
  tphan: 'https://www.wolvesville.com/static/media/icon_judge_filled.7753119d26562b9c0c75.svg',
  nptich: 'https://www.wolvesville.com/static/media/icon_analyst_filled.85e6155f6456f0f3f5eb.svg',
  nncam: 'https://www.wolvesville.com/static/media/icon_spirit_seer_filled.5b976e45e07ad3ea5a45.svg',
  cbac: 'https://www.wolvesville.com/static/media/icon_gambler_filled.12cb7a36cc44bd6dacf8.svg',
  py: 'https://www.wolvesville.com/static/media/icon_mortician_filled.7648b71cdb53465c2c5f.svg',
  nsi: 'https://www.wolvesville.com/static/media/icon_violinist_filled.0f7ca9bd3d67c09d7cba.svg',
  nghon: 'https://www.wolvesville.com/static/media/icon_conjuror_filled.ab8656e99e074040bcc7.svg',
  nldo: 'https://www.wolvesville.com/static/media/icon_ferryman_filled.9bad4f063da688ce099f.svg',
  tlbanh: 'https://www.wolvesville.com/static/media/icon_baker_filled.ffdd71f1e2b7b49e4d73.svg',
  tren: 'https://www.wolvesville.com/static/media/icon_forger_filled.d46ae2f72572ea8f00ec.svg',
  sptach: 'https://www.wolvesville.com/static/media/icon_split_wolf_filled.a537646389cb9e07a2f5.svg',
  strang: 'https://static.wikia.nocookie.net/werewolf-online/images/a/a5/Werewolf_Fan_-_Psycho_crime_and_Killer_BP37.png/revision/latest/scale-to-width-down/250?cb=20240823073154'
});

function paintFactionSelect(){
  const sel = $.customRoleFaction;
  if (!sel) return;
  sel.classList.remove('f-village','f-wolf','f-swap','f-third');
  const map = { village:'f-village', wolf:'f-wolf', swap:'f-swap', third:'f-third' };
  const cls = map[sel.value];
  if (cls) sel.classList.add(cls);
}
$.customRoleFaction && $.customRoleFaction.addEventListener('change', paintFactionSelect);

  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
  const load = () => { try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(s) STATE = {...STATE, ...s}; }catch{} };
  const clamp = (n,a,b)=>Math.min(Math.max(n,a),b);
  const pad = n=>String(n).padStart(2,'0');
  const rng = (max)=>{ if(crypto?.getRandomValues){ const arr=new Uint32Array(1); crypto.getRandomValues(arr); return arr[0]/0xffffffff*max; } return Math.random()*max; };
  const shuffle = (arr)=>{ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  // ====== NAMES UI ======
  function renderNames(){
    $.namesWrap.innerHTML = '';
    const n = Number($.playerCount.value||STATE.playerCount);
    while(STATE.names.length < n) STATE.names.push('');
    if(STATE.names.length > n) STATE.names.length = n;

    for(let i=0;i<n;i++){
      const w = document.createElement('div');
      const input = document.createElement('input');
      input.type='text'; input.placeholder = `Người chơi ${i+1}`; input.value = STATE.names[i]||'';
      input.oninput = (e)=>{ STATE.names[i] = e.target.value; save(); };
      w.appendChild(input); $.namesWrap.appendChild(w);
    }
    save();
  }

  $.playerCount.addEventListener('change', ()=>{
    STATE.playerCount = clamp(Number($.playerCount.value||10),3,151);
    $.playerCount.value = STATE.playerCount;
    renderNames(); updateSlotsLeft();
  });

// Xóa các ô tên đang trống (chỉ placeholder, chưa nhập)
$.removeEmptyNames.addEventListener('click', () => {
  const before = STATE.names.slice();
  const keep = before.filter(name => (name || '').trim() !== '');
  const removed = before.length - keep.length;

  if (removed === 0) {
    alert('Không có ô tên trống để xóa.');
    return;
  }

  // Cập nhật state + ô số người chơi
  STATE.names = keep;
  STATE.playerCount = keep.length;
  $.playerCount.value = STATE.playerCount;

  // Sau khi thay đổi số người, reset khu phân vai (tránh lệch)
  STATE.assignments = null;
  STATE.reveal = {};
  if ($.reshuffleBtn) $.reshuffleBtn.disabled = true;
  if ($.revealAllBtn) $.revealAllBtn.disabled = true;
  if ($.copyBtn) $.copyBtn.disabled = true;
  if ($.sortBtn) $.sortBtn.disabled = true;

  renderNames();
  updateSlotsLeft();
  save();
});

  // ====== ROLES UI ======
  function ensureDefaultRoles(){ if(!STATE.roles || Object.keys(STATE.roles).length===0){ STATE.roles = {werewolf:3, seer:1, witch:1, hsi:1, hunter:1, guard:1, cupid:1, spellcaster:1, prince:1}; } }

  function renderRoles(){
  $.rolesList.innerHTML = '';
  ensureDefaultRoles();
  normalizeCustomRoles();

  // Phe của vai mặc định
  // Phe của vai mặc định
const defaultFactionMap = {
  // Ma sói
  werewolf: 'wolf', werecub: 'wolf', minion: 'wolf',
  pssoi: 'wolf', soidc: 'wolf', soituyet: 'wolf', alpha: 'wolf', acmong: 'wolf', scuong: 'wolf', shbinh: 'wolf', sdto: 'wolf', shve: 'wolf', spsu: 'wolf', stthuat: 'wolf', sptach: 'wolf',

  // Dân làng
  seer: 'village', witch: 'village', hunter: 'village',
  guard: 'village', spellcaster: 'village',
  prince: 'village', elder: 'village', 'tough guy': 'village',
  mayor: 'village', village: 'village', hbi: 'village',
  dbom: 'village', tvan: 'village', lgac: 'village', gsu: 'village',
  tsu: 'village', hquang: 'village', nbenh: 'village', cma: 'village',
  hbinh: 'village', ttu: 'village', hsi: 'village', blang: 'village',
  cbac: 'village', hbcon: 'village', mnu: 'village', nsi: 'village', ngdem: 'village', nghon: 'village', nldo: 'village', nncam: 'village', nptich: 'village', py: 'village', tphan: 'village', txa: 'village', tlbanh: 'village', tren: 'village', bsi: 'village',

  // Đổi phe
  doppelganger: 'swap', cursed: 'swap', cupid: 'swap',

  // Phe thứ 3
  tanner: 'third', gchu: 'third', dgau: 'third', mcr: 'third', ttac: 'third', kphoa: 'third', snhloat: 'third', tsnguoi: 'third', ngkim: 'third', mnngu: 'third', ttama: 'third', strang: 'third'
};

  // Gom nhóm theo phe (gồm cả mặc định & tùy chỉnh)
  const groups = { wolf: [], village: [], swap: [], third: [] };

  DEFAULT_ROLES.forEach(r => {
    const f = defaultFactionMap[r.key] || 'third';
    groups[f].push({ type: 'default', role: r });
  });

  Object.entries(STATE.customRoles || {}).forEach(([name, obj]) => {
    const faction = (obj && obj.faction) || 'third';
    groups[faction].push({ type: 'custom', name, obj });
  });

  // Sắp xếp ABC theo tên (bỏ emoji, bỏ dấu)
  const collator = new Intl.Collator('vi', { sensitivity: 'base', numeric: true });
  const clean = s => String(s)
    .replace(/^[^\p{L}\p{N}]+/u, '')               // bỏ emoji/ký tự đầu
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // bỏ dấu
    .toLowerCase();

  const sortGroup = arr => arr.sort((a,b)=>{
    const an = a.type==='default' ? a.role.name : a.name;
    const bn = b.type==='default' ? b.role.name : b.name;
    return collator.compare(clean(an), clean(bn));
  });

  sortGroup(groups.wolf);
  sortGroup(groups.village);
  sortGroup(groups.swap);
  sortGroup(groups.third);

  // Helpers tạo dòng
  const addSep = (label)=>{
    const sep = document.createElement('div');
    sep.className = 'sep';
    sep.textContent = `--------------------- ${label} ---------------------`;
    $.rolesList.appendChild(sep);
  };

  // --- THAY THẾ HÀM NÀY BÊN TRONG renderRoles() ---
const makeRowDefault = (role) => {
  const row = document.createElement('div'); row.className = 'item';

  // Cột 1: tên
  const name = document.createElement('div');
  const labelText  = stripLeadingEmoji(role.name); // "Giáo chủ"
const leadingEmoji = role.name.match(/^[^\p{L}\p{N}]+/u)?.[0] || ''; // "🦹"
const iconHTML   = roleIconHTMLByKey(role.key, leadingEmoji, labelText);

name.innerHTML = `<span class="pill" style="border-color:${role.color||'#334'}">
  <svg width="8" height="8"><circle cx="4" cy="4" r="4" fill="${role.color||'#888'}"/></svg>
  ${iconHTML}${esc(labelText)}
</span>`;

  // Cột 2: nút "Hiện" (mở modal – title có Hào quang/Chức năng từ ROLE_META)
  const hint = document.createElement('div');
  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn ghost';
  viewBtn.textContent = 'Hiện';
  viewBtn.addEventListener('click', () => {
    modal.open(role.name, role.hint || '', { key: role.key });
  });
  hint.appendChild(viewBtn);

  // Cột 3: số lượng (giữ logic Chán đời/Hòa bình y như cũ)
  const count = document.createElement('input');
  count.type = 'number'; count.min = '0';
  const isTanner = role.key === 'tanner';
  const isPeace  = role.key === 'hbinh';
  const isPrince = role.key === 'prince';
  const isKnight = role.key === 'hsi'; 
  if (isTanner || isPeace) count.max = '1';
  count.value = STATE.roles[role.key] || 0;
  
  count.addEventListener('change', () => {
    const prev = Number(STATE.roles[role.key] || 0);
    const v = Math.min(Math.max(Number(count.value||0), 0), (isTanner||isPeace)?1:40);
    STATE.roles[role.key] = v;
    count.value = v;

    if (isTanner && prev === 0 && v === 1) {
      const peaceNow = Number(STATE.roles['hbinh'] || 0);
      if (peaceNow === 0) {
        STATE.roles['hbinh'] = 1;
        alert('Chức năng "🤝 Người Yêu Hòa Bình" được thêm vào vì đi chung với "😓 Thằng Ngố".');
        renderRoles(); updateSlotsLeft(); save(); return;
      }
    }
    if (isPeace && prev > 0 && v === 0) {
      const tannerNow = Number(STATE.roles['tanner'] || 0);
      if (tannerNow > 0) {
        STATE.roles['tanner'] = 0;
        alert('Vai trò "😓 Thằng Ngố" được bỏ ra vì đi chung với "🤝 Người Yêu Hòa Bình"');
        renderRoles(); updateSlotsLeft(); save(); return;
      }
    }
 // 👑 Công Chúa tăng từ 0 -> >0 mà Hiệp Sĩ = 0 --> tự thêm Hiệp Sĩ = 1
if (isPrince && prev === 0 && v > 0) {
  const knightNow = Number(STATE.roles['hsi'] || 0);
  if (knightNow === 0) {
    STATE.roles['hsi'] = 1;
    alert('Vai trò "💂‍♂ Hiệp Sĩ" được thêm vào vì đi chung với "👑 Công Chúa"');
    renderRoles(); updateSlotsLeft(); save(); return;
  }
}

// 💂‍♂ Hiệp Sĩ giảm về 0 --> tự giảm Công Chúa về 0
if (isKnight && prev > 0 && v === 0) {
  const princeNow = Number(STATE.roles['prince'] || 0);
  if (princeNow > 0) {
    STATE.roles['prince'] = 0;
    alert('Vai trò "👑 Công Chúa" được bỏ ra vì đi chung với "💂‍♂ Hiệp Sĩ"');
    renderRoles(); updateSlotsLeft(); save(); return;
  }
}
    updateSlotsLeft(); save();
  });
  
  // Cột 4: trống
  const del = document.createElement('div');

  $.rolesList.appendChild(row);
  row.append(name, hint, count, del);
};

  const colorMap = { village:'#3b82f6', wolf:'#ef4444', swap:'#10b981', third:'#eab308' };
  const factionLabel = { village:'Dân làng', wolf:'Ma sói', swap:'Đổi phe', third:'Phe thứ 3' };

  const makeRowCustom = (name, obj) => {
  const { count: countVal = 0, faction = 'third' } = obj || {};
  const row = document.createElement('div'); row.className = 'item';

  const colorMap = { village:'#3b82f6', wolf:'#ef4444', swap:'#10b981', third:'#eab308' };

  const nameDiv = document.createElement('div');
  nameDiv.innerHTML = `<span class="pill" style="border-color:${colorMap[faction]}">
    <svg width="8" height="8"><circle cx="4" cy="4" r="4" fill="${colorMap[faction]}"/></svg>
    🧩 ${escapeHtml(name)}
  </span>`;

  const hint = document.createElement('div');
  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn ghost';
  viewBtn.textContent = 'Hiện';
  viewBtn.addEventListener('click', () => {
    modal.open(`🧩 ${name}`, 'Chức năng và điệu kiện thắng của vai trò tùy chỉnh do Quản trò và tất cả người chơi thống nhất đưa ra.', { custom: true });
  });
  hint.appendChild(viewBtn);

  const count = document.createElement('input');
  count.type = 'number'; count.min = '0'; count.value = countVal;
  count.addEventListener('change', () => {
    normalizeCustomRoles();
    const v = clamp(Number(count.value||0), 0, 40);
    STATE.customRoles[name] = { count: v, faction };
    if (v === 0) delete STATE.customRoles[name];
    renderRoles(); updateSlotsLeft(); save();
  });

  const del = document.createElement('div');
  const delBtn = document.createElement('button');
  delBtn.className = 'btn danger'; delBtn.textContent = 'Xoá';
  delBtn.onclick = () => {
    delete STATE.customRoles[name];
    renderRoles(); updateSlotsLeft(); save();
  };
  del.appendChild(delBtn);

  $.rolesList.appendChild(row);
  row.append(nameDiv, hint, count, del);
};

  // In theo thứ tự phe: Ma sói -> Dân làng -> Đổi phe -> Phe thứ 3
  [
    {key:'wolf',    label:'Ma sói'},
    {key:'village', label:'Dân làng'},
    {key:'swap',    label:'Đổi phe'},
    {key:'third',   label:'Phe thứ 3'}
  ].forEach(sec=>{
    const arr = groups[sec.key];
    if(!arr.length) return;
    addSep(sec.label);
    arr.forEach(it => it.type==='default' ? makeRowDefault(it.role)
                                          : makeRowCustom(it.name, it.obj));
  });

  updateSlotsLeft();
}


  function updateSlotsLeft(){
    const totalPlayers = Number($.playerCount.value||STATE.playerCount);
    const totalSelected = totalRolesSelected();
    const left = totalPlayers - totalSelected;
    $.slotsLeft.textContent = left;
    $.slotsLeft.style.color = left < 0 ? 'salmon' : '#c7ffee';
const totalEl = document.getElementById('rolesTotal');
  if (totalEl) totalEl.textContent = totalSelected;
  }

  function totalRolesSelected(){
  const base = Object.values(STATE.roles||{}).reduce((a,b)=>a+Number(b||0),0);
  const custom = Object.values(STATE.customRoles||{}).reduce((a,v)=>a+Number((v&&v.count)||0),0);
  return base + custom;
}


  $.addCustomRole.addEventListener('click', ()=>{
  const name = ($.customRoleName.value||'').trim();
  const count = clamp(Number($.customRoleCount.value||1),1,40);
  const faction = $.customRoleFaction?.value || '';

  if (!name)   return alert('Vui lòng nhập tên vai trò tuỳ chỉnh!');
  if (!faction) return alert('Vui lòng lựa chọn phe cho vai trò này!');

  // đảm bảo cấu trúc {name:{count,faction}}
  normalizeCustomRoles();
  const cur = STATE.customRoles[name] || {count:0, faction};
  const newCount = (cur.count||0) + count;

  STATE.customRoles[name] = { count: newCount, faction };  // lưu phe
  $.customRoleName.value = '';
  $.customRoleCount.value = '1';
  if ($.customRoleFaction){ $.customRoleFaction.value = ''; paintFactionSelect(); }

  renderRoles(); updateSlotsLeft(); save();
});

  $.resetRoles.addEventListener('click', ()=>{ STATE.roles = {werewolf:3, seer:1, hsi:1, witch:1, hunter:1, guard:1, cupid:1, spellcaster:1, prince:1}; STATE.customRoles = {}; renderRoles(); save(); });

  // ====== ASSIGNMENT ======
  $.assignBtn.addEventListener('click', ()=>{
    const n = Number($.playerCount.value||10);
    const names = STATE.names.slice(0,n).map((x,i)=> (x||'').trim() || `Người chơi ${i+1}`);

    const parts = [];
    const addMany = (label,count)=>{ for(let i=0;i<count;i++) parts.push(label); };
    const roleNameFromKey = k => (DEFAULT_ROLES.find(r=>r.key===k)?.name) || k;

    Object.entries(STATE.roles||{}).forEach(([k,c])=> addMany(roleNameFromKey(k), Number(c||0)));
    Object.entries(STATE.customRoles||{}).forEach(([name,obj])=>{
  const c = Number((obj && obj.count) || 0);
  addMany(name, c);
});


    if(parts.length > n){ return alert(`Tổng số vai trò(${parts.length}) vượt quá số người (${n}). Hãy giảm bớt vai trò hoặc tăng số lượng người chơi.`); }

    // 🔒 CHỐT 1: lấp ô trống bằng Dân làng
  while (parts.length < n) parts.push('👨🏻‍🌾 Dân Làng');

  const rolesShuffled = shuffle(parts);

  // 🔒 CHỐT 2: đảm bảo sau shuffle vẫn đủ n phần tử
  while (rolesShuffled.length < n) rolesShuffled.push('👨🏻‍🌾 Dân Làng');
    STATE.assignments = names.map((name, idx)=> ({ name, role: rolesShuffled[idx] }));
    STATE.reveal = {};
    STATE.dead = {};
    STATE.alphaCanInfect = false;
    STATE.alphaUsedOrLost = false;
    /* 👥 Nhân bản */
    STATE.doppelTargets = {};         // reset target khi bắt đầu ván mới
    STATE.firstKillPromptShown = false; // cờ nhắc “lần giết đầu” cho ván mới
    STATE.apprenticePromoted = false;  // reset thăng cấp của Tập sự

    renderAssignments();
    $.reshuffleBtn.disabled = false; $.revealAllBtn.disabled=false; $.copyBtn.disabled=false; $.sortBtn.disabled=false;
    save();
  });

  // 🧹 Gỡ toàn bộ: đưa TẤT CẢ vai (mặc định + tùy chỉnh) về 0
$.reshuffleBtn.addEventListener('click', () => {
  if (!confirm('Gỡ toàn bộ số lượng của các vai trò đã thiết lập hiện tại về 0? (Không ảnh hưởng đến 📃 Danh sách phân vai trò hiện tại)')) return;

  // Chuẩn hoá để custom có {count, faction}
  normalizeCustomRoles();

  // Đưa tất cả vai mặc định về 0
  if (!STATE.roles) STATE.roles = {};
  Object.keys(STATE.roles).forEach(k => { STATE.roles[k] = 0; });

  // Đưa tất cả vai tuỳ chỉnh về 0 (giữ lại dòng trong bảng để tiện tăng lại)
  if (!STATE.customRoles) STATE.customRoles = {};
  Object.keys(STATE.customRoles).forEach(name => {
    const v = STATE.customRoles[name];
    if (typeof v === 'number') {
      STATE.customRoles[name] = { count: 0, faction: 'third' };
    } else {
      STATE.customRoles[name].count = 0;
    }
  });

  renderRoles();       // vẽ lại bảng vai
  updateSlotsLeft();   // cập nhật “Trống/Tổng”
  save();
});

  $.revealAllBtn.addEventListener('click', ()=>{
    const anyHidden = Object.values(STATE.reveal||{}).some(v=>!v);
    STATE.assignments.forEach((_,i)=> STATE.reveal[i] = anyHidden );
    renderAssignments(); save();
  });

  $.copyBtn.addEventListener('click', async ()=>{
    if(!STATE.assignments) return;
    const lines = STATE.assignments
  .map((x,i)=> `${i+1}. ${x.name} — ${displayRole(x.role)}`)
  .join('\n');

    try{ await navigator.clipboard.writeText(lines); alert('Đã sao chép danh sách vai trò vào clipboard!'); }
    catch{ alert('Không thể sao chép, hãy chọn thủ công.'); }
  });

  // ====== SORT & HIGHLIGHT ======
  function _ascii(s){
    return String(s).toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }
  function _roleKey(role){
    return String(role).replace(/^[^\p{L}\p{N}]+/u,'').trim().toLowerCase();
  }
  function factionOf(role){
    const t = _ascii(role);
// ƯU TIÊN: custom role có lưu phe
  const cr = STATE.customRoles && STATE.customRoles[role];
  if (cr && cr.faction) {
    const f = cr.faction;
    if (f==='wolf')    return {order:0, cls:'f-wolf'};
    if (f==='village') return {order:1, cls:'f-vil'};
    if (f==='swap')    return {order:2, cls:'f-swap'};
    return {order:3, cls:'f-third'};
  }
    // Phe Sói
    if (t.includes('soi con') || t.includes('ke phan boi') || t.includes('ma soi')|| t.includes('soi phu thuy')|| t.includes('soi đau đan')|| t.includes('soi tuyet')|| t.includes('soi meo con')|| t.includes('soi ac mong')|| t.includes('soi đien cuong')|| t.includes('soi phap su')|| t.includes('soi ho ve')|| t.includes('soi ta thuat')|| t.includes('soi hoa binh')|| t.includes('soi đoc to')|| t.includes('soi phan tach'))
      return {order:0, cls:'f-wolf'};
    // Phe Dân
    if (t.includes('tien tri')||t.includes('phu thuy')||
        t.includes('tho san quai thu')||t.includes('bao ve')||t.includes('ba gia kho tinh')||
        t.includes('dan lang')||t.includes('cong chua')||t.includes('gia lang')||
        t.includes('luc si')||t.includes('thi truong')||t.includes('thay boi')||
        t.includes('ke đanh bom')||t.includes('nha thien van hoc')||t.includes('nguoi canh gac')||
        t.includes('tham tu')||t.includes('tien tri tap su')||t.includes('tien tri hao quang')||t.includes('nguoi benh')||t.includes('ke pha roi')||
        t.includes('con ma')||t.includes('nguoi yeu hoa binh')||t.includes('hiep si')||t.includes('canh sat truong')||t.includes('nghe si vi cam')||t.includes('nguoi lai đo')||t.includes('hoa be con')||t.includes('nguoi gac đem')||t.includes('ma nu')||t.includes('thien xa')||t.includes('tham phan')||t.includes('nha phan tich')||t.includes('nha ngoai cam')||t.includes('con bac')||t.includes('phap y')||t.includes('nguoi goi hon')||t.includes('tho lam banh')||t.includes('tho ren')||t.includes('bac si'))
      return {order:1, cls:'f-vil'};
    // Phe đổi phe
    if (t.includes('than tinh yeu')||t.includes('nhan ban')||t.includes('ban soi'))
      return {order:2, cls:'f-swap'};
    // Phe thứ ba / khác
    if (t.includes('thang ngo')||t.includes('giao chu')||t.includes('du con')||t.includes('ma ca rong')||t.includes('soi trang')||t.includes('nha gia kim')||t.includes('nhan ngu')||t.includes('tham tu ac ma')||t.includes('tin tac')||t.includes('tho san nguoi')||t.includes('sat nhan')||t.includes('ke phong hoa'))
      return {order:3, cls:'f-third'};
    return {order:3, cls:'f-third'};
  }

  function sortAssignmentsByFactionThenRole(){
  if (!STATE.assignments || STATE.assignments.length === 0) return;

  // Giữ trạng thái "đã hiện" theo TÊN trước khi sắp xếp
  const revealByName = {};
  STATE.assignments.forEach((x, i) => {
    revealByName[x.name] = !!STATE.reveal[i];
  });

  // Map đánh dấu chết theo tên (đã set ở STATE.dead)
  const deadByName = { ...(STATE.dead || {}) };

  STATE.assignments.sort((a, b) => {
    // 1) Alive trước, Dead sau
    const aDead = !!deadByName[a.name];
    const bDead = !!deadByName[b.name];
    if (aDead !== bDead) return aDead ? 1 : -1;

    // 2) Sắp theo phe
    const fa = factionOf(a.role);
    const fb = factionOf(b.role);
    if (fa.order !== fb.order) return fa.order - fb.order;

    // 3) Cùng phe thì sắp theo alphabet của tên vai trò
    const ra = _roleKey(a.role);
    const rb = _roleKey(b.role);
    return ra.localeCompare(rb, 'vi');
  });

  // Khôi phục trạng thái "đã hiện" theo vị trí mới
  STATE.reveal = {};
  STATE.assignments.forEach((x, i) => {
    STATE.reveal[i] = !!revealByName[x.name];
  });

  renderAssignments();
  save();
}

function toggleDeadByName(name){
  const player = (STATE.assignments || []).find(p => p.name === name);
  const role = String(player?.role || '');
  const ascii = s => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  // 👻 Con ma: luôn bị loại & không thể cứu
  if (player && ascii(role).includes('con ma')) {
    STATE.dead = STATE.dead || {};
    STATE.dead[name] = true;
    renderAssignments(); save();
    alert('Vai trò "Con ma" luôn ở trạng thái BỊ LOẠI và không thể Cứu.');
    return;
  }

  STATE.dead = STATE.dead || {};
  const wasDead = !!STATE.dead[name];
  STATE.dead[name] = !wasDead;
  const justDied = (!wasDead && STATE.dead[name]);

  renderAssignments(); save();

  // === Nhánh VỪA CHẾT ===
  if (justDied) {
    // 👥 Nhân bản: chuyển vai nếu target vừa chết
    applyDoppelTransferForTarget(name, role);

    const low = ascii(role);
    const includesAny = (s, arr) => arr.some(k => s.includes(k));
    const isWolfCub   = includesAny(low, ['soi con']);
    const isWolfBoss  = includesAny(low, ['soi dau dan','soi đau đan']);
    const isAlpha     = includesAny(low, ['soi meo con']);
    const isMinion    = includesAny(low, ['ke phan boi']);
    const is_pssoi    = includesAny(low, ['soi phu thuy']);
    const isSnowWolf  = includesAny(low, ['soi tuyet']);
    const isWolfSide  = (factionOf(role)?.cls === 'f-wolf');

    const is_dbom     = includesAny(low, ['ke danh bom','ke đanh bom']);
    const isHunter    = includesAny(low, ['tho san quai thu']);

    if (isWolfCub)  alert('Vai trò "🐺 Sói Con" đã chết, hãy thông báo cho Bầy Sói được giết 2 người vào đêm hiện tại/tiếp theo.');
    if (isWolfBoss) alert('Vai trò "☠️ Sói Đầu Đàn" đã chết, hãy thông báo cho Bầy Sói chỉ còn có thể giết 1 người mỗi đêm vào đêm tiếp theo.');
    if (isSnowWolf) alert('Vai trò "❄️ Sói Tuyết" đã chết, cũng hãy làm cho bạn đồng hành của "❄️ Sói Tuyết" chết theo.');
    if (is_dbom)    alert('Vai trò "💣️ Kẻ Đánh Bom" đã chết, cũng hãy làm cho 2 người bên cạnh "💣️ Kẻ Đánh Bom" chết theo (không tính những người đã chết trước đó).');
    if (isHunter)   alert('Vai trò "🏹 Thợ săn" đã chết, nếu:\n\nBan ngày: Hãy thông báo cho "🏹 Thợ Săn" nhắm bắn ngay lập tức.\nBan đêm: Hãy làm cho người mà "🏹 Thợ Săn" đã nhắm bắn chết theo.');

    // Nếu chính 🐱 Sói Mèo Con chết -> tắt vĩnh viễn quyền hóa sói
    if (isAlpha) {
      STATE.alphaCanInfect = false;
      STATE.alphaUsedOrLost = true;
      save();
    }
    

    // “Nạp” quyền cho 🐱 Sói Mèo Con nếu MỘT SÓI (không phải Alpha/Kẻ Phản bội/Sói Phù Thủy) chết BAN NGÀY
    const alphaArmed = !!STATE.alphaCanInfect;
const alphaAlive = hasAliveAlpha();

if (alphaAlive && isWolfSide && !isAlpha && !alphaArmed && !STATE.alphaUsedOrLost && !isMinion && !is_pssoi) {
  const ok = confirm('Có phải thành viên phe 🐺 Ma Sói vừa chết do bị Treo cổ hay không?\n\nChọn "OK" = Phải (bị Treo Cổ)\nChọn "Cancel" = Không phải (lý do khác)');
  if (ok) {
    STATE.alphaCanInfect = true;
    save();
    alert('Hãy thông báo cho "🐱 Sói Mèo Con" được phép hóa sói 1 nạn nhân vào đêm tiếp theo.');
  }
} else if (!alphaAlive && STATE.alphaCanInfect) {
  // Không có Alpha trong ván (hoặc Alpha đã chết) -> vô hiệu quyền còn treo
  STATE.alphaCanInfect = false;
  save();
}
// ✅ Công Chúa vừa CHẾT → Hiệp Sĩ (còn sống) chết theo (kèm tên)
if (includesAny(low, ['cong chua'])) {
  const list = STATE.assignments || [];
  const livingKnights = list.filter(p => {
    const alive = !(STATE.dead && STATE.dead[p.name]);
    return alive && ascii(p.role).includes('hiep si');
  });

  if (livingKnights.length) {
    STATE.dead = STATE.dead || {};
    const killedKnights = [];

    livingKnights.forEach(kn => {
      STATE.dead[kn.name] = true;
      applyDoppelTransferForTarget(kn.name, kn.role);
      killedKnights.push(kn.name);
    });

    renderAssignments();
    save();

    if (killedKnights.length === 1) {
      alert(`Vì không thể bảo vệ được "👑 Công Chúa" nên "${killedKnights[0]}" (💂‍♂ Hiệp Sĩ) đã treo cổ tự vẫn`);
    } else {
      const listStr = killedKnights.map(n => `• "${n}" (💂‍♂ Hiệp Sĩ)`).join('\n');
      alert(`Vì không thể bảo vệ được Công Chúa nên các Hiệp Sĩ sau đã treo cổ tự vẫn:\n${listStr}`);
    }
  }
}

    return; // kết thúc nhánh vừa chết
  }

  // === Nhánh ĐƯỢC CỨU (từ chết -> sống) ===
  if (wasDead && !STATE.dead[name]) {
    const low = ascii(role);
    // 💪 Lực Sĩ: nếu từng đánh dấu "chết trễ", khi cứu thì bỏ cờ
    if (low.includes('luc si')) {
      if (STATE.toughGuyPending) delete STATE.toughGuyPending[name];
    }
  }
}

function displayRole(role) {
  // Nếu là vai trò tùy chỉnh (tên tồn tại trong STATE.customRoles) thì thêm 🧩
  if (STATE.customRoles && Object.prototype.hasOwnProperty.call(STATE.customRoles, role)) {
    return `🧩 ${role}`;
  }
  return role; // vai trò mặc định đã có emoji sẵn (🐺, 🔮, …)
}
// Khi một người 'target' chết, mọi 👥 Nhân bản đang "khóa mục tiêu" này sẽ nhận vai của target
function applyDoppelTransferForTarget(deadName, deadRole){
  const map = STATE.doppelTargets || {};
  const recipients = Object.keys(map).filter(holderName => map[holderName] === deadName);
  if (!recipients.length) return;

  const targetIndex = (STATE.assignments || []).findIndex(p => p.name === deadName);
  const tag = targetIndex >= 0 ? String(targetIndex+1).padStart(2,'0') : '??';
  const roleShown = displayRole(deadRole);

  recipients.forEach(holderName => {
    // Nếu Nhân bản đang sống -> nhận vai
    const idx = (STATE.assignments || []).findIndex(p => p.name === holderName);
    if (idx === -1) return;
    const alive = !(STATE.dead && STATE.dead[holderName]);
    if (!alive) return;

    STATE.assignments[idx].role = deadRole;     // đổi vai
    delete STATE.doppelTargets[holderName];     // xoá mục tiêu (hết là Nhân bản)
    alert(`Người chơi ${tag} đã chết, vai trò "${roleShown}" hiện tại sẽ được chuyển qua cho "${holderName}".`);
  });

  renderAssignments();
  save();
}
// Trả về danh sách NHÂN BẢN còn sống nhưng CHƯA khóa mục tiêu
function getAliveDoppelsMissingTargets(){
  const ascii = s => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  const alive = (STATE.assignments || []).filter(p => !(STATE.dead && STATE.dead[p.name]));
  const holders = alive.filter(p => ascii(p.role).includes('nhan ban'));
  const targets = STATE.doppelTargets || {};
  return holders.filter(p => !targets[p.name]).map(p => p.name);
}

// Dễ dùng trong handler: true = OK để giết, false = chặn & cảnh báo
function ensureDoppelPickBeforeKill(){
  const missing = getAliveDoppelsMissingTargets();
  if (missing.length){
    alert('Chưa chọn mục tiêu cho vai trò "👥 Nhân Bản". Hãy bấm nút 🎯👥 để chọn mục tiêu cho vai trò "👥 Nhân Bản" trước khi giết ai đó.');
    return false;
  }
  return true;
}
  function renderAssignments(){
  if(!STATE.assignments){ $.assignments.innerHTML=''; return; }

  const rows = STATE.assignments.map((x,i)=>{
  const toAscii = s => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  const revealed = !!STATE.reveal[i];
  const fac = factionOf(x.role);

  const rawRole = String(x.role || '');
  const isGhost = toAscii(rawRole).includes('con ma');  // 👻 Con ma?

  // Ép "Con ma" luôn chết
  if (isGhost) {
    STATE.dead = STATE.dead || {};
    STATE.dead[x.name] = true;
  }

  const isDead = isGhost ? true : !!(STATE.dead && STATE.dead[x.name]);
  const safeNameAttr = String(x.name).replace(/"/g,'&quot;'); // attr-safe
  const viewRole = displayRole(x.role);
  const roleCell = revealed ? renderRoleLabelHTML(viewRole) : '&nbsp;';

    const isDoppel = toAscii(rawRole).includes('nhan ban');  // 👥 Nhân bản?

  const killBtn = isGhost
    ? `<button class="btn" disabled title="Vai trò 'Con ma' luôn ở trạng thái BỊ LOẠI.">—</button>`
    : `<button class="btn ${isDead ? '' : 'danger'}" data-kill="${i}">
         ${isDead ? 'Cứu' : 'Giết'}
       </button>`;

  // Nút 🎯 chỉ hiện khi là Nhân bản và còn sống
  const targetBtn = (isDoppel && !isDead)
    ? `<button class="btn" title="Chọn mục tiêu để sao chép" data-doppel="${i}">🎯👥</button>`
    : '';

  const actionBtnHtml = `${targetBtn}${killBtn}`;

  return `<tr class="${revealed? 'revealed':''} ${fac.cls} ${isDead?'dead':''}"
               data-name="${safeNameAttr}">
    <td>${i+1}</td>
    <td class="name-cell">
      <div class="name-wrap">
        <span class="player-name">${escapeHtml(x.name)}</span>
        ${isDead ? '<span class="eliminated">– BỊ LOẠI</span>' : ''}
      </div>
    </td>
    <td class="role ${revealed? '':'hidden'}">${roleCell}</td>
    <td class="no-print">
      ${actionBtnHtml}
    </td>
  </tr>`;
}).join('');

  $.assignments.innerHTML = `
  <div class="section-title">
    <h2>📃 Danh sách phân vai trò</h2>
    <div class="chip">Tổng: <b>${STATE.assignments.length}</b></div>
  </div>
  <div class="table-wrap">
    <table aria-label="Danh sách phân vai trò">
      <thead>
        <tr><th>#</th><th>Tên người chơi</th><th>Vai trò</th>
        <th class="no-print">Giết</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;

  // Bấm nút Giết/Hồi sinh (toggle "đã chết")
qsa('[data-kill]', $.assignments).forEach(btn => {
  btn.addEventListener('click', (e) => {
    const i = Number(e.currentTarget.getAttribute('data-kill'));
    const player = STATE.assignments?.[i];
    if (!player) return;

    const name = player.name;
    const role = String(player.role || '');
    const isDead = !!(STATE.dead && STATE.dead[name]);
    // Chỉ chặn khi đang cố "Giết" (người đó còn sống)
// (Con ma đã disable nút nên không vào đây)
if (!isDead){
  if (!ensureDoppelPickBeforeKill()) return; // ⛔️ chặn lượt Giết
}

    // Bỏ dấu để so khớp robust (đời/đợi đều khớp)
    const ascii = (s) => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g,'d').replace(/Đ/g,'D').toLowerCase();
    // 🔔 Nhắc 1 lần ở lần "Giết" đầu tiên nếu có 👥 Nhân bản chưa chọn mục tiêu
if (!isDead && !STATE.firstKillPromptShown) {
  const ascii = s => String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  const alive = (STATE.assignments || []).filter(p => !(STATE.dead && STATE.dead[p.name]));
  const hasDoppel = alive.some(p => ascii(p.role).includes('nhan ban'));
  if (hasDoppel) {
    const needPick = alive.filter(p => ascii(p.role).includes('nhan ban') && !(STATE.doppelTargets || {})[p.name]);
    if (needPick.length > 0) {
      STATE.firstKillPromptShown = true;  // chỉ nhắc 1 lần trong ván
      save();
      alert('Chưa chọn mục tiêu cho vai trò "👥 Nhân bản". Hãy bấm nút 🎯👥 để chọn mục tiêu cho vai trò "👥 Nhân bản" trước khi giết ai đó.');
    }
  }
}
    // --- Ngoại lệ 1: 🌑 Bán Sói ---
    if (!isDead && ascii(role).includes('ban soi')) {
      const ok = confirm('Có phải vai trò "🌑 Bán Sói" bị phe 🐺 Ma Sói cắn hay không?\n\nChọn "OK" = Phải (bị Ma Sói cắn)\nChọn "Cancel" = Không phải (lý do khác)');
      if (ok) {
        // Hóa Ma sói: đổi vai, không bị loại, và "Hiện" vai
        player.role = '🐺 Ma Sói';
        if (STATE.dead) delete STATE.dead[name];
        STATE.reveal[i] = true;

        renderAssignments();
        save();
        alert(`"${name}" đã bị hóa thành 🐺 Ma Sói!`);
        return; // KHÔNG toggleDead
      }
      // Cancel -> rơi xuống xử lý Bị loại bình thường
    }

    // --- Ngoại lệ 2: 😓 Thằng Ngố ---
    // Yêu cầu mới: hỏi "Có phải ... bị Treo cổ hay không?"
    if (!isDead && ascii(role).includes('thang ngo')) {
      const ok = confirm('Có phải vai trò "😓 Thằng Ngố" bị Treo cổ hay không?\n\nChọn "OK" = Phải (bị Treo cổ)\nChọn "Cancel" = Không phải (lý do khác)');
      if (ok) {
        // Treo cổ -> Chán đời THẮNG và Game kết thúc (đánh dấu chết + hiện vai + thông báo)
        STATE.dead = STATE.dead || {};
        STATE.dead[name] = true;
        STATE.reveal[i] = true;

        renderAssignments();
        save();
        alert(`🎉 GAME KẾT THÚC 🎉\n"${name}" là (😓 Thằng Ngố) chiến thắng do bị Treo cổ!`);
        return;
      } else {
        // Không phải treo cổ -> bị loại bình thường
        toggleDeadByName(name);
        return;
      }
    }
   
   // --- Ngoại lệ 3: 👴 Già Làng ---
    if (!isDead && ascii(role).includes('gia lang')) {
      const ok = confirm('Có phải vai trò "👴 Già Làng" đã chết cả 2 mạng không?\n\nChọn "OK" = Phải (đã chết cả 2 mạng)\nChọn "Cancel" = Không phải (chưa chết cả 2 mạng)');
      if (ok) {
        STATE.dead = STATE.dead || {};
        STATE.dead[name] = true;
        renderAssignments();
        save();
        // Auto sắp xếp giống hành vi "Giết"
        alert('Vai trò "👴 Già Làng" đã chết, vào đêm tiếp theo, hãy thông báo cho phe 👨🏻‍🌾 Dân Làng không thể sử dụng chức năng vào đêm hiện tại.');
      }
      // Dù OK hay Cancel đều kết thúc tại đây (Cancel = giữ nguyên, OK = đã set chết)
      return;
    }
// --- Ngoại lệ 4: 👑 Công Chúa ---
if (!isDead && ascii(role).includes('cong chua')) {
  const ok = confirm(
    'Có phải vai trò "👑 Công Chúa" bị Treo cổ hay không?\n\n' +
    'Chọn "OK" = Phải (bị Treo cổ)\n' +
    'Chọn "Cancel" = Không phải (lý do khác)'
  );

  if (ok) {
    // Treo cổ -> lật bài, KHÔNG bị loại
    STATE.reveal[i] = true;
    if (STATE.dead) delete STATE.dead[name];
    renderAssignments();
    save();
    alert('Hãy thông báo cho Mọi người: Người chơi "' + name + '" là (👑 Công Chúa). Treo cổ THẤT BẠI và đêm tiếp theo bắt đầu.');
    return;
  } else {
    // ❗️Không phải treo cổ -> ưu tiên xử lý "hóa sói" nếu đang có quyền
    if (STATE.alphaCanInfect) {
      if (!hasAliveAlpha()) {
        // Alpha không còn sống -> tắt quyền còn treo, KHÔNG hỏi gì thêm
        STATE.alphaCanInfect = false;
        save();
      } else {
        const low = ascii(role);
        const isWolfSideTarget = (factionOf(role)?.cls === 'f-wolf');
        const isVampire   = low.includes('ma ca rong'); // 🧛 Ma Cà Rồng
        const isWolfMage  = low.includes('soi phu thuy'); // ☄️ Sói Phù Thủy

        // ☄️ Sói Phù Thủy: vẫn hỏi có bị sói cắn (đặc biệt), nếu có -> hóa sói thất bại và MẤT quyền
        if (isWolfMage) {
          const bitten = confirm(
            'Có phải vai trò "☄️ Sói Phù Thủy" vừa bị 🐺 Ma Sói cắn hay không?\n\n' +
            'Chọn "OK" = Phải (bị Ma Sói cắn)\n' +
            'Chọn "Cancel" = Không phải (lý do khác)'
          );
          if (bitten) {
            alert('Chức năng hóa sói của "🐱 Sói Mèo Con" THẤT BẠI, hãy thông báo cho "🐱 Sói Mèo Con" đã mất chức năng hóa sói.');
            STATE.alphaCanInfect = false;
            STATE.alphaUsedOrLost = true;
            save();
            return; // không giết ở đây
          }
          // Không phải do sói cắn -> rơi xuống "giết thường"
        } else if (!isWolfSideTarget) {
          // Mục tiêu KHÔNG thuộc phe Sói
          if (isVampire) {
            // 🧛 Ma Cà Rồng: hóa sói thất bại và MẤT quyền
            alert('Chức năng hóa sói của "🐱 Sói Mèo Con" THẤT BẠI, hãy thông báo cho "🐱 Sói Mèo Con" đã mất chức năng hóa sói.');
            STATE.alphaCanInfect = false;
            STATE.alphaUsedOrLost = true;
            save();
            // vẫn rơi xuống xử lý "giết thường" ở dưới
          } else {
            // Hỏi có phải bị sói cắn không?
            const bitten = confirm(
              `Có phải vai trò "${role}" vừa bị 🐺 Ma Sói cắn hay không?\n\n` +
              'Chọn "OK" = Phải (bị Ma Sói cắn)\n' +
              'Chọn "Cancel" = Không phải (lý do khác)'
            );

            if (bitten) {
              // Hỏi có được bảo vệ?
              const prot = confirm(
                'Có phải vai trò này đang được bảo vệ bởi "💂‍♂ Hiệp Sĩ", "🛡️ Bảo Vệ" hoặc "🧙‍♂️ Phù Thủy" hay không?\n\n' +
                'Chọn "OK" = Phải (được bảo vệ)\n' +
                'Chọn "Cancel" = Không phải (không được bảo vệ)'
              );

              if (prot) {
                // Được bảo vệ -> giữ quyền cho đêm sau
                alert('Chức năng hóa sói của "🐱 Sói Mèo Con" THẤT BẠI, hãy thông báo cho "🐱 Sói Mèo Con" được hóa sói lại vào đêm sau.');
                return;
              } else {
                // ✅ Hóa sói thành công
                STATE.assignments[i].role = '🐺 Ma Sói';
                if (STATE.dead) delete STATE.dead[name];
                renderAssignments(); save();
                alert(`"${name}" vai trò "${role}" bị hóa thành 🐺 Ma Sói, hãy thông báo cho người này thức dậy cùng Bầy Sói.`);
                STATE.alphaCanInfect = false;
                STATE.alphaUsedOrLost = true;
                save();
                return;
              }
            }
            // Không phải do sói cắn -> rơi xuống "giết thường"
          }
        }
        // Nếu mục tiêu là phe Sói (trừ Sói Phù Thủy đã xử lý), không áp dụng hóa sói -> rơi xuống "giết thường"
      }
    }

    // Fallback: xử lý loại bình thường
    toggleDeadByName(name);
    return;
  }
}
  
// --- Ngoại lệ 5b: Chế độ cắn "hóa sói" của Sói Mèo Con khi đã được nạp (alphaCanInfect) ---
if (!isDead && STATE.alphaCanInfect) {
  const low = ascii(role);
  const isWolfSideTarget = (factionOf(role)?.cls === 'f-wolf');
  const isVampire   = low.includes('ma ca rong');
  const isWolfMage  = low.includes('soi phu thuy'); // ☄️ Sói Phù Thủy

  // ❗️Trường hợp đặc biệt: Sói Phù Thủy (dù thuộc phe Sói) vẫn cần hỏi khi 🐱 Sói Mèo Con(Alpha) đang nạp quyền
  if (isWolfMage) {
    const bitten = confirm(
      'Có phải vai trò "☄️ Sói Phù Thủy" vừa bị 🐺 Ma Sói cắn hay không?\n\n' +
      'Chọn "OK" = Phải (bị Ma Sói cắn)\n' +
      'Chọn "Cancel" = Không phải (lý do khác)'
    );
    if (bitten) {
      alert('Chức năng hóa sói của "🐱 Sói Mèo Con" THẤT BẠI, hãy thông báo cho "🐱 Sói Mèo Con" đã mất chức năng hóa sói.');
      STATE.alphaCanInfect = false;
      STATE.alphaUsedOrLost = true;   // ⬅️ đánh dấu đã “xài/mất” 1 lần
      save();
      return;                          // không giết ở đây
    } else {
      toggleDeadByName(name);          // lý do khác -> bị loại bình thường
      return;
    }
  }

  // Mục tiêu KHÔNG thuộc phe Sói -> áp dụng quy trình hoá sói như cũ
  if (!isWolfSideTarget) {
    // Nếu là Ma cà rồng -> hoá sói thất bại và MẤT quyền vĩnh viễn
    if (isVampire) {
      alert('Chức năng hóa sói của "🐱 Sói Mèo Con" THẤT BẠI, hãy thông báo cho "🐱 Sói Mèo Con" đã mất chức năng hóa sói.');
      STATE.alphaCanInfect = false;
      STATE.alphaUsedOrLost = true;   // ⬅️ đánh dấu đã “xài/mất” 1 lần
      save();
      // Không return => rơi xuống xử lý giết thường (Ma cà rồng vốn đêm không chết bởi Sói, nhưng bạn vẫn đang dùng UI đánh dấu)
    } else {
      // Hỏi: có phải nạn nhân bị Ma sói cắn không?
      const bitten = confirm(
        `Có phải vai trò "${role}" vừa bị 🐺 Ma Sói cắn hay không?\n\n` +
        'Chọn "OK" = Phải (bị Ma Sói cắn)\n' +
        'Chọn "Cancel" = Không phải (lý do khác)'
      );

      if (bitten) {
        // Kiểm tra được bảo vệ?
        const prot = confirm(
          'Có phải vai trò này đang được bảo vệ bởi "💂‍♂ Hiệp Sĩ", "🛡️ Bảo Vệ" hoặc "🧙‍♂️ Phù Thủy" hay không?\n\n' +
          'Chọn "OK" = Phải (được bảo vệ)\n' +
          'Chọn "Cancel" = Không phải (không được bảo vệ)'
        );

        if (prot) {
          alert('Chức năng hóa sói của "🐱 Sói Mèo Con" THẤT BẠI, hãy thông báo cho "🐱 Sói Mèo Con" được hóa sói lại vào đêm sau.');
          return; // vẫn còn quyền cho đêm sau (KHÔNG set usedOrLost)
        } else {
          // Hoá sói thành công
          player.role = '🐺 Ma Sói';
          if (STATE.dead) delete STATE.dead[name];
          renderAssignments(); save();
          alert(`"${name}" vai trò "${role}" bị hóa thành 🐺 Ma Sói, hãy thông báo cho người này thức dậy cùng Bầy Sói.`);
          STATE.alphaCanInfect = false;
          STATE.alphaUsedOrLost = true;   // ⬅️ đã dùng xong 1 lần
          save();
          return;
        }
      }
      // Không phải do Sói cắn -> rơi xuống xử lý giết thường ở dưới
    }
  }
  // Nếu rơi xuống đây: hoặc là mục tiêu phe Sói (không phải Pháp sư sói),
  // hoặc Vampire/khác sau khi đã hiển thị thông báo thất bại.
}
// --- Ngoại lệ: MỌI vai trò THÔNG TIN -> thăng cấp cho "🔮 Tiên Tri Tập Sự" (chỉ lần ĐẦU) ---
if (!isDead) {
  // 1) Xác định vai vừa bị "Giết" có phải là 1 trong các vai thông tin hay không
  const killedKey = roleKeyByDisplay(role);           // ví dụ 'seer', 'gsu', 'hquang', 'ttu', 'hbi'
  const isInfo = killedKey && INFO_ROLE_KEYS.has(killedKey);

  if (isInfo) {
    // Giết người này trước (toggleDeadByName sẽ render + lưu trạng thái chết)
    toggleDeadByName(name);

    // 2) Nếu Tập sự chưa từng thăng cấp trong ván này -> tìm 1 Tập sự còn sống để “lên chức”
    if (!STATE.apprenticePromoted) {
      const idxApprentice = (STATE.assignments || []).findIndex(p => {
        const alive = !(STATE.dead && STATE.dead[p.name]);
        return alive && roleKeyByDisplay(p.role) === 'tsu';
      });

      if (idxApprentice !== -1) {
        const newRoleName = roleNameByKey(killedKey);  // lấy đúng tên hiển thị (emoji + tên)
        const targetName  = STATE.assignments[idxApprentice].name;

        STATE.assignments[idxApprentice].role = newRoleName;  // thăng cấp
        STATE.apprenticePromoted = true;                      // chỉ 1 lần/1 ván
        renderAssignments(); save();

        alert(`"${targetName}" (🔮 Tiên Tri Tập Sự) đã được thăng cấp thành ${newRoleName} vì vai trò thông tin này đã chết.`);
      }
    }

    // ĐÃ xử lý xong nhánh này
    return;
  }
}
      
// --- Ngoại lệ 7: 💪 Lực sĩ (chết trễ nếu bị Ma sói cắn) ---
if (!isDead) {
  const low = ascii(role);
  const isToughGuy = low.includes('luc si');

  if (isToughGuy) {
    // Nếu đã bị đánh dấu "chết trễ" từ đêm trước -> lần này giết luôn
    if (STATE.toughGuyPending && STATE.toughGuyPending[name]) {
      delete STATE.toughGuyPending[name];
      toggleDeadByName(name);
      return;
    }

    const ok = confirm(
      'Có phải vai trò "💪 Lực Sĩ" vừa bị Ma Sói cắn không?\n\n' +
      'Chọn "OK" = Phải (bị Ma Sói cắn)\n' +
      'Chọn "Cancel" = Không (lý do khác)'
    );

    if (ok) {
      // Đánh dấu "chết trễ": KHÔNG giết bây giờ
      STATE.toughGuyPending = STATE.toughGuyPending || {};
      STATE.toughGuyPending[name] = true;
      renderAssignments(); save();

      // 🔀 Random 1 sói còn sống, phe Ma Sói, loại Kẻ Phản Bội & Sói Phù Thủy
      const list = STATE.assignments || [];
      const wolves = list.filter(p => {
        const alive = !(STATE.dead && STATE.dead[p.name]);
        if (!alive) return false;
        const f = factionOf(p.role);
        if (!f || f.cls !== 'f-wolf') return false;
        const pr = ascii(p.role);
        if (pr.includes('ke phan boi')) return false;   // 🎭 Kẻ Phản Bội
        if (pr.includes('soi phu thuy')) return false;  // ☄️ Sói Phù Thủy
        return true;
      });

      const attacker = wolves.length ? wolves[Math.floor(rng(wolves.length))] : null;
      const attackerRole = attacker ? `${attacker.name}` : '🐺 Ma Sói';

      alert(
        `Hãy thông báo cho vai trò "💪 Lực Sĩ" bị "${attackerRole}" - vai trò "🐺 Ma Sói" cắn ` +
        `và để vai trò "💪 Lực Sĩ" tham gia thảo luận và biểu quyết vào buổi sáng ` +
        `và "Giết" lại vai trò "💪 Lực Sĩ" vào đêm tiếp theo.`
      );
      return;
    } else {
      // Không phải do sói cắn -> chết ngay
      if (STATE.toughGuyPending) delete STATE.toughGuyPending[name];
      toggleDeadByName(name);
      return;
    }
  }
}

// --- Ngoại lệ 8: 🤒 Người bệnh ---
if (!isDead && ascii(role).includes('nguoi benh')) {
  const ok = confirm(
    'Có phải vai trò "🤒 Người Bệnh" vừa bị Ma Sói cắn hay không?\n\n' +
    'Chọn "OK" = Phải (bị Ma Sói cắn)\n' +
    'Chọn "Cancel" = Không phải (lý do khác)'
  );

  // Bị loại bình thường trong cả hai trường hợp
  toggleDeadByName(name);  // (hàm này tự auto-sort giống giết thường)

  // Nếu đúng là do Ma sói cắn thì thêm thông báo cho bầy sói
  if (ok) {
    alert('Hãy thông báo cho phe 🐺 Ma Sói không được giết người nào vào đêm tiếp theo.');
  }
  return; // đã xử lý xong Người bệnh
}

    // Mặc định: toggle chết / cứu như cũ
    toggleDeadByName(name);
  });
});
// Mở modal chọn mục tiêu cho 👥 Nhân bản
qsa('[data-doppel]', $.assignments).forEach(btn => {
  btn.addEventListener('click', (e) => {
    const idx = Number(e.currentTarget.getAttribute('data-doppel'));
    doppelModal.open(idx);
  });
});

// double-click / double-tap để toggle “đã chết”
qsa('tbody tr', $.assignments).forEach(tr=>{
  const name = tr.getAttribute('data-name'); // DOM sẽ decode &quot; => "
  // chặn khi click vào nút
  tr.addEventListener('dblclick', (e)=>{
    if (e.target.closest('button')) return;
    const isDeadNow = !!(STATE.dead && STATE.dead[name]);
    if (!isDeadNow && !ensureDoppelPickBeforeKill()) { e.preventDefault(); return; } // ⛔️ chặn
    toggleDeadByName(name);
  });

  // mobile: double-tap trong ~300ms
  let lastTap = 0;
  tr.addEventListener('touchend', (e)=>{
    if (e.target.closest('button')) return;
    const now = Date.now();
    if (now - lastTap < 300){
      const isDeadNow = !!(STATE.dead && STATE.dead[name]);
      if (!isDeadNow && !ensureDoppelPickBeforeKill()) { e.preventDefault(); return; } // ⛔️ chặn
      toggleDeadByName(name);
    }
    lastTap = now;
  }, {passive:false});
});
}

  $.sortBtn.addEventListener('click', () => {
    sortAssignmentsByFactionThenRole();
});

// Bỏ emoji/ký tự đặc biệt đầu tên -> lấy phần chữ "Giáo chủ"
function stripLeadingEmoji(name){
  return String(name||'').replace(/^[^\p{L}\p{N}]+/u,'').trim();
}
// ---- Helper: Có Sói Mèo Con còn sống trong ván không? ----
function hasAliveAlpha(){
  const list = STATE.assignments || [];
  const toAscii = s => String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();

  return list.some(p => {
    const alive = !(STATE.dead && STATE.dead[p.name]);
    const role  = toAscii(p.role);
    // 🐱 "Sói Mèo Con" (đang dùng tên này trong DEFAULT_ROLES)
    return alive && role.includes('soi meo con');
  });
}
// ==== Helpers cho nhận diện vai từ tên hiển thị (emoji + tiếng Việt) ====
function _toAscii(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/đ/g,'d').replace(/Đ/g,'D')
    .toLowerCase().trim();
}
function roleKeyByDisplay(displayName){
  const plain = stripLeadingEmoji(displayName||'');
  const want  = _toAscii(plain);
  const hit   = DEFAULT_ROLES.find(r => _toAscii(stripLeadingEmoji(r.name)) === want);
  return hit ? hit.key : null;
}
function roleNameByKey(key){
  const hit = DEFAULT_ROLES.find(r => r.key === key);
  return hit ? hit.name : key;
}
// Tập vai "thông tin" (info roles) mà Tập sự có thể thăng cấp
const INFO_ROLE_KEYS = new Set(['seer','gsu','hquang','ttu','hbi', 'py', 'cbac', 'nncam', 'nptich']);

// Trả về HTML icon (ưu tiên ảnh nếu có URL), fallback về emoji nếu truyền vào
function roleIconHTMLByKey(key, fallbackEmoji, altText){
  const url = ROLE_ICON_URL[key];
  if (url) {
    // onerror -> ẩn icon nếu lỗi tải để còn lại chữ
    return `<img class="role-icon" src="${esc(url)}" alt="${esc(altText||'')}" onerror="this.style.display='none'">`;
  }
  return fallbackEmoji ? `<span class="role-icon" aria-hidden="true" style="width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center">${fallbackEmoji}</span>` : '';
}

  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

// ===== KHO LƯU GHI CHÉP =====
const notesArchiveModal = {
  wrap: document.getElementById('notesArchiveModal'),
  title: document.getElementById('notesArchiveTitle'),
  body:  document.getElementById('notesArchiveBody'),
  btnClose: document.getElementById('notesArchiveClose'),
  open(){
    this.render();
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose?.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
  },
  render(){
    const list = STATE.notesArchive || [];
    const total = list.length;

    const itemsHTML = !total
      ? `<div class="hint">Chưa có bản lưu nào. Hãy bấm <b>💿️ Lưu</b> sau khi ghi chú.</div>`
      : `<div class="hint">Đã lưu <b>${total}</b> lần.</div>
         <div class="archive-list">
           ${list.slice().reverse().map(it=>{
              const when = new Date(it.timeISO).toLocaleString('vi-VN', { hour12:false });
              return `
                <div class="archive-item">
                  <div class="archive-meta">Lần #${it.id} • ${when}</div>
                  <div class="archive-content">${escapeHtml(it.content)}</div>
                </div>`;
            }).join('')}
         </div>`;

    this.body.innerHTML = itemsHTML +
      `<div class="archive-actions">
         <button class="btn danger" id="notesArchiveClearAll">🗑️ Xóa toàn bộ lưu trữ</button>
         <button class="btn" id="notesArchiveClose2">Đóng</button>
       </div>`;

    // gắn sự kiện cho 2 nút trong body (vì body vừa được innerHTML)
    const clearBtn = this.body.querySelector('#notesArchiveClearAll');
    const close2   = this.body.querySelector('#notesArchiveClose2');

    clearBtn?.addEventListener('click', ()=>{
      if(!confirm('Bạn chắc chắn muốn xóa toàn bộ các bản lưu? Hành động này không thể hoàn tác.')) return;
      STATE.notesArchive = [];
      STATE.notesSaveSeq = 0;   // reset số lần
      save();
      this.render();
      alert('Đã xóa toàn bộ lưu trữ và đặt lại bộ đếm.');
    });
    close2?.addEventListener('click', ()=> this.close());
  }
};

// Đóng modal khi click ra ngoài / nhấn ESC
notesArchiveModal.btnClose?.addEventListener('click', ()=> notesArchiveModal.close());
notesArchiveModal.wrap?.addEventListener('click', (e)=>{ if(e.target===notesArchiveModal.wrap) notesArchiveModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') notesArchiveModal.close(); });

// Lưu một “bản chụp” ghi chú
function saveNotesSnapshot(){
  const text = (qs('#notes')?.value || '');
  if(!text.trim()){
    if(!confirm('Ghi chú đang trống. Bạn có muốn lưu một đoạn văn bản trống?')) return;
  }
  STATE.notesSaveSeq = (STATE.notesSaveSeq || 0) + 1;
  const entry = { id: STATE.notesSaveSeq, timeISO: new Date().toISOString(), content: text };
  STATE.notesArchive = STATE.notesArchive || [];
  STATE.notesArchive.push(entry);
  save();

  const when = new Date(entry.timeISO).toLocaleString('vi-VN', { hour12:false });
  alert(`Đã lưu ghi chép #${entry.id} (${when}).\nXem lại ở "📁 Kho lưu trữ".`);
}
// LƯU 1 bản chụp danh sách người chơi
function savePlayersSnapshot(){
  const n = Number($.playerCount.value || STATE.playerCount);
  const names = STATE.names.slice(0, n).map((x,i) => (x||'').trim() || `Người chơi ${i+1}`);

  STATE.playersSaveSeq = (STATE.playersSaveSeq || 0) + 1;
  const entry = { id: STATE.playersSaveSeq, timeISO: new Date().toISOString(), players: names };
  STATE.playersArchive.push(entry);
  save();

  const when = new Date(entry.timeISO).toLocaleString('vi-VN', {hour12:false});
  alert(`Đã lưu danh sách #${entry.id} (${when}).\nMở "📁 Kho lưu trữ" để xem.`);
}

// Modal Kho lưu danh sách người chơi
const playersArchiveModal = {
  wrap: document.getElementById('playersArchiveModal'),
  body: document.getElementById('playersArchiveBody'),
  btnClose: document.getElementById('playersArchiveClose'),
  open(){ this.render(); this.wrap.classList.add('show'); this.wrap.setAttribute('aria-hidden','false'); this.btnClose?.focus(); },
  close(){ this.wrap.classList.remove('show'); this.wrap.setAttribute('aria-hidden','true'); },
  render(){
    const list = STATE.playersArchive || [];
    const items = !list.length
      ? `<div class="hint">Chưa có bản lưu nào. Bấm <b>💾 Lưu trữ danh sách</b> để lưu.</div>`
      : `<div class="archive-list">
           ${list.slice().reverse().map(it=>{
              const when = new Date(it.timeISO).toLocaleString('vi-VN',{hour12:false});
              const content = it.players.map((n,i)=>`${String(i+1).padStart(2,'0')}. ${esc(n)}`).join('\n');
              return `
                <div class="archive-item" data-id="${it.id}">
                  <div class="archive-meta">Danh sách #${it.id} • ${when} • ${it.players.length} người</div>
                  <div class="archive-content">${content}</div>
                  <div class="archive-actions">
                    <button class="btn ok" data-use="${it.id}">Sử dụng</button>
                    <button class="btn danger" data-del="${it.id}">Xóa</button>
                  </div>
                </div>`;
            }).join('')}
         </div>`;

    this.body.innerHTML = items + `
      <div class="archive-actions">
        <button class="btn danger" id="playersArchiveClearAll">🗑️ Xóa tất cả</button>
        <button class="btn" id="playersArchiveClose2">Đóng</button>
      </div>`;

    // Sự kiện trong body
    this.body.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = Number(e.currentTarget.getAttribute('data-del'));
        if (!confirm(`Xóa danh sách #${id}?`)) return;
        STATE.playersArchive = (STATE.playersArchive||[]).filter(x=>x.id!==id);
        save();
        this.render();
      });
    });
    // Sử dụng một danh sách đã lưu
this.body.querySelectorAll('[data-use]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const id = Number(e.currentTarget.getAttribute('data-use'));
    const entry = (STATE.playersArchive || []).find(x => x.id === id);
    if (!entry) return;

    const list = (entry.players || []).slice();              // clone tên
    const newCount = clamp(list.length, 3, 151);             // theo min/max của app

    // Cập nhật state & ô nhập số người chơi
    STATE.names = list;
    STATE.playerCount = newCount;
    $.playerCount.value = newCount;

    // Reset khu phân vai vì số người đã đổi
    STATE.assignments = null;
    STATE.reveal = {};
    STATE.dead = {};
    if ($.reshuffleBtn) $.reshuffleBtn.disabled = true;
    if ($.revealAllBtn) $.revealAllBtn.disabled = true;
    if ($.copyBtn) $.copyBtn.disabled = true;
    if ($.sortBtn) $.sortBtn.disabled = true;

    // Vẽ lại UI
    renderNames();
    updateSlotsLeft();
    save();

    // Đóng modal & báo
    playersArchiveModal.close();
    alert(`Đã sử dụng danh sách #${id} (${list.length} người).`);
  });
});

    this.body.querySelector('#playersArchiveClearAll')?.addEventListener('click', ()=>{
      if (!confirm('Bạn chắc chắn muốn xóa toàn bộ các bản lưu? Hành động này không thể hoàn tác.')) return;
      STATE.playersArchive = []; STATE.playersSaveSeq = 0; save(); this.render();
    });
    this.body.querySelector('#playersArchiveClose2')?.addEventListener('click', ()=> this.close());
  }
};
playersArchiveModal.btnClose?.addEventListener('click', ()=> playersArchiveModal.close());
playersArchiveModal.wrap?.addEventListener('click', (e)=>{ if(e.target===playersArchiveModal.wrap) playersArchiveModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') playersArchiveModal.close(); });

// Gán lại hành vi cho 2 nút ở khu "Thiết lập người chơi"
$.autoFillNames.addEventListener('click', savePlayersSnapshot);          // 💾 Lưu trữ danh sách
$.shuffleNames.addEventListener('click', ()=> playersArchiveModal.open()); // 📁 Kho lưu trữ

  // ====== TIMER ======
  let TICK = null; let remaining = 120; let countingUp=false;

  function setTimerFromInputs(){
    const min = clamp(Number($.timerMin.value||0),0,999);
    const sec = clamp(Number($.timerSec.value||0),0,59);
    $.timerMin.value=min; $.timerSec.value=sec;
    if($.timerMode.value==='down'){ remaining = min*60 + sec; countingUp=false; }
    else { remaining = 0; countingUp=true; }
    updateTimerDisplay();
    STATE.timer = { ...STATE.timer, mode: $.timerMode.value, min, sec, left: remaining, running:false, sound: $.soundToggle.checked };
    $.startPauseBtn.textContent='▶︎ Bắt đầu'; save();
  }

  function updateTimerDisplay(){
    const sec = Math.max(0, Math.floor(remaining%60));
    const min = Math.max(0, Math.floor(remaining/60));
    $.timerDisplay.textContent = `${pad(min)}:${pad(sec)}`;
  }

  // Thay toàn bộ hàm beep() cũ bằng hàm mới này
  function beep(times = 5, vol = 1.0, freq = 900, dur = 180, gap = 120){
    if(!$.soundToggle.checked) return;

    // RUNG: 5 nhịp 200ms, nghỉ 100ms
    try{ navigator.vibrate && navigator.vibrate([200,100,200,100,200,100,200,100,200]); }catch{}

    // ÂM THANH: nhiều "tút" liền nhau
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();

      let t = ctx.currentTime;
      for(let i = 0; i < times; i++){
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);

        // Giữ tiếng "tút" rõ ràng
        o.type = 'sine';
        o.frequency.setValueAtTime(freq, t);

        // Envelope để nghe to nhưng không rè
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(vol, t + 0.02);           // lên nhanh
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur/1000);    // tắt nhanh

        o.start(t);
        o.stop(t + dur/1000 + 0.01);

        // khoảng nghỉ giữa các "tút"
        t += (dur + gap) / 1000;
      }

      // đóng context sau khi phát xong để tiết kiệm pin
      const total = times*dur + (times-1)*gap + 200;
      setTimeout(()=>{ try{ ctx.close(); }catch{} }, total);
    }catch{}
  }

  function startPause(){
    if(TICK){ clearInterval(TICK); TICK=null; $.startPauseBtn.textContent='▶︎ Tiếp tục'; STATE.timer.running=false; save(); return; }
    $.startPauseBtn.textContent='❚❚ Tạm dừng'; STATE.timer.running=true; save();
    TICK = setInterval(()=>{
      remaining += countingUp ? 1 : -1;
      updateTimerDisplay();
      if(!countingUp && remaining<=0){ clearInterval(TICK); TICK=null; beep(); $.startPauseBtn.textContent='▶︎ Bắt đầu'; STATE.timer.running=false; save(); }
    }, 1000);
  }

  function resetTimer(){ clearInterval(TICK); TICK=null; setTimerFromInputs(); }

  $.timerMode.addEventListener('change', setTimerFromInputs);
  $.timerMin.addEventListener('change', setTimerFromInputs);
  $.timerSec.addEventListener('change', setTimerFromInputs);
  $.startPauseBtn.addEventListener('click', startPause);
  $.resetTimerBtn.addEventListener('click', resetTimer);
  qsa('[data-preset]').forEach(btn=> btn.addEventListener('click', (e)=>{
    const s = Number(e.currentTarget.getAttribute('data-preset'))||120;
    $.timerMode.value='down'; $.timerMin.value = Math.floor(s/60); $.timerSec.value = s%60; setTimerFromInputs();
  }));
  $.soundToggle.addEventListener('change', ()=>{ STATE.timer.sound = $.soundToggle.checked; save(); });

  // ====== NOTES ======
  const notesEl = qs('#notes');

// Tự giãn chiều cao ghi chú theo nội dung
function autoGrowNotes(){
  if(!notesEl) return;
  notesEl.style.height = 'auto';                    // reset
  notesEl.style.height = Math.max(160, notesEl.scrollHeight) + 'px';
}

// khi nhập thì tự giãn
notesEl.addEventListener('input', autoGrowNotes);
// nếu cửa sổ đổi kích thước (mobile xoay…), tính lại
window.addEventListener('resize', autoGrowNotes);

  notesEl.addEventListener('input', ()=>{ STATE.notes = notesEl.value; save(); });

  // Nút: Xóa tất cả
  $.clearNotesBtn.addEventListener('click', ()=>{
    notesEl.value = '';
    STATE.notes = '';
    save();
    autoGrowNotes();
    notesEl.focus();
  });

  // Nút: Soạn mẫu nhanh
  $.quickTemplateBtn.addEventListener('click', ()=>{
    const tpl =
`🐺 Sói _________ Giết:
🛡️ Bảo vệ ______ Chắn:
🧙‍♂️ Phù Thủy _____ Cứu:
🧙‍♂️ Phù Thủy ____ Giết:
🏹 Thợ săn _____ Ngắm:
💘 Cupid _______ Ghép:
👥 Nhân bản ____ Chọn:
🔇 Nguyệt nữ ____ Câm: `;
    notesEl.value = tpl;
    STATE.notes = tpl;
    save();
    autoGrowNotes();
    // Đưa con trỏ về cuối cho tiện ghi tiếp
    notesEl.focus();
    try{
      notesEl.selectionStart = notesEl.selectionEnd = notesEl.value.length;
    }catch{}
  });

$.saveNotesBtn?.addEventListener('click', saveNotesSnapshot);
$.openArchiveBtn?.addEventListener('click', () => notesArchiveModal.open());

  // ====== INIT ======
  function init(){
    load();
    if (STATE.firstKillPromptShown === undefined) STATE.firstKillPromptShown = false;
    if (STATE.alphaCanInfect === undefined) STATE.alphaCanInfect = false;
    if (STATE.alphaUsedOrLost === undefined) STATE.alphaUsedOrLost = false;
    if (!Array.isArray(STATE.notesArchive)) STATE.notesArchive = [];
    if (!Number.isInteger(STATE.notesSaveSeq)) STATE.notesSaveSeq = 0;
    if (!Array.isArray(STATE.playersArchive)) STATE.playersArchive = [];
    if (!Number.isInteger(STATE.playersSaveSeq)) STATE.playersSaveSeq = 0;

    save();
    $.playerCount.value = STATE.playerCount;
    renderNames();

    ensureDefaultRoles();
    normalizeCustomRoles();
    renderRoles();

    if(STATE.assignments){ renderAssignments(); $.reshuffleBtn.disabled=false; $.revealAllBtn.disabled=false; $.copyBtn.disabled=false; $.sortBtn.disabled=false; }

    notesEl.value = STATE.notes||'';
    autoGrowNotes();

    $.timerMode.value = STATE.timer.mode||'down';
    $.timerMin.value = STATE.timer.min||0; $.timerSec.value = STATE.timer.sec||0;
    let remainingLocal = STATE.timer.left || (STATE.timer.mode==='down' ? (STATE.timer.min*60 + STATE.timer.sec): 0);
    remaining = remainingLocal;
    countingUp = STATE.timer.mode==='up'; $.soundToggle.checked = !!STATE.timer.sound;
    updateTimerDisplay();
    if(STATE.timer.running){ startPause(); }

    updateSlotsLeft();
  }

// ===== Modal 'Thứ tự kêu dậy' =====
const nightOrderModal = {
  wrap: document.getElementById('nightOrderModal'),
  body: document.getElementById('nightOrderBody'),
  btnClose: document.getElementById('nightOrderClose'),
  open(){
    this.render();
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose?.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
  },
  render(){
    this.body.innerHTML = `
      <p class="intro">VAI TRÒ CHỈ KÊU DẬY KHÔNG LÀM GÌ, CHỈ XÁC NHẬN RỒI CHO NGỦ<br>
      <em>(Khi kêu Bầy sói dậy vui lòng không chỉ ra 🐺 Ma sói, ☠️ Sói đại ca và 🐺 Sói trắng)</em></p>

      <ol start="1">
        <li>👻 Con ma (đêm đầu tiên)</li>
        <li>💘 Cupid _ Chọn 2 người để ghép đôi (đêm đầu tiên)</li>
        <li>☠️ Sói đại ca (lượt riêng, Đêm đầu tiên)</li>
        <li>🐻 Đầu gấu _ Chọn 2 người để dụ dỗ (đêm đầu tiên) / Giết 1 người</li>
        <li>Bầy sói gồm: 🎃 Ác mộng + 🐺 Ma sói (bao gồm: 🐺 Ma sói thật + ☠️ Sói đại ca + 🐺 Sói trắng) + 🎭️ Phản bội + 🐺 Sói con + 💢 Sói cuồng + 🐱 Sói đầu đàn + ❄️ Sói tuyết 
          <div class="sub">Thứ tự hành động của Bầy sói:</div>
          <div class="sub"> 5.1 🎃 Ác mộng _ Chọn 1 người để vô hiệu chức năng (1 lần)</div>
          <div class="sub"> 5.2 🐺 Sói con _ Có thể hy sinh để Bầy sói được giết 2 người (1 lần)</div>
          <div class="sub"> 5.3 💢 Sói cuồng _ Có thể cuồng nộ để cắn xuyên các đợt bảo vệ (từ đêm thứ 2, 1 lần)</div>
          <div class="sub"> 5.3 🐱 Sói đầu đàn _ Chọn 1 người để cắn hóa sói (nếu có Ma sói chết vào buổi sáng, 1 lần)</div>
          <div class="sub"> 5.5 ❄️ Sói tuyết _ Chọn 1 người để làm bạn đồng hành (đêm đầu tiên)</div>
          <div class="sub"> 5.6 🐺 Giết và Giết liền kề (nếu còn ☠️ Sói đại ca)</div>
        </li>
        <li>☄️ Pháp sư sói_ Chọn 1 người để biết có phải Tiên tri hay không?</li>
        <li>🐺 Sói trắng (Lượt riêng) _ Chọn 1 người để giết riêng.</li>
        <li>🧛 Ma cà rồng _ Chọn 1 người để làm nạn nhân.</li>
        <li>🦹 Giáo chủ _ Chọn 1 người để thêm vào giáo phái.</li>
        <li>💂‍♂ Hiệp sĩ _ Chọn 1 người để bảo vệ vĩnh viễn (1 lần).</li>
        <li>🛡️ Bảo vệ _ Chọn 1 người để bảo vệ (không liên tiếp).</li>
        <li>🧙‍♂️ Phù thủy _ Có thể sử dụng bình cứu (1 lần) hoặc bình độc.(1 lần)</li>
        <li>🔭 Thiên văn _ Có thể chọn 1 người để gọi mưa sao băng.</li>
        <li>🏹 Thợ săn _ Chọn 1 người để nhắm bắn khi chết.</li>
        <li>🕵‍♂ Thám tử _ Có thể chọn 1 người để điều tra hoặc điều tra 2 người kế bên người đó có phải Ma sói hay không (1 lần)?.</li>
        <li>🔮 Tiên tri _ Chọn 1 người để biết có phải Ma sói hay không (Hào quang: Ác)?</li>
        <li>🧿 Hào quang _ Chọn 1 người để biết người đó có chức năng hay không (Chức năng: Có)?</li>
        <li>✨ THuyền bí _ Chọn 1 người để biết chính xác vai trò của người đó.</li>
        <li>👨‍🏫 Giáo sư _ Chọn 2 người để biết 2 người đó có cùng phe hay khác phe nhau.</li>
        <li>🔇 Nguyệt nữ _ Chọn 1 người bị câm vào sáng hôm sau.</li>
        <li>🐆 Báo làng _ Có thể quậy phá làng (1 lần).</li>
      </ol>

      <div class="section">KÊU DẬY 1 LẦN VÀO ĐÊM ĐẦU TIÊN</div>

      <ol start="22">
        <li>👥 Nhân bản _ Chọn 1 người để làm mục tiêu nhân bản (đêm đầu tiên)</li>
        <li>⚔️ Lính gác (đêm đầu tiên)</li>
        <li>🤝 Hòa bình (đêm đầu tiên)</li>
        <li>👑 Hoàng tử (đêm đầu tiên)</li>
        <li>⭐ Thị trưởng (đêm đầu tiên)</li>   
        <li>🤒 Người bệnh (đêm đầu tiên)</li>
        <li>💪 Lực sĩ (đêm đầu tiên)</li>
        <li>👴 Già làng (đêm đầu tiên)</li>
        <li>🔮 Tập sự (đêm đầu tiên)</li>
        <li>🌑 Bị nguyền (đêm đầu tiên)</li>
        <li>💣️ Đánh bom (đêm đầu tiên)</li>
        <li>😓 Chán đời (đêm đầu tiên)</li>
        <li>👨🏻‍🌾 Dân làng (đêm đầu tiên)</li>
      </ol>`;
  }
};

// mở/đóng + hành vi giống các modal khác
document.getElementById('nightOrderBtn')?.addEventListener('click', () => nightOrderModal.open());
nightOrderModal.btnClose?.addEventListener('click', ()=> nightOrderModal.close());
nightOrderModal.wrap?.addEventListener('click', (e)=>{ if(e.target===nightOrderModal.wrap) nightOrderModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') nightOrderModal.close(); });

  init();
})();
</script>
</body>
</html>