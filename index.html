<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Werewolf Assistant</title>
  <style>
    :root{
      --bg: #0f1222;
      --bg-elev: #171b33;
      --text: #eef2ff;
      --muted:#a5b4fc;
      --accent:#7c5cff;
      --accent-2:#22d3ee;
      --danger:#ef4444;
      --ok:#10b981;
      --card: #141832;
      --border:#283056;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      /* Lưới phần “Thiết lập vai trò” */
      --roles-cols: 1.2fr .6fr 120px auto;
    }

    *{ box-sizing:border-box }

    /* Ngăn mọi tràn ngang, giữ kích cỡ chữ hệ */
    html, body{
      height:100%;
      max-width:100%;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    body{
      margin:0;
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1400px 900px at 15% -10%, #2a3b77 0%, #18203f 58%),
        radial-gradient(1100px 700px at 110% 30%, rgba(124,92,255,.25), rgba(34,211,238,0) 70%),
        linear-gradient(180deg, #0e1430 0%, #0a0f22 100%);
    }

    /* ===== HEADER full-bleed, KHÔNG bo góc ===== */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      overflow: visible;
      isolation: isolate; /* để ::before/::after nằm trên nền nhưng dưới nội dung */
    }

/* Hiển thị đủ chữ trên các nút Điền tên, Xáo trộn, Xóa người chơi */
#autoFillNames,
#shuffleNames,
#removeEmptyNames {
  white-space: normal !important;   /* cho xuống dòng nếu thiếu chỗ */
  text-overflow: unset !important;  /* bỏ dấu "..." */
  overflow: visible !important;     /* hiển thị đủ nội dung */
  max-width: none !important;       /* không giới hạn chiều ngang */
  min-width: 120px;                 /* tối thiểu 120px cho đủ chữ */
  flex: 1;                          /* chia đều mỗi nút nếu cùng hàng */
}

#playerSetupRow > .row {
  display: flex;
  justify-content: space-between; /* các nút cách đều nhau */
  gap: 8px;                       /* khoảng cách giữa nút */
}

    /* Tấm mờ toàn bề ngang */
    header::before{
      content:"";
      position:absolute;
      inset:0;                               /* theo chiều cao header */
      margin-left:  calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      background: linear-gradient(0deg, rgba(15,18,34,.20), rgba(15,18,34,.60));
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index:-1;
      border-radius:0;
    }
    /* Hiệu ứng sáng */
    header::after{
      content:"";
      position:absolute;
      inset:0;
      margin-left:  calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      pointer-events:none;
      background:
        radial-gradient(900px 280px at 25% 40%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        radial-gradient(700px 240px at 70% 60%, rgba(255,255,255,.08), rgba(255,255,255,0) 70%);
      opacity:.9;
      z-index:-1;
      border-radius:0;
    }
    /* Nếu máy hỗ trợ viewport động, vẫn đảm bảo full-bleed mà không sinh thanh trượt */
    @supports (width: 100dvw){
      header::before, header::after{ width:100dvw; left:50%; transform:translateX(-50%); margin:0; }
    }

    /* Nội dung tiêu đề */
    header .title{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      max-width:1200px; margin:0 auto;
    }
    header .title .top-row{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap }
    header .title h1{
      margin:0; font-weight:800; letter-spacing:.3px; white-space:nowrap;
      font-size:clamp(20px,5vw,34px); line-height:1.1;
    }
    .logo{ width:32px; height:32px }
    .logo img{ width:100%; height:100%; object-fit:cover; border-radius:10px }

    /* ===== Layout ===== */
    .container{ position:relative; z-index:1; max-width:1200px; margin:20px auto; padding:0 16px }
    .container::after{
      content:""; position:fixed; right:-6vw; top:240px; width:88vw; height:1200px;
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 60px rgba(124,92,255,.18), 0 0 120px rgba(34,211,238,.12);
      opacity:.45; pointer-events:none; z-index:0;
    }

    .grid{ display:grid; gap:16px }
    @media (min-width:980px){ .grid{ grid-template-columns:1.2fr .8fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; position:relative; z-index:1; max-width:100%;
    }
    .card h2{ margin:6px 6px 14px; font-size:20px }

    label{ display:block; margin:10px 6px 6px; color:var(--muted); font-size:13px }
    input[type="number"], input[type="text"], select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
      background:#0c0f1f; color:var(--text); outline:none; transition:.2s border,.2s box-shadow
    }
    input:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(124,92,255,.15) }
    /* Tự giãn: bỏ thanh cuộn bên trong */
textarea{
  min-height:160px;
  resize:none;          /* không cần kéo tay nữa */
  overflow:hidden;      /* ẩn scrollbar bên trong */
}

    .row{ display:flex; gap:10px; align-items:center }
    .row.wrap{ flex-wrap:wrap }
    .grow{ flex:1 }

    .btn{
      padding:10px 14px; border:1px solid var(--border); color:var(--text); background:#11152b;
      border-radius:12px; cursor:pointer; transition:.15s transform,.2s background,.2s border-color
    }
    .btn:hover{ transform:translateY(-1px); background:#171c36 }
    .btn:active{ transform:translateY(0) }
    .btn.primary{ background:linear-gradient(135deg, var(--accent) 0%, #5f44ff 100%); border:none }
    .btn.ghost{ background:transparent }
    .btn.danger{ background:#2a0f12; border-color:#5e1a22; color:#ffb4b4 }
    .btn.ok{ background:#0d2a22; border-color:#13493b; color:#c7ffee }

    .hint{ font-size:12px; color:#c7cfff; opacity:.9 }
    .chip{ display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; background:#0c0f1f; border:1px solid var(--border) }

    /* Danh sách tên người chơi – 2 cột không tràn */
    .names{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:10px; width:100%;
    }

    /* Tiêu đề section */
    .section-title{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:6px }
    .section-title h2{ margin:0 }

    /* Header khu vai trò */
    .section-title.roles-head{
      display:grid; grid-template-columns: var(--roles-cols); align-items:end; gap:8px
    }
    .section-title.roles-head h2{ grid-column:1 / span 2; margin:0 }
    .section-title.roles-head .chip{ grid-column:3; justify-self:start }

    /* Bảng vai trò (grid, không tràn) */
    .roles{
      display:grid; grid-template-columns: var(--roles-cols); gap:8px; align-items:center; width:100%;
    }
    .roles .header{ font-size:12px; color:var(--muted); opacity:.8; padding:0 6px }
    .roles .item{ display:contents }
    .roles input[type="number"]{ width:120px }

    /* Khu thêm vai trò */
    #customRoleName{ flex:1 1 320px; min-width:200px }
    #customRoleCount{ width:90px; text-align:center }
    #customRoleActions{ width:100%; display:flex; justify-content:center; gap:10px; margin-top:8px }
    #customRoleActions .btn{ min-width:140px }

    .pill{ font-size:12px; opacity:.9; padding:4px 8px; border-radius:999px; border:1px dashed #334; display:inline-flex; gap:6px; align-items:center; width:max-content }

    /* Danh sách phân vai – fit màn hình */
    .assignments table{ width:100%; border-collapse:collapse; table-layout:fixed }
    .assignments th,.assignments td{ border-bottom:1px solid #2a315a; padding:10px; text-align:left; }
    .assignments tr.revealed td.role{ filter:none }
    .assignments td.role.hidden{ filter:blur(8px); opacity:.7 }
    .assignments th, .assignments td{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

    /* Công cụ */
    .tools{ display:grid; gap:10px; margin-top:12px; grid-template-columns:repeat(2,1fr) }
    .tools .btn.primary{ grid-column:1 / -1 }
    .tools .btn{ width:100%; text-align:center; white-space:normal; justify-content:center }
    @media (min-width:640px){ .tools{ grid-template-columns:repeat(3,1fr) } }
    @media (min-width:960px){ .tools{ grid-template-columns:repeat(4,1fr) } }

    .kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; background:#0b0e1d; border:1px solid var(--border); padding:2px 6px; border-radius:6px }

    .timer-big{ font-variant-numeric:tabular-nums; font-weight:800; font-size:clamp(36px,11vw,48px); letter-spacing:1px; text-align:center; margin:8px 0 12px }
    .timer-controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }

    .footer{ opacity:.6; text-align:center; font-size:12px; padding:12px }

    /* Print */
    @media print{
      header, .no-print{ display:none !important }
      body{ background:#fff; color:#000 }
      .card{ box-shadow:none; border:1px solid #ccc }
      .assignments td.role.hidden{ filter:none }
    }
    #rolesList{ display:contents }

    /* ===== Modal vai trò ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:9999; padding:16px;
    }
    .modal-backdrop.show{ display:flex }
    /* Bo viền toàn bộ modal và cắt (clip) mọi hiệu ứng mờ bị tràn */
.modal{
  border-radius:12px;
  overflow:hidden;                 /* QUAN TRỌNG: không cho dải mờ tràn ra */
}

/* Header modal: đã bo góc trên, vẫn giữ overflow để không bị leak */
.modal header{
  position:relative;
  overflow:hidden;
  border-radius:12px 12px 0 0;     /* bo 2 góc trên */
}

/* Phần nội dung: bo 2 góc dưới để khớp với khung modal */
.modal .content{
  padding:16px;
  border-radius:0 0 12px 12px;     /* bo 2 góc dưới */
  overflow:hidden;                 /* phòng khi có hiệu ứng mờ bên trong */
}

/* Nền tối của phần mô tả – chỉ bo góc dưới (trên đã do header đảm nhiệm) */
#roleModalBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;    /* chỉ bo 2 góc dưới */
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: pre-wrap; text-align: justify; text-wrap: pretty; hyphens: auto;
}

/* Thân modal kho lưu – cùng phong cách với roleModal */
#notesArchiveBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: normal;
}

/* Danh sách bản lưu */
.archive-list{ display:flex; flex-direction:column; gap:12px; }
.archive-item{ border:1px solid var(--border); border-radius:10px; padding:10px; background:#0c0f1f; }
.archive-meta{ font-size:12px; color:#a5b4fc; margin-bottom:6px; }
.archive-content{
  white-space:pre-wrap;              /* giữ xuống dòng */
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background:#0b0e1d; border:1px solid var(--border);
  padding:10px; border-radius:8px;
}

/* Hàng nút ở đáy modal */
.archive-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    .modal .close{ border:1px solid var(--border); background:#11152b; color:var(--text); border-radius:10px; padding:8px 12px; cursor:pointer }

.archive-list{display:grid;gap:10px;max-height:50vh;overflow:auto}
.archive-item{background:#0c0f1f;border:1px solid var(--border);border-radius:10px;padding:10px}
.archive-meta{font-size:12px;color:var(--muted)}
.archive-content{white-space:pre-wrap}
.archive-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* Label “Số người chơi” không bẻ dòng */
    label[for="playerCount"]{ white-space:nowrap }

    /* Căn đều cột mô tả */
    .roles .item div:nth-child(2){ text-align:justify; text-justify:inter-word }

    /* Co giãn cho màn nhỏ – xử lý triệt để việc bị “khuyết” bên phải */
    @media (max-width:420px){
      .container{ padding:0 10px }
      .card{ padding:12px; border-radius:14px }
      .section-title{ gap:4px }
      .chip{ padding:5px 8px; font-size:12px }
      .btn{ padding:8px 12px; font-size:14px }
      .btn.primary{ font-size:15px }
      input[type="number"], input[type="text"], select, textarea{ padding:10px; border-radius:10px; font-size:15px; max-width:100% }

      /* Tên người chơi 2 cột chắc chắn vừa */
      .names{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) }

      /* Bảng vai trò: thu cột số lượng, tránh tràn */
      :root{ --roles-cols: 1fr .6fr 90px auto }
      .roles input[type="number"]{ width:90px }

      /* Bảng phân vai: cho wrap nội dung */
      .assignments th, .assignments td{ padding:8px; font-size:13px; white-space:normal; word-break:break-word }
      .assignments td .btn{ padding:6px 10px }

      /* Bộ đếm thời gian */
      #timerMin, #timerSec{ width:90px !important }
      .card, .card *{ max-width:100% }
    }

    /* Thêm chút co lại cho màn rất nhỏ */
    @media (max-width:360px){
      .names{ grid-template-columns: 1fr }  /* 1 cột */
    }

    /* Co nhẹ header trên màn rất hẹp */
    @media (max-width:400px){
      header{ padding:12px 16px }
      header .title h1{ font-size:clamp(18px,4.8vw,30px) }
      .logo{ width:30px; height:30px }
    }

/* Mobile: đưa cụm nút xuống dưới input "Số người chơi", căn giữa và rút khoảng cách */
@media (max-width: 480px){

  /* hàng chứa input + cụm nút */
  .row.wrap{
    align-items:flex-end;
  }

  /* cụm 2 nút thành 1 hàng full-width, nằm dưới và căn giữa */
  .row.wrap > .row{
    flex: 0 0 100%;                 /* xuống dòng dưới */
    justify-content:center;         /* căn giữa 2 nút */
    margin-top: 6px;                /* rút khoảng cách */
    gap: 8px;                       /* nút sát hơn */
  }

  /* tinh gọn kích thước nút */
  #autoFillNames, #shuffleNames{
    padding:8px 12px;
    font-size:14px;
    min-width:unset;
  }

  /* input số người chơi không quá to */
  #playerCount{ max-width: 220px; }
}

/* Tinh chỉnh bảng “Danh sách phân vai” */
.assignments table th:nth-child(2),
.assignments table td:nth-child(2), /* Cột Tên người chơi */
.assignments table th:nth-child(3),
.assignments table td:nth-child(3)  /* Cột Vai trò */
{
  padding-left: 6px;        /* giảm padding trái */
  text-align: left;         /* căn thẳng lề trái */
}

/* Tuỳ chọn: chỉnh cột số thứ tự sát trái luôn */
.assignments table th:first-child,
.assignments table td:first-child{
  padding-left: 4px;
  text-align: center;
  width: 28px;              /* hẹp lại cột # */
}

/* Chỉnh lại cột Tiết lộ để cột Vai trò thoáng hơn */
.assignments table th:last-child,
.assignments table td:last-child {
  text-align: center;   /* căn giữa nút Ẩn/Hiện */
  width: 70px;          /* cố định chiều rộng hẹp lại */
  padding-left: 4px;
  padding-right: 4px;
}

/* Cột Vai trò dịch trái, không bị thụt */
.assignments table th:nth-child(3),
.assignments table td:nth-child(3) {
  padding-left: 6px;
  text-align: left;
}

/* Nút + Thêm vai trò -> xanh đồng bộ với "Hiện" và "Bắt đầu" */
#addCustomRole {
  background: #0d2a22 !important;   /* xanh đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;
}

/* Nút Mặc định -> xám tối hơn */
#resetRoles {
  background: #1a1c2b !important;   /* xám tối */
  border-color: #2a2d40 !important;
  color: #d1d5db !important;        /* chữ xám nhạt dễ đọc */
}

/* Gom ô nhập + 2 nút vào cùng hàng */
#playerCount {
  max-width: 100px;      /* thu nhỏ ô nhập */
  text-align: center;    /* canh giữa số */
}

/* Bố cục: input và 2 nút thẳng hàng */
#playerCount, 
#autoFillNames, 
#shuffleNames {
  display: inline-block;
  vertical-align: middle;
  margin-top: 0;         /* bỏ khoảng cách thừa */
}

#autoFillNames, #shuffleNames {
  padding: 8px 12px;
  font-size: 14px;
  margin-left: 6px;      /* cách nhẹ sang phải */
}

/* === Số người chơi + 2 nút nằm CÙNG HÀNG (mọi cỡ màn) === */
.row.wrap { align-items: flex-end; }

/* Đừng để .grow chiếm hết chiều ngang */
.row.wrap .grow{ 
  flex: 0 0 auto;          /* vừa đủ nội dung */
  margin-right: 8px;
}

/* Cụm hai nút ở ngay bên phải, không xuống dòng */
.row.wrap > .row{
  flex: 0 0 auto;
  gap: 8px;
  margin-top: 0;           /* bỏ khoảng cách thừa */
}

/* Bỏ wrapper + label rỗng của hai nút để canh thẳng hàng đẹp */
.row.wrap > .row > div{ display: contents; }
.row.wrap > .row label{ display: none; }

/* Thu nhỏ và canh giữa số người chơi */
#playerCount{ 
  width: 100px;            /* hoặc 110px tuỳ bạn */
  max-width: 100px;
  text-align: center;
}

/* Nút tinh gọn chút để vừa hàng */
#autoFillNames, #shuffleNames{
  padding: 8px 12px;
  font-size: 14px;
}

/* Fallback màu nền đặc khi gradient chưa kịp render */
html, body{
  background-color:#0a0f22;   /* trùng tông nền cuối của bạn */
}

/* Card dùng nền đặc (ít trong suốt) để không lộ nền trắng khi cuộn */
.card{
  background: var(--card) !important;         /* #141832 */
  /* Nếu muốn vẫn có cảm giác kính mờ:
  background: linear-gradient(180deg, rgba(20,24,50,.98), rgba(20,24,50,.96)) !important;
  */
}

/* Trên thiết bị di động: bỏ blur để tránh jank/flash trắng khi cuộn nhanh */
@media (max-width: 600px){
  header::before{
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    background: rgba(15,18,34,.60) !important; /* vẫn có lớp mờ tối */
  }
  header::after{ opacity:.6 !important; } /* nhẹ hiệu ứng sáng để giảm paint */
}

/* Đưa các khối lớn lên compositing layer để hạn chế checkerboard */
.container,
.card,
.assignments table{
  will-change: transform;
  transform: translateZ(0);
}

.assignments th,
.assignments td{ background-color: rgba(12,15,31,.98); }

/* Header của modal: căn tiêu đề bên trái, nút Đóng bên phải */
.modal header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 16px;           /* có thể giữ như cũ nếu bạn đã set */
  overflow: hidden;              /* giữ theo thiết kế ban đầu */
  border-radius: 12px 12px 0 0;  /* đảm bảo bo góc trên */
}

/* Tiêu đề co giãn và cắt ... khi dài */
#roleModalTitle{
  margin: 0;
  font-size: 18px;
  line-height: 1.2;
  flex: 1 1 auto;                /* chiếm phần còn lại */
  min-width: 0;                  /* để text-overflow hoạt động trong flex */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Nút Đóng giữ kích thước gọn và không xuống dòng */
.modal .close{
  flex: 0 0 auto;
  white-space: nowrap;
  margin-left: 8px;
}

/* Căn giữa 2 nút "Điền tên mặc định" và "Xáo trộn danh sách" */
.row.wrap > .row{
  flex: 0 0 100%;        /* chiếm toàn bộ chiều ngang */
  justify-content: center;
  margin-top: 6px;       /* khoảng cách nhẹ so với ô nhập số */
}

/* Nút "Điền tên mặc định" -> xám đậm */
#autoFillNames{
  background: #1a1c2b !important;   /* xám tối */
  border-color: #2a2d40 !important;
  color: #d1d5db !important;        /* chữ xám nhạt dễ đọc */
}

/* Nút "Xáo trộn tên" -> xanh (giống Hiện/Bắt đầu) */
#shuffleNames{
  background: #0d2a22 !important;   /* xanh đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;        /* chữ xanh nhạt */
}

/* Căn giữa label và ô nhập "Số người chơi" */
#playerCount{
  margin: 0 auto;        /* đưa input vào giữa */
  display: block;
  text-align: center;
}

label[for="playerCount"]{
  display: block;
  text-align: center;    /* căn chữ "Số người chơi" giữa */
}

/* === Căn giữa "Số người chơi" + input + 2 nút, chỉ ở hàng playerSetupRow === */
#playerSetupRow{
  align-items: flex-end;
  flex-wrap: wrap;
}

/* Label + input ở giữa, nằm trên cùng một cột */
#playerSetupRow .grow{
  flex: 0 0 100%;
  text-align: center;
}
#playerSetupRow label[for="playerCount"]{
  display: block;
  margin: 10px 0 6px;       /* tạo khoảng cách với dòng Mẹo */
}
#playerSetupRow #playerCount{
  display: block;
  margin: 0 auto;           /* giữa ngang */
  width: 110px;
  max-width: 110px;
  text-align: center;
}

/* Hai nút ở dòng dưới, căn giữa */
#playerSetupRow > .row{
  flex: 0 0 100%;
  justify-content: center;
  gap: 8px;
  margin-top: 6px;
}
/* bỏ label trống bọc nút */
#playerSetupRow > .row > div{ display: contents; }
#playerSetupRow > .row label{ display: none; }

/* Highlight theo phe – CHỈ khi đã bấm Hiện */
.assignments tr.revealed.hl-wolf    td { background: rgba(239,68,68,.10); }   /* Phe sói */
.assignments tr.revealed.hl-village td { background: rgba(59,130,246,.10); }  /* Phe dân */
.assignments tr.revealed.hl-flip    td { background: rgba(16,185,129,.10); }  /* Đổi phe */
.assignments tr.revealed.hl-third   td { background: rgba(234,179,8,.10); }   /* Phe 3 & custom */

/* --- Nút cho khu Ghi chú --- */
.notes-tools{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
.notes-tools .btn{ min-width:140px }

/* Ẩn vai trò: để TRỐNG, không blur, vẫn giữ chiều cao ô */
.assignments td.role.hidden{
  filter: none !important;
  opacity: 1 !important;
  color: transparent !important;
  text-shadow: none !important;
}

/* Highlight theo phe – CHỈ khi đã bấm Hiện */
.assignments tr.revealed.f-wolf  td { background: rgba(239,68,68,.10); }  /* Phe sói */
.assignments tr.revealed.f-vil   td { background: rgba(59,130,246,.10); } /* Phe dân */
.assignments tr.revealed.f-swap  td { background: rgba(16,185,129,.10); } /* Đổi phe */
.assignments tr.revealed.f-third td { background: rgba(234,179,8,.10); }  /* Phe 3 & custom */

/* ===== Chết / bị loại: tô đen đậm, đè lên mọi highlight ===== */
.assignments tr.dead td{
  background: #0a0c14 !important;   /* đen xanh đậm hơn (#0a0c14) */
  color: #8f97a8;                   /* chữ xám nhạt hơn để nổi bật */
}
.assignments tr.dead td .btn{
  opacity: .8;
  filter: brightness(0.9);          /* nút cũng tối đi chút */
}

/* Ẩn hiệu ứng trang trí gây tràn trên màn nhỏ / vừa */
@media (max-width: 1024px){
  .container::after{ display:none !important; }
}

/* Bảng/ô không tràn ngang */
.assignments table{
  table-layout: fixed;
  width: 100%;
}
.assignments th, .assignments td{
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* Giữ Phút + Giây cùng hàng */
#timerMin, #timerSec {
  width: 90px !important;     /* co nhỏ chút để chắc chắn vừa */
  min-width: 70px;            /* không nhỏ quá */
  display: inline-block;
}

#timerMin, #timerSec {
  box-sizing: border-box;
}

/* Bố cục hàng timer: ép không xuống dòng */
#timerMin, #timerSec {
  flex: 0 0 auto;             /* giữ cố định, không co kéo */
}

#timerSec {
  margin-left: 8px;           /* tạo khoảng cách với ô phút */
}

.timer-row {
  display: flex;
  flex-wrap: nowrap !important; /* ép luôn ngang */
  gap: 8px;
}

/* Làm ô "Chế độ" rộng hơn một chút */
#timerMode{
  width: 160px;          /* bạn có thể đổi 170–180px nếu thích */
  min-width: 150px;
  display: inline-block;
}

/* Căn CẢ 3 ô (Chế độ / Phút / Giây) vào chính giữa hàng */
.timer-row{
  display: flex;
  justify-content: center;   /* Ctrl + E */
  gap: 12px;                 /* khoảng cách giữa các ô */
}

/* Đừng để .grow đẩy lệch sang trái trong hàng timer */
.timer-row .grow{
  flex: 0 0 auto;            /* chỉ vừa nội dung */
  text-align: center;        /* label và select đều giữa */
}

/* Cho đẹp: căn giữa label + input của 2 cột Phút/Giây */
.timer-row > div{
  text-align: center;
}

/* Giữ Phút/Giây không xuống hàng (nếu bạn chưa có) */
#timerMin, #timerSec{
  width: 110px !important;
  min-width: 90px;
  flex: 0 0 auto;
}

/* Căn giữa 2 nút "Xóa tất cả" và "Soạn mẫu nhanh" */
.notes-tools{
  display: flex;
  justify-content: center;  /* Ctrl + E */
  gap: 12px;                /* khoảng cách giữa nút */
  margin: 8px 0 10px;
}

/* Cho các nút đồng đều */
.notes-tools .btn{
  min-width: 140px;
  text-align: center;
}

/* Chữ "– BỊ LOẠI" */
.assignments td .eliminated {
  color: #ff6b6b;       /* đỏ nhạt cảnh báo */
  font-weight: 600;
  margin-left: 6px;
  font-size: 0.9em;
  opacity: 0.9;
}

/* td giữ kiểu bảng, không flex */
.assignments td.name-cell{
  display: table-cell !important;   /* ép về table-cell để không phá layout */
  vertical-align: middle;
  padding-left: 6px;
}

/* wrapper bên trong chia 2 phía: Tên | – BỊ LOẠI */
.assignments td.name-cell .name-wrap{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  width: 100%;
  min-width: 0;
}

/* Tên cắt ... khi dài */
.assignments td.name-cell .player-name{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Nhãn – BỊ LOẠI */
.assignments td.name-cell .eliminated{
  color: #ff6b6b;
  font-weight: 700;
  font-size: .92em;
  white-space: nowrap;
  margin-left: 12px;
}

/* Chữ BỊ LOẠI nổi bật */
.assignments td .eliminated {
  color: #ff6b6b;
  font-weight: 600;
  font-size: 0.9em;
  white-space: nowrap;
}

/* td giữ kiểu bảng, không flex */
.assignments td.name-cell {
  vertical-align: middle;
  padding-left: 6px;  /* tuỳ chỉnh */
}

/* wrapper mới bên trong để chia 2 bên */
.assignments td.name-cell .name-wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  width: 100%;
  min-width: 0;
}

/* Tên bị cắt ... nếu dài */
.assignments td.name-cell .player-name {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Nhãn BỊ LOẠI */
.assignments td.name-cell .eliminated {
  color: #ff6b6b;
  font-weight: 700;
  font-size: .92em;
  white-space: nowrap;
  margin-left: 12px;
}

/* --- MOBILE HARDEN KIT: chống tràn & co giãn an toàn --- */

/* 1) Các item trong flex/grid mặc định được phép co lại */
.grid > *, .row > *, .section-title > *, .tools > *,
.roles .item > *, .assignments table th, .assignments table td {
  min-width: 0;
}

/* 2) Văn bản dài có thể xuống dòng & cắt ... khi cần */
:where(h1,h2,h3,h4,h5,p,div,span,button,td,th,label){
  overflow-wrap: anywhere;
  word-break: break-word;
  text-wrap: balance;        /* đẹp trên trình duyệt mới */
}

/* 3) Hình/ SVG không vượt chiều ngang */
img, svg, video, canvas { max-width: 100%; height: auto; }

/* 4) Không cho phần tử nào tạo thanh cuộn ngang ngoài ý muốn */
html, body, .container { overflow-x: hidden; }

/* 5) Header & container tôn trọng safe-area (tai thỏ iPhone) */
header {
  padding-left: calc(16px + env(safe-area-inset-left, 0px));
  padding-right: calc(16px + env(safe-area-inset-right, 0px));
}
.container {
  padding-left: calc(16px + env(safe-area-inset-left, 0px));
  padding-right: calc(16px + env(safe-area-inset-right, 0px));
}

/* 6) Vai trò (grid) luôn “lọt” màn – cho cột số lượng co nhỏ */
:root { --roles-cols: 1.1fr .8fr 110px auto; }
@media (max-width: 480px){
  :root { --roles-cols: 1fr .8fr 90px auto; }
  .roles input[type="number"]{ max-width: 90px; }
}

/* 7) Tên người chơi – lưới không tràn */
.names { grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); }
@media (max-width: 360px){ .names { grid-template-columns: 1fr; } }

/* 8) Bảng phân vai: cho phép wrap & ép cột nút hẹp hơn trên màn nhỏ */
.assignments table { table-layout: fixed; width: 100%; }
.assignments th, .assignments td { white-space: normal; }   /* cho xuống dòng khi cần */
@media (max-width: 420px){
  .assignments table th:last-child,
  .assignments table td:last-child { width: 60px; }          /* nút nhỏ hơn chút */
  .assignments td .btn{ padding:6px 8px; font-size:13px; }
}

/* 9) Hàng timer: co đều, không đẩy tràn */
.timer-row { flex-wrap: nowrap; gap: 8px; }
.timer-row > * { min-width: 0; }          /* cho phép co */
#timerMode, #timerMin, #timerSec { width: auto; }
@media (max-width: 360px){
  #timerMode{ min-width: 120px; }
  #timerMin, #timerSec{ min-width: 84px; }
}

/* 10) Nút dài/nhãn dài vẫn co gọn */
.btn { max-width: 100%; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }

/* 11) Trang trí nền không gây tràn (đã ẩn <=1024, nhưng chặn thêm) */
.container::after { pointer-events:none; max-width: 100dvw; }

/* 12) Trường hợp cực đoan (<340px): bọc bảng để không tạo tràn toàn trang */
@media (max-width: 340px){
  .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .table-wrap table{ min-width: 440px; }  /* chỉ cuộn ngang bên trong khi RẤT hẹp */
}

/* === Thu nhỏ ô nhập Phút & Giây === */
#timerMin,
#timerSec {
  width: 70px !important;    /* nhỏ hơn (trước bạn để 90–110px) */
  max-width: 80px;
  text-align: center;
  padding: 6px 8px;          /* giảm padding bên trong */
  font-size: 15px;           /* chữ nhỏ gọn vừa mắt */
}

/* Mobile: ép nhỏ hơn nữa nếu màn rất hẹp */
@media (max-width: 420px) {
  #timerMin,
  #timerSec {
    width: 60px !important;
    font-size: 14px;
  }
}

/* === Thu gọn cột Mô tả & Số lượng để nhường chỗ cho Vai trò === */
.roles {
  grid-template-columns: 1.2fr 0.6fr 80px auto; /* Vai trò | Mô tả | Số lượng | (xóa) */
  gap: 8px;
}

/* Ô nhập số lượng nhỏ lại */
.roles input[type="number"] {
  width: 70px !important;   /* gọn hơn (trước là 120px) */
  max-width: 80px;
  text-align: center;
  padding: 4px 6px;
  font-size: 15px;
}

/* Nút "Hiện" trong cột Mô tả */
.roles .item button {
  min-width: 70px;          /* nút nhỏ hơn */
  padding: 6px 10px;
  font-size: 14px;
  text-align: center;
}

/* Trên màn hẹp hơn 480px, ép nhỏ hơn nữa */
@media (max-width: 480px) {
  .roles {
    grid-template-columns: 1fr 0.6fr 60px auto;
  }
  .roles input[type="number"] {
    width: 60px !important;
    font-size: 14px;
  }
  .roles .item button {
    min-width: 60px;
    font-size: 13px;
    padding: 5px 8px;
  }
}

/* Căn giữa dòng ghi chú */
.hint {
  text-align: center;
}

/* Ẩn ô Mẹo ở các section bình thường, KHÔNG ẩn ở header vai trò */
.section-title:not(.roles-head) .chip {
  display: none !important;
}

/* ==== TIMER: 3 ô thẳng hàng, cao bằng nhau, không tràn phải ==== */

/* Bỏ mọi width cứng trước đó */
#timerMode,
#timerMin,
#timerSec{
  width: 100% !important;   /* để cột quyết định bề ngang */
  min-width: 0 !important;
  max-width: 100% !important;
}

/* ==== TIMER: 3 ô thẳng hàng, cao bằng nhau, Giây sát Phút ==== */
.timer-row{
  display: grid !important;
  grid-template-columns: minmax(160px,1fr) 80px 80px; /* chế độ | phút | giây */
  grid-template-areas: "mode min sec";
  column-gap: 8px;          /* khoảng cách chung */
  align-items: end;
}

.timer-row > div:nth-child(2){ grid-area: min; }
.timer-row > div:nth-child(3){ grid-area: sec; }

/* Thu hẹp khoảng cách giữa Phút và Giây */
.timer-row > div:nth-child(2),
.timer-row > div:nth-child(3){
  margin-right: 0;          /* không có dư bên phải */
}
.timer-row > div:nth-child(2){ margin-right: 4px; } /* chỉ cách nhẹ giữa Phút và Giây */

.timer-row select,
.timer-row input[type="number"]{
  height: 44px;
  padding: 10px 12px;
  border-radius: 12px;
  text-align: center;
  box-sizing: border-box;
}

.timer-row label{
  display:block;
  margin: 6px 2px;
  text-align:center;
}

/* Màn nhỏ */
@media (max-width: 400px){
  .timer-row{
    grid-template-columns: minmax(140px,1fr) 70px 70px;
    column-gap: 6px;        /* hẹp hơn nữa */
  }
  .timer-row select,
  .timer-row input[type="number"]{ height: 40px; font-size: 15px; }
}

/* Căn giữa nhãn + input của cột Giây */
.timer-row > div:nth-child(3) {
  text-align: center;    /* nhãn Giây căn giữa */
  justify-self: center;  /* ô nhập liệu Giây căn giữa theo cột */
}

/* Đảm bảo input không bị kéo lệch */
#timerSec {
  margin-left: 0 !important;
}
/* Màu viền theo phe khi đã chọn */
#customRoleFaction.f-village { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15); }
#customRoleFaction.f-wolf    { border-color:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
#customRoleFaction.f-swap    { border-color:#10b981; box-shadow:0 0 0 3px rgba(16,185,129,.15); }
#customRoleFaction.f-third   { border-color:#eab308; box-shadow:0 0 0 3px rgba(234,179,8,.15); }

/* ỦNG HỘ: xếp dọc – QR trên, info dưới, căn giữa */
.donate .wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}

/* QR vuông, bo góc, căn giữa */
.donate .qr{
  width:220px;            /* thích 180–240 tuỳ bạn */
  aspect-ratio:1/1;
  object-fit:contain;
  background:#0c0f1f;
  border:1px solid #283056;
  border-radius:12px;
  padding:8px;
}

/* Info bên dưới căn giữa */
.donate .info{ text-align:center; }

/* Mỗi dòng info là một hàng gọn */
.donate .row{ display:inline-flex; align-items:center; gap:8px; }
.donate .label{ color:var(--muted); font-weight:600; }

/* MB BANK ở giữa hàng */
.donate .bank-name{ font-weight:700; letter-spacing:.2px; }

/* Không xuống dòng cho SỐ TK / TÊN TK */
.donate .nowrap{ white-space:nowrap; }

@media (max-width:420px){
  .donate .qr{ width:180px; }
}

/* Promo handmade: ảnh trái, 2 dòng phải */
.donate-promo{
  display:flex; align-items:center; gap:12px;
  margin-top:12px;
  background:#0c0f1f; border:1px solid var(--border);
  border-radius:12px; padding:10px;
}
.donate-promo .promo-photo{
  width:140px; aspect-ratio:4/3; object-fit:cover;
  border-radius:10px; flex:0 0 auto;
}
.donate-promo .promo-text{ flex:1 1 auto; }
.donate-promo .promo-text p{ margin:0 0 6px; line-height:1.5; }
.donate-promo a{
  color:#dbeafe; text-decoration:underline;
  overflow-wrap:anywhere;
}

/* Nếu màn rất hẹp, vẫn giữ bố cục trái–phải gọn */
@media (max-width:420px){
  .donate-promo .promo-photo{ width:120px; }
  .donate-promo .promo-text p{ font-size:15px; }
}

/* Center + màu giống "NGÂN HÀNG TMCP QUÂN ĐỘI" */
.donate-promo .promo-text { text-align: center; }

.donate-promo .promo-title{
  margin: 0 0 6px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: var(--muted);          /* cùng màu label ngân hàng */
}

.donate-promo .promo-line{
  margin: 0;
  line-height: 1.5;
  text-align: center;
}

.donate-promo .promo-link{ margin: 6px 0 0; }
.donate-promo .promo-link a{
  color: var(--muted) !important; /* link trung màu với tiêu đề ngân hàng */
  text-decoration: underline;
}

/* Ảnh cao hơn một chút */
.donate-promo .promo-photo{
  width: 160px;
  height: 140px;               /* tăng chiều cao */
  aspect-ratio: auto !important;/* vô hiệu tỉ lệ cũ 4/3 */
  object-fit: cover;
  border-radius: 10px;
  flex: 0 0 auto;
}

@media (max-width: 420px){
  .donate-promo .promo-photo{
    width: 140px;
    height: 120px;
  }
}

/* Xếp dọc & căn giữa toàn bộ khối */
.donate-promo{
  display: flex;
  flex-direction: column;   /* <- đổi từ hàng sang cột */
  align-items: center;
  gap: 10px;
  text-align: center;       /* mọi dòng chữ căn giữa */
}

/* Dòng tiêu đề – đậm, cùng màu với “NGÂN HÀNG TMCP QUÂN ĐỘI” */
.donate-promo .promo-title{
  margin: 0;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: var(--muted);
}

/* Dòng mô tả dưới tiêu đề */
.donate-promo .promo-line{ margin: 0; line-height: 1.5; }

/* Ảnh: căn giữa và cao hơn chút */
.donate-promo .promo-photo{
  display: block;
  width: 240px;          /* có thể chỉnh 220–280 tuỳ thích */
  height: 160px;         /* “cao hơn xíu” */
  object-fit: cover;
  border-radius: 12px;
  margin: 4px auto 0;
}

/* Link: căn giữa + màu giống tiêu đề ngân hàng */
.donate-promo .promo-link{ margin: 0; }
.donate-promo .promo-link a{
  color: var(--muted) !important;
  text-decoration: underline;
  word-break: break-word;
}

@media (max-width: 420px){
  .donate-promo .promo-photo{ width: 210px; height: 145px; }
}

/* === Donate promo: tweak per request === */

/* 1) Tiêu đề: lớn hơn ~2 cỡ, giữ màu như "NGÂN HÀNG TMCP QUÂN ĐỘI" */
.donate-promo .promo-title{
  font-size: clamp(22px, 5.2vw, 24px); /* tăng size */
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: #ba0000;                 /* màu giống dòng ngân hàng */
  text-align: center;
  margin: 0;
}

/* 2) Dòng mô tả: căn giữa (Ctrl + E), đọc dễ hơn */
.donate-promo .promo-line{
  margin: 0 auto 6px;
  text-align: justify;                  /* căn giữa */
  max-width: 640px;                    /* giới hạn độ dài để dễ đọc */
  line-height: 1.6;
}

/* 3) Ảnh: rộng hơn một xíu */
.donate-promo .promo-photo{
  width: 280px;                        /* trước ~240px -> nới rộng */
  height: 180px;                       /* giữ tỉ lệ, có thể chỉnh 170–190 */
  object-fit: cover;
  border-radius: 12px;
  display: block;
  margin: 4px auto 0;                  /* luôn căn giữa */
}

/* Mobile vẫn to hơn chút nhưng vừa màn */
@media (max-width: 420px){
  .donate-promo .promo-photo{
    width: 260px;
    height: 172px;
  }
}

/* Link: đã căn giữa sẵn, giữ màu giống tiêu đề ngân hàng */
.donate-promo .promo-link{ margin: 0; text-align: center; }
.donate-promo .promo-link a{
  color: var(--muted) !important;
  text-decoration: underline;
  word-break: break-word;
}

/* --- Header "Thiết lập vai trò" gọn trên mobile --- */
@media (max-width: 560px){
  .section-title.roles-head{
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "title title"
      "slots total";
    row-gap: 8px;
    column-gap: 8px;
    align-items: end;
  }
  .section-title.roles-head h2{
    grid-area: title;
    margin: 0;
    white-space: nowrap;          /* giữ tiêu đề không xuống dòng */
  }
  /* 2 chip nằm hàng dưới, trái | phải */
  .section-title.roles-head .chip{
    grid-column: auto !important; /* ghi đè mọi grid-column cũ */
  }
  .section-title.roles-head .chip:first-of-type{  /* Còn trống */
    grid-area: slots;
    justify-self: start;
  }
  .section-title.roles-head .chip:last-of-type{   /* Tổng */
    grid-area: total;
    justify-self: end;
  }
}
/* Tiêu đề 2 dòng + 2 tim hai bên, tim nằm giữa hai dòng */
.donate-title{
  display:flex;
  align-items:center;          /* tim canh giữa theo chiều dọc khối 2 dòng */
  justify-content:center;
  gap:12px;
  margin:0 0 10px;
  text-align:center;
}
.donate-title .heart{
  font-size:22px;
  line-height:1;
}
.donate-title .lines{ line-height:1.25 }
.donate-title .line1{
  font-size:20px;
  font-weight:800;
}
.donate-title .line2{
  font-size:18px;
  font-weight:700;
  opacity:.95;
}
@media (max-width:420px){
  .donate-title .line1{ font-size:18px }
  .donate-title .line2{ font-size:16px }
}
/* Header "Thiết lập vai trò": title trái, 2 chip phải – luôn cùng hàng */
.section-title.roles-head{
  display: grid !important;
  grid-template-columns: 1fr auto !important; /* 2 cột: title | chips */
  align-items: center;
  gap: 8px;
}

.section-title.roles-head h2{
  margin: 0;
  white-space: nowrap;         /* không xuống dòng */
  overflow: hidden;
  text-overflow: ellipsis;     /* thiếu chỗ thì … */
  min-width: 0;                /* cho phép co */
}

/* Nhóm 2 chip đứng cạnh nhau */
.section-title.roles-head .chips{
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
.section-title.roles-head .chip{ white-space: nowrap; }

/* Mobile vẫn giữ 1 hàng, chỉ thu nhỏ khoảng cách/chữ nếu cần */
@media (max-width: 560px){
  .section-title.roles-head{ grid-template-columns: 1fr auto !important; }
  .section-title.roles-head .chips{ gap: 6px; }
  .section-title.roles-head h2{ font-size: 18px; }  /* tuỳ thích */
}
/* Header "Thiết lập vai trò": tiêu đề trái, 2 chip dạt phải */
.section-title.roles-head{
  display: flex !important;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
.section-title.roles-head h2{
  margin: 0;
  white-space: nowrap;         /* không xuống dòng */
  overflow: hidden;
  text-overflow: ellipsis;     /* thiếu chỗ thì … */
  flex: 1 1 auto;              /* nhường chỗ cho 2 chip bên phải */
  min-width: 0;
}
.section-title.roles-head .chip{
  flex: 0 0 auto;
  white-space: nowrap;
}
/* đẩy CẶP chip sang phải */
.section-title.roles-head .chip:first-of-type{
  margin-left: auto;
}

/* Ghi đè rule mobile cũ từng đẩy chip xuống dòng */
@media (max-width: 560px){
  .section-title.roles-head{
    display: flex !important;
    flex-wrap: nowrap !important;
  }
  .section-title.roles-head .chip:first-of-type{
    margin-left: auto !important;
  }
}
/* Dòng ngăn cách giữa các phe trong bảng vai trò */
.roles .sep{
  grid-column: 1 / -1;      /* chiếm cả 4 cột */
  text-align: center;
  color: #a5b4fc;
  opacity: .9;
  padding: 6px 0 2px;
  font-weight: 700;
  letter-spacing: .2px;
}

/* === Ghi chú: màu riêng cho 2 nút === */
#quickTemplateBtn{
  background: #0f1f3a !important;   /* xanh lam đậm */
  border-color: #244b8a !important;
  color: #dbeafe !important;
}
#quickTemplateBtn:hover{
  background: #152a57 !important;
  border-color: #2e60b3 !important;
}

#saveNotesBtn{
  background: #0d2a22 !important;   /* xanh lục đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;
}
#saveNotesBtn:hover{
  background: #123628 !important;
  border-color: #17604e !important;
}
/* Nút "Cứu" trong hàng đã bị loại: xanh lục + không mờ */
.assignments tr.dead td .btn{
  background: #0d2a22 !important;   /* xanh lục đậm */
  border-color: #13493b !important;
  color: #c7ffee !important;
  opacity: 1 !important;            /* bỏ làm mờ */
  filter: none !important;          /* bỏ giảm sáng */
}
.assignments tr.dead td .btn:hover{
  background: #123628 !important;
  border-color: #17604e !important;
}

@media (max-width: 480px){
  .promo-title{ font-size: clamp(22px, 5.4vw, 28px); } /* mobile to hơn */
}
/* === FAB '!!' mở bảng Thứ tự kêu dậy === */
.fab-night{
  position: fixed;
  right: 16px; 
  bottom: 16px;
  width: 56px; height: 56px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: linear-gradient(135deg, var(--accent) 0%, #5f44ff 100%);
  color: #fff; font-weight: 900; font-size: 20px;
  box-shadow: var(--shadow);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 1000;
}
.fab-night:hover{ transform: translateY(-1px); }

/* Thân modal nội dung 'Thứ tự kêu dậy' */
#nightOrderBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.7;
  white-space: normal;                 /* dùng danh sách, không cần pre-wrap */
}
#nightOrderBody .intro{ color:#c7cfff; margin: 0 0 8px }
#nightOrderBody ol{ margin: 6px 0 10px; padding-left: 1.4em }
#nightOrderBody li + li{ margin-top: 4px }
#nightOrderBody .note{ opacity:.9; font-size:.95em }
#nightOrderBody .sub{ color:#a5b4fc; font-size:.95em; margin:.25em 0 .5em }
#nightOrderBody .section{
  text-align:center; margin:10px 0 6px; color:var(--muted); font-weight:700
}

/* Ẩn khi in */
@media print{ .fab-night{ display:none !important } }
/* Cho thân modal cuộn khi nội dung dài */
.modal{
  width: min(720px, 95vw);
  max-height: calc(100dvh - 32px);
  display: flex;
  flex-direction: column;
}
.modal header{
  flex: 0 0 auto;
}
.modal .content{
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto !important;            /* <- cho phép cuộn */
  -webkit-overflow-scrolling: touch;    /* mượt trên mobile */
}
/* Modal 'Thứ tự kêu dậy' — căn giữa 2 dòng mở đầu */
#nightOrderBody .intro{
  color:#c7cfff;
  margin:0 0 8px;
  text-align:center;            /* căn giữa */
  text-wrap:balance;
}

/* Mục số 4 của danh sách đầu tiên: căn đều (Ctrl+J) */
#nightOrderBody ol:first-of-type > li:nth-child(4){
  text-align: justify;
  text-justify: inter-word;
  hyphens: auto;
}

/* Dòng phụ bên trong mục 4 vẫn căn trái bình thường */
#nightOrderBody ol:first-of-type > li:nth-child(4) .sub{
  text-align: left;
}
/* Mục 4: 2 dòng .sub căn giữa + đỏ + đậm */
#nightOrderBody ol:first-of-type > li:nth-child(4) .sub{
  text-align: center !important;
  color: var(--danger, #ef4444) !important; /* đỏ đồng bộ theme */
  font-weight: 700 !important;
}
/* Đỏ + đậm cho dòng "Kêu dậy 1 lần đêm đầu tiên ..." trong modal */
#nightOrderBody .section{
  color: var(--danger, #ef4444) !important;
  font-weight: 800 !important;
}
/* Thu nhỏ header 2 modal: Kho lưu trữ & Thứ tự kêu dậy */
#notesArchiveModal header,
#nightOrderModal header{
  padding: 12px 16px;     /* cùng padding như modal mô tả vai */
}

/* H3 không còn margin mặc định -> header thấp lại đúng bằng nhau */
#notesArchiveModal header h3,
#nightOrderModal header h3{
  margin: 0;              /* quan trọng: bỏ top/bottom margin mặc định */
  font-size: 18px;        /* đồng bộ kích thước */
  line-height: 1.2;
}

/* Nút đóng gọn lại một chút cho cân đối (tuỳ chọn) */
#notesArchiveModal .close,
#nightOrderModal .close{
  padding: 6px 10px;
  font-size: 14px;
  line-height: 1.2;
}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="top-row">
        <div class="logo" aria-hidden="true">
          <img src="https://play-lh.googleusercontent.com/NoTmMzso2UYOdoaLcADzE6eRnZaKpfz_gTcFsJMBQyLB09Q_J8I0aLWRlTi6RZpTdO33" alt="Logo Sói">
        </div>
        <h1>Trợ Thủ Quản Trò 🐺🎲</h1>
      </div>
      <div class="chip" title="Dữ liệu được lưu tự động trong trình duyệt">Created by Dang Khoa ❤️</div>
    </div>
  </header>

  <div class="container grid">
    <!-- LEFT: SETUP + ASSIGNMENT -->
    <section class="card">
      <div class="section-title">
        <h2>👤 Thiết lập người chơi</h2>
        <div class="chip">Mẹo: <span class="kbd">Tab</span> để chuyển nhanh giữa các ô tên trên máy tính.</div>
      </div>

      <div class="row wrap" id="playerSetupRow">
        <div class="grow">
          <label for="playerCount">Số người chơi</label>
          <input id="playerCount" type="number" min="3" max="151" value="10" />
        </div>
        <div class="row" style="gap:8px; align-items:flex-end">
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="autoFillNames">Điền tên mặc định</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="shuffleNames">Xáo trộn danh sách</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn danger" id="removeEmptyNames">Xóa tên người chơi</button>
          </div>
        </div>
      </div>

      <label>Danh sách tên người chơi</label>
      <div id="names" class="names"></div>

      <hr style="border-color:#28305633; margin:16px 0">

      <!-- Header khu vai trò -->
      <div class="section-title roles-head">
  <h2>🃏 Thiết lập vai trò</h2>
  <div class="chips">
    <div class="chip">Trống: <b id="slotsLeft">0</b></div>
    <div class="chip">Tổng: <b id="rolesTotal">0</b></div>
  </div>
</div>

      <div class="roles" role="table" aria-label="Bảng vai trò">
        <div class="header">Vai trò</div>
        <div class="header">Mô tả</div>
        <div class="header">Số lượng</div>
        <div class="header">&nbsp;</div>
        <div id="rolesList"></div>
      </div>

      <div class="row wrap" style="margin-top:8px" id="customRoleRow">
        <div class="grow row">
          <input id="customRoleName" type="text" placeholder="Thêm vai trò mới (ví dụ: Bị nguyền rủa)" />
          <input id="customRoleCount" type="number" min="1" value="1" />
<select id="customRoleFaction" title="Chọn phe cho vai trò">
    <option value="" selected disabled>— Chọn phe —</option>
    <option value="village">Dân làng</option>
    <option value="wolf">Ma sói</option>
    <option value="swap">Đổi phe</option>
    <option value="third">Phe thứ 3</option>
  </select>
        </div>
        <div id="customRoleActions" class="row">
          <button class="btn" id="addCustomRole">+ Thêm vai trò</button>
          <button class="btn ghost" id="resetRoles" title="Đưa vai trò về mặc định">Mặc định: 10👤</button>
        </div>
      </div>

      <div class="hint" style="margin:6px">Nếu tổng vai trò vượt quá số người, bạn sẽ được nhắc điều chỉnh. Ô trống sẽ tự lấp bằng vai trò <b>Dân làng</b>.</div>

      <div class="tools no-print" style="margin-top:12px">
        <button class="btn primary" id="assignBtn">🎲 Chia vai trò ngẫu nhiên</button>
        <button class="btn" id="reshuffleBtn" disabled>🔀 Trộn lại</button>
        <button class="btn" id="revealAllBtn" disabled>👁️‍🗨️ Hiện/Ẩn tất cả</button>
        <button class="btn" id="copyBtn" disabled>📋 Sao chép</button>
        <!-- Đổi nút In thành nút Sắp xếp -->
        <button class="btn" id="sortBtn" disabled>↕️ Sắp xếp</button>
      </div>

      <div class="assignments" id="assignments" style="margin-top:8px"></div>
    </section>

    <!-- RIGHT: TIMER + NOTES -->
    <aside class="card">
      <div class="section-title">
        <h2>⏳️ Bộ đếm thời gian</h2>
        <div class="row">
          <label class="chip" style="cursor:pointer"><input id="soundToggle" type="checkbox" checked style="margin-right:8px">Chuông</label>
        </div>
      </div>

      <div class="row wrap timer-row">
  <div class="grow">
    <label>Chế độ</label>
    <select id="timerMode">
      <option value="down">Đếm ngược</option>
      <option value="up">Đếm xuôi</option>
    </select>
  </div>
  <div>
    <label>Phút</label>
    <input id="timerMin" type="number" min="0" value="2">
  </div>
  <div>
    <label>Giây</label>
    <input id="timerSec" type="number" min="0" max="59" value="0">
  </div>
</div>

      <div class="timer-big" id="timerDisplay">02:00</div>
      <div class="timer-controls no-print">
        <button class="btn ok" id="startPauseBtn">▶︎ Bắt đầu</button>
        <button class="btn" id="resetTimerBtn">⟲ Đặt lại</button>
        <button class="btn" data-preset="30">Biện hộ (30s)</button>
        <button class="btn" data-preset="120">Thảo luận (2’)</button>
        <button class="btn" data-preset="180">Thảo luận (3’)</button>
        <button class="btn" data-preset="300">Thảo luận (5’)</button>
      </div>

      <hr style="border-color:#28305633; margin:18px 0">

      <h2>🗒️ Ghi chú</h2>
      <!-- Nút mới cho ghi chú -->
      <div class="notes-tools no-print">
        <button class="btn danger" id="clearNotesBtn">🗑️ Xóa tất cả</button>
        <button class="btn" id="quickTemplateBtn">✍️ Soạn mẫu nhanh</button>
        <button class="btn" id="saveNotesBtn">💿️ Lưu</button>
        <button class="btn" id="openArchiveBtn">📁 Kho lưu trữ</button>
      </div>
      <textarea id="notes" placeholder="Ghi chú: ai bị treo cổ, ai bị sói cắn, lá phiếu, v.v."></textarea>

<!-- ỦNG HỘ TÔI -->
<div class="donate no-print">
  <div class="donate-title" role="heading" aria-level="2">
  <div class="lines">
    <div class="line1">❤ ỦNG HỘ TÔI VÀI GÓI MÌ TÔM ❤</div>
    <div class="line2">(nếu bạn muốn)</div>
  </div>
</div>
  <div class="wrap">
    <!-- NHỚ đúng đuôi file: .jpg (hoặc link raw GitHub) -->
    <img class="qr" src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/qr.jpg" alt="QR MB Bank 0332807382">

    <div class="info">
      <div class="row bank-row">
        <span class="label">NGÂN HÀNG TMCP QUÂN ĐỘI</span>
        <span class="bank-name">- MB BANK</span>
      </div>
      <div class="row nowrap">
        <span class="label">SỐ TK:</span><span class="value">0332807382</span>
      </div>
      <div class="row nowrap">
        <span class="label">TÊN TK:</span><span class="value">NGUYEN DINH DANG KHOA</span>
      </div>
    </div>
  </div>
<div class="donate-promo">
  <div class="promo-text">
    <p class="promo-title">❤ HOẶC ỦNG HỘ BẰNG CÁCH ❤</p>
    <p class="promo-line">Order các đồ len Handmade siêu xinh và cực kì đáng iu với giá cả vô cùng yêu thương ở link Facebook phía dưới:</p>
  </div>

  <!-- ẢNH: căn giữa -->
  <img class="promo-photo" src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/pr.png" alt="Đồ len handmade dễ thương">

  <!-- LINK: căn giữa + màu như tiêu đề ngân hàng -->
  <p class="promo-link">
    <a href="https://www.facebook.com/phuoc.hanh.543792" target="_blank" rel="noopener">
      facebook.com/phuoc.hanh.543792
    </a>
  </p>
</div>
  </div>
</div>

    </aside>
  </div>

  <div class="footer no-print">Created by Dang Khoa ❤️ – Lưu tự động, hoạt động offline.</div>
  <div class="footer no-print">Phiên bản cập nhật mới nhất: 00:50 17/09/2025</div>
  <!-- Modal xem mô tả vai -->
  <div id="roleModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <h3 id="roleModalTitle">Vai trò</h3>
        <button class="close" id="roleModalClose">Đóng</button>
      </header>
      <div class="content" id="roleModalBody"></div>
    </div>
  </div>

<!-- Modal kho lưu ghi chép -->
<div id="notesArchiveModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="notesArchiveTitle">📁 Kho lưu trữ</h3>
      <button class="close" id="notesArchiveClose">Đóng</button>
    </header>
    <div class="content" id="notesArchiveBody">
      <!-- Nội dung render bằng JS -->
    </div>
  </div>
</div>
<!-- NÚT '!!' nổi -->
<button class="fab-night no-print" id="nightOrderBtn" aria-label="Thứ tự kêu dậy">!!</button>

<!-- Modal: Thứ tự kêu dậy -->
<div id="nightOrderModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="nightOrderTitle">🌙 Thứ tự kêu dậy mỗi đêm</h3>
      <button class="close" id="nightOrderClose">Đóng</button>
    </header>
    <div class="content" id="nightOrderBody"></div>
  </div>
</div>
<script>
(function(){
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const $ = {
    playerCount: qs('#playerCount'),
    namesWrap: qs('#names'),
    autoFillNames: qs('#autoFillNames'),
    shuffleNames: qs('#shuffleNames'),
    removeEmptyNames: qs('#removeEmptyNames'),
    rolesList: qs('#rolesList'),
    slotsLeft: qs('#slotsLeft'),
    addCustomRole: qs('#addCustomRole'),
    customRoleName: qs('#customRoleName'),
    customRoleCount: qs('#customRoleCount'),
    resetRoles: qs('#resetRoles'),
    customRoleFaction: qs('#customRoleFaction'),

    assignBtn: qs('#assignBtn'),
    reshuffleBtn: qs('#reshuffleBtn'),
    revealAllBtn: qs('#revealAllBtn'),
    copyBtn: qs('#copyBtn'),
    sortBtn: qs('#sortBtn'),
    assignments: qs('#assignments'),

    // Timer
    timerMode: qs('#timerMode'),
    timerMin: qs('#timerMin'),
    timerSec: qs('#timerSec'),
    timerDisplay: qs('#timerDisplay'),
    startPauseBtn: qs('#startPauseBtn'),
    resetTimerBtn: qs('#resetTimerBtn'),
    soundToggle: qs('#soundToggle'),

    // Notes buttons
    clearNotesBtn: qs('#clearNotesBtn'),
    quickTemplateBtn: qs('#quickTemplateBtn'),
    saveNotesBtn: qs('#saveNotesBtn'),        
    openArchiveBtn: qs('#openArchiveBtn'),
  };

// --- Auto sort sau khi "Giết"
let autoSortTimer = null;
function scheduleAutoSort(){
  clearTimeout(autoSortTimer);
  autoSortTimer = setTimeout(() => {
    sortAssignmentsByFactionThenRole();
    alert('Tự động sắp xếp các người chơi bị loại xuống cuối danh sách.');
  }, 10000); // 10 giây
}

  // ===== Modal helpers =====
  const modal = {
    wrap: document.getElementById('roleModal'),
    title: document.getElementById('roleModalTitle'),
    body: document.getElementById('roleModalBody'),
    btnClose: document.getElementById('roleModalClose'),
    open(title, text){
      this.title.textContent = title || 'Vai trò';
      this.body.textContent = text || '';
      this.wrap.classList.add('show');
      this.wrap.setAttribute('aria-hidden','false');
      this.btnClose.focus();
    },
    close(){ this.wrap.classList.remove('show'); this.wrap.setAttribute('aria-hidden','true'); }
  };
  modal.btnClose.addEventListener('click', ()=>modal.close());
  modal.wrap.addEventListener('click', (e)=>{ if(e.target === modal.wrap) modal.close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') modal.close(); });

  // ====== STATE ======
  const STORAGE_KEY = 'werewolf_mod_state_v1';
  let STATE = {
    playerCount: 10,
    names: [],
    roles: {},          // {key: count}
    customRoles: {},    // {name: count}
    assignments: null,
    reveal: {},         // {index: bool}
    dead: {},
    notes: '',
    notesArchive: [],   // mảng các bản lưu {id, timeISO, content}
    notesSaveSeq: 0,    // số lần đã lưu (đánh số #)
    timer: {mode:'down', min:2, sec:0, running:false, left:120, sound:true},
  };

  // Default roles
  const DEFAULT_ROLES = [
    { key:'cupid', name:'💘 Cupid', hint:'Thức dậy vào đêm đầu tiên và chọn ra 2 người chơi để ghép đôi( được phép chọn cả mình). Hai người được chọn sẽ thức dậy, nhận diện và trao đổi vai trò cho nhau nhưng không biết ai là người ghép đôi( trừ khi chính Cupid chọn bản thân là người được ghép đôi). Nếu một trong hai người này chết, người còn lại cũng sẽ chết theo. Nếu ghép trúng 2 phe trái nhau thì 2 người chơi sẽ trở thành phe thứ 3 hoàn toàn mới và dành chiến thắng khi họ là người cuối cùng còn sống sót.', color:'#10b981' },
    { key:'werewolf', name:'🐺 Ma sói', hint:'Vào mỗi đêm, Ma sói sẽ tỉnh dậy cùng nhau và thống nhất giết 1 người chơi. Bầy sói có thể không giết người nào và không được giết sói khác. Ma sói chiến thắng khi số Dân làng < hoặc = số Ma sói và không còn Sói trắng.', color:'#ef4444' },
    { key:'werecub', name:'🐺 Sói con', hint:'Sói con thức dậy cùng bầy sói mỗi đêm. Nếu Sói con bị giết, Ma sói còn lại sẽ giết 2 người vào đêm hôm sau. Bầy sói có thể chọn giết Sói con như 1 sự hy sinh( Tất cả bầy sói bao gồm cả Sói con đều đồng ý việc đó). Khi đó bầy sói có thể lập tức giết 2 người chơi khác vào ngay đêm hôm đó.', color:'#ef4444' },
    { key:'minion', name:'🎭️ Phản bội', hint:'Phản bội thức dậy cùng bầy sói. Tham gia cùng bầy sói để giết Dân làng. Tuy nhiên Tiên tri khi soi vào phản bội thì vẫn ra Dân làng.', color:'#ef4444' },
    { key:'seer', name:'🔮 Tiên tri', hint:'Mỗi đêm, Tiên tri chỉ tay vào một người. Quản trò sẽ cho biết người đó có phải là Ma sói hay không.', color:'#3b82f6' },
    { key:'witch', name:'🧙‍♂️ Phù thuỷ', hint:'Phù thủy sẽ có hai bình thuốc. Một bình thuốc để cứu 1 người và một bình thuốc để giết 1 người. Trong đêm, Quản trò sẽ cho biết ai sẽ bị giết trong đêm và hỏi xem Phù thủy có muốn sử dụng quyền năng nào hay không. Có thể dùng cả hai bình thuốc này vào cùng 1 đêm, nhưng mỗi bình chỉ dùng một lần.', color:'#3b82f6' },
    { key:'hunter', name:'🏹 Thợ săn', hint:'Nếu Thợ săn chết, hắn lập tức được phép nhắm vào một người và người này sẽ bị chết. Nếu Thợ săn chết trong đêm, Quản trò sẽ đụng vai để báo cho Thợ săn nhắm bắn.', color:'#3b82f6' },
    { key:'guard', name:'🛡️ Bảo vệ', hint:'Mỗi đêm, Bảo vệ chọn một người khác nhau để bảo vệ. Người chơi này sẽ bất tử vào đêm đó (nhưng không thể bảo vệ khỏi Phù thủy).', color:'#3b82f6' },
    { key:'spellcaster', name:'🔇 Nguyệt nữ', hint:'Mỗi đêm, Nguyệt nữ sẽ được phép chỉ định 1 người bị câm vào hôm sau. Người này vào ngày hôm sau sẽ không được nói (nếu người bị câm lỡ nói thì sẽ bị loại ngay lập tức). ', color:'#3b82f6' },
    { key:'doppelganger', name:'👥 Nhân bản', hint:'Vào đêm đầu tiên, Nhân bản tỉnh dậy và lựa chọn một người chơi. Nếu người chơi kia chết, Nhân bản sẽ bí mật lấy chức năng của người đó. Trước khi có chức năng mới, Nhân bản theo phe dân. Sau khi có chức năng mới, Nhân bản theo phe của chức năng này. ', color:'#10b981' },
    { key:'cursed', name:'🌑 Bị nguyền', hint:'Bị nguyền ban đầu là người, Tiên tri soi cũng ra người. Nếu Bị nguyền bị Ma sói cắn thì sẽ không chết, mà từ đêm tiếp theo sẽ biến thành Ma sói, đồng thời nếu Tiên tri sói thì cũng sẽ là Sói. Bị nguyền mỗi đêm được gọi dậy riêng biệt, kể cả sau khi hóa Sói, để cho người này biết đã bị hóa Sói hay chưa. ', color:'#10b981' },
    { key:'tanner', name:'😓 Chán đời', hint:'Chán đời chỉ thắng khi anh ta bị treo cổ vào ban ngày. Các điều kiện thắng khác cũng được áp dụng. Chức năng này đi chung với lá bài Yêu hòa bình.', color:'#eab308' },
    { key:'village', name:'👨🏻‍🌾 Dân làng', hint:'Không có tính năng đặc biệt nào cả, ngủ suốt đêm và tham gia biểu quyết tìm Ma sói vào ban ngày. ', color:'#3b82f6' },
    { key:'prince', name:'👑 Hoàng tử', hint:'Hoàng tử không thể bị treo cổ chết. Vào lần bị vote chết và chuẩn bị treo cổ, người này sẽ lật lá bài lên để mọi người được thấy và không phải chịu treo cổ. Tất cả người chơi lập tức đi ngủ. ', color:'#3b82f6' },
    { key:'elder', name:'👴 Già làng', hint:'Già làng có 2 mạng sống. Nếu chết cả 2 lần thì các quyền năng (Tiên tri, Bảo vệ,…) của nhân vật khác sẽ mất đi trong 2 đêm.', color:'#3b82f6' },
    { key:'tough guy', name:'💪 Lực sĩ', hint:'Nếu bị Ma sói cắn, Lực sĩ sẽ chết vào đêm tiếp theo chứ không phải ngay tại đêm đó.', color:'#3b82f6' },
    { key:'mayor', name:'⭐ Thị trưởng', hint:'Phiếu biểu quyết của Thị trưởng được tính là 2 phiếu khi biểu quyết treo cổ.', color:'#3b82f6' },

{ key:'pssoi', name:'☄️ Pháp sư sói', hint:'Vào mỗi đêm, Pháp sư sói thức dậy và sẽ đi tìm kiếm Tiên tri bằng cách chỉ thị một người, Quản trò sẽ cho biết đó có phải là Tiên tri hay không. Ma sói không được biết Pháp sư sói là ai và Pháp sư sói cũng không biết Ma sói là ai. Tiên tri sẽ soi Pháp sư sói là người.', color:'#ef4444' },
{ key:'scuong', name:'💢 Sói cuồng', hint:'Một lần trong trò chơi, kể từ đêm thứ hai, Sói cuồng có thể sử dụng chức năng cuồng nộ. Khi bầy sói ở trạng thái cuồng nộ người bị bầy sói giết không thể sống sót( các lượt bảo vệ không phải từ Hiệp sĩ thì không thể ngăn chặn).', color:'#ef4444' },
{ key:'soidc', name:'☠️ Sói đại ca', hint:'Thức dậy cùng Ma sói. Chừng nào Sói đại ca còn tồn tại trong trò chơi thì mỗi đêm phe Ma sói có thể giết hai người chơi, miễn là hai người chơi đó ngồi cạnh nhau. Tuy nhiên phe Ma sói sẽ không biết ai là Sói đại ca. Đêm đầu tiên, Sói đại ca sẽ thức dậy một mình để cho Quản trò biết được người đó là ai.', color:'#ef4444' },
{ key:'soituyet', name:'❄️ Sói tuyết', hint:'Sói tuyết thức dậy cùng các Sói khác. Đêm đầu tiên thức dậy, Sói tuyết lựa chọn một người chơi khác làm bạn đồng hành. Nếu Sói tuyết chết người chơi đó cũng chết theo. Nếu người chơi đó chết thì Sói tuyết không chết.', color:'#ef4444' },
{ key:'alpha', name:'🌕 Sói đầu đàn', hint:'Một lần trong trò chơi, sau cái chết của một Ma sói khác vào ban ngày, vào đêm tiếp theo, Sói đầu đàn(Alpha) có thể biến mục tiêu của phe Ma Sói thành Ma sói thay vì bị giết. Nếu người chơi này được bảo vệ bởi một nguyên nhân nào đó thì vết cắn của Sói đầu đàn sẽ không có tác dụng. Khi đó Sói đầu đàn sẽ được cắn thêm một lần khác vào đêm sau.', color:'#ef4444' },
{ key:'acmong', name:'🎃 Ác mộng', hint:'Một lần trong trò chơi, vào ban đêm, Sói ác mộng có thể gieo cơn ác mộng cho một người chơi và khiến chức năng của người đó bị vô hiệu trong đêm.', color:'#ef4444' },
{ key:'hbi', name:'✨ Huyền Bí', hint:'Mỗi đêm, Tiên tri Huyền bí sẽ tỉnh dậy và chỉ định một người. Quản trò sẽ cho Tiên tri Huyền bí biết chính xác người chơi này là chức năng gì.', color:'#3b82f6' },
{ key:'dbom', name:'💣️ Đánh bom', hint:'Nếu Đánh bom  bị loại, thì hai người chơi bên trái và phải của người chơi này sẽ cùng bị loại (không tính những người chơi đã bị loại rồi).', color:'#3b82f6' },
{ key:'tvan', name:'🔭 Thiên văn', hint:'Mỗi đêm, Thiên văn sẽ tỉnh dậy và có thể chỉ vào một người chơi để gọi mưa sao băng. Nếu người chơi đó là Ma sói, người đó sẽ bị loại. Nếu không, Thiên văn sẽ bị loại.', color:'#3b82f6' },
{ key:'lgac', name:'⚔️ Lính gác', hint:'Một lần trong trò chơi, kể từ sáng thứ hai, Lính gác có thể chỉ định giết một người chơi nếu nghi ngờ. Nhưng vai trò của bạn sẽ bị tiết lộ khi giết người chơi khác.', color:'#3b82f6' },
{ key:'gsu',  name:'👨‍🏫 Giáo sư', hint:'Mỗi Đêm, Giáo sư tỉnh dậy và chỉ định hai người chơi. Quản trò sẽ cho biết hai người chơi này có cùng phe với nhau hay không.', color:'#3b82f6' },
{ key:'tsu', name:'🔮 Tập sự', hint:'Nếu Tiên tri chết, Tiên tri Tập sự sẽ trở thành Tiên tri mới. Tiên tri Tập sự được thông báo trong đêm, vào lượt gọi Tiên tri, Quản trò đụng vào vai của Tiên tri Tập sự để gọi dậy.', color:'#3b82f6' },
{ key:'hquang', name:'🧿 Hào quang', hint:'Tiên tri Hào quang thức dậy mỗi đêm để kiểm tra người chơi có chức năng hay không, trường hợp không có chức năng là Dân thường và Sói thường.', color:'#3b82f6' },
{ key:'nbenh', name:'🤒 Người bệnh', hint:'Nếu Người bệnh bị Ma sói cắn, thì Ma sói sẽ không thể cắn người nào vào đêm tiếp theo do bị bệnh.', color:'#3b82f6' },
{ key:'cma', name:'👻 Con ma', hint:'Con ma bị chết ngay vào đêm đầu tiên. Mỗi đêm( bao gồm cả đêm đầu tiên), Con ma có thể liên hệ với những người chơi khác bằng cách viết 1 chữ lên 1 tờ giấy nhưng không được viết tên hay viết tắt tên, mà thay vào đó là đưa ra các gợi ý thú vị.', color:'#3b82f6' },
{ key:'hbinh', name:'🤝 Hòa bình', hint:'Một lần trong trò chơi, Người yêu hòa bình ngăn chặn một lần biểu quyết treo cổ. Quản trò sẽ để ý hành động biểu quyết của bạn.', color:'#3b82f6' },
{ key:'ttu', name:'🕵‍♂ Thám tử', hint:'Một lần trong trò chơi, vào ban đêm, Thám tử sẽ được gọi dậy và được phép chọn 1 một người. Quản trò sẽ cho Thám tử biết người đó hoặc hai người bên cạnh người đó có phải là Ma sói hay không.', color:'#3b82f6' },
{ key:'hsi', name:'💂‍♂ Hiệp sĩ', hint:'Một lần trong trò chơi, vào ban đêm, Hiệp sĩ có thể chọn một người chơi để được bảo vệ. Người chơi này sẽ bất tử vào tất cả các đêm. Chỉ bị loại bởi các lí do vào ban ngày. ( như bị treo cổ).', color:'#3b82f6' },
{ key:'blang', name:'🐆 Báo làng', hint:'Mỗi đêm, Quản trò sẽ hỏi “Báo làng có muốn quậy phá không?”. Nếu đồng ý, Báo làng sẽ tỉnh dậy và ra hiệu bằng cách gật đầu. Ngày hôm sau, sẽ có 2 lượt biểu quyết treo cổ. Báo làng chỉ thực hiện được 1 lần quậy phá trong suốt cả ván chơi.', color:'#3b82f6' },
{ key:'gchu', name:'🦹 Giáo chủ', hint:'Mỗi đêm, Giáo chủ sẽ phải tỉnh dậy và thêm 1 người chơi vào giáo phái của mình. Nếu tất cả những người còn sống đều là người của giáo phái mình, Giáo chủ sẽ là người chiến thắng. Các điều kiện thắng khác cũng được áp dụng.', color:'#eab308' },
{ key:'dgau', name:'🐻 Đầu gấu', hint:'Vào đêm thứ hai, Đầu gấu dụ dỗ hai người chơi. Nếu người bị dụ đồng ý bằng cách gật đầu thì thức dậy và trở thành đồng bọn của đầu gấu. Nếu chỉ còn một mình đầu gấu thì đầu gấu được giết một người vào mỗi đêm( không được giết người chơi khác vào đêm đầu tiên) hoặc tiếp tục dụ dỗ một người khác( lần cuối). Và chiến thắng cùng đồng bọn khi họ là những người chơi cuối cùng.', color:'#eab308' },
{ key:'mcr', name:'🧛 Ma cà rồng', hint:'Là 1 thế lực mạnh thứ 3 ngoài phe Ma sói và phe Dân làng. Mỗi đêm, Ma cà rồng sẽ chọn 1 người chơi là nạn nhân. Nếu nạn nhân của Ma cà rồng bị từ 2 người chơi trở lên( không tính Ma cà rồng) nghi ngơ  trong cuộc thảo luận ở buổi sáng thì nạn nhân sẽ chết khi đến giờ biểu quyết. Ma cà rồng không thể bị giết bởi Ma sói vào ban đêm( trừ Sói trắng).', color:'#eab308' },
{ key:'strang', name:'🐺 Sói trắng', hint:'Sói trắng thức dậy cùng bầy sói và tham gia cùng bầy sói để giết dân làng. Sau đó, Sói trắng sẽ thức dậy thêm một lần nữa để tiếp tục chọn mục tiêu để giết. Sói trắng dành chiến thắng khi còn lại cuối cùng.', color:'#eab308' },
  ];

// Chuẩn hoá dữ liệu customRoles: cho phép dạng {name:{count,faction}}
function normalizeCustomRoles(){
  const cr = STATE.customRoles || {};
  const fixed = {};
  Object.entries(cr).forEach(([name, val])=>{
    if (typeof val === 'number') {
      fixed[name] = { count: val, faction: 'third' }; // mặc định phe 3 cho dữ liệu cũ
    } else {
      const c = Number(val.count||0);
      fixed[name] = { count: c, faction: val.faction || 'third' };
    }
  });
  STATE.customRoles = fixed;
}

function paintFactionSelect(){
  const sel = $.customRoleFaction;
  if (!sel) return;
  sel.classList.remove('f-village','f-wolf','f-swap','f-third');
  const map = { village:'f-village', wolf:'f-wolf', swap:'f-swap', third:'f-third' };
  const cls = map[sel.value];
  if (cls) sel.classList.add(cls);
}
$.customRoleFaction && $.customRoleFaction.addEventListener('change', paintFactionSelect);

  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
  const load = () => { try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(s) STATE = {...STATE, ...s}; }catch{} };
  const clamp = (n,a,b)=>Math.min(Math.max(n,a),b);
  const pad = n=>String(n).padStart(2,'0');
  const rng = (max)=>{ if(crypto?.getRandomValues){ const arr=new Uint32Array(1); crypto.getRandomValues(arr); return arr[0]/0xffffffff*max; } return Math.random()*max; };
  const shuffle = (arr)=>{ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  // ====== NAMES UI ======
  function renderNames(){
    $.namesWrap.innerHTML = '';
    const n = Number($.playerCount.value||STATE.playerCount);
    while(STATE.names.length < n) STATE.names.push('');
    if(STATE.names.length > n) STATE.names.length = n;

    for(let i=0;i<n;i++){
      const w = document.createElement('div');
      const input = document.createElement('input');
      input.type='text'; input.placeholder = `Người chơi ${i+1}`; input.value = STATE.names[i]||'';
      input.oninput = (e)=>{ STATE.names[i] = e.target.value; save(); };
      w.appendChild(input); $.namesWrap.appendChild(w);
    }
    save();
  }

  $.playerCount.addEventListener('change', ()=>{
    STATE.playerCount = clamp(Number($.playerCount.value||10),3,151);
    $.playerCount.value = STATE.playerCount;
    renderNames(); updateSlotsLeft();
  });
  $.autoFillNames.addEventListener('click', ()=>{
    const n = Number($.playerCount.value||10);
    STATE.names = Array.from({length:n},(_,i)=>`Người chơi ${i+1}`);
    renderNames();
  });
  $.shuffleNames.addEventListener('click', ()=>{ STATE.names = shuffle(STATE.names); renderNames(); });

// Xóa các ô tên đang trống (chỉ placeholder, chưa nhập)
$.removeEmptyNames.addEventListener('click', () => {
  const before = STATE.names.slice();
  const keep = before.filter(name => (name || '').trim() !== '');
  const removed = before.length - keep.length;

  if (removed === 0) {
    alert('Không có ô tên trống để xóa.');
    return;
  }

  // Cập nhật state + ô số người chơi
  STATE.names = keep;
  STATE.playerCount = keep.length;
  $.playerCount.value = STATE.playerCount;

  // Sau khi thay đổi số người, reset khu phân vai (tránh lệch)
  STATE.assignments = null;
  STATE.reveal = {};
  if ($.reshuffleBtn) $.reshuffleBtn.disabled = true;
  if ($.revealAllBtn) $.revealAllBtn.disabled = true;
  if ($.copyBtn) $.copyBtn.disabled = true;
  if ($.sortBtn) $.sortBtn.disabled = true;

  renderNames();
  updateSlotsLeft();
  save();
});

  // ====== ROLES UI ======
  function ensureDefaultRoles(){ if(!STATE.roles || Object.keys(STATE.roles).length===0){ STATE.roles = {werewolf:3, seer:1, witch:1, hunter:1, guard:1, cupid:1, spellcaster:1, prince:1}; } }

  function renderRoles(){
  $.rolesList.innerHTML = '';
  ensureDefaultRoles();
  normalizeCustomRoles();

  // Phe của vai mặc định
  // Phe của vai mặc định
const defaultFactionMap = {
  // Ma sói
  werewolf: 'wolf', werecub: 'wolf', minion: 'wolf',
  pssoi: 'wolf', soidc: 'wolf', soituyet: 'wolf', alpha: 'wolf', acmong: 'wolf', scuong: 'wolf',

  // Dân làng
  seer: 'village', witch: 'village', hunter: 'village',
  guard: 'village', spellcaster: 'village',
  prince: 'village', elder: 'village', 'tough guy': 'village',
  mayor: 'village', village: 'village', hbi: 'village',
  dbom: 'village', tvan: 'village', lgac: 'village', gsu: 'village',
  tsu: 'village', hquang: 'village', nbenh: 'village', cma: 'village',
  hbinh: 'village', ttu: 'village', hsi: 'village', blang: 'village',
  

  // Đổi phe
  doppelganger: 'swap', cursed: 'swap', cupid: 'swap',

  // Phe thứ 3
  tanner: 'third', gchu: 'third', dgau: 'third', mcr: 'third', strang: 'third'
};

  // Gom nhóm theo phe (gồm cả mặc định & tùy chỉnh)
  const groups = { wolf: [], village: [], swap: [], third: [] };

  DEFAULT_ROLES.forEach(r => {
    const f = defaultFactionMap[r.key] || 'third';
    groups[f].push({ type: 'default', role: r });
  });

  Object.entries(STATE.customRoles || {}).forEach(([name, obj]) => {
    const faction = (obj && obj.faction) || 'third';
    groups[faction].push({ type: 'custom', name, obj });
  });

  // Sắp xếp ABC theo tên (bỏ emoji, bỏ dấu)
  const collator = new Intl.Collator('vi', { sensitivity: 'base', numeric: true });
  const clean = s => String(s)
    .replace(/^[^\p{L}\p{N}]+/u, '')               // bỏ emoji/ký tự đầu
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // bỏ dấu
    .toLowerCase();

  const sortGroup = arr => arr.sort((a,b)=>{
    const an = a.type==='default' ? a.role.name : a.name;
    const bn = b.type==='default' ? b.role.name : b.name;
    return collator.compare(clean(an), clean(bn));
  });

  sortGroup(groups.wolf);
  sortGroup(groups.village);
  sortGroup(groups.swap);
  sortGroup(groups.third);

  // Helpers tạo dòng
  const addSep = (label)=>{
    const sep = document.createElement('div');
    sep.className = 'sep';
    sep.textContent = `--------------------- ${label} ---------------------`;
    $.rolesList.appendChild(sep);
  };

  // --- THAY THẾ HÀM NÀY BÊN TRONG renderRoles() ---
const makeRowDefault = (role)=>{
  const row = document.createElement('div'); row.className='item';

  const name = document.createElement('div');
  name.innerHTML = `<span class="pill" style="border-color:${role.color||'#334'}">
    <svg width="8" height="8"><circle cx="4" cy="4" r="4" fill="${role.color||'#888'}"/></svg> ${role.name}
  </span>`;

  const hint = document.createElement('div');
  const viewBtn = document.createElement('button');
  viewBtn.className='btn ghost';
  viewBtn.textContent='Hiện';
  viewBtn.addEventListener('click', ()=> modal.open(role.name, role.hint||'')); 
  hint.appendChild(viewBtn);

  const count = document.createElement('input');
  count.type='number'; 
  count.min='0';
  // Riêng 2 vai này chỉ cho 0–1
  const isTanner = role.key === 'tanner';
  const isPeace  = role.key === 'hbinh';             // 🤝 Yêu hòa bình
  if (isTanner || isPeace) count.max = '1';

  // Giá trị hiện tại
  count.value = STATE.roles[role.key] || 0;

  count.addEventListener('change', ()=>{
    const prev = Number(STATE.roles[role.key] || 0);
    // Clamp: tanner & hbinh chỉ 0–1, còn lại 0–40
    const v = clamp(Number(count.value||0), 0, (isTanner||isPeace) ? 1 : 40);
    STATE.roles[role.key] = v;
    count.value = v;  // phản ánh lại nếu người dùng gõ > max

    // ===== RÀNG BUỘC MỚI =====
    // 1) Nếu tăng "Chán đời" từ 0 -> 1, tự thêm "Yêu hòa bình" = 1 (nếu đang 0)
    if (isTanner && prev === 0 && v === 1) {
      const peaceNow = Number(STATE.roles['hbinh'] || 0);
      if (peaceNow === 0) {
        STATE.roles['hbinh'] = 1;
        alert('Chức năng "Hòa bình" được thêm vào danh sách vì đi chung với lá bài \'Chán đời\'');
        renderRoles(); updateSlotsLeft(); save();
        return; // vì đã re-render xong
      }
    }

    // 2) Nếu giảm "Yêu hòa bình" xuống 0, tự giảm "Chán đời" = 0
    if (isPeace && prev > 0 && v === 0) {
      const tannerNow = Number(STATE.roles['tanner'] || 0);
      if (tannerNow > 0) {
        STATE.roles['tanner'] = 0;
        alert('Chức năng "Chán đời" bị loại khỏi danh sách vì đi chung với lá bài \'Hòa bình\'');
        renderRoles(); updateSlotsLeft(); save();
        return; // vì đã re-render xong
      }
    }

    // 3) Giảm "Chán đời" xuống 0: KHÔNG làm gì thêm (theo yêu cầu)
    updateSlotsLeft(); save();
  });

  const del = document.createElement('div'); // trống cho khớp lưới

  $.rolesList.appendChild(row);
  row.append(name, hint, count, del);
};

  const colorMap = { village:'#3b82f6', wolf:'#ef4444', swap:'#10b981', third:'#eab308' };
  const factionLabel = { village:'Dân làng', wolf:'Ma sói', swap:'Đổi phe', third:'Phe thứ 3' };

  const makeRowCustom = (name, obj)=>{
    const { count:countVal=0, faction='third' } = obj || {};
    const row = document.createElement('div'); row.className='item';

    const nameDiv = document.createElement('div');
    nameDiv.innerHTML = `<span class="pill" style="border-color:${colorMap[faction]}">
      <svg width="8" height="8"><circle cx="4" cy="4" r="4" fill="${colorMap[faction]}"/></svg>
      🧩 ${escapeHtml(name)}
    </span>`;

    const hint = document.createElement('div');
    const viewBtn = document.createElement('button');
    viewBtn.className='btn ghost'; viewBtn.textContent='Hiện';
    viewBtn.addEventListener('click', ()=> 
      modal.open(`🧩 ${name}`, `Chức năng của vai trò tuỳ chỉnh do Quản trò và Dân làng thống nhất đưa ra · Phe: ${factionLabel[faction]}`)
    );
    hint.appendChild(viewBtn);

    const count = document.createElement('input');
    count.type='number'; count.min='0'; count.value=countVal;
    count.addEventListener('change', ()=>{
      normalizeCustomRoles();
      const v = clamp(Number(count.value||0),0,40);
      STATE.customRoles[name] = { count: v, faction };
      if (v===0) delete STATE.customRoles[name];
      renderRoles(); updateSlotsLeft(); save();
    });

    const del = document.createElement('div');
    const delBtn = document.createElement('button');
    delBtn.className='btn danger'; delBtn.textContent='Xoá';
    delBtn.onclick = ()=>{
      delete STATE.customRoles[name];
      renderRoles(); updateSlotsLeft(); save();
    };
    del.appendChild(delBtn);

    $.rolesList.appendChild(row);
    row.append(nameDiv, hint, count, del);
  };

  // In theo thứ tự phe: Ma sói -> Dân làng -> Đổi phe -> Phe thứ 3
  [
    {key:'wolf',    label:'Ma sói'},
    {key:'village', label:'Dân làng'},
    {key:'swap',    label:'Đổi phe'},
    {key:'third',   label:'Phe thứ 3'}
  ].forEach(sec=>{
    const arr = groups[sec.key];
    if(!arr.length) return;
    addSep(sec.label);
    arr.forEach(it => it.type==='default' ? makeRowDefault(it.role)
                                          : makeRowCustom(it.name, it.obj));
  });

  updateSlotsLeft();
}


  function updateSlotsLeft(){
    const totalPlayers = Number($.playerCount.value||STATE.playerCount);
    const totalSelected = totalRolesSelected();
    const left = totalPlayers - totalSelected;
    $.slotsLeft.textContent = left;
    $.slotsLeft.style.color = left < 0 ? 'salmon' : '#c7ffee';
const totalEl = document.getElementById('rolesTotal');
  if (totalEl) totalEl.textContent = totalSelected;
  }

  function totalRolesSelected(){
  const base = Object.values(STATE.roles||{}).reduce((a,b)=>a+Number(b||0),0);
  const custom = Object.values(STATE.customRoles||{}).reduce((a,v)=>a+Number((v&&v.count)||0),0);
  return base + custom;
}


  $.addCustomRole.addEventListener('click', ()=>{
  const name = ($.customRoleName.value||'').trim();
  const count = clamp(Number($.customRoleCount.value||1),1,40);
  const faction = $.customRoleFaction?.value || '';

  if (!name)   return alert('Vui lòng nhập tên vai trò tuỳ chỉnh!');
  if (!faction) return alert('Vui lòng lựa chọn phe cho vai trò này!');

  // đảm bảo cấu trúc {name:{count,faction}}
  normalizeCustomRoles();
  const cur = STATE.customRoles[name] || {count:0, faction};
  const newCount = (cur.count||0) + count;

  STATE.customRoles[name] = { count: newCount, faction };  // lưu phe
  $.customRoleName.value = '';
  $.customRoleCount.value = '1';
  if ($.customRoleFaction){ $.customRoleFaction.value = ''; paintFactionSelect(); }

  renderRoles(); updateSlotsLeft(); save();
});

  $.resetRoles.addEventListener('click', ()=>{ STATE.roles = {werewolf:3, seer:1, witch:1, hunter:1, guard:1, cupid:1, spellcaster:1, prince:1}; STATE.customRoles = {}; renderRoles(); save(); });

  // ====== ASSIGNMENT ======
  $.assignBtn.addEventListener('click', ()=>{
    const n = Number($.playerCount.value||10);
    const names = STATE.names.slice(0,n).map((x,i)=> (x||'').trim() || `Người chơi ${i+1}`);

    const parts = [];
    const addMany = (label,count)=>{ for(let i=0;i<count;i++) parts.push(label); };
    const roleNameFromKey = k => (DEFAULT_ROLES.find(r=>r.key===k)?.name) || k;

    Object.entries(STATE.roles||{}).forEach(([k,c])=> addMany(roleNameFromKey(k), Number(c||0)));
    Object.entries(STATE.customRoles||{}).forEach(([name,obj])=>{
  const c = Number((obj && obj.count) || 0);
  addMany(name, c);
});


    if(parts.length > n){ return alert(`Tổng số vai trò(${parts.length}) vượt quá số người (${n}). Hãy giảm bớt vai trò hoặc tăng số lượng người chơi.`); }

    // 🔒 CHỐT 1: lấp ô trống bằng Dân làng
  while (parts.length < n) parts.push('👨🏻‍🌾 Dân làng');

  const rolesShuffled = shuffle(parts);

  // 🔒 CHỐT 2: đảm bảo sau shuffle vẫn đủ n phần tử
  while (rolesShuffled.length < n) rolesShuffled.push('👨🏻‍🌾 Dân làng');
    STATE.assignments = names.map((name, idx)=> ({ name, role: rolesShuffled[idx] }));
    STATE.reveal = {};
    STATE.dead = {};
    renderAssignments();
    clearTimeout(autoSortTimer);
    $.reshuffleBtn.disabled = false; $.revealAllBtn.disabled=false; $.copyBtn.disabled=false; $.sortBtn.disabled=false;
    save();
  });

  $.reshuffleBtn.addEventListener('click', ()=>{
    if(!STATE.assignments) return;
    const roles = STATE.assignments.map(x=>x.role);
    const names = STATE.assignments.map(x=>x.name);
    const reshuffled = shuffle(roles);
    STATE.assignments = names.map((name,i)=>({name, role: reshuffled[i]}));
    STATE.reveal = {}; renderAssignments(); save();
  });

  $.revealAllBtn.addEventListener('click', ()=>{
    const anyHidden = Object.values(STATE.reveal||{}).some(v=>!v);
    STATE.assignments.forEach((_,i)=> STATE.reveal[i] = anyHidden );
    renderAssignments(); save();
  });

  $.copyBtn.addEventListener('click', async ()=>{
    if(!STATE.assignments) return;
    const lines = STATE.assignments
  .map((x,i)=> `${i+1}. ${x.name} — ${displayRole(x.role)}`)
  .join('\n');

    try{ await navigator.clipboard.writeText(lines); alert('Đã sao chép danh sách vai trò vào clipboard!'); }
    catch{ alert('Không thể sao chép, hãy chọn thủ công.'); }
  });

  // ====== SORT & HIGHLIGHT ======
  function _ascii(s){
    return String(s).toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }
  function _roleKey(role){
    return String(role).replace(/^[^\p{L}\p{N}]+/u,'').trim().toLowerCase();
  }
  function factionOf(role){
    const t = _ascii(role);
// ƯU TIÊN: custom role có lưu phe
  const cr = STATE.customRoles && STATE.customRoles[role];
  if (cr && cr.faction) {
    const f = cr.faction;
    if (f==='wolf')    return {order:0, cls:'f-wolf'};
    if (f==='village') return {order:1, cls:'f-vil'};
    if (f==='swap')    return {order:2, cls:'f-swap'};
    return {order:3, cls:'f-third'};
  }
    // Phe Sói
    if (t.includes('soi con') || t.includes('phan boi') || t.includes('ma soi')|| t.includes('phap su soi')|| t.includes('soi đai ca')|| t.includes('soi tuyet')|| t.includes('soi đau đan')|| t.includes('ac mong')|| t.includes('soi cuong'))
      return {order:0, cls:'f-wolf'};
    // Phe Dân
    if (t.includes('tien tri')||t.includes('phu thuy')||
        t.includes('tho san')||t.includes('bao ve')||t.includes('nguyet nu')||
        t.includes('dan lang')||t.includes('hoang tu')||t.includes('gia lang')||
        t.includes('luc si')||t.includes('thi truong')||t.includes('huyen bi')||
        t.includes('đanh bom')||t.includes('thien van')||t.includes('linh gac')||
        t.includes('giao su')||t.includes('tap su')||t.includes('hao quang')||t.includes('nguoi benh')||t.includes('bao lang')||
        t.includes('con ma')||t.includes('hoa binh')||t.includes('hiep si')||t.includes('tham tu'))
      return {order:1, cls:'f-vil'};
    // Phe đổi phe
    if (t.includes('cupid')||t.includes('nhan ban')||t.includes('bi nguyen'))
      return {order:2, cls:'f-swap'};
    // Phe thứ ba / khác
    if (t.includes('chan doi')||t.includes('giao chu')||t.includes('đau gau')||t.includes('ma ca rong')||t.includes('soi trang'))
      return {order:3, cls:'f-third'};
    return {order:3, cls:'f-third'};
  }

  function sortAssignmentsByFactionThenRole(){
  if (!STATE.assignments || STATE.assignments.length === 0) return;

  // Giữ trạng thái "đã hiện" theo TÊN trước khi sắp xếp
  const revealByName = {};
  STATE.assignments.forEach((x, i) => {
    revealByName[x.name] = !!STATE.reveal[i];
  });

  // Map đánh dấu chết theo tên (đã set ở STATE.dead)
  const deadByName = { ...(STATE.dead || {}) };

  STATE.assignments.sort((a, b) => {
    // 1) Alive trước, Dead sau
    const aDead = !!deadByName[a.name];
    const bDead = !!deadByName[b.name];
    if (aDead !== bDead) return aDead ? 1 : -1;

    // 2) Sắp theo phe
    const fa = factionOf(a.role);
    const fb = factionOf(b.role);
    if (fa.order !== fb.order) return fa.order - fb.order;

    // 3) Cùng phe thì sắp theo alphabet của tên vai trò
    const ra = _roleKey(a.role);
    const rb = _roleKey(b.role);
    return ra.localeCompare(rb, 'vi');
  });

  // Khôi phục trạng thái "đã hiện" theo vị trí mới
  STATE.reveal = {};
  STATE.assignments.forEach((x, i) => {
    STATE.reveal[i] = !!revealByName[x.name];
  });

  renderAssignments();
  save();
}

function toggleDeadByName(name){
  STATE.dead = STATE.dead || {};
  const wasDead = !!STATE.dead[name];
  STATE.dead[name] = !wasDead;

  renderAssignments(); save();

  if (!wasDead) {
    // Vừa bị "Giết" -> đếm 10s rồi auto-sort
    scheduleAutoSort();
  }
}

function displayRole(role) {
  // Nếu là vai trò tùy chỉnh (tên tồn tại trong STATE.customRoles) thì thêm 🧩
  if (STATE.customRoles && Object.prototype.hasOwnProperty.call(STATE.customRoles, role)) {
    return `🧩 ${role}`;
  }
  return role; // vai trò mặc định đã có emoji sẵn (🐺, 🔮, …)
}

  function renderAssignments(){
  if(!STATE.assignments){ $.assignments.innerHTML=''; return; }

  const rows = STATE.assignments.map((x,i)=>{
    const revealed = !!STATE.reveal[i];
    const fac = factionOf(x.role);
    const isDead = !!(STATE.dead && STATE.dead[x.name]);
    const safeNameAttr = String(x.name).replace(/"/g,'&quot;'); // attr-safe
    const viewRole = displayRole(x.role);
const roleCell = revealed ? escapeHtml(viewRole) : '&nbsp;';

    return `<tr class="${revealed? 'revealed':''} ${fac.cls} ${isDead?'dead':''}"
               data-name="${safeNameAttr}">
      <td>${i+1}</td>
      <td class="name-cell">
  <div class="name-wrap">
    <span class="player-name">${escapeHtml(x.name)}</span>
    ${isDead ? '<span class="eliminated">– BỊ LOẠI</span>' : ''}
  </div>
</td>
      <td class="role ${revealed? '':'hidden'}">${roleCell}</td>
      <td class="no-print">
  <button class="btn ${isDead ? '' : 'danger'}" data-kill="${i}">
    ${isDead ? 'Cứu' : 'Giết'}
  </button>
</td>

    </tr>`;
  }).join('');

  $.assignments.innerHTML = `
  <div class="section-title">
    <h2>📃 Danh sách phân vai trò</h2>
    <div class="chip">Tổng: <b>${STATE.assignments.length}</b></div>
  </div>
  <div class="table-wrap">
    <table aria-label="Danh sách phân vai trò">
      <thead>
        <tr><th>#</th><th>Tên người chơi</th><th>Vai trò</th>
        <th class="no-print">Giết</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;

  // Bấm nút Giết/Hồi sinh (toggle "đã chết")
qsa('[data-kill]', $.assignments).forEach(btn => {
  btn.addEventListener('click', (e) => {
    const i = Number(e.currentTarget.getAttribute('data-kill'));
    const name = STATE.assignments[i]?.name;
    if (!name) return;
    toggleDeadByName(name);     // đã có sẵn trong mã
  });
});

  // double-click / double-tap để toggle “đã chết”
  qsa('tbody tr', $.assignments).forEach(tr=>{
    const name = tr.getAttribute('data-name'); // DOM sẽ decode &quot; => "
    // chặn khi click vào nút
    tr.addEventListener('dblclick', (e)=>{
      if (e.target.closest('button')) return;
      toggleDeadByName(name);
    });
    // mobile: double-tap trong ~300ms
    let lastTap = 0;
    tr.addEventListener('touchend', (e)=>{
      if (e.target.closest('button')) return;
      const now = Date.now();
      if (now - lastTap < 300){ toggleDeadByName(name); e.preventDefault(); }
      lastTap = now;
    }, {passive:false});
  });
}

  $.sortBtn.addEventListener('click', () => {
  clearTimeout(autoSortTimer);
  sortAssignmentsByFactionThenRole();
});

  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

// ===== KHO LƯU GHI CHÉP =====
const notesArchiveModal = {
  wrap: document.getElementById('notesArchiveModal'),
  title: document.getElementById('notesArchiveTitle'),
  body:  document.getElementById('notesArchiveBody'),
  btnClose: document.getElementById('notesArchiveClose'),
  open(){
    this.render();
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose?.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
  },
  render(){
    const list = STATE.notesArchive || [];
    const total = list.length;

    const itemsHTML = !total
      ? `<div class="hint">Chưa có bản lưu nào. Hãy bấm <b>💿️ Lưu</b> sau khi ghi chú.</div>`
      : `<div class="hint">Đã lưu <b>${total}</b> lần.</div>
         <div class="archive-list">
           ${list.slice().reverse().map(it=>{
              const when = new Date(it.timeISO).toLocaleString('vi-VN', { hour12:false });
              return `
                <div class="archive-item">
                  <div class="archive-meta">Lần #${it.id} • ${when}</div>
                  <div class="archive-content">${escapeHtml(it.content)}</div>
                </div>`;
            }).join('')}
         </div>`;

    this.body.innerHTML = itemsHTML +
      `<div class="archive-actions">
         <button class="btn danger" id="notesArchiveClearAll">Xóa toàn bộ lưu trữ</button>
         <button class="btn" id="notesArchiveClose2">Đóng</button>
       </div>`;

    // gắn sự kiện cho 2 nút trong body (vì body vừa được innerHTML)
    const clearBtn = this.body.querySelector('#notesArchiveClearAll');
    const close2   = this.body.querySelector('#notesArchiveClose2');

    clearBtn?.addEventListener('click', ()=>{
      if(!confirm('Bạn chắc chắn muốn xóa toàn bộ các bản lưu? Hành động này không thể hoàn tác.')) return;
      STATE.notesArchive = [];
      STATE.notesSaveSeq = 0;   // reset số lần
      save();
      this.render();
      alert('Đã xóa toàn bộ lưu trữ và đặt lại bộ đếm.');
    });
    close2?.addEventListener('click', ()=> this.close());
  }
};

// Đóng modal khi click ra ngoài / nhấn ESC
notesArchiveModal.btnClose?.addEventListener('click', ()=> notesArchiveModal.close());
notesArchiveModal.wrap?.addEventListener('click', (e)=>{ if(e.target===notesArchiveModal.wrap) notesArchiveModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') notesArchiveModal.close(); });

// Lưu một “bản chụp” ghi chú
function saveNotesSnapshot(){
  const text = (qs('#notes')?.value || '');
  if(!text.trim()){
    if(!confirm('Ghi chú đang trống. Bạn có muốn lưu một đoạn văn bản trống?')) return;
  }
  STATE.notesSaveSeq = (STATE.notesSaveSeq || 0) + 1;
  const entry = { id: STATE.notesSaveSeq, timeISO: new Date().toISOString(), content: text };
  STATE.notesArchive = STATE.notesArchive || [];
  STATE.notesArchive.push(entry);
  save();

  const when = new Date(entry.timeISO).toLocaleString('vi-VN', { hour12:false });
  alert(`Đã lưu ghi chép #${entry.id} (${when}).\nXem lại ở "📁 Kho lưu trữ".`);
}

  // ====== TIMER ======
  let TICK = null; let remaining = 120; let countingUp=false;

  function setTimerFromInputs(){
    const min = clamp(Number($.timerMin.value||0),0,999);
    const sec = clamp(Number($.timerSec.value||0),0,59);
    $.timerMin.value=min; $.timerSec.value=sec;
    if($.timerMode.value==='down'){ remaining = min*60 + sec; countingUp=false; }
    else { remaining = 0; countingUp=true; }
    updateTimerDisplay();
    STATE.timer = { ...STATE.timer, mode: $.timerMode.value, min, sec, left: remaining, running:false, sound: $.soundToggle.checked };
    $.startPauseBtn.textContent='▶︎ Bắt đầu'; save();
  }

  function updateTimerDisplay(){
    const sec = Math.max(0, Math.floor(remaining%60));
    const min = Math.max(0, Math.floor(remaining/60));
    $.timerDisplay.textContent = `${pad(min)}:${pad(sec)}`;
  }

  // Thay toàn bộ hàm beep() cũ bằng hàm mới này
  function beep(times = 5, vol = 1.0, freq = 900, dur = 180, gap = 120){
    if(!$.soundToggle.checked) return;

    // RUNG: 5 nhịp 200ms, nghỉ 100ms
    try{ navigator.vibrate && navigator.vibrate([200,100,200,100,200,100,200,100,200]); }catch{}

    // ÂM THANH: nhiều "tút" liền nhau
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();

      let t = ctx.currentTime;
      for(let i = 0; i < times; i++){
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);

        // Giữ tiếng "tút" rõ ràng
        o.type = 'sine';
        o.frequency.setValueAtTime(freq, t);

        // Envelope để nghe to nhưng không rè
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(vol, t + 0.02);           // lên nhanh
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur/1000);    // tắt nhanh

        o.start(t);
        o.stop(t + dur/1000 + 0.01);

        // khoảng nghỉ giữa các "tút"
        t += (dur + gap) / 1000;
      }

      // đóng context sau khi phát xong để tiết kiệm pin
      const total = times*dur + (times-1)*gap + 200;
      setTimeout(()=>{ try{ ctx.close(); }catch{} }, total);
    }catch{}
  }

  function startPause(){
    if(TICK){ clearInterval(TICK); TICK=null; $.startPauseBtn.textContent='▶︎ Tiếp tục'; STATE.timer.running=false; save(); return; }
    $.startPauseBtn.textContent='❚❚ Tạm dừng'; STATE.timer.running=true; save();
    TICK = setInterval(()=>{
      remaining += countingUp ? 1 : -1;
      updateTimerDisplay();
      if(!countingUp && remaining<=0){ clearInterval(TICK); TICK=null; beep(); $.startPauseBtn.textContent='▶︎ Bắt đầu'; STATE.timer.running=false; save(); }
    }, 1000);
  }

  function resetTimer(){ clearInterval(TICK); TICK=null; setTimerFromInputs(); }

  $.timerMode.addEventListener('change', setTimerFromInputs);
  $.timerMin.addEventListener('change', setTimerFromInputs);
  $.timerSec.addEventListener('change', setTimerFromInputs);
  $.startPauseBtn.addEventListener('click', startPause);
  $.resetTimerBtn.addEventListener('click', resetTimer);
  qsa('[data-preset]').forEach(btn=> btn.addEventListener('click', (e)=>{
    const s = Number(e.currentTarget.getAttribute('data-preset'))||120;
    $.timerMode.value='down'; $.timerMin.value = Math.floor(s/60); $.timerSec.value = s%60; setTimerFromInputs();
  }));
  $.soundToggle.addEventListener('change', ()=>{ STATE.timer.sound = $.soundToggle.checked; save(); });

  // ====== NOTES ======
  const notesEl = qs('#notes');

// Tự giãn chiều cao ghi chú theo nội dung
function autoGrowNotes(){
  if(!notesEl) return;
  notesEl.style.height = 'auto';                    // reset
  notesEl.style.height = Math.max(160, notesEl.scrollHeight) + 'px';
}

// khi nhập thì tự giãn
notesEl.addEventListener('input', autoGrowNotes);
// nếu cửa sổ đổi kích thước (mobile xoay…), tính lại
window.addEventListener('resize', autoGrowNotes);

  notesEl.addEventListener('input', ()=>{ STATE.notes = notesEl.value; save(); });

  // Nút: Xóa tất cả
  $.clearNotesBtn.addEventListener('click', ()=>{
    notesEl.value = '';
    STATE.notes = '';
    save();
    autoGrowNotes();
    notesEl.focus();
  });

  // Nút: Soạn mẫu nhanh
  $.quickTemplateBtn.addEventListener('click', ()=>{
    const tpl =
`🐺 Sói _________ Giết:
🛡️ Bảo vệ ______ Chắn:
🧙‍♂️ Phù Thủy _____ Cứu:
🧙‍♂️ Phù Thủy ____ Giết:
🏹 Thợ săn _____ Ngắm:
💘 Cupid _______ Ghép:
👥 Nhân bản ____ Chọn:
🔇 Nguyệt nữ ____ Câm: `;
    notesEl.value = tpl;
    STATE.notes = tpl;
    save();
    autoGrowNotes();
    // Đưa con trỏ về cuối cho tiện ghi tiếp
    notesEl.focus();
    try{
      notesEl.selectionStart = notesEl.selectionEnd = notesEl.value.length;
    }catch{}
  });

$.saveNotesBtn?.addEventListener('click', saveNotesSnapshot);
$.openArchiveBtn?.addEventListener('click', () => notesArchiveModal.open());

  // ====== INIT ======
  function init(){
    load();
    if (!Array.isArray(STATE.notesArchive)) STATE.notesArchive = [];
    if (!Number.isInteger(STATE.notesSaveSeq)) STATE.notesSaveSeq = 0;
    save();
    $.playerCount.value = STATE.playerCount;
    renderNames();

    ensureDefaultRoles();
    normalizeCustomRoles();
    renderRoles();

    if(STATE.assignments){ renderAssignments(); $.reshuffleBtn.disabled=false; $.revealAllBtn.disabled=false; $.copyBtn.disabled=false; $.sortBtn.disabled=false; }

    notesEl.value = STATE.notes||'';
    autoGrowNotes();

    $.timerMode.value = STATE.timer.mode||'down';
    $.timerMin.value = STATE.timer.min||0; $.timerSec.value = STATE.timer.sec||0;
    let remainingLocal = STATE.timer.left || (STATE.timer.mode==='down' ? (STATE.timer.min*60 + STATE.timer.sec): 0);
    remaining = remainingLocal;
    countingUp = STATE.timer.mode==='up'; $.soundToggle.checked = !!STATE.timer.sound;
    updateTimerDisplay();
    if(STATE.timer.running){ startPause(); }

    updateSlotsLeft();
  }

// ===== Modal 'Thứ tự kêu dậy' =====
const nightOrderModal = {
  wrap: document.getElementById('nightOrderModal'),
  body: document.getElementById('nightOrderBody'),
  btnClose: document.getElementById('nightOrderClose'),
  open(){
    this.render();
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose?.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
  },
  render(){
    this.body.innerHTML = `
      <p class="intro">— Thứ tự kêu dậy mỗi đêm —<br>
      <em>(Con ma chết ngay đêm đầu tiên)</em></p>

      <ol start="1">
        <li>Cupid          (1 lần đêm đầu tiên)</li>
        <li>Sói đại ca     (1 lần đêm đầu tiên)</li>
        <li>Đầu gấu</li>
        <li>Bầy sói gồm: Ác mộng + Ma sói + Phản bội + Sói con + Sói cuồng + Sói đại ca + Sói đầu đàn + Sói tuyết + Sói trắng
          <div class="sub">Thứ tự hành động của phe Ma sói:</div>
          <div class="sub">Ác mộng / Sói con / Sói cuồng / Sói đầu đàn / Sói tuyết</div>
        </li>
        <li>Pháp sư sói</li>
        <li>Sói trắng</li>
        <li>Ma cà rồng</li>
        <li>Giáo chủ</li>
        <li>Hiệp sĩ</li>
        <li>Bảo vệ</li>
        <li>Phù thủy</li>
        <li>Thiên văn</li>
        <li>Thợ săn</li>
        <li>Thám tử</li>
        <li>Tiên tri</li>
        <li>Tiên tri_Hào quang</li>
        <li>Tiên tri_Huyền bí</li>
        <li>Giáo sư</li>
        <li>Nguyệt nữ</li>
        <li>Báo làng</li>
      </ol>

      <div class="section">Kêu dậy 1 lần đêm đầu tiên</div>

      <ol start="21">
        <li>Lính gác</li>
        <li>Hoàng tử</li>
        <li>Thị trưởng</li>
        <li>Hòa bình</li>
        <li>Người bệnh</li>
        <li>Lực sĩ</li>
        <li>Tiên tri_Tập sự</li>
        <li>Dân làng</li>
        <li>Già làng</li>
        <li>Nhân bản</li>
        <li>Bị nguyền</li>
        <li>Đánh bom</li>
        <li>Chán đời</li>
      </ol>`;
  }
};

// mở/đóng + hành vi giống các modal khác
document.getElementById('nightOrderBtn')?.addEventListener('click', () => nightOrderModal.open());
nightOrderModal.btnClose?.addEventListener('click', ()=> nightOrderModal.close());
nightOrderModal.wrap?.addEventListener('click', (e)=>{ if(e.target===nightOrderModal.wrap) nightOrderModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') nightOrderModal.close(); });

  init();
})();
</script>
</body>
</html>