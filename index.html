<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Werewolf Assistant</title>
  <style>
    :root{
      --bg: #0f1222;
      --bg-elev: #171b33;
      --text: #eef2ff;
      --muted:#a5b4fc;
      --accent:#7c5cff;
      --accent-2:#22d3ee;
      --danger:#ef4444;
      --ok:#10b981;
      --card: #141832;
      --border:#283056;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      /* L∆∞·ªõi ph·∫ßn ‚ÄúThi·∫øt l·∫≠p vai tr√≤‚Äù */
      --roles-cols: 1.2fr .6fr 120px auto;
    }

    *{ box-sizing:border-box }

    /* NgƒÉn m·ªçi tr√†n ngang, gi·ªØ k√≠ch c·ª° ch·ªØ h·ªá */
    html, body{
      height:100%;
      max-width:100%;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    body{
      margin:0;
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1400px 900px at 15% -10%, #2a3b77 0%, #18203f 58%),
        radial-gradient(1100px 700px at 110% 30%, rgba(124,92,255,.25), rgba(34,211,238,0) 70%),
        linear-gradient(180deg, #0e1430 0%, #0a0f22 100%);
    }

    /* ===== HEADER full-bleed, KH√îNG bo g√≥c ===== */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      overflow: visible;
      isolation: isolate; /* ƒë·ªÉ ::before/::after n·∫±m tr√™n n·ªÅn nh∆∞ng d∆∞·ªõi n·ªôi dung */
    }

/* Hi·ªÉn th·ªã ƒë·ªß ch·ªØ tr√™n c√°c n√∫t ƒêi·ªÅn t√™n, X√°o tr·ªôn, X√≥a ng∆∞·ªùi ch∆°i */
#autoFillNames,
#shuffleNames,
#removeEmptyNames {
  white-space: normal !important;   /* cho xu·ªëng d√≤ng n·∫øu thi·∫øu ch·ªó */
  text-overflow: unset !important;  /* b·ªè d·∫•u "..." */
  overflow: visible !important;     /* hi·ªÉn th·ªã ƒë·ªß n·ªôi dung */
  max-width: none !important;       /* kh√¥ng gi·ªõi h·∫°n chi·ªÅu ngang */
  min-width: 120px;                 /* t·ªëi thi·ªÉu 120px cho ƒë·ªß ch·ªØ */
  flex: 1;                          /* chia ƒë·ªÅu m·ªói n√∫t n·∫øu c√πng h√†ng */
}

#playerSetupRow > .row {
  display: flex;
  justify-content: space-between; /* c√°c n√∫t c√°ch ƒë·ªÅu nhau */
  gap: 8px;                       /* kho·∫£ng c√°ch gi·ªØa n√∫t */
}

    /* T·∫•m m·ªù to√†n b·ªÅ ngang */
    header::before{
      content:"";
      position:absolute;
      inset:0;                               /* theo chi·ªÅu cao header */
      margin-left:  calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      background: linear-gradient(0deg, rgba(15,18,34,.20), rgba(15,18,34,.60));
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index:-1;
      border-radius:0;
    }
    /* Hi·ªáu ·ª©ng s√°ng */
    header::after{
      content:"";
      position:absolute;
      inset:0;
      margin-left:  calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      pointer-events:none;
      background:
        radial-gradient(900px 280px at 25% 40%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        radial-gradient(700px 240px at 70% 60%, rgba(255,255,255,.08), rgba(255,255,255,0) 70%);
      opacity:.9;
      z-index:-1;
      border-radius:0;
    }
    /* N·∫øu m√°y h·ªó tr·ª£ viewport ƒë·ªông, v·∫´n ƒë·∫£m b·∫£o full-bleed m√† kh√¥ng sinh thanh tr∆∞·ª£t */
    @supports (width: 100dvw){
      header::before, header::after{ width:100dvw; left:50%; transform:translateX(-50%); margin:0; }
    }

    /* N·ªôi dung ti√™u ƒë·ªÅ */
    header .title{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      max-width:1200px; margin:0 auto;
    }
    header .title .top-row{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap }
    header .title h1{
      margin:0; font-weight:800; letter-spacing:.3px; white-space:nowrap;
      font-size:clamp(20px,5vw,34px); line-height:1.1;
    }
    .logo{ width:32px; height:32px }
    .logo img{ width:100%; height:100%; object-fit:cover; border-radius:10px }

    /* ===== Layout ===== */
    .container{ position:relative; z-index:1; max-width:1200px; margin:20px auto; padding:0 16px }
    .container::after{
      content:""; position:fixed; right:-6vw; top:240px; width:88vw; height:1200px;
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 60px rgba(124,92,255,.18), 0 0 120px rgba(34,211,238,.12);
      opacity:.45; pointer-events:none; z-index:0;
    }

    .grid{ display:grid; gap:16px }
    @media (min-width:980px){ .grid{ grid-template-columns:1.2fr .8fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; position:relative; z-index:1; max-width:100%;
    }
    .card h2{ margin:6px 6px 14px; font-size:20px }

    label{ display:block; margin:10px 6px 6px; color:var(--muted); font-size:13px }
    input[type="number"], input[type="text"], select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
      background:#0c0f1f; color:var(--text); outline:none; transition:.2s border,.2s box-shadow
    }
    input:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(124,92,255,.15) }
    /* T·ª± gi√£n: b·ªè thanh cu·ªôn b√™n trong */
textarea{
  min-height:160px;
  resize:none;          /* kh√¥ng c·∫ßn k√©o tay n·ªØa */
  overflow:hidden;      /* ·∫©n scrollbar b√™n trong */
}

    .row{ display:flex; gap:10px; align-items:center }
    .row.wrap{ flex-wrap:wrap }
    .grow{ flex:1 }

    .btn{
      padding:10px 14px; border:1px solid var(--border); color:var(--text); background:#11152b;
      border-radius:12px; cursor:pointer; transition:.15s transform,.2s background,.2s border-color
    }
    .btn:hover{ transform:translateY(-1px); background:#171c36 }
    .btn:active{ transform:translateY(0) }
    .btn.primary{ background:linear-gradient(135deg, var(--accent) 0%, #5f44ff 100%); border:none }
    .btn.ghost{ background:transparent }
    .btn.danger{ background:#2a0f12; border-color:#5e1a22; color:#ffb4b4 }
    .btn.ok{ background:#0d2a22; border-color:#13493b; color:#c7ffee }

    .hint{ font-size:12px; color:#c7cfff; opacity:.9 }
    .chip{ display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; background:#0c0f1f; border:1px solid var(--border) }

    /* Danh s√°ch t√™n ng∆∞·ªùi ch∆°i ‚Äì 2 c·ªôt kh√¥ng tr√†n */
    .names{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:10px; width:100%;
    }

    /* Ti√™u ƒë·ªÅ section */
    .section-title{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:6px }
    .section-title h2{ margin:0 }

    /* Header khu vai tr√≤ */
    .section-title.roles-head{
      display:grid; grid-template-columns: var(--roles-cols); align-items:end; gap:8px
    }
    .section-title.roles-head h2{ grid-column:1 / span 2; margin:0 }
    .section-title.roles-head .chip{ grid-column:3; justify-self:start }

    /* B·∫£ng vai tr√≤ (grid, kh√¥ng tr√†n) */
    .roles{
      display:grid; grid-template-columns: var(--roles-cols); gap:8px; align-items:center; width:100%;
    }
    .roles .header{ font-size:12px; color:var(--muted); opacity:.8; padding:0 6px }
    .roles .item{ display:contents }
    .roles input[type="number"]{ width:120px }

    /* Khu th√™m vai tr√≤ */
    #customRoleName{ flex:1 1 320px; min-width:200px }
    #customRoleCount{ width:90px; text-align:center }
    #customRoleActions{ width:100%; display:flex; justify-content:center; gap:10px; margin-top:8px }
    #customRoleActions .btn{ min-width:140px }

    .pill{ font-size:12px; opacity:.9; padding:4px 8px; border-radius:999px; border:1px dashed #334; display:inline-flex; gap:6px; align-items:center; width:max-content }

    /* Danh s√°ch ph√¢n vai ‚Äì fit m√†n h√¨nh */
    .assignments table{ width:100%; border-collapse:collapse; table-layout:fixed }
    .assignments th,.assignments td{ border-bottom:1px solid #2a315a; padding:10px; text-align:left; }
    .assignments tr.revealed td.role{ filter:none }
    .assignments td.role.hidden{ filter:blur(8px); opacity:.7 }
    .assignments th, .assignments td{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

    /* C√¥ng c·ª• */
    .tools{ display:grid; gap:10px; margin-top:12px; grid-template-columns:repeat(2,1fr) }
    .tools .btn.primary{ grid-column:1 / -1 }
    .tools .btn{ width:100%; text-align:center; white-space:normal; justify-content:center }
    @media (min-width:640px){ .tools{ grid-template-columns:repeat(3,1fr) } }
    @media (min-width:960px){ .tools{ grid-template-columns:repeat(4,1fr) } }

    .kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; background:#0b0e1d; border:1px solid var(--border); padding:2px 6px; border-radius:6px }

    .timer-big{ font-variant-numeric:tabular-nums; font-weight:800; font-size:clamp(36px,11vw,48px); letter-spacing:1px; text-align:center; margin:8px 0 12px }
    .timer-controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }

    .footer{ opacity:.6; text-align:center; font-size:12px; padding:12px }

    /* Print */
    @media print{
      header, .no-print{ display:none !important }
      body{ background:#fff; color:#000 }
      .card{ box-shadow:none; border:1px solid #ccc }
      .assignments td.role.hidden{ filter:none }
    }
    #rolesList{ display:contents }

    /* ===== Modal vai tr√≤ ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:9999; padding:16px;
    }
    .modal-backdrop.show{ display:flex }
    /* Bo vi·ªÅn to√†n b·ªô modal v√† c·∫Øt (clip) m·ªçi hi·ªáu ·ª©ng m·ªù b·ªã tr√†n */
.modal{
  border-radius:12px;
  overflow:hidden;                 /* QUAN TR·ªåNG: kh√¥ng cho d·∫£i m·ªù tr√†n ra */
}

/* Header modal: ƒë√£ bo g√≥c tr√™n, v·∫´n gi·ªØ overflow ƒë·ªÉ kh√¥ng b·ªã leak */
.modal header{
  position:relative;
  overflow:hidden;
  border-radius:12px 12px 0 0;     /* bo 2 g√≥c tr√™n */
}

/* Ph·∫ßn n·ªôi dung: bo 2 g√≥c d∆∞·ªõi ƒë·ªÉ kh·ªõp v·ªõi khung modal */
.modal .content{
  padding:16px;
  border-radius:0 0 12px 12px;     /* bo 2 g√≥c d∆∞·ªõi */
  overflow:hidden;                 /* ph√≤ng khi c√≥ hi·ªáu ·ª©ng m·ªù b√™n trong */
}

/* N·ªÅn t·ªëi c·ªßa ph·∫ßn m√¥ t·∫£ ‚Äì ch·ªâ bo g√≥c d∆∞·ªõi (tr√™n ƒë√£ do header ƒë·∫£m nhi·ªám) */
#roleModalBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;    /* ch·ªâ bo 2 g√≥c d∆∞·ªõi */
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: pre-wrap; text-align: justify; text-wrap: pretty; hyphens: auto;
}

/* Th√¢n modal kho l∆∞u ‚Äì c√πng phong c√°ch v·ªõi roleModal */
#notesArchiveBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.8;
  white-space: normal;
}

/* Danh s√°ch b·∫£n l∆∞u */
.archive-list{ display:flex; flex-direction:column; gap:12px; }
.archive-item{ border:1px solid var(--border); border-radius:10px; padding:10px; background:#0c0f1f; }
.archive-meta{ font-size:12px; color:#a5b4fc; margin-bottom:6px; }
.archive-content{
  white-space:pre-wrap;              /* gi·ªØ xu·ªëng d√≤ng */
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background:#0b0e1d; border:1px solid var(--border);
  padding:10px; border-radius:8px;
}

/* H√†ng n√∫t ·ªü ƒë√°y modal */
.archive-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    .modal .close{ border:1px solid var(--border); background:#11152b; color:var(--text); border-radius:10px; padding:8px 12px; cursor:pointer }

.archive-list{display:grid;gap:10px;max-height:50vh;overflow:auto}
.archive-item{background:#0c0f1f;border:1px solid var(--border);border-radius:10px;padding:10px}
.archive-meta{font-size:12px;color:var(--muted)}
.archive-content{white-space:pre-wrap}
.archive-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* Label ‚ÄúS·ªë ng∆∞·ªùi ch∆°i‚Äù kh√¥ng b·∫ª d√≤ng */
    label[for="playerCount"]{ white-space:nowrap }

    /* CƒÉn ƒë·ªÅu c·ªôt m√¥ t·∫£ */
    .roles .item div:nth-child(2){ text-align:justify; text-justify:inter-word }

    /* Co gi√£n cho m√†n nh·ªè ‚Äì x·ª≠ l√Ω tri·ªát ƒë·ªÉ vi·ªác b·ªã ‚Äúkhuy·∫øt‚Äù b√™n ph·∫£i */
    @media (max-width:420px){
      .container{ padding:0 10px }
      .card{ padding:12px; border-radius:14px }
      .section-title{ gap:4px }
      .chip{ padding:5px 8px; font-size:12px }
      .btn{ padding:8px 12px; font-size:14px }
      .btn.primary{ font-size:15px }
      input[type="number"], input[type="text"], select, textarea{ padding:10px; border-radius:10px; font-size:15px; max-width:100% }

      /* T√™n ng∆∞·ªùi ch∆°i 2 c·ªôt ch·∫Øc ch·∫Øn v·ª´a */
      .names{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) }

      /* B·∫£ng vai tr√≤: thu c·ªôt s·ªë l∆∞·ª£ng, tr√°nh tr√†n */
      :root{ --roles-cols: 1fr .6fr 90px auto }
      .roles input[type="number"]{ width:90px }

      /* B·∫£ng ph√¢n vai: cho wrap n·ªôi dung */
      .assignments th, .assignments td{ padding:8px; font-size:13px; white-space:normal; word-break:break-word }
      .assignments td .btn{ padding:6px 10px }

      /* B·ªô ƒë·∫øm th·ªùi gian */
      #timerMin, #timerSec{ width:90px !important }
      .card, .card *{ max-width:100% }
    }

    /* Th√™m ch√∫t co l·∫°i cho m√†n r·∫•t nh·ªè */
    @media (max-width:360px){
      .names{ grid-template-columns: 1fr }  /* 1 c·ªôt */
    }

    /* Co nh·∫π header tr√™n m√†n r·∫•t h·∫πp */
    @media (max-width:400px){
      header{ padding:12px 16px }
      header .title h1{ font-size:clamp(18px,4.8vw,30px) }
      .logo{ width:30px; height:30px }
    }

/* Mobile: ƒë∆∞a c·ª•m n√∫t xu·ªëng d∆∞·ªõi input "S·ªë ng∆∞·ªùi ch∆°i", cƒÉn gi·ªØa v√† r√∫t kho·∫£ng c√°ch */
@media (max-width: 480px){

  /* h√†ng ch·ª©a input + c·ª•m n√∫t */
  .row.wrap{
    align-items:flex-end;
  }

  /* c·ª•m 2 n√∫t th√†nh 1 h√†ng full-width, n·∫±m d∆∞·ªõi v√† cƒÉn gi·ªØa */
  .row.wrap > .row{
    flex: 0 0 100%;                 /* xu·ªëng d√≤ng d∆∞·ªõi */
    justify-content:center;         /* cƒÉn gi·ªØa 2 n√∫t */
    margin-top: 6px;                /* r√∫t kho·∫£ng c√°ch */
    gap: 8px;                       /* n√∫t s√°t h∆°n */
  }

  /* tinh g·ªçn k√≠ch th∆∞·ªõc n√∫t */
  #autoFillNames, #shuffleNames{
    padding:8px 12px;
    font-size:14px;
    min-width:unset;
  }

  /* input s·ªë ng∆∞·ªùi ch∆°i kh√¥ng qu√° to */
  #playerCount{ max-width: 220px; }
}

/* Tinh ch·ªânh b·∫£ng ‚ÄúDanh s√°ch ph√¢n vai‚Äù */
.assignments table th:nth-child(2),
.assignments table td:nth-child(2), /* C·ªôt T√™n ng∆∞·ªùi ch∆°i */
.assignments table th:nth-child(3),
.assignments table td:nth-child(3)  /* C·ªôt Vai tr√≤ */
{
  padding-left: 6px;        /* gi·∫£m padding tr√°i */
  text-align: left;         /* cƒÉn th·∫≥ng l·ªÅ tr√°i */
}

/* Tu·ª≥ ch·ªçn: ch·ªânh c·ªôt s·ªë th·ª© t·ª± s√°t tr√°i lu√¥n */
.assignments table th:first-child,
.assignments table td:first-child{
  padding-left: 4px;
  text-align: center;
  width: 28px;              /* h·∫πp l·∫°i c·ªôt # */
}

/* Ch·ªânh l·∫°i c·ªôt Ti·∫øt l·ªô ƒë·ªÉ c·ªôt Vai tr√≤ tho√°ng h∆°n */
.assignments table th:last-child,
.assignments table td:last-child {
  text-align: center;   /* cƒÉn gi·ªØa n√∫t ·∫®n/Hi·ªán */
  width: 70px;          /* c·ªë ƒë·ªãnh chi·ªÅu r·ªông h·∫πp l·∫°i */
  padding-left: 4px;
  padding-right: 4px;
}

/* C·ªôt Vai tr√≤ d·ªãch tr√°i, kh√¥ng b·ªã th·ª•t */
.assignments table th:nth-child(3),
.assignments table td:nth-child(3) {
  padding-left: 6px;
  text-align: left;
}

/* N√∫t + Th√™m vai tr√≤ -> xanh ƒë·ªìng b·ªô v·ªõi "Hi·ªán" v√† "B·∫Øt ƒë·∫ßu" */
#addCustomRole {
  background: #0d2a22 !important;   /* xanh ƒë·∫≠m */
  border-color: #13493b !important;
  color: #c7ffee !important;
}

/* N√∫t M·∫∑c ƒë·ªãnh -> x√°m t·ªëi h∆°n */
#resetRoles {
  background: #1a1c2b !important;   /* x√°m t·ªëi */
  border-color: #2a2d40 !important;
  color: #d1d5db !important;        /* ch·ªØ x√°m nh·∫°t d·ªÖ ƒë·ªçc */
}

/* Gom √¥ nh·∫≠p + 2 n√∫t v√†o c√πng h√†ng */
#playerCount {
  max-width: 100px;      /* thu nh·ªè √¥ nh·∫≠p */
  text-align: center;    /* canh gi·ªØa s·ªë */
}

/* B·ªë c·ª•c: input v√† 2 n√∫t th·∫≥ng h√†ng */
#playerCount, 
#autoFillNames, 
#shuffleNames {
  display: inline-block;
  vertical-align: middle;
  margin-top: 0;         /* b·ªè kho·∫£ng c√°ch th·ª´a */
}

#autoFillNames, #shuffleNames {
  padding: 8px 12px;
  font-size: 14px;
  margin-left: 6px;      /* c√°ch nh·∫π sang ph·∫£i */
}

/* === S·ªë ng∆∞·ªùi ch∆°i + 2 n√∫t n·∫±m C√ôNG H√ÄNG (m·ªçi c·ª° m√†n) === */
.row.wrap { align-items: flex-end; }

/* ƒê·ª´ng ƒë·ªÉ .grow chi·∫øm h·∫øt chi·ªÅu ngang */
.row.wrap .grow{ 
  flex: 0 0 auto;          /* v·ª´a ƒë·ªß n·ªôi dung */
  margin-right: 8px;
}

/* C·ª•m hai n√∫t ·ªü ngay b√™n ph·∫£i, kh√¥ng xu·ªëng d√≤ng */
.row.wrap > .row{
  flex: 0 0 auto;
  gap: 8px;
  margin-top: 0;           /* b·ªè kho·∫£ng c√°ch th·ª´a */
}

/* B·ªè wrapper + label r·ªóng c·ªßa hai n√∫t ƒë·ªÉ canh th·∫≥ng h√†ng ƒë·∫πp */
.row.wrap > .row > div{ display: contents; }
.row.wrap > .row label{ display: none; }

/* Thu nh·ªè v√† canh gi·ªØa s·ªë ng∆∞·ªùi ch∆°i */
#playerCount{ 
  width: 100px;            /* ho·∫∑c 110px tu·ª≥ b·∫°n */
  max-width: 100px;
  text-align: center;
}

/* N√∫t tinh g·ªçn ch√∫t ƒë·ªÉ v·ª´a h√†ng */
#autoFillNames, #shuffleNames{
  padding: 8px 12px;
  font-size: 14px;
}

/* Fallback m√†u n·ªÅn ƒë·∫∑c khi gradient ch∆∞a k·ªãp render */
html, body{
  background-color:#0a0f22;   /* tr√πng t√¥ng n·ªÅn cu·ªëi c·ªßa b·∫°n */
}

/* Card d√πng n·ªÅn ƒë·∫∑c (√≠t trong su·ªët) ƒë·ªÉ kh√¥ng l·ªô n·ªÅn tr·∫Øng khi cu·ªôn */
.card{
  background: var(--card) !important;         /* #141832 */
  /* N·∫øu mu·ªën v·∫´n c√≥ c·∫£m gi√°c k√≠nh m·ªù:
  background: linear-gradient(180deg, rgba(20,24,50,.98), rgba(20,24,50,.96)) !important;
  */
}

/* Tr√™n thi·∫øt b·ªã di ƒë·ªông: b·ªè blur ƒë·ªÉ tr√°nh jank/flash tr·∫Øng khi cu·ªôn nhanh */
@media (max-width: 600px){
  header::before{
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    background: rgba(15,18,34,.60) !important; /* v·∫´n c√≥ l·ªõp m·ªù t·ªëi */
  }
  header::after{ opacity:.6 !important; } /* nh·∫π hi·ªáu ·ª©ng s√°ng ƒë·ªÉ gi·∫£m paint */
}

/* ƒê∆∞a c√°c kh·ªëi l·ªõn l√™n compositing layer ƒë·ªÉ h·∫°n ch·∫ø checkerboard */
.container,
.card,
.assignments table{
  will-change: transform;
  transform: translateZ(0);
}

.assignments th,
.assignments td{ background-color: rgba(12,15,31,.98); }

/* Header c·ªßa modal: cƒÉn ti√™u ƒë·ªÅ b√™n tr√°i, n√∫t ƒê√≥ng b√™n ph·∫£i */
.modal header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 16px;           /* c√≥ th·ªÉ gi·ªØ nh∆∞ c≈© n·∫øu b·∫°n ƒë√£ set */
  overflow: hidden;              /* gi·ªØ theo thi·∫øt k·∫ø ban ƒë·∫ßu */
  border-radius: 12px 12px 0 0;  /* ƒë·∫£m b·∫£o bo g√≥c tr√™n */
}

/* Ti√™u ƒë·ªÅ co gi√£n v√† c·∫Øt ... khi d√†i */
#roleModalTitle{
  margin: 0;
  font-size: 18px;
  line-height: 1.2;
  flex: 1 1 auto;                /* chi·∫øm ph·∫ßn c√≤n l·∫°i */
  min-width: 0;                  /* ƒë·ªÉ text-overflow ho·∫°t ƒë·ªông trong flex */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* N√∫t ƒê√≥ng gi·ªØ k√≠ch th∆∞·ªõc g·ªçn v√† kh√¥ng xu·ªëng d√≤ng */
.modal .close{
  flex: 0 0 auto;
  white-space: nowrap;
  margin-left: 8px;
}

/* CƒÉn gi·ªØa 2 n√∫t "ƒêi·ªÅn t√™n m·∫∑c ƒë·ªãnh" v√† "X√°o tr·ªôn danh s√°ch" */
.row.wrap > .row{
  flex: 0 0 100%;        /* chi·∫øm to√†n b·ªô chi·ªÅu ngang */
  justify-content: center;
  margin-top: 6px;       /* kho·∫£ng c√°ch nh·∫π so v·ªõi √¥ nh·∫≠p s·ªë */
}

/* N√∫t "ƒêi·ªÅn t√™n m·∫∑c ƒë·ªãnh" -> x√°m ƒë·∫≠m */
#autoFillNames{
  background: #1a1c2b !important;   /* x√°m t·ªëi */
  border-color: #2a2d40 !important;
  color: #d1d5db !important;        /* ch·ªØ x√°m nh·∫°t d·ªÖ ƒë·ªçc */
}

/* N√∫t "X√°o tr·ªôn t√™n" -> xanh (gi·ªëng Hi·ªán/B·∫Øt ƒë·∫ßu) */
#shuffleNames{
  background: #0d2a22 !important;   /* xanh ƒë·∫≠m */
  border-color: #13493b !important;
  color: #c7ffee !important;        /* ch·ªØ xanh nh·∫°t */
}

/* CƒÉn gi·ªØa label v√† √¥ nh·∫≠p "S·ªë ng∆∞·ªùi ch∆°i" */
#playerCount{
  margin: 0 auto;        /* ƒë∆∞a input v√†o gi·ªØa */
  display: block;
  text-align: center;
}

label[for="playerCount"]{
  display: block;
  text-align: center;    /* cƒÉn ch·ªØ "S·ªë ng∆∞·ªùi ch∆°i" gi·ªØa */
}

/* === CƒÉn gi·ªØa "S·ªë ng∆∞·ªùi ch∆°i" + input + 2 n√∫t, ch·ªâ ·ªü h√†ng playerSetupRow === */
#playerSetupRow{
  align-items: flex-end;
  flex-wrap: wrap;
}

/* Label + input ·ªü gi·ªØa, n·∫±m tr√™n c√πng m·ªôt c·ªôt */
#playerSetupRow .grow{
  flex: 0 0 100%;
  text-align: center;
}
#playerSetupRow label[for="playerCount"]{
  display: block;
  margin: 10px 0 6px;       /* t·∫°o kho·∫£ng c√°ch v·ªõi d√≤ng M·∫πo */
}
#playerSetupRow #playerCount{
  display: block;
  margin: 0 auto;           /* gi·ªØa ngang */
  width: 110px;
  max-width: 110px;
  text-align: center;
}

/* Hai n√∫t ·ªü d√≤ng d∆∞·ªõi, cƒÉn gi·ªØa */
#playerSetupRow > .row{
  flex: 0 0 100%;
  justify-content: center;
  gap: 8px;
  margin-top: 6px;
}
/* b·ªè label tr·ªëng b·ªçc n√∫t */
#playerSetupRow > .row > div{ display: contents; }
#playerSetupRow > .row label{ display: none; }

/* Highlight theo phe ‚Äì CH·ªà khi ƒë√£ b·∫•m Hi·ªán */
.assignments tr.revealed.hl-wolf    td { background: rgba(239,68,68,.10); }   /* Phe s√≥i */
.assignments tr.revealed.hl-village td { background: rgba(59,130,246,.10); }  /* Phe d√¢n */
.assignments tr.revealed.hl-flip    td { background: rgba(16,185,129,.10); }  /* ƒê·ªïi phe */
.assignments tr.revealed.hl-third   td { background: rgba(234,179,8,.10); }   /* Phe 3 & custom */

/* --- N√∫t cho khu Ghi ch√∫ --- */
.notes-tools{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
.notes-tools .btn{ min-width:140px }

/* ·∫®n vai tr√≤: ƒë·ªÉ TR·ªêNG, kh√¥ng blur, v·∫´n gi·ªØ chi·ªÅu cao √¥ */
.assignments td.role.hidden{
  filter: none !important;
  opacity: 1 !important;
  color: transparent !important;
  text-shadow: none !important;
}

/* Highlight theo phe ‚Äì CH·ªà khi ƒë√£ b·∫•m Hi·ªán */
.assignments tr.revealed.f-wolf  td { background: rgba(239,68,68,.10); }  /* Phe s√≥i */
.assignments tr.revealed.f-vil   td { background: rgba(59,130,246,.10); } /* Phe d√¢n */
.assignments tr.revealed.f-swap  td { background: rgba(16,185,129,.10); } /* ƒê·ªïi phe */
.assignments tr.revealed.f-third td { background: rgba(234,179,8,.10); }  /* Phe 3 & custom */

/* ===== Ch·∫øt / b·ªã lo·∫°i: t√¥ ƒëen ƒë·∫≠m, ƒë√® l√™n m·ªçi highlight ===== */
.assignments tr.dead td{
  background: #0a0c14 !important;   /* ƒëen xanh ƒë·∫≠m h∆°n (#0a0c14) */
  color: #8f97a8;                   /* ch·ªØ x√°m nh·∫°t h∆°n ƒë·ªÉ n·ªïi b·∫≠t */
}
.assignments tr.dead td .btn{
  opacity: .8;
  filter: brightness(0.9);          /* n√∫t c≈©ng t·ªëi ƒëi ch√∫t */
}

/* ·∫®n hi·ªáu ·ª©ng trang tr√≠ g√¢y tr√†n tr√™n m√†n nh·ªè / v·ª´a */
@media (max-width: 1024px){
  .container::after{ display:none !important; }
}

/* B·∫£ng/√¥ kh√¥ng tr√†n ngang */
.assignments table{
  table-layout: fixed;
  width: 100%;
}
.assignments th, .assignments td{
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* Gi·ªØ Ph√∫t + Gi√¢y c√πng h√†ng */
#timerMin, #timerSec {
  width: 90px !important;     /* co nh·ªè ch√∫t ƒë·ªÉ ch·∫Øc ch·∫Øn v·ª´a */
  min-width: 70px;            /* kh√¥ng nh·ªè qu√° */
  display: inline-block;
}

#timerMin, #timerSec {
  box-sizing: border-box;
}

/* B·ªë c·ª•c h√†ng timer: √©p kh√¥ng xu·ªëng d√≤ng */
#timerMin, #timerSec {
  flex: 0 0 auto;             /* gi·ªØ c·ªë ƒë·ªãnh, kh√¥ng co k√©o */
}

#timerSec {
  margin-left: 8px;           /* t·∫°o kho·∫£ng c√°ch v·ªõi √¥ ph√∫t */
}

.timer-row {
  display: flex;
  flex-wrap: nowrap !important; /* √©p lu√¥n ngang */
  gap: 8px;
}

/* L√†m √¥ "Ch·∫ø ƒë·ªô" r·ªông h∆°n m·ªôt ch√∫t */
#timerMode{
  width: 160px;          /* b·∫°n c√≥ th·ªÉ ƒë·ªïi 170‚Äì180px n·∫øu th√≠ch */
  min-width: 150px;
  display: inline-block;
}

/* CƒÉn C·∫¢ 3 √¥ (Ch·∫ø ƒë·ªô / Ph√∫t / Gi√¢y) v√†o ch√≠nh gi·ªØa h√†ng */
.timer-row{
  display: flex;
  justify-content: center;   /* Ctrl + E */
  gap: 12px;                 /* kho·∫£ng c√°ch gi·ªØa c√°c √¥ */
}

/* ƒê·ª´ng ƒë·ªÉ .grow ƒë·∫©y l·ªách sang tr√°i trong h√†ng timer */
.timer-row .grow{
  flex: 0 0 auto;            /* ch·ªâ v·ª´a n·ªôi dung */
  text-align: center;        /* label v√† select ƒë·ªÅu gi·ªØa */
}

/* Cho ƒë·∫πp: cƒÉn gi·ªØa label + input c·ªßa 2 c·ªôt Ph√∫t/Gi√¢y */
.timer-row > div{
  text-align: center;
}

/* Gi·ªØ Ph√∫t/Gi√¢y kh√¥ng xu·ªëng h√†ng (n·∫øu b·∫°n ch∆∞a c√≥) */
#timerMin, #timerSec{
  width: 110px !important;
  min-width: 90px;
  flex: 0 0 auto;
}

/* CƒÉn gi·ªØa 2 n√∫t "X√≥a t·∫•t c·∫£" v√† "So·∫°n m·∫´u nhanh" */
.notes-tools{
  display: flex;
  justify-content: center;  /* Ctrl + E */
  gap: 12px;                /* kho·∫£ng c√°ch gi·ªØa n√∫t */
  margin: 8px 0 10px;
}

/* Cho c√°c n√∫t ƒë·ªìng ƒë·ªÅu */
.notes-tools .btn{
  min-width: 140px;
  text-align: center;
}

/* Ch·ªØ "‚Äì B·ªä LO·∫†I" */
.assignments td .eliminated {
  color: #ff6b6b;       /* ƒë·ªè nh·∫°t c·∫£nh b√°o */
  font-weight: 600;
  margin-left: 6px;
  font-size: 0.9em;
  opacity: 0.9;
}

/* td gi·ªØ ki·ªÉu b·∫£ng, kh√¥ng flex */
.assignments td.name-cell{
  display: table-cell !important;   /* √©p v·ªÅ table-cell ƒë·ªÉ kh√¥ng ph√° layout */
  vertical-align: middle;
  padding-left: 6px;
}

/* wrapper b√™n trong chia 2 ph√≠a: T√™n | ‚Äì B·ªä LO·∫†I */
.assignments td.name-cell .name-wrap{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  width: 100%;
  min-width: 0;
}

/* T√™n c·∫Øt ... khi d√†i */
.assignments td.name-cell .player-name{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Nh√£n ‚Äì B·ªä LO·∫†I */
.assignments td.name-cell .eliminated{
  color: #ff6b6b;
  font-weight: 700;
  font-size: .92em;
  white-space: nowrap;
  margin-left: 12px;
}

/* Ch·ªØ B·ªä LO·∫†I n·ªïi b·∫≠t */
.assignments td .eliminated {
  color: #ff6b6b;
  font-weight: 600;
  font-size: 0.9em;
  white-space: nowrap;
}

/* td gi·ªØ ki·ªÉu b·∫£ng, kh√¥ng flex */
.assignments td.name-cell {
  vertical-align: middle;
  padding-left: 6px;  /* tu·ª≥ ch·ªânh */
}

/* wrapper m·ªõi b√™n trong ƒë·ªÉ chia 2 b√™n */
.assignments td.name-cell .name-wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  width: 100%;
  min-width: 0;
}

/* T√™n b·ªã c·∫Øt ... n·∫øu d√†i */
.assignments td.name-cell .player-name {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Nh√£n B·ªä LO·∫†I */
.assignments td.name-cell .eliminated {
  color: #ff6b6b;
  font-weight: 700;
  font-size: .92em;
  white-space: nowrap;
  margin-left: 12px;
}

/* --- MOBILE HARDEN KIT: ch·ªëng tr√†n & co gi√£n an to√†n --- */

/* 1) C√°c item trong flex/grid m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c ph√©p co l·∫°i */
.grid > *, .row > *, .section-title > *, .tools > *,
.roles .item > *, .assignments table th, .assignments table td {
  min-width: 0;
}

/* 2) VƒÉn b·∫£n d√†i c√≥ th·ªÉ xu·ªëng d√≤ng & c·∫Øt ... khi c·∫ßn */
:where(h1,h2,h3,h4,h5,p,div,span,button,td,th,label){
  overflow-wrap: anywhere;
  word-break: break-word;
  text-wrap: balance;        /* ƒë·∫πp tr√™n tr√¨nh duy·ªát m·ªõi */
}

/* 3) H√¨nh/ SVG kh√¥ng v∆∞·ª£t chi·ªÅu ngang */
img, svg, video, canvas { max-width: 100%; height: auto; }

/* 4) Kh√¥ng cho ph·∫ßn t·ª≠ n√†o t·∫°o thanh cu·ªôn ngang ngo√†i √Ω mu·ªën */
html, body, .container { overflow-x: hidden; }

/* 5) Header & container t√¥n tr·ªçng safe-area (tai th·ªè iPhone) */
header {
  padding-left: calc(16px + env(safe-area-inset-left, 0px));
  padding-right: calc(16px + env(safe-area-inset-right, 0px));
}
.container {
  padding-left: calc(16px + env(safe-area-inset-left, 0px));
  padding-right: calc(16px + env(safe-area-inset-right, 0px));
}

/* 6) Vai tr√≤ (grid) lu√¥n ‚Äúl·ªçt‚Äù m√†n ‚Äì cho c·ªôt s·ªë l∆∞·ª£ng co nh·ªè */
:root { --roles-cols: 1.1fr .8fr 110px auto; }
@media (max-width: 480px){
  :root { --roles-cols: 1fr .8fr 90px auto; }
  .roles input[type="number"]{ max-width: 90px; }
}

/* 7) T√™n ng∆∞·ªùi ch∆°i ‚Äì l∆∞·ªõi kh√¥ng tr√†n */
.names { grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); }
@media (max-width: 360px){ .names { grid-template-columns: 1fr; } }

/* 8) B·∫£ng ph√¢n vai: cho ph√©p wrap & √©p c·ªôt n√∫t h·∫πp h∆°n tr√™n m√†n nh·ªè */
.assignments table { table-layout: fixed; width: 100%; }
.assignments th, .assignments td { white-space: normal; }   /* cho xu·ªëng d√≤ng khi c·∫ßn */
@media (max-width: 420px){
  .assignments table th:last-child,
  .assignments table td:last-child { width: 60px; }          /* n√∫t nh·ªè h∆°n ch√∫t */
  .assignments td .btn{ padding:6px 8px; font-size:13px; }
}

/* 9) H√†ng timer: co ƒë·ªÅu, kh√¥ng ƒë·∫©y tr√†n */
.timer-row { flex-wrap: nowrap; gap: 8px; }
.timer-row > * { min-width: 0; }          /* cho ph√©p co */
#timerMode, #timerMin, #timerSec { width: auto; }
@media (max-width: 360px){
  #timerMode{ min-width: 120px; }
  #timerMin, #timerSec{ min-width: 84px; }
}

/* 10) N√∫t d√†i/nh√£n d√†i v·∫´n co g·ªçn */
.btn { max-width: 100%; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }

/* 11) Trang tr√≠ n·ªÅn kh√¥ng g√¢y tr√†n (ƒë√£ ·∫©n <=1024, nh∆∞ng ch·∫∑n th√™m) */
.container::after { pointer-events:none; max-width: 100dvw; }

/* 12) Tr∆∞·ªùng h·ª£p c·ª±c ƒëoan (<340px): b·ªçc b·∫£ng ƒë·ªÉ kh√¥ng t·∫°o tr√†n to√†n trang */
@media (max-width: 340px){
  .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .table-wrap table{ min-width: 440px; }  /* ch·ªâ cu·ªôn ngang b√™n trong khi R·∫§T h·∫πp */
}

/* === Thu nh·ªè √¥ nh·∫≠p Ph√∫t & Gi√¢y === */
#timerMin,
#timerSec {
  width: 70px !important;    /* nh·ªè h∆°n (tr∆∞·ªõc b·∫°n ƒë·ªÉ 90‚Äì110px) */
  max-width: 80px;
  text-align: center;
  padding: 6px 8px;          /* gi·∫£m padding b√™n trong */
  font-size: 15px;           /* ch·ªØ nh·ªè g·ªçn v·ª´a m·∫Øt */
}

/* Mobile: √©p nh·ªè h∆°n n·ªØa n·∫øu m√†n r·∫•t h·∫πp */
@media (max-width: 420px) {
  #timerMin,
  #timerSec {
    width: 60px !important;
    font-size: 14px;
  }
}

/* === Thu g·ªçn c·ªôt M√¥ t·∫£ & S·ªë l∆∞·ª£ng ƒë·ªÉ nh∆∞·ªùng ch·ªó cho Vai tr√≤ === */
.roles {
  grid-template-columns: 1.2fr 0.6fr 80px auto; /* Vai tr√≤ | M√¥ t·∫£ | S·ªë l∆∞·ª£ng | (x√≥a) */
  gap: 8px;
}

/* √î nh·∫≠p s·ªë l∆∞·ª£ng nh·ªè l·∫°i */
.roles input[type="number"] {
  width: 70px !important;   /* g·ªçn h∆°n (tr∆∞·ªõc l√† 120px) */
  max-width: 80px;
  text-align: center;
  padding: 4px 6px;
  font-size: 15px;
}

/* N√∫t "Hi·ªán" trong c·ªôt M√¥ t·∫£ */
.roles .item button {
  min-width: 70px;          /* n√∫t nh·ªè h∆°n */
  padding: 6px 10px;
  font-size: 14px;
  text-align: center;
}

/* Tr√™n m√†n h·∫πp h∆°n 480px, √©p nh·ªè h∆°n n·ªØa */
@media (max-width: 480px) {
  .roles {
    grid-template-columns: 1fr 0.6fr 60px auto;
  }
  .roles input[type="number"] {
    width: 60px !important;
    font-size: 14px;
  }
  .roles .item button {
    min-width: 60px;
    font-size: 13px;
    padding: 5px 8px;
  }
}

/* CƒÉn gi·ªØa d√≤ng ghi ch√∫ */
.hint {
  text-align: center;
}

/* ·∫®n √¥ M·∫πo ·ªü c√°c section b√¨nh th∆∞·ªùng, KH√îNG ·∫©n ·ªü header vai tr√≤ */
.section-title:not(.roles-head) .chip {
  display: none !important;
}

/* ==== TIMER: 3 √¥ th·∫≥ng h√†ng, cao b·∫±ng nhau, kh√¥ng tr√†n ph·∫£i ==== */

/* B·ªè m·ªçi width c·ª©ng tr∆∞·ªõc ƒë√≥ */
#timerMode,
#timerMin,
#timerSec{
  width: 100% !important;   /* ƒë·ªÉ c·ªôt quy·∫øt ƒë·ªãnh b·ªÅ ngang */
  min-width: 0 !important;
  max-width: 100% !important;
}

/* ==== TIMER: 3 √¥ th·∫≥ng h√†ng, cao b·∫±ng nhau, Gi√¢y s√°t Ph√∫t ==== */
.timer-row{
  display: grid !important;
  grid-template-columns: minmax(160px,1fr) 80px 80px; /* ch·∫ø ƒë·ªô | ph√∫t | gi√¢y */
  grid-template-areas: "mode min sec";
  column-gap: 8px;          /* kho·∫£ng c√°ch chung */
  align-items: end;
}

.timer-row > div:nth-child(2){ grid-area: min; }
.timer-row > div:nth-child(3){ grid-area: sec; }

/* Thu h·∫πp kho·∫£ng c√°ch gi·ªØa Ph√∫t v√† Gi√¢y */
.timer-row > div:nth-child(2),
.timer-row > div:nth-child(3){
  margin-right: 0;          /* kh√¥ng c√≥ d∆∞ b√™n ph·∫£i */
}
.timer-row > div:nth-child(2){ margin-right: 4px; } /* ch·ªâ c√°ch nh·∫π gi·ªØa Ph√∫t v√† Gi√¢y */

.timer-row select,
.timer-row input[type="number"]{
  height: 44px;
  padding: 10px 12px;
  border-radius: 12px;
  text-align: center;
  box-sizing: border-box;
}

.timer-row label{
  display:block;
  margin: 6px 2px;
  text-align:center;
}

/* M√†n nh·ªè */
@media (max-width: 400px){
  .timer-row{
    grid-template-columns: minmax(140px,1fr) 70px 70px;
    column-gap: 6px;        /* h·∫πp h∆°n n·ªØa */
  }
  .timer-row select,
  .timer-row input[type="number"]{ height: 40px; font-size: 15px; }
}

/* CƒÉn gi·ªØa nh√£n + input c·ªßa c·ªôt Gi√¢y */
.timer-row > div:nth-child(3) {
  text-align: center;    /* nh√£n Gi√¢y cƒÉn gi·ªØa */
  justify-self: center;  /* √¥ nh·∫≠p li·ªáu Gi√¢y cƒÉn gi·ªØa theo c·ªôt */
}

/* ƒê·∫£m b·∫£o input kh√¥ng b·ªã k√©o l·ªách */
#timerSec {
  margin-left: 0 !important;
}
/* M√†u vi·ªÅn theo phe khi ƒë√£ ch·ªçn */
#customRoleFaction.f-village { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15); }
#customRoleFaction.f-wolf    { border-color:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
#customRoleFaction.f-swap    { border-color:#10b981; box-shadow:0 0 0 3px rgba(16,185,129,.15); }
#customRoleFaction.f-third   { border-color:#eab308; box-shadow:0 0 0 3px rgba(234,179,8,.15); }

/* ·ª¶NG H·ªò: x·∫øp d·ªçc ‚Äì QR tr√™n, info d∆∞·ªõi, cƒÉn gi·ªØa */
.donate .wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}

/* QR vu√¥ng, bo g√≥c, cƒÉn gi·ªØa */
.donate .qr{
  width:220px;            /* th√≠ch 180‚Äì240 tu·ª≥ b·∫°n */
  aspect-ratio:1/1;
  object-fit:contain;
  background:#0c0f1f;
  border:1px solid #283056;
  border-radius:12px;
  padding:8px;
}

/* Info b√™n d∆∞·ªõi cƒÉn gi·ªØa */
.donate .info{ text-align:center; }

/* M·ªói d√≤ng info l√† m·ªôt h√†ng g·ªçn */
.donate .row{ display:inline-flex; align-items:center; gap:8px; }
.donate .label{ color:var(--muted); font-weight:600; }

/* MB BANK ·ªü gi·ªØa h√†ng */
.donate .bank-name{ font-weight:700; letter-spacing:.2px; }

/* Kh√¥ng xu·ªëng d√≤ng cho S·ªê TK / T√äN TK */
.donate .nowrap{ white-space:nowrap; }

@media (max-width:420px){
  .donate .qr{ width:180px; }
}

/* Promo handmade: ·∫£nh tr√°i, 2 d√≤ng ph·∫£i */
.donate-promo{
  display:flex; align-items:center; gap:12px;
  margin-top:12px;
  background:#0c0f1f; border:1px solid var(--border);
  border-radius:12px; padding:10px;
}
.donate-promo .promo-photo{
  width:140px; aspect-ratio:4/3; object-fit:cover;
  border-radius:10px; flex:0 0 auto;
}
.donate-promo .promo-text{ flex:1 1 auto; }
.donate-promo .promo-text p{ margin:0 0 6px; line-height:1.5; }
.donate-promo a{
  color:#dbeafe; text-decoration:underline;
  overflow-wrap:anywhere;
}

/* N·∫øu m√†n r·∫•t h·∫πp, v·∫´n gi·ªØ b·ªë c·ª•c tr√°i‚Äìph·∫£i g·ªçn */
@media (max-width:420px){
  .donate-promo .promo-photo{ width:120px; }
  .donate-promo .promo-text p{ font-size:15px; }
}

/* Center + m√†u gi·ªëng "NG√ÇN H√ÄNG TMCP QU√ÇN ƒê·ªòI" */
.donate-promo .promo-text { text-align: center; }

.donate-promo .promo-title{
  margin: 0 0 6px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: var(--muted);          /* c√πng m√†u label ng√¢n h√†ng */
}

.donate-promo .promo-line{
  margin: 0;
  line-height: 1.5;
  text-align: center;
}

.donate-promo .promo-link{ margin: 6px 0 0; }
.donate-promo .promo-link a{
  color: var(--muted) !important; /* link trung m√†u v·ªõi ti√™u ƒë·ªÅ ng√¢n h√†ng */
  text-decoration: underline;
}

/* ·∫¢nh cao h∆°n m·ªôt ch√∫t */
.donate-promo .promo-photo{
  width: 160px;
  height: 140px;               /* tƒÉng chi·ªÅu cao */
  aspect-ratio: auto !important;/* v√¥ hi·ªáu t·ªâ l·ªá c≈© 4/3 */
  object-fit: cover;
  border-radius: 10px;
  flex: 0 0 auto;
}

@media (max-width: 420px){
  .donate-promo .promo-photo{
    width: 140px;
    height: 120px;
  }
}

/* X·∫øp d·ªçc & cƒÉn gi·ªØa to√†n b·ªô kh·ªëi */
.donate-promo{
  display: flex;
  flex-direction: column;   /* <- ƒë·ªïi t·ª´ h√†ng sang c·ªôt */
  align-items: center;
  gap: 10px;
  text-align: center;       /* m·ªçi d√≤ng ch·ªØ cƒÉn gi·ªØa */
}

/* D√≤ng ti√™u ƒë·ªÅ ‚Äì ƒë·∫≠m, c√πng m√†u v·ªõi ‚ÄúNG√ÇN H√ÄNG TMCP QU√ÇN ƒê·ªòI‚Äù */
.donate-promo .promo-title{
  margin: 0;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: var(--muted);
}

/* D√≤ng m√¥ t·∫£ d∆∞·ªõi ti√™u ƒë·ªÅ */
.donate-promo .promo-line{ margin: 0; line-height: 1.5; }

/* ·∫¢nh: cƒÉn gi·ªØa v√† cao h∆°n ch√∫t */
.donate-promo .promo-photo{
  display: block;
  width: 240px;          /* c√≥ th·ªÉ ch·ªânh 220‚Äì280 tu·ª≥ th√≠ch */
  height: 160px;         /* ‚Äúcao h∆°n x√≠u‚Äù */
  object-fit: cover;
  border-radius: 12px;
  margin: 4px auto 0;
}

/* Link: cƒÉn gi·ªØa + m√†u gi·ªëng ti√™u ƒë·ªÅ ng√¢n h√†ng */
.donate-promo .promo-link{ margin: 0; }
.donate-promo .promo-link a{
  color: var(--muted) !important;
  text-decoration: underline;
  word-break: break-word;
}

@media (max-width: 420px){
  .donate-promo .promo-photo{ width: 210px; height: 145px; }
}

/* === Donate promo: tweak per request === */

/* 1) Ti√™u ƒë·ªÅ: l·ªõn h∆°n ~2 c·ª°, gi·ªØ m√†u nh∆∞ "NG√ÇN H√ÄNG TMCP QU√ÇN ƒê·ªòI" */
.donate-promo .promo-title{
  font-size: clamp(22px, 5.2vw, 24px); /* tƒÉng size */
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .3px;
  color: #ba0000;                 /* m√†u gi·ªëng d√≤ng ng√¢n h√†ng */
  text-align: center;
  margin: 0;
}

/* 2) D√≤ng m√¥ t·∫£: cƒÉn gi·ªØa (Ctrl + E), ƒë·ªçc d·ªÖ h∆°n */
.donate-promo .promo-line{
  margin: 0 auto 6px;
  text-align: justify;                  /* cƒÉn gi·ªØa */
  max-width: 640px;                    /* gi·ªõi h·∫°n ƒë·ªô d√†i ƒë·ªÉ d·ªÖ ƒë·ªçc */
  line-height: 1.6;
}

/* 3) ·∫¢nh: r·ªông h∆°n m·ªôt x√≠u */
.donate-promo .promo-photo{
  width: 280px;                        /* tr∆∞·ªõc ~240px -> n·ªõi r·ªông */
  height: 180px;                       /* gi·ªØ t·ªâ l·ªá, c√≥ th·ªÉ ch·ªânh 170‚Äì190 */
  object-fit: cover;
  border-radius: 12px;
  display: block;
  margin: 4px auto 0;                  /* lu√¥n cƒÉn gi·ªØa */
}

/* Mobile v·∫´n to h∆°n ch√∫t nh∆∞ng v·ª´a m√†n */
@media (max-width: 420px){
  .donate-promo .promo-photo{
    width: 260px;
    height: 172px;
  }
}

/* Link: ƒë√£ cƒÉn gi·ªØa s·∫µn, gi·ªØ m√†u gi·ªëng ti√™u ƒë·ªÅ ng√¢n h√†ng */
.donate-promo .promo-link{ margin: 0; text-align: center; }
.donate-promo .promo-link a{
  color: var(--muted) !important;
  text-decoration: underline;
  word-break: break-word;
}

/* --- Header "Thi·∫øt l·∫≠p vai tr√≤" g·ªçn tr√™n mobile --- */
@media (max-width: 560px){
  .section-title.roles-head{
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "title title"
      "slots total";
    row-gap: 8px;
    column-gap: 8px;
    align-items: end;
  }
  .section-title.roles-head h2{
    grid-area: title;
    margin: 0;
    white-space: nowrap;          /* gi·ªØ ti√™u ƒë·ªÅ kh√¥ng xu·ªëng d√≤ng */
  }
  /* 2 chip n·∫±m h√†ng d∆∞·ªõi, tr√°i | ph·∫£i */
  .section-title.roles-head .chip{
    grid-column: auto !important; /* ghi ƒë√® m·ªçi grid-column c≈© */
  }
  .section-title.roles-head .chip:first-of-type{  /* C√≤n tr·ªëng */
    grid-area: slots;
    justify-self: start;
  }
  .section-title.roles-head .chip:last-of-type{   /* T·ªïng */
    grid-area: total;
    justify-self: end;
  }
}
/* Ti√™u ƒë·ªÅ 2 d√≤ng + 2 tim hai b√™n, tim n·∫±m gi·ªØa hai d√≤ng */
.donate-title{
  display:flex;
  align-items:center;          /* tim canh gi·ªØa theo chi·ªÅu d·ªçc kh·ªëi 2 d√≤ng */
  justify-content:center;
  gap:12px;
  margin:0 0 10px;
  text-align:center;
}
.donate-title .heart{
  font-size:22px;
  line-height:1;
}
.donate-title .lines{ line-height:1.25 }
.donate-title .line1{
  font-size:20px;
  font-weight:800;
}
.donate-title .line2{
  font-size:18px;
  font-weight:700;
  opacity:.95;
}
@media (max-width:420px){
  .donate-title .line1{ font-size:18px }
  .donate-title .line2{ font-size:16px }
}
/* Header "Thi·∫øt l·∫≠p vai tr√≤": title tr√°i, 2 chip ph·∫£i ‚Äì lu√¥n c√πng h√†ng */
.section-title.roles-head{
  display: grid !important;
  grid-template-columns: 1fr auto !important; /* 2 c·ªôt: title | chips */
  align-items: center;
  gap: 8px;
}

.section-title.roles-head h2{
  margin: 0;
  white-space: nowrap;         /* kh√¥ng xu·ªëng d√≤ng */
  overflow: hidden;
  text-overflow: ellipsis;     /* thi·∫øu ch·ªó th√¨ ‚Ä¶ */
  min-width: 0;                /* cho ph√©p co */
}

/* Nh√≥m 2 chip ƒë·ª©ng c·∫°nh nhau */
.section-title.roles-head .chips{
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
.section-title.roles-head .chip{ white-space: nowrap; }

/* Mobile v·∫´n gi·ªØ 1 h√†ng, ch·ªâ thu nh·ªè kho·∫£ng c√°ch/ch·ªØ n·∫øu c·∫ßn */
@media (max-width: 560px){
  .section-title.roles-head{ grid-template-columns: 1fr auto !important; }
  .section-title.roles-head .chips{ gap: 6px; }
  .section-title.roles-head h2{ font-size: 18px; }  /* tu·ª≥ th√≠ch */
}
/* Header "Thi·∫øt l·∫≠p vai tr√≤": ti√™u ƒë·ªÅ tr√°i, 2 chip d·∫°t ph·∫£i */
.section-title.roles-head{
  display: flex !important;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
.section-title.roles-head h2{
  margin: 0;
  white-space: nowrap;         /* kh√¥ng xu·ªëng d√≤ng */
  overflow: hidden;
  text-overflow: ellipsis;     /* thi·∫øu ch·ªó th√¨ ‚Ä¶ */
  flex: 1 1 auto;              /* nh∆∞·ªùng ch·ªó cho 2 chip b√™n ph·∫£i */
  min-width: 0;
}
.section-title.roles-head .chip{
  flex: 0 0 auto;
  white-space: nowrap;
}
/* ƒë·∫©y C·∫∂P chip sang ph·∫£i */
.section-title.roles-head .chip:first-of-type{
  margin-left: auto;
}

/* Ghi ƒë√® rule mobile c≈© t·ª´ng ƒë·∫©y chip xu·ªëng d√≤ng */
@media (max-width: 560px){
  .section-title.roles-head{
    display: flex !important;
    flex-wrap: nowrap !important;
  }
  .section-title.roles-head .chip:first-of-type{
    margin-left: auto !important;
  }
}
/* D√≤ng ngƒÉn c√°ch gi·ªØa c√°c phe trong b·∫£ng vai tr√≤ */
.roles .sep{
  grid-column: 1 / -1;      /* chi·∫øm c·∫£ 4 c·ªôt */
  text-align: center;
  color: #a5b4fc;
  opacity: .9;
  padding: 6px 0 2px;
  font-weight: 700;
  letter-spacing: .2px;
}

/* === Ghi ch√∫: m√†u ri√™ng cho 2 n√∫t === */
#quickTemplateBtn{
  background: #0f1f3a !important;   /* xanh lam ƒë·∫≠m */
  border-color: #244b8a !important;
  color: #dbeafe !important;
}
#quickTemplateBtn:hover{
  background: #152a57 !important;
  border-color: #2e60b3 !important;
}

#saveNotesBtn{
  background: #0d2a22 !important;   /* xanh l·ª•c ƒë·∫≠m */
  border-color: #13493b !important;
  color: #c7ffee !important;
}
#saveNotesBtn:hover{
  background: #123628 !important;
  border-color: #17604e !important;
}
/* N√∫t "C·ª©u" trong h√†ng ƒë√£ b·ªã lo·∫°i: xanh l·ª•c + kh√¥ng m·ªù */
.assignments tr.dead td .btn{
  background: #0d2a22 !important;   /* xanh l·ª•c ƒë·∫≠m */
  border-color: #13493b !important;
  color: #c7ffee !important;
  opacity: 1 !important;            /* b·ªè l√†m m·ªù */
  filter: none !important;          /* b·ªè gi·∫£m s√°ng */
}
.assignments tr.dead td .btn:hover{
  background: #123628 !important;
  border-color: #17604e !important;
}

@media (max-width: 480px){
  .promo-title{ font-size: clamp(22px, 5.4vw, 28px); } /* mobile to h∆°n */
}
/* === FAB '!!' m·ªü b·∫£ng Th·ª© t·ª± k√™u d·∫≠y === */
.fab-night{
  position: fixed;
  right: 16px; 
  bottom: 16px;
  width: 56px; height: 56px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: linear-gradient(135deg, var(--accent) 0%, #5f44ff 100%);
  color: #fff; font-weight: 900; font-size: 20px;
  box-shadow: var(--shadow);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 1000;
}
.fab-night:hover{ transform: translateY(-1px); }

/* Th√¢n modal n·ªôi dung 'Th·ª© t·ª± k√™u d·∫≠y' */
#nightOrderBody{
  background: rgba(8,12,28,.72);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 0 0 12px 12px;
  padding: 14px 16px;
  color: var(--text);
  line-height: 1.7;
  white-space: normal;                 /* d√πng danh s√°ch, kh√¥ng c·∫ßn pre-wrap */
}
#nightOrderBody .intro{ color:#c7cfff; margin: 0 0 8px }
#nightOrderBody ol{ margin: 6px 0 10px; padding-left: 1.4em }
#nightOrderBody li + li{ margin-top: 4px }
#nightOrderBody .note{ opacity:.9; font-size:.95em }
#nightOrderBody .sub{ color:#a5b4fc; font-size:.95em; margin:.25em 0 .5em }
#nightOrderBody .section{
  text-align:center; margin:10px 0 6px; color:var(--muted); font-weight:700
}

/* ·∫®n khi in */
@media print{ .fab-night{ display:none !important } }
/* Cho th√¢n modal cu·ªôn khi n·ªôi dung d√†i */
.modal{
  width: min(720px, 95vw);
  max-height: calc(100dvh - 32px);
  display: flex;
  flex-direction: column;
}
.modal header{
  flex: 0 0 auto;
}
.modal .content{
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto !important;            /* <- cho ph√©p cu·ªôn */
  -webkit-overflow-scrolling: touch;    /* m∆∞·ª£t tr√™n mobile */
}
/* Modal 'Th·ª© t·ª± k√™u d·∫≠y' ‚Äî cƒÉn gi·ªØa 2 d√≤ng m·ªü ƒë·∫ßu */
#nightOrderBody .intro{
  color:#c7cfff;
  margin:0 0 8px;
  text-align:center;            /* cƒÉn gi·ªØa */
  text-wrap:balance;
}

/* M·ª•c s·ªë 4 c·ªßa danh s√°ch ƒë·∫ßu ti√™n: cƒÉn ƒë·ªÅu (Ctrl+J) */
#nightOrderBody ol:first-of-type > li:nth-child(4){
  text-align: justify;
  text-justify: inter-word;
  hyphens: auto;
}

/* D√≤ng ph·ª• b√™n trong m·ª•c 4 v·∫´n cƒÉn tr√°i b√¨nh th∆∞·ªùng */
#nightOrderBody ol:first-of-type > li:nth-child(4) .sub{
  text-align: left;
}
/* M·ª•c 4: 2 d√≤ng .sub cƒÉn gi·ªØa + ƒë·ªè + ƒë·∫≠m */
#nightOrderBody ol:first-of-type > li:nth-child(4) .sub{
  text-align: center !important;
  color: var(--danger, #ef4444) !important; /* ƒë·ªè ƒë·ªìng b·ªô theme */
  font-weight: 700 !important;
}
/* ƒê·ªè + ƒë·∫≠m cho d√≤ng "K√™u d·∫≠y 1 l·∫ßn ƒë√™m ƒë·∫ßu ti√™n ..." trong modal */
#nightOrderBody .section{
  color: var(--danger, #ef4444) !important;
  font-weight: 800 !important;
}
/* Thu nh·ªè header 2 modal: Kho l∆∞u tr·ªØ & Th·ª© t·ª± k√™u d·∫≠y */
#notesArchiveModal header,
#nightOrderModal header{
  padding: 12px 16px;     /* c√πng padding nh∆∞ modal m√¥ t·∫£ vai */
}

/* H3 kh√¥ng c√≤n margin m·∫∑c ƒë·ªãnh -> header th·∫•p l·∫°i ƒë√∫ng b·∫±ng nhau */
#notesArchiveModal header h3,
#nightOrderModal header h3{
  margin: 0;              /* quan tr·ªçng: b·ªè top/bottom margin m·∫∑c ƒë·ªãnh */
  font-size: 18px;        /* ƒë·ªìng b·ªô k√≠ch th∆∞·ªõc */
  line-height: 1.2;
}

/* N√∫t ƒë√≥ng g·ªçn l·∫°i m·ªôt ch√∫t cho c√¢n ƒë·ªëi (tu·ª≥ ch·ªçn) */
#notesArchiveModal .close,
#nightOrderModal .close{
  padding: 6px 10px;
  font-size: 14px;
  line-height: 1.2;
}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="top-row">
        <div class="logo" aria-hidden="true">
          <img src="https://play-lh.googleusercontent.com/NoTmMzso2UYOdoaLcADzE6eRnZaKpfz_gTcFsJMBQyLB09Q_J8I0aLWRlTi6RZpTdO33" alt="Logo S√≥i">
        </div>
        <h1>Tr·ª£ Th·ªß Qu·∫£n Tr√≤ üê∫üé≤</h1>
      </div>
      <div class="chip" title="D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông trong tr√¨nh duy·ªát">Created by Dang Khoa ‚ù§Ô∏è</div>
    </div>
  </header>

  <div class="container grid">
    <!-- LEFT: SETUP + ASSIGNMENT -->
    <section class="card">
      <div class="section-title">
        <h2>üë§ Thi·∫øt l·∫≠p ng∆∞·ªùi ch∆°i</h2>
        <div class="chip">M·∫πo: <span class="kbd">Tab</span> ƒë·ªÉ chuy·ªÉn nhanh gi·ªØa c√°c √¥ t√™n tr√™n m√°y t√≠nh.</div>
      </div>

      <div class="row wrap" id="playerSetupRow">
        <div class="grow">
          <label for="playerCount">S·ªë ng∆∞·ªùi ch∆°i</label>
          <input id="playerCount" type="number" min="3" max="151" value="10" />
        </div>
        <div class="row" style="gap:8px; align-items:flex-end">
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="autoFillNames">ƒêi·ªÅn t√™n m·∫∑c ƒë·ªãnh</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="shuffleNames">X√°o tr·ªôn danh s√°ch</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn danger" id="removeEmptyNames">X√≥a t√™n ng∆∞·ªùi ch∆°i</button>
          </div>
        </div>
      </div>

      <label>Danh s√°ch t√™n ng∆∞·ªùi ch∆°i</label>
      <div id="names" class="names"></div>

      <hr style="border-color:#28305633; margin:16px 0">

      <!-- Header khu vai tr√≤ -->
      <div class="section-title roles-head">
  <h2>üÉè Thi·∫øt l·∫≠p vai tr√≤</h2>
  <div class="chips">
    <div class="chip">Tr·ªëng: <b id="slotsLeft">0</b></div>
    <div class="chip">T·ªïng: <b id="rolesTotal">0</b></div>
  </div>
</div>

      <div class="roles" role="table" aria-label="B·∫£ng vai tr√≤">
        <div class="header">Vai tr√≤</div>
        <div class="header">M√¥ t·∫£</div>
        <div class="header">S·ªë l∆∞·ª£ng</div>
        <div class="header">&nbsp;</div>
        <div id="rolesList"></div>
      </div>

      <div class="row wrap" style="margin-top:8px" id="customRoleRow">
        <div class="grow row">
          <input id="customRoleName" type="text" placeholder="Th√™m vai tr√≤ m·ªõi (v√≠ d·ª•: B·ªã nguy·ªÅn r·ªßa)" />
          <input id="customRoleCount" type="number" min="1" value="1" />
<select id="customRoleFaction" title="Ch·ªçn phe cho vai tr√≤">
    <option value="" selected disabled>‚Äî Ch·ªçn phe ‚Äî</option>
    <option value="village">D√¢n l√†ng</option>
    <option value="wolf">Ma s√≥i</option>
    <option value="swap">ƒê·ªïi phe</option>
    <option value="third">Phe th·ª© 3</option>
  </select>
        </div>
        <div id="customRoleActions" class="row">
          <button class="btn" id="addCustomRole">+ Th√™m vai tr√≤</button>
          <button class="btn ghost" id="resetRoles" title="ƒê∆∞a vai tr√≤ v·ªÅ m·∫∑c ƒë·ªãnh">M·∫∑c ƒë·ªãnh: 10üë§</button>
        </div>
      </div>

      <div class="hint" style="margin:6px">N·∫øu t·ªïng vai tr√≤ v∆∞·ª£t qu√° s·ªë ng∆∞·ªùi, b·∫°n s·∫Ω ƒë∆∞·ª£c nh·∫Øc ƒëi·ªÅu ch·ªânh. √î tr·ªëng s·∫Ω t·ª± l·∫•p b·∫±ng vai tr√≤ <b>D√¢n l√†ng</b>.</div>

      <div class="tools no-print" style="margin-top:12px">
        <button class="btn primary" id="assignBtn">üé≤ Chia vai tr√≤ ng·∫´u nhi√™n</button>
        <button class="btn" id="reshuffleBtn" disabled>üîÄ Tr·ªôn l·∫°i</button>
        <button class="btn" id="revealAllBtn" disabled>üëÅÔ∏è‚Äçüó®Ô∏è Hi·ªán/·∫®n t·∫•t c·∫£</button>
        <button class="btn" id="copyBtn" disabled>üìã Sao ch√©p</button>
        <!-- ƒê·ªïi n√∫t In th√†nh n√∫t S·∫Øp x·∫øp -->
        <button class="btn" id="sortBtn" disabled>‚ÜïÔ∏è S·∫Øp x·∫øp</button>
      </div>

      <div class="assignments" id="assignments" style="margin-top:8px"></div>
    </section>

    <!-- RIGHT: TIMER + NOTES -->
    <aside class="card">
      <div class="section-title">
        <h2>‚è≥Ô∏è B·ªô ƒë·∫øm th·ªùi gian</h2>
        <div class="row">
          <label class="chip" style="cursor:pointer"><input id="soundToggle" type="checkbox" checked style="margin-right:8px">Chu√¥ng</label>
        </div>
      </div>

      <div class="row wrap timer-row">
  <div class="grow">
    <label>Ch·∫ø ƒë·ªô</label>
    <select id="timerMode">
      <option value="down">ƒê·∫øm ng∆∞·ª£c</option>
      <option value="up">ƒê·∫øm xu√¥i</option>
    </select>
  </div>
  <div>
    <label>Ph√∫t</label>
    <input id="timerMin" type="number" min="0" value="2">
  </div>
  <div>
    <label>Gi√¢y</label>
    <input id="timerSec" type="number" min="0" max="59" value="0">
  </div>
</div>

      <div class="timer-big" id="timerDisplay">02:00</div>
      <div class="timer-controls no-print">
        <button class="btn ok" id="startPauseBtn">‚ñ∂Ô∏é B·∫Øt ƒë·∫ßu</button>
        <button class="btn" id="resetTimerBtn">‚ü≤ ƒê·∫∑t l·∫°i</button>
        <button class="btn" data-preset="30">Bi·ªán h·ªô (30s)</button>
        <button class="btn" data-preset="120">Th·∫£o lu·∫≠n (2‚Äô)</button>
        <button class="btn" data-preset="180">Th·∫£o lu·∫≠n (3‚Äô)</button>
        <button class="btn" data-preset="300">Th·∫£o lu·∫≠n (5‚Äô)</button>
      </div>

      <hr style="border-color:#28305633; margin:18px 0">

      <h2>üóíÔ∏è Ghi ch√∫</h2>
      <!-- N√∫t m·ªõi cho ghi ch√∫ -->
      <div class="notes-tools no-print">
        <button class="btn danger" id="clearNotesBtn">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
        <button class="btn" id="quickTemplateBtn">‚úçÔ∏è So·∫°n m·∫´u nhanh</button>
        <button class="btn" id="saveNotesBtn">üíøÔ∏è L∆∞u</button>
        <button class="btn" id="openArchiveBtn">üìÅ Kho l∆∞u tr·ªØ</button>
      </div>
      <textarea id="notes" placeholder="Ghi ch√∫: ai b·ªã treo c·ªï, ai b·ªã s√≥i c·∫Øn, l√° phi·∫øu, v.v."></textarea>

<!-- ·ª¶NG H·ªò T√îI -->
<div class="donate no-print">
  <div class="donate-title" role="heading" aria-level="2">
  <div class="lines">
    <div class="line1">‚ù§ ·ª¶NG H·ªò T√îI V√ÄI G√ìI M√å T√îM ‚ù§</div>
    <div class="line2">(n·∫øu b·∫°n mu·ªën)</div>
  </div>
</div>
  <div class="wrap">
    <!-- NH·ªö ƒë√∫ng ƒëu√¥i file: .jpg (ho·∫∑c link raw GitHub) -->
    <img class="qr" src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/qr.jpg" alt="QR MB Bank 0332807382">

    <div class="info">
      <div class="row bank-row">
        <span class="label">NG√ÇN H√ÄNG TMCP QU√ÇN ƒê·ªòI</span>
        <span class="bank-name">- MB BANK</span>
      </div>
      <div class="row nowrap">
        <span class="label">S·ªê TK:</span><span class="value">0332807382</span>
      </div>
      <div class="row nowrap">
        <span class="label">T√äN TK:</span><span class="value">NGUYEN DINH DANG KHOA</span>
      </div>
    </div>
  </div>
<div class="donate-promo">
  <div class="promo-text">
    <p class="promo-title">‚ù§ HO·∫∂C ·ª¶NG H·ªò B·∫∞NG C√ÅCH ‚ù§</p>
    <p class="promo-line">Order c√°c ƒë·ªì len Handmade si√™u xinh v√† c·ª±c k√¨ ƒë√°ng iu v·ªõi gi√° c·∫£ v√¥ c√πng y√™u th∆∞∆°ng ·ªü link Facebook ph√≠a d∆∞·ªõi:</p>
  </div>

  <!-- ·∫¢NH: cƒÉn gi·ªØa -->
  <img class="promo-photo" src="https://raw.githubusercontent.com/samuel2025-dangkhoa/werewolf-assistant/refs/heads/main/pr.png" alt="ƒê·ªì len handmade d·ªÖ th∆∞∆°ng">

  <!-- LINK: cƒÉn gi·ªØa + m√†u nh∆∞ ti√™u ƒë·ªÅ ng√¢n h√†ng -->
  <p class="promo-link">
    <a href="https://www.facebook.com/phuoc.hanh.543792" target="_blank" rel="noopener">
      facebook.com/phuoc.hanh.543792
    </a>
  </p>
</div>
  </div>
</div>

    </aside>
  </div>

  <div class="footer no-print">Created by Dang Khoa ‚ù§Ô∏è ‚Äì L∆∞u t·ª± ƒë·ªông, ho·∫°t ƒë·ªông offline.</div>
  <div class="footer no-print">Phi√™n b·∫£n c·∫≠p nh·∫≠t m·ªõi nh·∫•t: 00:50 17/09/2025</div>
  <!-- Modal xem m√¥ t·∫£ vai -->
  <div id="roleModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <h3 id="roleModalTitle">Vai tr√≤</h3>
        <button class="close" id="roleModalClose">ƒê√≥ng</button>
      </header>
      <div class="content" id="roleModalBody"></div>
    </div>
  </div>

<!-- Modal kho l∆∞u ghi ch√©p -->
<div id="notesArchiveModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="notesArchiveTitle">üìÅ Kho l∆∞u tr·ªØ</h3>
      <button class="close" id="notesArchiveClose">ƒê√≥ng</button>
    </header>
    <div class="content" id="notesArchiveBody">
      <!-- N·ªôi dung render b·∫±ng JS -->
    </div>
  </div>
</div>
<!-- N√öT '!!' n·ªïi -->
<button class="fab-night no-print" id="nightOrderBtn" aria-label="Th·ª© t·ª± k√™u d·∫≠y">!!</button>

<!-- Modal: Th·ª© t·ª± k√™u d·∫≠y -->
<div id="nightOrderModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <header>
      <h3 id="nightOrderTitle">üåô Th·ª© t·ª± k√™u d·∫≠y m·ªói ƒë√™m</h3>
      <button class="close" id="nightOrderClose">ƒê√≥ng</button>
    </header>
    <div class="content" id="nightOrderBody"></div>
  </div>
</div>
<script>
(function(){
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const $ = {
    playerCount: qs('#playerCount'),
    namesWrap: qs('#names'),
    autoFillNames: qs('#autoFillNames'),
    shuffleNames: qs('#shuffleNames'),
    removeEmptyNames: qs('#removeEmptyNames'),
    rolesList: qs('#rolesList'),
    slotsLeft: qs('#slotsLeft'),
    addCustomRole: qs('#addCustomRole'),
    customRoleName: qs('#customRoleName'),
    customRoleCount: qs('#customRoleCount'),
    resetRoles: qs('#resetRoles'),
    customRoleFaction: qs('#customRoleFaction'),

    assignBtn: qs('#assignBtn'),
    reshuffleBtn: qs('#reshuffleBtn'),
    revealAllBtn: qs('#revealAllBtn'),
    copyBtn: qs('#copyBtn'),
    sortBtn: qs('#sortBtn'),
    assignments: qs('#assignments'),

    // Timer
    timerMode: qs('#timerMode'),
    timerMin: qs('#timerMin'),
    timerSec: qs('#timerSec'),
    timerDisplay: qs('#timerDisplay'),
    startPauseBtn: qs('#startPauseBtn'),
    resetTimerBtn: qs('#resetTimerBtn'),
    soundToggle: qs('#soundToggle'),

    // Notes buttons
    clearNotesBtn: qs('#clearNotesBtn'),
    quickTemplateBtn: qs('#quickTemplateBtn'),
    saveNotesBtn: qs('#saveNotesBtn'),        
    openArchiveBtn: qs('#openArchiveBtn'),
  };

// --- Auto sort sau khi "Gi·∫øt"
let autoSortTimer = null;
function scheduleAutoSort(){
  clearTimeout(autoSortTimer);
  autoSortTimer = setTimeout(() => {
    sortAssignmentsByFactionThenRole();
    alert('T·ª± ƒë·ªông s·∫Øp x·∫øp c√°c ng∆∞·ªùi ch∆°i b·ªã lo·∫°i xu·ªëng cu·ªëi danh s√°ch.');
  }, 10000); // 10 gi√¢y
}

  // ===== Modal helpers =====
  const modal = {
    wrap: document.getElementById('roleModal'),
    title: document.getElementById('roleModalTitle'),
    body: document.getElementById('roleModalBody'),
    btnClose: document.getElementById('roleModalClose'),
    open(title, text){
      this.title.textContent = title || 'Vai tr√≤';
      this.body.textContent = text || '';
      this.wrap.classList.add('show');
      this.wrap.setAttribute('aria-hidden','false');
      this.btnClose.focus();
    },
    close(){ this.wrap.classList.remove('show'); this.wrap.setAttribute('aria-hidden','true'); }
  };
  modal.btnClose.addEventListener('click', ()=>modal.close());
  modal.wrap.addEventListener('click', (e)=>{ if(e.target === modal.wrap) modal.close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') modal.close(); });

  // ====== STATE ======
  const STORAGE_KEY = 'werewolf_mod_state_v1';
  let STATE = {
    playerCount: 10,
    names: [],
    roles: {},          // {key: count}
    customRoles: {},    // {name: count}
    assignments: null,
    reveal: {},         // {index: bool}
    dead: {},
    notes: '',
    notesArchive: [],   // m·∫£ng c√°c b·∫£n l∆∞u {id, timeISO, content}
    notesSaveSeq: 0,    // s·ªë l·∫ßn ƒë√£ l∆∞u (ƒë√°nh s·ªë #)
    timer: {mode:'down', min:2, sec:0, running:false, left:120, sound:true},
  };

  // Default roles
  const DEFAULT_ROLES = [
    { key:'cupid', name:'üíò Cupid', hint:'Th·ª©c d·∫≠y v√†o ƒë√™m ƒë·∫ßu ti√™n v√† ch·ªçn ra 2 ng∆∞·ªùi ch∆°i ƒë·ªÉ gh√©p ƒë√¥i( ƒë∆∞·ª£c ph√©p ch·ªçn c·∫£ m√¨nh). Hai ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn s·∫Ω th·ª©c d·∫≠y, nh·∫≠n di·ªán v√† trao ƒë·ªïi vai tr√≤ cho nhau nh∆∞ng kh√¥ng bi·∫øt ai l√† ng∆∞·ªùi gh√©p ƒë√¥i( tr·ª´ khi ch√≠nh Cupid ch·ªçn b·∫£n th√¢n l√† ng∆∞·ªùi ƒë∆∞·ª£c gh√©p ƒë√¥i). N·∫øu m·ªôt trong hai ng∆∞·ªùi n√†y ch·∫øt, ng∆∞·ªùi c√≤n l·∫°i c≈©ng s·∫Ω ch·∫øt theo. N·∫øu gh√©p tr√∫ng 2 phe tr√°i nhau th√¨ 2 ng∆∞·ªùi ch∆°i s·∫Ω tr·ªü th√†nh phe th·ª© 3 ho√†n to√†n m·ªõi v√† d√†nh chi·∫øn th·∫Øng khi h·ªç l√† ng∆∞·ªùi cu·ªëi c√πng c√≤n s·ªëng s√≥t.', color:'#10b981' },
    { key:'werewolf', name:'üê∫ Ma s√≥i', hint:'V√†o m·ªói ƒë√™m, Ma s√≥i s·∫Ω t·ªânh d·∫≠y c√πng nhau v√† th·ªëng nh·∫•t gi·∫øt 1 ng∆∞·ªùi ch∆°i. B·∫ßy s√≥i c√≥ th·ªÉ kh√¥ng gi·∫øt ng∆∞·ªùi n√†o v√† kh√¥ng ƒë∆∞·ª£c gi·∫øt s√≥i kh√°c. Ma s√≥i chi·∫øn th·∫Øng khi s·ªë D√¢n l√†ng < ho·∫∑c = s·ªë Ma s√≥i v√† kh√¥ng c√≤n S√≥i tr·∫Øng.', color:'#ef4444' },
    { key:'werecub', name:'üê∫ S√≥i con', hint:'S√≥i con th·ª©c d·∫≠y c√πng b·∫ßy s√≥i m·ªói ƒë√™m. N·∫øu S√≥i con b·ªã gi·∫øt, Ma s√≥i c√≤n l·∫°i s·∫Ω gi·∫øt 2 ng∆∞·ªùi v√†o ƒë√™m h√¥m sau. B·∫ßy s√≥i c√≥ th·ªÉ ch·ªçn gi·∫øt S√≥i con nh∆∞ 1 s·ª± hy sinh( T·∫•t c·∫£ b·∫ßy s√≥i bao g·ªìm c·∫£ S√≥i con ƒë·ªÅu ƒë·ªìng √Ω vi·ªác ƒë√≥). Khi ƒë√≥ b·∫ßy s√≥i c√≥ th·ªÉ l·∫≠p t·ª©c gi·∫øt 2 ng∆∞·ªùi ch∆°i kh√°c v√†o ngay ƒë√™m h√¥m ƒë√≥.', color:'#ef4444' },
    { key:'minion', name:'üé≠Ô∏è Ph·∫£n b·ªôi', hint:'Ph·∫£n b·ªôi th·ª©c d·∫≠y c√πng b·∫ßy s√≥i. Tham gia c√πng b·∫ßy s√≥i ƒë·ªÉ gi·∫øt D√¢n l√†ng. Tuy nhi√™n Ti√™n tri khi soi v√†o ph·∫£n b·ªôi th√¨ v·∫´n ra D√¢n l√†ng.', color:'#ef4444' },
    { key:'seer', name:'üîÆ Ti√™n tri', hint:'M·ªói ƒë√™m, Ti√™n tri ch·ªâ tay v√†o m·ªôt ng∆∞·ªùi. Qu·∫£n tr√≤ s·∫Ω cho bi·∫øt ng∆∞·ªùi ƒë√≥ c√≥ ph·∫£i l√† Ma s√≥i hay kh√¥ng.', color:'#3b82f6' },
    { key:'witch', name:'üßô‚Äç‚ôÇÔ∏è Ph√π thu·ª∑', hint:'Ph√π th·ªßy s·∫Ω c√≥ hai b√¨nh thu·ªëc. M·ªôt b√¨nh thu·ªëc ƒë·ªÉ c·ª©u 1 ng∆∞·ªùi v√† m·ªôt b√¨nh thu·ªëc ƒë·ªÉ gi·∫øt 1 ng∆∞·ªùi. Trong ƒë√™m, Qu·∫£n tr√≤ seÃÉ cho bi√™ÃÅt ai seÃÉ biÃ£ gi√™ÃÅt trong ƒë√™m vaÃÄ h·ªèi xem Ph√π th·ªßy c√≥ mu·ªën s·ª≠ d·ª•ng quy·ªÅn nƒÉng n√†o hay kh√¥ng. C√≥ th·ªÉ d√πng c·∫£ hai b√¨nh thu·ªëc n√†y v√†o c√πng 1 ƒë√™m, nh∆∞ng m√¥ÃÉi biÃÄnh chiÃâ duÃÄng m√¥Ã£t l√¢ÃÄn.', color:'#3b82f6' },
    { key:'hunter', name:'üèπ Th·ª£ sƒÉn', hint:'N·∫øu Th·ª£ sƒÉn ch·∫øt, h·∫Øn l·∫≠p t·ª©c ƒë∆∞·ª£c ph√©p nh·∫Øm v√†o m·ªôt ng∆∞·ªùi v√† ng∆∞·ªùi n√†y s·∫Ω b·ªã ch·∫øt. N·∫øu Th·ª£ sƒÉn ch·∫øt trong ƒë√™m, Qu·∫£n tr√≤ s·∫Ω ƒë·ª•ng vai ƒë·ªÉ b√°o cho Th·ª£ sƒÉn nh·∫Øm b·∫Øn.', color:'#3b82f6' },
    { key:'guard', name:'üõ°Ô∏è B·∫£o v·ªá', hint:'M·ªói ƒë√™m, B·∫£o v·ªá ch·ªçn m·ªôt ng∆∞·ªùi kh√°c nhau ƒë·ªÉ b·∫£o v·ªá. Ng∆∞·ªùi ch∆°i n√†y s·∫Ω b·∫•t t·ª≠ v√†o ƒë√™m ƒë√≥ (nh∆∞ng kh√¥ng th·ªÉ b·∫£o v·ªá kh·ªèi Ph√π th·ªßy).', color:'#3b82f6' },
    { key:'spellcaster', name:'üîá Nguy·ªát n·ªØ', hint:'M·ªói ƒë√™m, Nguy·ªát n·ªØ s·∫Ω ƒë∆∞·ª£c ph√©p ch·ªâ ƒë·ªãnh 1 ng∆∞·ªùi b·ªã c√¢m v√†o h√¥m sau. Ng∆∞·ªùi n√†y v√†o ng√†y h√¥m sau s·∫Ω kh√¥ng ƒë∆∞·ª£c n√≥i (n·∫øu ng∆∞·ªùi b·ªã c√¢m l·ª° n√≥i th√¨ s·∫Ω b·ªã lo·∫°i ngay l·∫≠p t·ª©c). ', color:'#3b82f6' },
    { key:'doppelganger', name:'üë• Nh√¢n b·∫£n', hint:'V√†o ƒë√™m ƒë·∫ßu ti√™n, Nh√¢n b·∫£n t·ªânh d·∫≠y v√† l·ª±a ch·ªçn m·ªôt ng∆∞·ªùi ch∆°i. N·∫øu ng∆∞·ªùi ch∆°i kia ch·∫øt, Nh√¢n b·∫£n s·∫Ω b√≠ m·∫≠t l·∫•y ch·ª©c nƒÉng c·ªßa ng∆∞·ªùi ƒë√≥. Tr∆∞·ªõc khi c√≥ ch·ª©c nƒÉng m·ªõi, Nh√¢n b·∫£n theo phe d√¢n. Sau khi c√≥ ch·ª©c nƒÉng m·ªõi, Nh√¢n b·∫£n theo phe c·ªßa ch·ª©c nƒÉng n√†y. ', color:'#10b981' },
    { key:'cursed', name:'üåë B·ªã nguy·ªÅn', hint:'B·ªã nguy·ªÅn ban ƒë·∫ßu l√† ng∆∞·ªùi, Ti√™n tri soi c≈©ng ra ng∆∞·ªùi. N·∫øu B·ªã nguy·ªÅn b·ªã Ma s√≥i c·∫Øn th√¨ s·∫Ω kh√¥ng ch·∫øt, m√† t·ª´ ƒë√™m ti·∫øp theo s·∫Ω bi·∫øn th√†nh Ma s√≥i, ƒë·ªìng th·ªùi n·∫øu Ti√™n tri s√≥i th√¨ c≈©ng s·∫Ω l√† S√≥i. B·ªã nguy·ªÅn m·ªói ƒë√™m ƒë∆∞·ª£c g·ªçi d·∫≠y ri√™ng bi·ªát, k·ªÉ c·∫£ sau khi h√≥a S√≥i, ƒë·ªÉ cho ng∆∞·ªùi n√†y bi·∫øt ƒë√£ b·ªã h√≥a S√≥i hay ch∆∞a. ', color:'#10b981' },
    { key:'tanner', name:'üòì Ch√°n ƒë·ªùi', hint:'Ch√°n ƒë·ªùi ch·ªâ th·∫Øng khi anh ta b·ªã treo c·ªï v√†o ban ng√†y. C√°c ƒëi·ªÅu ki·ªán th·∫Øng kh√°c c≈©ng ƒë∆∞·ª£c √°p d·ª•ng. Ch·ª©c nƒÉng n√†y ƒëi chung v·ªõi l√° b√†i Y√™u h√≤a b√¨nh.', color:'#eab308' },
    { key:'village', name:'üë®üèª‚Äçüåæ D√¢n l√†ng', hint:'Kh√¥ng c√≥ t√≠nh nƒÉng ƒë·∫∑c bi·ªát n√†o c·∫£, ng·ªß su·ªët ƒë√™m v√† tham gia bi·ªÉu quy·∫øt t√¨m Ma s√≥i v√†o ban ng√†y. ', color:'#3b82f6' },
    { key:'prince', name:'üëë Ho√†ng t·ª≠', hint:'Ho√†ng t·ª≠ kh√¥ng th·ªÉ b·ªã treo c·ªï ch·∫øt. V√†o l·∫ßn b·ªã vote ch·∫øt v√† chu·∫©n b·ªã treo c·ªï, ng∆∞·ªùi n√†y s·∫Ω l·∫≠t l√° b√†i l√™n ƒë·ªÉ m·ªçi ng∆∞·ªùi ƒë∆∞·ª£c th·∫•y v√† kh√¥ng ph·∫£i ch·ªãu treo c·ªï. T·∫•t c·∫£ ng∆∞·ªùi ch∆°i l·∫≠p t·ª©c ƒëi ng·ªß. ', color:'#3b82f6' },
    { key:'elder', name:'üë¥ Gi√† l√†ng', hint:'Gi√† l√†ng c√≥ 2 m·∫°ng s·ªëng. N·∫øu ch·∫øt c·∫£ 2 l·∫ßn th√¨ c√°c quy·ªÅn nƒÉng (Ti√™n tri, B·∫£o v·ªá,‚Ä¶) c·ªßa nh√¢n v·∫≠t kh√°c s·∫Ω m·∫•t ƒëi trong 2 ƒë√™m.', color:'#3b82f6' },
    { key:'tough guy', name:'üí™ L·ª±c sƒ©', hint:'N·∫øu b·ªã Ma s√≥i c·∫Øn, L·ª±c sƒ© s·∫Ω ch·∫øt v√†o ƒë√™m ti·∫øp theo ch·ª© kh√¥ng ph·∫£i ngay t·∫°i ƒë√™m ƒë√≥.', color:'#3b82f6' },
    { key:'mayor', name:'‚≠ê Th·ªã tr∆∞·ªüng', hint:'Phi·∫øu bi·ªÉu quy·∫øt c·ªßa Th·ªã tr∆∞·ªüng ƒë∆∞·ª£c t√≠nh l√† 2 phi·∫øu khi bi·ªÉu quy·∫øt treo c·ªï.', color:'#3b82f6' },

{ key:'pssoi', name:'‚òÑÔ∏è Ph√°p s∆∞ s√≥i', hint:'V√†o m·ªói ƒë√™m, Ph√°p s∆∞ s√≥i th·ª©c d·∫≠y v√† s·∫Ω ƒëi t√¨m ki·∫øm Ti√™n tri b·∫±ng c√°ch ch·ªâ th·ªã m·ªôt ng∆∞·ªùi, Qu·∫£n tr√≤ s·∫Ω cho bi·∫øt ƒë√≥ c√≥ ph·∫£i l√† Ti√™n tri hay kh√¥ng. Ma s√≥i kh√¥ng ƒë∆∞·ª£c bi·∫øt Ph√°p s∆∞ s√≥i l√† ai v√† Ph√°p s∆∞ s√≥i c≈©ng kh√¥ng bi·∫øt Ma s√≥i l√† ai. Ti√™n tri s·∫Ω soi Ph√°p s∆∞ s√≥i l√† ng∆∞·ªùi.', color:'#ef4444' },
{ key:'scuong', name:'üí¢ S√≥i cu·ªìng', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, k·ªÉ t·ª´ ƒë√™m th·ª© hai, S√≥i cu·ªìng c√≥ th·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng cu·ªìng n·ªô. Khi b·∫ßy s√≥i ·ªü tr·∫°ng th√°i cu·ªìng n·ªô ng∆∞·ªùi b·ªã b·∫ßy s√≥i gi·∫øt kh√¥ng th·ªÉ s·ªëng s√≥t( c√°c l∆∞·ª£t b·∫£o v·ªá kh√¥ng ph·∫£i t·ª´ Hi·ªáp sƒ© th√¨ kh√¥ng th·ªÉ ngƒÉn ch·∫∑n).', color:'#ef4444' },
{ key:'soidc', name:'‚ò†Ô∏è S√≥i ƒë·∫°i ca', hint:'Th·ª©c d·∫≠y c√πng Ma s√≥i. Ch·ª´ng n√†o S√≥i ƒë·∫°i ca c√≤n t·ªìn t·∫°i trong tr√≤ ch∆°i th√¨ m·ªói ƒë√™m phe Ma s√≥i c√≥ th·ªÉ gi·∫øt hai ng∆∞·ªùi ch∆°i, mi·ªÖn l√† hai ng∆∞·ªùi ch∆°i ƒë√≥ ng·ªìi c·∫°nh nhau. Tuy nhi√™n phe Ma s√≥i s·∫Ω kh√¥ng bi·∫øt ai l√† S√≥i ƒë·∫°i ca. ƒê√™m ƒë·∫ßu ti√™n, S√≥i ƒë·∫°i ca s·∫Ω th·ª©c d·∫≠y m·ªôt m√¨nh ƒë·ªÉ cho Qu·∫£n tr√≤ bi·∫øt ƒë∆∞·ª£c ng∆∞·ªùi ƒë√≥ l√† ai.', color:'#ef4444' },
{ key:'soituyet', name:'‚ùÑÔ∏è S√≥i tuy·∫øt', hint:'S√≥i tuy·∫øt th·ª©c d·∫≠y c√πng c√°c S√≥i kh√°c. ƒê√™m ƒë·∫ßu ti√™n th·ª©c d·∫≠y, S√≥i tuy·∫øt l·ª±a ch·ªçn m·ªôt ng∆∞·ªùi ch∆°i kh√°c l√†m b·∫°n ƒë·ªìng h√†nh. N·∫øu S√≥i tuy·∫øt ch·∫øt ng∆∞·ªùi ch∆°i ƒë√≥ c≈©ng ch·∫øt theo. N·∫øu ng∆∞·ªùi ch∆°i ƒë√≥ ch·∫øt th√¨ S√≥i tuy·∫øt kh√¥ng ch·∫øt.', color:'#ef4444' },
{ key:'alpha', name:'üåï S√≥i ƒë·∫ßu ƒë√†n', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, sau c√°i ch·∫øt c·ªßa m·ªôt Ma s√≥i kh√°c vaÃÄo ban ngaÃÄy, v√†o ƒë√™m ti·∫øp theo, S√≥i ƒë·∫ßu ƒë√†n(Alpha) c√≥ th·ªÉ bi·∫øn m·ª•c ti√™u c·ªßa phe Ma S√≥i th√†nh Ma s√≥i thay v√¨ b·ªã gi·∫øt. N·∫øu ng∆∞·ªùi ch∆°i n√†y ƒë∆∞·ª£c b·∫£o v·ªá b·ªüi m·ªôt nguy√™n nh√¢n n√†o ƒë√≥ th√¨ v·∫øt c·∫Øn c·ªßa S√≥i ƒë·∫ßu ƒë√†n s·∫Ω kh√¥ng c√≥ t√°c d·ª•ng. Khi ƒë√≥ S√≥i ƒë·∫ßu ƒë√†n s·∫Ω ƒë∆∞·ª£c c·∫Øn th√™m m·ªôt l·∫ßn kh√°c v√†o ƒë√™m sau.', color:'#ef4444' },
{ key:'acmong', name:'üéÉ √Åc m·ªông', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, v√†o ban ƒë√™m, S√≥i √°c m·ªông c√≥ th·ªÉ gieo c∆°n √°c m·ªông cho m·ªôt ng∆∞·ªùi ch∆°i v√† khi·∫øn ch·ª©c nƒÉng c·ªßa ng∆∞·ªùi ƒë√≥ b·ªã v√¥ hi·ªáu trong ƒë√™m.', color:'#ef4444' },
{ key:'hbi', name:'‚ú® Huy·ªÅn B√≠', hint:'M·ªói ƒë√™m, Ti√™n tri Huy·ªÅn b√≠ s·∫Ω t·ªânh d·∫≠y v√† ch·ªâ ƒë·ªãnh m·ªôt ng∆∞·ªùi. Qu·∫£n tr√≤ s·∫Ω cho Ti√™n tri Huy·ªÅn b√≠ bi·∫øt ch√≠nh x√°c ng∆∞·ªùi ch∆°i n√†y l√† ch·ª©c nƒÉng g√¨.', color:'#3b82f6' },
{ key:'dbom', name:'üí£Ô∏è ƒê√°nh bom', hint:'N·∫øu ƒêaÃÅnh bom  b·ªã lo·∫°i, th√¨ hai ng∆∞·ªùi ch∆°i b√™n tr√°i v√† ph·∫£i c·ªßa ng∆∞·ªùi ch∆°i n√†y s·∫Ω c√πng b·ªã lo·∫°i (kh√¥ng tiÃÅnh nh∆∞ÃÉng ng∆∞∆°ÃÄi ch∆°i ƒëaÃÉ biÃ£ loaÃ£i r√¥ÃÄi).', color:'#3b82f6' },
{ key:'tvan', name:'üî≠ Thi√™n vƒÉn', hint:'M·ªói ƒë√™m, Thi√™n vƒÉn s·∫Ω t·ªânh d·∫≠y v√† c√≥ th·ªÉ ch·ªâ v√†o m·ªôt ng∆∞·ªùi ch∆°i ƒë·ªÉ g·ªçi m∆∞a sao bƒÉng. N·∫øu ng∆∞·ªùi ch∆°i ƒë√≥ l√† Ma s√≥i, ng∆∞·ªùi ƒë√≥ s·∫Ω b·ªã lo·∫°i. N·∫øu kh√¥ng, Thi√™n vƒÉn s·∫Ω b·ªã lo·∫°i.', color:'#3b82f6' },
{ key:'lgac', name:'‚öîÔ∏è L√≠nh g√°c', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, k·ªÉ t·ª´ s√°ng th·ª© hai, L√≠nh g√°c c√≥ th·ªÉ ch·ªâ ƒë·ªãnh gi·∫øt m·ªôt ng∆∞·ªùi ch∆°i n·∫øu nghi ng·ªù. Nh∆∞ng vai tr√≤ c·ªßa b·∫°n s·∫Ω b·ªã ti·∫øt l·ªô khi gi·∫øt ng∆∞·ªùi ch∆°i kh√°c.', color:'#3b82f6' },
{ key:'gsu',  name:'üë®‚Äçüè´ Gi√°o s∆∞', hint:'M·ªói ƒê√™m, Gi√°o s∆∞ t·ªânh d·∫≠y v√† ch·ªâ ƒë·ªãnh hai ng∆∞·ªùi ch∆°i. Qu·∫£n tr√≤ s·∫Ω cho bi·∫øt hai ng∆∞·ªùi ch∆°i n√†y c√≥ c√πng phe v·ªõi nhau hay kh√¥ng.', color:'#3b82f6' },
{ key:'tsu', name:'üîÆ T·∫≠p s·ª±', hint:'N·∫øu Ti√™n tri ch·∫øt, Ti√™n tri T·∫≠p s·ª± s·∫Ω tr·ªü th√†nh Ti√™n tri m·ªõi. Ti√™n tri T·∫≠p s·ª± ƒë∆∞·ª£c th√¥ng b√°o trong ƒë√™m, v√†o l∆∞·ª£t g·ªçi Ti√™n tri, Qu·∫£n tr√≤ ƒë·ª•ng v√†o vai c·ªßa Ti√™n tri T·∫≠p s·ª± ƒë·ªÉ g·ªçi d·∫≠y.', color:'#3b82f6' },
{ key:'hquang', name:'üßø H√†o quang', hint:'Ti√™n tri H√†o quang th·ª©c d·∫≠y m·ªói ƒë√™m ƒë·ªÉ ki·ªÉm tra ng∆∞·ªùi ch∆°i c√≥ ch·ª©c nƒÉng hay kh√¥ng, tr∆∞·ªùng h·ª£p kh√¥ng c√≥ ch·ª©c nƒÉng l√† D√¢n th∆∞·ªùng v√† S√≥i th∆∞·ªùng.', color:'#3b82f6' },
{ key:'nbenh', name:'ü§í Ng∆∞·ªùi b·ªánh', hint:'N·∫øu Ng∆∞·ªùi b·ªánh b·ªã Ma s√≥i c·∫Øn, th√¨ Ma s√≥i s·∫Ω kh√¥ng th·ªÉ c·∫Øn ng∆∞·ªùi n√†o v√†o ƒë√™m ti·∫øp theo do b·ªã b·ªánh.', color:'#3b82f6' },
{ key:'cma', name:'üëª Con ma', hint:'Con ma b·ªã ch·∫øt ngay v√†o ƒë√™m ƒë·∫ßu ti√™n. M·ªói ƒë√™m( bao g·ªìm c·∫£ ƒë√™m ƒë·∫ßu ti√™n), Con ma c√≥ th·ªÉ li√™n h·ªá v·ªõi nh·ªØng ng∆∞·ªùi ch∆°i kh√°c b·∫±ng c√°ch vi·∫øt 1 ch·ªØ l√™n 1 t·ªù gi·∫•y nh∆∞ng kh√¥ng ƒë∆∞·ª£c vi·∫øt t√™n hay vi·∫øt t·∫Øt t√™n, m√† thay v√†o ƒë√≥ l√† ƒë∆∞a ra c√°c g·ª£i √Ω th√∫ v·ªã.', color:'#3b82f6' },
{ key:'hbinh', name:'ü§ù H√≤a b√¨nh', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, Ng∆∞·ªùi y√™u h√≤a b√¨nh ngƒÉn ch·∫∑n m·ªôt l·∫ßn bi·ªÉu quy·∫øt treo c·ªï. Qu·∫£n tr√≤ s·∫Ω ƒë·ªÉ √Ω h√†nh ƒë·ªông bi·ªÉu quy·∫øt c·ªßa b·∫°n.', color:'#3b82f6' },
{ key:'ttu', name:'üïµ‚Äç‚ôÇ Th√°m t·ª≠', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, v√†o ban ƒë√™m, Th√°m t·ª≠ s·∫Ω ƒë∆∞·ª£c g·ªçi d·∫≠y v√† ƒë∆∞·ª£c ph√©p ch·ªçn 1 m·ªôt ng∆∞·ªùi. Qu·∫£n tr√≤ s·∫Ω cho Th√°m t·ª≠ bi·∫øt ng∆∞·ªùi ƒë√≥ ho·∫∑c hai ng∆∞·ªùi b√™n c·∫°nh ng∆∞·ªùi ƒë√≥ c√≥ ph·∫£i l√† Ma s√≥i hay kh√¥ng.', color:'#3b82f6' },
{ key:'hsi', name:'üíÇ‚Äç‚ôÇ Hi·ªáp sƒ©', hint:'M·ªôt l·∫ßn trong tr√≤ ch∆°i, v√†o ban ƒë√™m, Hi·ªáp sƒ© c√≥ th·ªÉ ch·ªçn m·ªôt ng∆∞·ªùi ch∆°i ƒë·ªÉ ƒë∆∞·ª£c b·∫£o v·ªá. Ng∆∞·ªùi ch∆°i n√†y s·∫Ω b·∫•t t·ª≠ vaÃÄo t·∫•t c·∫£ c√°c ƒë√™m. ChiÃâ biÃ£ loaÃ£i b∆°Ãâi caÃÅc liÃÅ do vaÃÄo ban ngaÃÄy. ( nh∆∞ biÃ£ treo c√¥Ãâ).', color:'#3b82f6' },
{ key:'blang', name:'üêÜ B√°o l√†ng', hint:'M·ªói ƒë√™m, Qu·∫£n tr√≤ s·∫Ω h·ªèi ‚ÄúB√°o l√†ng c√≥ mu·ªën qu·∫≠y ph√° kh√¥ng?‚Äù. N·∫øu ƒë·ªìng √Ω, B√°o l√†ng s·∫Ω t·ªânh d·∫≠y v√† ra hi·ªáu b·∫±ng c√°ch g·∫≠t ƒë·∫ßu. Ng√†y h√¥m sau, s·∫Ω c√≥ 2 l∆∞·ª£t bi·ªÉu quy·∫øt treo c·ªï. B√°o l√†ng ch·ªâ th·ª±c hi·ªán ƒë∆∞·ª£c 1 l·∫ßn qu·∫≠y ph√° trong su·ªët c·∫£ v√°n ch∆°i.', color:'#3b82f6' },
{ key:'gchu', name:'ü¶π Gi√°o ch·ªß', hint:'M·ªói ƒë√™m, Gi√°o ch·ªß s·∫Ω ph·∫£i t·ªânh d·∫≠y v√† th√™m 1 ng∆∞·ªùi ch∆°i v√†o gi√°o ph√°i c·ªßa m√¨nh. N·∫øu t·∫•t c·∫£ nh·ªØng ng∆∞·ªùi c√≤n s·ªëng ƒë·ªÅu l√† ng∆∞·ªùi c·ªßa gi√°o ph√°i m√¨nh, Gi√°o ch·ªß s·∫Ω l√† ng∆∞·ªùi chi·∫øn th·∫Øng. C√°c ƒëi·ªÅu ki·ªán th·∫Øng kh√°c c≈©ng ƒë∆∞·ª£c √°p d·ª•ng.', color:'#eab308' },
{ key:'dgau', name:'üêª ƒê·∫ßu g·∫•u', hint:'V√†o ƒë√™m th·ª© hai, ƒê·∫ßu g·∫•u d·ª• d·ªó hai ng∆∞·ªùi ch∆°i. N·∫øu ng∆∞·ªùi b·ªã d·ª• ƒë·ªìng √Ω b·∫±ng c√°ch g·∫≠t ƒë·∫ßu th√¨ th·ª©c d·∫≠y v√† tr·ªü th√†nh ƒë·ªìng b·ªçn c·ªßa ƒë·∫ßu g·∫•u. N·∫øu ch·ªâ c√≤n m·ªôt m√¨nh ƒë·∫ßu g·∫•u th√¨ ƒë·∫ßu g·∫•u ƒë∆∞·ª£c gi·∫øt m·ªôt ng∆∞·ªùi v√†o m·ªói ƒë√™m( kh√¥ng ƒë∆∞·ª£c gi·∫øt ng∆∞·ªùi ch∆°i kh√°c v√†o ƒë√™m ƒë·∫ßu ti√™n) ho·∫∑c ti·∫øp t·ª•c d·ª• d·ªó m·ªôt ng∆∞·ªùi kh√°c( l·∫ßn cu·ªëi). V√† chi·∫øn th·∫Øng c√πng ƒë·ªìng b·ªçn khi h·ªç l√† nh·ªØng ng∆∞·ªùi ch∆°i cu·ªëi c√πng.', color:'#eab308' },
{ key:'mcr', name:'üßõ Ma c√† r·ªìng', hint:'L√† 1 th·∫ø l·ª±c m·∫°nh th·ª© 3 ngo√†i phe Ma s√≥i v√† phe D√¢n l√†ng. M·ªói ƒë√™m, Ma c√† r·ªìng s·∫Ω ch·ªçn 1 ng∆∞·ªùi ch∆°i l√† n·∫°n nh√¢n. N·∫øu n·∫°n nh√¢n c·ªßa Ma c√† r·ªìng b·ªã t·ª´ 2 ng∆∞·ªùi ch∆°i tr·ªü l√™n( kh√¥ng t√≠nh Ma c√† r·ªìng) nghi ng∆°  trong cu·ªôc th·∫£o lu·∫≠n ·ªü bu·ªïi s√°ng th√¨ n·∫°n nh√¢n s·∫Ω ch·∫øt khi ƒë·∫øn gi·ªù bi·ªÉu quy·∫øt. Ma c√† r·ªìng kh√¥ng th·ªÉ b·ªã gi·∫øt b·ªüi Ma s√≥i v√†o ban ƒë√™m( tr·ª´ S√≥i tr·∫Øng).', color:'#eab308' },
{ key:'strang', name:'üê∫ S√≥i tr·∫Øng', hint:'S√≥i tr·∫Øng th·ª©c d·∫≠y c√πng b·∫ßy s√≥i v√† tham gia c√πng b·∫ßy s√≥i ƒë·ªÉ gi·∫øt d√¢n l√†ng. Sau ƒë√≥, S√≥i tr·∫Øng s·∫Ω th·ª©c d·∫≠y th√™m m·ªôt l·∫ßn n·ªØa ƒë·ªÉ ti·∫øp t·ª•c ch·ªçn m·ª•c ti√™u ƒë·ªÉ gi·∫øt. S√≥i tr·∫Øng d√†nh chi·∫øn th·∫Øng khi c√≤n l·∫°i cu·ªëi c√πng.', color:'#eab308' },
  ];

// Chu·∫©n ho√° d·ªØ li·ªáu customRoles: cho ph√©p d·∫°ng {name:{count,faction}}
function normalizeCustomRoles(){
  const cr = STATE.customRoles || {};
  const fixed = {};
  Object.entries(cr).forEach(([name, val])=>{
    if (typeof val === 'number') {
      fixed[name] = { count: val, faction: 'third' }; // m·∫∑c ƒë·ªãnh phe 3 cho d·ªØ li·ªáu c≈©
    } else {
      const c = Number(val.count||0);
      fixed[name] = { count: c, faction: val.faction || 'third' };
    }
  });
  STATE.customRoles = fixed;
}

function paintFactionSelect(){
  const sel = $.customRoleFaction;
  if (!sel) return;
  sel.classList.remove('f-village','f-wolf','f-swap','f-third');
  const map = { village:'f-village', wolf:'f-wolf', swap:'f-swap', third:'f-third' };
  const cls = map[sel.value];
  if (cls) sel.classList.add(cls);
}
$.customRoleFaction && $.customRoleFaction.addEventListener('change', paintFactionSelect);

  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
  const load = () => { try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(s) STATE = {...STATE, ...s}; }catch{} };
  const clamp = (n,a,b)=>Math.min(Math.max(n,a),b);
  const pad = n=>String(n).padStart(2,'0');
  const rng = (max)=>{ if(crypto?.getRandomValues){ const arr=new Uint32Array(1); crypto.getRandomValues(arr); return arr[0]/0xffffffff*max; } return Math.random()*max; };
  const shuffle = (arr)=>{ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  // ====== NAMES UI ======
  function renderNames(){
    $.namesWrap.innerHTML = '';
    const n = Number($.playerCount.value||STATE.playerCount);
    while(STATE.names.length < n) STATE.names.push('');
    if(STATE.names.length > n) STATE.names.length = n;

    for(let i=0;i<n;i++){
      const w = document.createElement('div');
      const input = document.createElement('input');
      input.type='text'; input.placeholder = `Ng∆∞·ªùi ch∆°i ${i+1}`; input.value = STATE.names[i]||'';
      input.oninput = (e)=>{ STATE.names[i] = e.target.value; save(); };
      w.appendChild(input); $.namesWrap.appendChild(w);
    }
    save();
  }

  $.playerCount.addEventListener('change', ()=>{
    STATE.playerCount = clamp(Number($.playerCount.value||10),3,151);
    $.playerCount.value = STATE.playerCount;
    renderNames(); updateSlotsLeft();
  });
  $.autoFillNames.addEventListener('click', ()=>{
    const n = Number($.playerCount.value||10);
    STATE.names = Array.from({length:n},(_,i)=>`Ng∆∞·ªùi ch∆°i ${i+1}`);
    renderNames();
  });
  $.shuffleNames.addEventListener('click', ()=>{ STATE.names = shuffle(STATE.names); renderNames(); });

// X√≥a c√°c √¥ t√™n ƒëang tr·ªëng (ch·ªâ placeholder, ch∆∞a nh·∫≠p)
$.removeEmptyNames.addEventListener('click', () => {
  const before = STATE.names.slice();
  const keep = before.filter(name => (name || '').trim() !== '');
  const removed = before.length - keep.length;

  if (removed === 0) {
    alert('Kh√¥ng c√≥ √¥ t√™n tr·ªëng ƒë·ªÉ x√≥a.');
    return;
  }

  // C·∫≠p nh·∫≠t state + √¥ s·ªë ng∆∞·ªùi ch∆°i
  STATE.names = keep;
  STATE.playerCount = keep.length;
  $.playerCount.value = STATE.playerCount;

  // Sau khi thay ƒë·ªïi s·ªë ng∆∞·ªùi, reset khu ph√¢n vai (tr√°nh l·ªách)
  STATE.assignments = null;
  STATE.reveal = {};
  if ($.reshuffleBtn) $.reshuffleBtn.disabled = true;
  if ($.revealAllBtn) $.revealAllBtn.disabled = true;
  if ($.copyBtn) $.copyBtn.disabled = true;
  if ($.sortBtn) $.sortBtn.disabled = true;

  renderNames();
  updateSlotsLeft();
  save();
});

  // ====== ROLES UI ======
  function ensureDefaultRoles(){ if(!STATE.roles || Object.keys(STATE.roles).length===0){ STATE.roles = {werewolf:3, seer:1, witch:1, hunter:1, guard:1, cupid:1, spellcaster:1, prince:1}; } }

  function renderRoles(){
  $.rolesList.innerHTML = '';
  ensureDefaultRoles();
  normalizeCustomRoles();

  // Phe c·ªßa vai m·∫∑c ƒë·ªãnh
  // Phe c·ªßa vai m·∫∑c ƒë·ªãnh
const defaultFactionMap = {
  // Ma s√≥i
  werewolf: 'wolf', werecub: 'wolf', minion: 'wolf',
  pssoi: 'wolf', soidc: 'wolf', soituyet: 'wolf', alpha: 'wolf', acmong: 'wolf', scuong: 'wolf',

  // D√¢n l√†ng
  seer: 'village', witch: 'village', hunter: 'village',
  guard: 'village', spellcaster: 'village',
  prince: 'village', elder: 'village', 'tough guy': 'village',
  mayor: 'village', village: 'village', hbi: 'village',
  dbom: 'village', tvan: 'village', lgac: 'village', gsu: 'village',
  tsu: 'village', hquang: 'village', nbenh: 'village', cma: 'village',
  hbinh: 'village', ttu: 'village', hsi: 'village', blang: 'village',
  

  // ƒê·ªïi phe
  doppelganger: 'swap', cursed: 'swap', cupid: 'swap',

  // Phe th·ª© 3
  tanner: 'third', gchu: 'third', dgau: 'third', mcr: 'third', strang: 'third'
};

  // Gom nh√≥m theo phe (g·ªìm c·∫£ m·∫∑c ƒë·ªãnh & t√πy ch·ªânh)
  const groups = { wolf: [], village: [], swap: [], third: [] };

  DEFAULT_ROLES.forEach(r => {
    const f = defaultFactionMap[r.key] || 'third';
    groups[f].push({ type: 'default', role: r });
  });

  Object.entries(STATE.customRoles || {}).forEach(([name, obj]) => {
    const faction = (obj && obj.faction) || 'third';
    groups[faction].push({ type: 'custom', name, obj });
  });

  // S·∫Øp x·∫øp ABC theo t√™n (b·ªè emoji, b·ªè d·∫•u)
  const collator = new Intl.Collator('vi', { sensitivity: 'base', numeric: true });
  const clean = s => String(s)
    .replace(/^[^\p{L}\p{N}]+/u, '')               // b·ªè emoji/k√Ω t·ª± ƒë·∫ßu
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // b·ªè d·∫•u
    .toLowerCase();

  const sortGroup = arr => arr.sort((a,b)=>{
    const an = a.type==='default' ? a.role.name : a.name;
    const bn = b.type==='default' ? b.role.name : b.name;
    return collator.compare(clean(an), clean(bn));
  });

  sortGroup(groups.wolf);
  sortGroup(groups.village);
  sortGroup(groups.swap);
  sortGroup(groups.third);

  // Helpers t·∫°o d√≤ng
  const addSep = (label)=>{
    const sep = document.createElement('div');
    sep.className = 'sep';
    sep.textContent = `--------------------- ${label} ---------------------`;
    $.rolesList.appendChild(sep);
  };

  // --- THAY TH·∫æ H√ÄM N√ÄY B√äN TRONG renderRoles() ---
const makeRowDefault = (role)=>{
  const row = document.createElement('div'); row.className='item';

  const name = document.createElement('div');
  name.innerHTML = `<span class="pill" style="border-color:${role.color||'#334'}">
    <svg width="8" height="8"><circle cx="4" cy="4" r="4" fill="${role.color||'#888'}"/></svg> ${role.name}
  </span>`;

  const hint = document.createElement('div');
  const viewBtn = document.createElement('button');
  viewBtn.className='btn ghost';
  viewBtn.textContent='Hi·ªán';
  viewBtn.addEventListener('click', ()=> modal.open(role.name, role.hint||'')); 
  hint.appendChild(viewBtn);

  const count = document.createElement('input');
  count.type='number'; 
  count.min='0';
  // Ri√™ng 2 vai n√†y ch·ªâ cho 0‚Äì1
  const isTanner = role.key === 'tanner';
  const isPeace  = role.key === 'hbinh';             // ü§ù Y√™u h√≤a b√¨nh
  if (isTanner || isPeace) count.max = '1';

  // Gi√° tr·ªã hi·ªán t·∫°i
  count.value = STATE.roles[role.key] || 0;

  count.addEventListener('change', ()=>{
    const prev = Number(STATE.roles[role.key] || 0);
    // Clamp: tanner & hbinh ch·ªâ 0‚Äì1, c√≤n l·∫°i 0‚Äì40
    const v = clamp(Number(count.value||0), 0, (isTanner||isPeace) ? 1 : 40);
    STATE.roles[role.key] = v;
    count.value = v;  // ph·∫£n √°nh l·∫°i n·∫øu ng∆∞·ªùi d√πng g√µ > max

    // ===== R√ÄNG BU·ªòC M·ªöI =====
    // 1) N·∫øu tƒÉng "Ch√°n ƒë·ªùi" t·ª´ 0 -> 1, t·ª± th√™m "Y√™u h√≤a b√¨nh" = 1 (n·∫øu ƒëang 0)
    if (isTanner && prev === 0 && v === 1) {
      const peaceNow = Number(STATE.roles['hbinh'] || 0);
      if (peaceNow === 0) {
        STATE.roles['hbinh'] = 1;
        alert('Ch·ª©c nƒÉng "H√≤a b√¨nh" ƒë∆∞·ª£c th√™m v√†o danh s√°ch v√¨ ƒëi chung v·ªõi l√° b√†i \'Ch√°n ƒë·ªùi\'');
        renderRoles(); updateSlotsLeft(); save();
        return; // v√¨ ƒë√£ re-render xong
      }
    }

    // 2) N·∫øu gi·∫£m "Y√™u h√≤a b√¨nh" xu·ªëng 0, t·ª± gi·∫£m "Ch√°n ƒë·ªùi" = 0
    if (isPeace && prev > 0 && v === 0) {
      const tannerNow = Number(STATE.roles['tanner'] || 0);
      if (tannerNow > 0) {
        STATE.roles['tanner'] = 0;
        alert('Ch·ª©c nƒÉng "Ch√°n ƒë·ªùi" b·ªã lo·∫°i kh·ªèi danh s√°ch v√¨ ƒëi chung v·ªõi l√° b√†i \'H√≤a b√¨nh\'');
        renderRoles(); updateSlotsLeft(); save();
        return; // v√¨ ƒë√£ re-render xong
      }
    }

    // 3) Gi·∫£m "Ch√°n ƒë·ªùi" xu·ªëng 0: KH√îNG l√†m g√¨ th√™m (theo y√™u c·∫ßu)
    updateSlotsLeft(); save();
  });

  const del = document.createElement('div'); // tr·ªëng cho kh·ªõp l∆∞·ªõi

  $.rolesList.appendChild(row);
  row.append(name, hint, count, del);
};

  const colorMap = { village:'#3b82f6', wolf:'#ef4444', swap:'#10b981', third:'#eab308' };
  const factionLabel = { village:'D√¢n l√†ng', wolf:'Ma s√≥i', swap:'ƒê·ªïi phe', third:'Phe th·ª© 3' };

  const makeRowCustom = (name, obj)=>{
    const { count:countVal=0, faction='third' } = obj || {};
    const row = document.createElement('div'); row.className='item';

    const nameDiv = document.createElement('div');
    nameDiv.innerHTML = `<span class="pill" style="border-color:${colorMap[faction]}">
      <svg width="8" height="8"><circle cx="4" cy="4" r="4" fill="${colorMap[faction]}"/></svg>
      üß© ${escapeHtml(name)}
    </span>`;

    const hint = document.createElement('div');
    const viewBtn = document.createElement('button');
    viewBtn.className='btn ghost'; viewBtn.textContent='Hi·ªán';
    viewBtn.addEventListener('click', ()=> 
      modal.open(`üß© ${name}`, `Ch·ª©c nƒÉng c·ªßa vai tr√≤ tu·ª≥ ch·ªânh do Qu·∫£n tr√≤ v√† D√¢n l√†ng th·ªëng nh·∫•t ƒë∆∞a ra ¬∑ Phe: ${factionLabel[faction]}`)
    );
    hint.appendChild(viewBtn);

    const count = document.createElement('input');
    count.type='number'; count.min='0'; count.value=countVal;
    count.addEventListener('change', ()=>{
      normalizeCustomRoles();
      const v = clamp(Number(count.value||0),0,40);
      STATE.customRoles[name] = { count: v, faction };
      if (v===0) delete STATE.customRoles[name];
      renderRoles(); updateSlotsLeft(); save();
    });

    const del = document.createElement('div');
    const delBtn = document.createElement('button');
    delBtn.className='btn danger'; delBtn.textContent='Xo√°';
    delBtn.onclick = ()=>{
      delete STATE.customRoles[name];
      renderRoles(); updateSlotsLeft(); save();
    };
    del.appendChild(delBtn);

    $.rolesList.appendChild(row);
    row.append(nameDiv, hint, count, del);
  };

  // In theo th·ª© t·ª± phe: Ma s√≥i -> D√¢n l√†ng -> ƒê·ªïi phe -> Phe th·ª© 3
  [
    {key:'wolf',    label:'Ma s√≥i'},
    {key:'village', label:'D√¢n l√†ng'},
    {key:'swap',    label:'ƒê·ªïi phe'},
    {key:'third',   label:'Phe th·ª© 3'}
  ].forEach(sec=>{
    const arr = groups[sec.key];
    if(!arr.length) return;
    addSep(sec.label);
    arr.forEach(it => it.type==='default' ? makeRowDefault(it.role)
                                          : makeRowCustom(it.name, it.obj));
  });

  updateSlotsLeft();
}


  function updateSlotsLeft(){
    const totalPlayers = Number($.playerCount.value||STATE.playerCount);
    const totalSelected = totalRolesSelected();
    const left = totalPlayers - totalSelected;
    $.slotsLeft.textContent = left;
    $.slotsLeft.style.color = left < 0 ? 'salmon' : '#c7ffee';
const totalEl = document.getElementById('rolesTotal');
  if (totalEl) totalEl.textContent = totalSelected;
  }

  function totalRolesSelected(){
  const base = Object.values(STATE.roles||{}).reduce((a,b)=>a+Number(b||0),0);
  const custom = Object.values(STATE.customRoles||{}).reduce((a,v)=>a+Number((v&&v.count)||0),0);
  return base + custom;
}


  $.addCustomRole.addEventListener('click', ()=>{
  const name = ($.customRoleName.value||'').trim();
  const count = clamp(Number($.customRoleCount.value||1),1,40);
  const faction = $.customRoleFaction?.value || '';

  if (!name)   return alert('Vui l√≤ng nh·∫≠p t√™n vai tr√≤ tu·ª≥ ch·ªânh!');
  if (!faction) return alert('Vui l√≤ng l·ª±a ch·ªçn phe cho vai tr√≤ n√†y!');

  // ƒë·∫£m b·∫£o c·∫•u tr√∫c {name:{count,faction}}
  normalizeCustomRoles();
  const cur = STATE.customRoles[name] || {count:0, faction};
  const newCount = (cur.count||0) + count;

  STATE.customRoles[name] = { count: newCount, faction };  // l∆∞u phe
  $.customRoleName.value = '';
  $.customRoleCount.value = '1';
  if ($.customRoleFaction){ $.customRoleFaction.value = ''; paintFactionSelect(); }

  renderRoles(); updateSlotsLeft(); save();
});

  $.resetRoles.addEventListener('click', ()=>{ STATE.roles = {werewolf:3, seer:1, witch:1, hunter:1, guard:1, cupid:1, spellcaster:1, prince:1}; STATE.customRoles = {}; renderRoles(); save(); });

  // ====== ASSIGNMENT ======
  $.assignBtn.addEventListener('click', ()=>{
    const n = Number($.playerCount.value||10);
    const names = STATE.names.slice(0,n).map((x,i)=> (x||'').trim() || `Ng∆∞·ªùi ch∆°i ${i+1}`);

    const parts = [];
    const addMany = (label,count)=>{ for(let i=0;i<count;i++) parts.push(label); };
    const roleNameFromKey = k => (DEFAULT_ROLES.find(r=>r.key===k)?.name) || k;

    Object.entries(STATE.roles||{}).forEach(([k,c])=> addMany(roleNameFromKey(k), Number(c||0)));
    Object.entries(STATE.customRoles||{}).forEach(([name,obj])=>{
  const c = Number((obj && obj.count) || 0);
  addMany(name, c);
});


    if(parts.length > n){ return alert(`T·ªïng s·ªë vai tr√≤(${parts.length}) v∆∞·ª£t qu√° s·ªë ng∆∞·ªùi (${n}). H√£y gi·∫£m b·ªõt vai tr√≤ ho·∫∑c tƒÉng s·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i.`); }

    // üîí CH·ªêT 1: l·∫•p √¥ tr·ªëng b·∫±ng D√¢n l√†ng
  while (parts.length < n) parts.push('üë®üèª‚Äçüåæ D√¢n l√†ng');

  const rolesShuffled = shuffle(parts);

  // üîí CH·ªêT 2: ƒë·∫£m b·∫£o sau shuffle v·∫´n ƒë·ªß n ph·∫ßn t·ª≠
  while (rolesShuffled.length < n) rolesShuffled.push('üë®üèª‚Äçüåæ D√¢n l√†ng');
    STATE.assignments = names.map((name, idx)=> ({ name, role: rolesShuffled[idx] }));
    STATE.reveal = {};
    STATE.dead = {};
    renderAssignments();
    clearTimeout(autoSortTimer);
    $.reshuffleBtn.disabled = false; $.revealAllBtn.disabled=false; $.copyBtn.disabled=false; $.sortBtn.disabled=false;
    save();
  });

  $.reshuffleBtn.addEventListener('click', ()=>{
    if(!STATE.assignments) return;
    const roles = STATE.assignments.map(x=>x.role);
    const names = STATE.assignments.map(x=>x.name);
    const reshuffled = shuffle(roles);
    STATE.assignments = names.map((name,i)=>({name, role: reshuffled[i]}));
    STATE.reveal = {}; renderAssignments(); save();
  });

  $.revealAllBtn.addEventListener('click', ()=>{
    const anyHidden = Object.values(STATE.reveal||{}).some(v=>!v);
    STATE.assignments.forEach((_,i)=> STATE.reveal[i] = anyHidden );
    renderAssignments(); save();
  });

  $.copyBtn.addEventListener('click', async ()=>{
    if(!STATE.assignments) return;
    const lines = STATE.assignments
  .map((x,i)=> `${i+1}. ${x.name} ‚Äî ${displayRole(x.role)}`)
  .join('\n');

    try{ await navigator.clipboard.writeText(lines); alert('ƒê√£ sao ch√©p danh s√°ch vai tr√≤ v√†o clipboard!'); }
    catch{ alert('Kh√¥ng th·ªÉ sao ch√©p, h√£y ch·ªçn th·ªß c√¥ng.'); }
  });

  // ====== SORT & HIGHLIGHT ======
  function _ascii(s){
    return String(s).toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }
  function _roleKey(role){
    return String(role).replace(/^[^\p{L}\p{N}]+/u,'').trim().toLowerCase();
  }
  function factionOf(role){
    const t = _ascii(role);
// ∆ØU TI√äN: custom role c√≥ l∆∞u phe
  const cr = STATE.customRoles && STATE.customRoles[role];
  if (cr && cr.faction) {
    const f = cr.faction;
    if (f==='wolf')    return {order:0, cls:'f-wolf'};
    if (f==='village') return {order:1, cls:'f-vil'};
    if (f==='swap')    return {order:2, cls:'f-swap'};
    return {order:3, cls:'f-third'};
  }
    // Phe S√≥i
    if (t.includes('soi con') || t.includes('phan boi') || t.includes('ma soi')|| t.includes('phap su soi')|| t.includes('soi ƒëai ca')|| t.includes('soi tuyet')|| t.includes('soi ƒëau ƒëan')|| t.includes('ac mong')|| t.includes('soi cuong'))
      return {order:0, cls:'f-wolf'};
    // Phe D√¢n
    if (t.includes('tien tri')||t.includes('phu thuy')||
        t.includes('tho san')||t.includes('bao ve')||t.includes('nguyet nu')||
        t.includes('dan lang')||t.includes('hoang tu')||t.includes('gia lang')||
        t.includes('luc si')||t.includes('thi truong')||t.includes('huyen bi')||
        t.includes('ƒëanh bom')||t.includes('thien van')||t.includes('linh gac')||
        t.includes('giao su')||t.includes('tap su')||t.includes('hao quang')||t.includes('nguoi benh')||t.includes('bao lang')||
        t.includes('con ma')||t.includes('hoa binh')||t.includes('hiep si')||t.includes('tham tu'))
      return {order:1, cls:'f-vil'};
    // Phe ƒë·ªïi phe
    if (t.includes('cupid')||t.includes('nhan ban')||t.includes('bi nguyen'))
      return {order:2, cls:'f-swap'};
    // Phe th·ª© ba / kh√°c
    if (t.includes('chan doi')||t.includes('giao chu')||t.includes('ƒëau gau')||t.includes('ma ca rong')||t.includes('soi trang'))
      return {order:3, cls:'f-third'};
    return {order:3, cls:'f-third'};
  }

  function sortAssignmentsByFactionThenRole(){
  if (!STATE.assignments || STATE.assignments.length === 0) return;

  // Gi·ªØ tr·∫°ng th√°i "ƒë√£ hi·ªán" theo T√äN tr∆∞·ªõc khi s·∫Øp x·∫øp
  const revealByName = {};
  STATE.assignments.forEach((x, i) => {
    revealByName[x.name] = !!STATE.reveal[i];
  });

  // Map ƒë√°nh d·∫•u ch·∫øt theo t√™n (ƒë√£ set ·ªü STATE.dead)
  const deadByName = { ...(STATE.dead || {}) };

  STATE.assignments.sort((a, b) => {
    // 1) Alive tr∆∞·ªõc, Dead sau
    const aDead = !!deadByName[a.name];
    const bDead = !!deadByName[b.name];
    if (aDead !== bDead) return aDead ? 1 : -1;

    // 2) S·∫Øp theo phe
    const fa = factionOf(a.role);
    const fb = factionOf(b.role);
    if (fa.order !== fb.order) return fa.order - fb.order;

    // 3) C√πng phe th√¨ s·∫Øp theo alphabet c·ªßa t√™n vai tr√≤
    const ra = _roleKey(a.role);
    const rb = _roleKey(b.role);
    return ra.localeCompare(rb, 'vi');
  });

  // Kh√¥i ph·ª•c tr·∫°ng th√°i "ƒë√£ hi·ªán" theo v·ªã tr√≠ m·ªõi
  STATE.reveal = {};
  STATE.assignments.forEach((x, i) => {
    STATE.reveal[i] = !!revealByName[x.name];
  });

  renderAssignments();
  save();
}

function toggleDeadByName(name){
  STATE.dead = STATE.dead || {};
  const wasDead = !!STATE.dead[name];
  STATE.dead[name] = !wasDead;

  renderAssignments(); save();

  if (!wasDead) {
    // V·ª´a b·ªã "Gi·∫øt" -> ƒë·∫øm 10s r·ªìi auto-sort
    scheduleAutoSort();
  }
}

function displayRole(role) {
  // N·∫øu l√† vai tr√≤ t√πy ch·ªânh (t√™n t·ªìn t·∫°i trong STATE.customRoles) th√¨ th√™m üß©
  if (STATE.customRoles && Object.prototype.hasOwnProperty.call(STATE.customRoles, role)) {
    return `üß© ${role}`;
  }
  return role; // vai tr√≤ m·∫∑c ƒë·ªãnh ƒë√£ c√≥ emoji s·∫µn (üê∫, üîÆ, ‚Ä¶)
}

  function renderAssignments(){
  if(!STATE.assignments){ $.assignments.innerHTML=''; return; }

  const rows = STATE.assignments.map((x,i)=>{
    const revealed = !!STATE.reveal[i];
    const fac = factionOf(x.role);
    const isDead = !!(STATE.dead && STATE.dead[x.name]);
    const safeNameAttr = String(x.name).replace(/"/g,'&quot;'); // attr-safe
    const viewRole = displayRole(x.role);
const roleCell = revealed ? escapeHtml(viewRole) : '&nbsp;';

    return `<tr class="${revealed? 'revealed':''} ${fac.cls} ${isDead?'dead':''}"
               data-name="${safeNameAttr}">
      <td>${i+1}</td>
      <td class="name-cell">
  <div class="name-wrap">
    <span class="player-name">${escapeHtml(x.name)}</span>
    ${isDead ? '<span class="eliminated">‚Äì B·ªä LO·∫†I</span>' : ''}
  </div>
</td>
      <td class="role ${revealed? '':'hidden'}">${roleCell}</td>
      <td class="no-print">
  <button class="btn ${isDead ? '' : 'danger'}" data-kill="${i}">
    ${isDead ? 'C·ª©u' : 'Gi·∫øt'}
  </button>
</td>

    </tr>`;
  }).join('');

  $.assignments.innerHTML = `
  <div class="section-title">
    <h2>üìÉ Danh s√°ch ph√¢n vai tr√≤</h2>
    <div class="chip">T·ªïng: <b>${STATE.assignments.length}</b></div>
  </div>
  <div class="table-wrap">
    <table aria-label="Danh s√°ch ph√¢n vai tr√≤">
      <thead>
        <tr><th>#</th><th>T√™n ng∆∞·ªùi ch∆°i</th><th>Vai tr√≤</th>
        <th class="no-print">Gi·∫øt</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;

  // B·∫•m n√∫t Gi·∫øt/H·ªìi sinh (toggle "ƒë√£ ch·∫øt")
qsa('[data-kill]', $.assignments).forEach(btn => {
  btn.addEventListener('click', (e) => {
    const i = Number(e.currentTarget.getAttribute('data-kill'));
    const name = STATE.assignments[i]?.name;
    if (!name) return;
    toggleDeadByName(name);     // ƒë√£ c√≥ s·∫µn trong m√£
  });
});

  // double-click / double-tap ƒë·ªÉ toggle ‚Äúƒë√£ ch·∫øt‚Äù
  qsa('tbody tr', $.assignments).forEach(tr=>{
    const name = tr.getAttribute('data-name'); // DOM s·∫Ω decode &quot; => "
    // ch·∫∑n khi click v√†o n√∫t
    tr.addEventListener('dblclick', (e)=>{
      if (e.target.closest('button')) return;
      toggleDeadByName(name);
    });
    // mobile: double-tap trong ~300ms
    let lastTap = 0;
    tr.addEventListener('touchend', (e)=>{
      if (e.target.closest('button')) return;
      const now = Date.now();
      if (now - lastTap < 300){ toggleDeadByName(name); e.preventDefault(); }
      lastTap = now;
    }, {passive:false});
  });
}

  $.sortBtn.addEventListener('click', () => {
  clearTimeout(autoSortTimer);
  sortAssignmentsByFactionThenRole();
});

  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

// ===== KHO L∆ØU GHI CH√âP =====
const notesArchiveModal = {
  wrap: document.getElementById('notesArchiveModal'),
  title: document.getElementById('notesArchiveTitle'),
  body:  document.getElementById('notesArchiveBody'),
  btnClose: document.getElementById('notesArchiveClose'),
  open(){
    this.render();
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose?.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
  },
  render(){
    const list = STATE.notesArchive || [];
    const total = list.length;

    const itemsHTML = !total
      ? `<div class="hint">Ch∆∞a c√≥ b·∫£n l∆∞u n√†o. H√£y b·∫•m <b>üíøÔ∏è L∆∞u</b> sau khi ghi ch√∫.</div>`
      : `<div class="hint">ƒê√£ l∆∞u <b>${total}</b> l·∫ßn.</div>
         <div class="archive-list">
           ${list.slice().reverse().map(it=>{
              const when = new Date(it.timeISO).toLocaleString('vi-VN', { hour12:false });
              return `
                <div class="archive-item">
                  <div class="archive-meta">L·∫ßn #${it.id} ‚Ä¢ ${when}</div>
                  <div class="archive-content">${escapeHtml(it.content)}</div>
                </div>`;
            }).join('')}
         </div>`;

    this.body.innerHTML = itemsHTML +
      `<div class="archive-actions">
         <button class="btn danger" id="notesArchiveClearAll">X√≥a to√†n b·ªô l∆∞u tr·ªØ</button>
         <button class="btn" id="notesArchiveClose2">ƒê√≥ng</button>
       </div>`;

    // g·∫Øn s·ª± ki·ªán cho 2 n√∫t trong body (v√¨ body v·ª´a ƒë∆∞·ª£c innerHTML)
    const clearBtn = this.body.querySelector('#notesArchiveClearAll');
    const close2   = this.body.querySelector('#notesArchiveClose2');

    clearBtn?.addEventListener('click', ()=>{
      if(!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô c√°c b·∫£n l∆∞u? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) return;
      STATE.notesArchive = [];
      STATE.notesSaveSeq = 0;   // reset s·ªë l·∫ßn
      save();
      this.render();
      alert('ƒê√£ x√≥a to√†n b·ªô l∆∞u tr·ªØ v√† ƒë·∫∑t l·∫°i b·ªô ƒë·∫øm.');
    });
    close2?.addEventListener('click', ()=> this.close());
  }
};

// ƒê√≥ng modal khi click ra ngo√†i / nh·∫•n ESC
notesArchiveModal.btnClose?.addEventListener('click', ()=> notesArchiveModal.close());
notesArchiveModal.wrap?.addEventListener('click', (e)=>{ if(e.target===notesArchiveModal.wrap) notesArchiveModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') notesArchiveModal.close(); });

// L∆∞u m·ªôt ‚Äúb·∫£n ch·ª•p‚Äù ghi ch√∫
function saveNotesSnapshot(){
  const text = (qs('#notes')?.value || '');
  if(!text.trim()){
    if(!confirm('Ghi ch√∫ ƒëang tr·ªëng. B·∫°n c√≥ mu·ªën l∆∞u m·ªôt ƒëo·∫°n vƒÉn b·∫£n tr·ªëng?')) return;
  }
  STATE.notesSaveSeq = (STATE.notesSaveSeq || 0) + 1;
  const entry = { id: STATE.notesSaveSeq, timeISO: new Date().toISOString(), content: text };
  STATE.notesArchive = STATE.notesArchive || [];
  STATE.notesArchive.push(entry);
  save();

  const when = new Date(entry.timeISO).toLocaleString('vi-VN', { hour12:false });
  alert(`ƒê√£ l∆∞u ghi ch√©p #${entry.id} (${when}).\nXem l·∫°i ·ªü "üìÅ Kho l∆∞u tr·ªØ".`);
}

  // ====== TIMER ======
  let TICK = null; let remaining = 120; let countingUp=false;

  function setTimerFromInputs(){
    const min = clamp(Number($.timerMin.value||0),0,999);
    const sec = clamp(Number($.timerSec.value||0),0,59);
    $.timerMin.value=min; $.timerSec.value=sec;
    if($.timerMode.value==='down'){ remaining = min*60 + sec; countingUp=false; }
    else { remaining = 0; countingUp=true; }
    updateTimerDisplay();
    STATE.timer = { ...STATE.timer, mode: $.timerMode.value, min, sec, left: remaining, running:false, sound: $.soundToggle.checked };
    $.startPauseBtn.textContent='‚ñ∂Ô∏é B·∫Øt ƒë·∫ßu'; save();
  }

  function updateTimerDisplay(){
    const sec = Math.max(0, Math.floor(remaining%60));
    const min = Math.max(0, Math.floor(remaining/60));
    $.timerDisplay.textContent = `${pad(min)}:${pad(sec)}`;
  }

  // Thay to√†n b·ªô h√†m beep() c≈© b·∫±ng h√†m m·ªõi n√†y
  function beep(times = 5, vol = 1.0, freq = 900, dur = 180, gap = 120){
    if(!$.soundToggle.checked) return;

    // RUNG: 5 nh·ªãp 200ms, ngh·ªâ 100ms
    try{ navigator.vibrate && navigator.vibrate([200,100,200,100,200,100,200,100,200]); }catch{}

    // √ÇM THANH: nhi·ªÅu "t√∫t" li·ªÅn nhau
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();

      let t = ctx.currentTime;
      for(let i = 0; i < times; i++){
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);

        // Gi·ªØ ti·∫øng "t√∫t" r√µ r√†ng
        o.type = 'sine';
        o.frequency.setValueAtTime(freq, t);

        // Envelope ƒë·ªÉ nghe to nh∆∞ng kh√¥ng r√®
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(vol, t + 0.02);           // l√™n nhanh
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur/1000);    // t·∫Øt nhanh

        o.start(t);
        o.stop(t + dur/1000 + 0.01);

        // kho·∫£ng ngh·ªâ gi·ªØa c√°c "t√∫t"
        t += (dur + gap) / 1000;
      }

      // ƒë√≥ng context sau khi ph√°t xong ƒë·ªÉ ti·∫øt ki·ªám pin
      const total = times*dur + (times-1)*gap + 200;
      setTimeout(()=>{ try{ ctx.close(); }catch{} }, total);
    }catch{}
  }

  function startPause(){
    if(TICK){ clearInterval(TICK); TICK=null; $.startPauseBtn.textContent='‚ñ∂Ô∏é Ti·∫øp t·ª•c'; STATE.timer.running=false; save(); return; }
    $.startPauseBtn.textContent='‚ùö‚ùö T·∫°m d·ª´ng'; STATE.timer.running=true; save();
    TICK = setInterval(()=>{
      remaining += countingUp ? 1 : -1;
      updateTimerDisplay();
      if(!countingUp && remaining<=0){ clearInterval(TICK); TICK=null; beep(); $.startPauseBtn.textContent='‚ñ∂Ô∏é B·∫Øt ƒë·∫ßu'; STATE.timer.running=false; save(); }
    }, 1000);
  }

  function resetTimer(){ clearInterval(TICK); TICK=null; setTimerFromInputs(); }

  $.timerMode.addEventListener('change', setTimerFromInputs);
  $.timerMin.addEventListener('change', setTimerFromInputs);
  $.timerSec.addEventListener('change', setTimerFromInputs);
  $.startPauseBtn.addEventListener('click', startPause);
  $.resetTimerBtn.addEventListener('click', resetTimer);
  qsa('[data-preset]').forEach(btn=> btn.addEventListener('click', (e)=>{
    const s = Number(e.currentTarget.getAttribute('data-preset'))||120;
    $.timerMode.value='down'; $.timerMin.value = Math.floor(s/60); $.timerSec.value = s%60; setTimerFromInputs();
  }));
  $.soundToggle.addEventListener('change', ()=>{ STATE.timer.sound = $.soundToggle.checked; save(); });

  // ====== NOTES ======
  const notesEl = qs('#notes');

// T·ª± gi√£n chi·ªÅu cao ghi ch√∫ theo n·ªôi dung
function autoGrowNotes(){
  if(!notesEl) return;
  notesEl.style.height = 'auto';                    // reset
  notesEl.style.height = Math.max(160, notesEl.scrollHeight) + 'px';
}

// khi nh·∫≠p th√¨ t·ª± gi√£n
notesEl.addEventListener('input', autoGrowNotes);
// n·∫øu c·ª≠a s·ªï ƒë·ªïi k√≠ch th∆∞·ªõc (mobile xoay‚Ä¶), t√≠nh l·∫°i
window.addEventListener('resize', autoGrowNotes);

  notesEl.addEventListener('input', ()=>{ STATE.notes = notesEl.value; save(); });

  // N√∫t: X√≥a t·∫•t c·∫£
  $.clearNotesBtn.addEventListener('click', ()=>{
    notesEl.value = '';
    STATE.notes = '';
    save();
    autoGrowNotes();
    notesEl.focus();
  });

  // N√∫t: So·∫°n m·∫´u nhanh
  $.quickTemplateBtn.addEventListener('click', ()=>{
    const tpl =
`üê∫ S√≥i _________ Gi·∫øt:
üõ°Ô∏è B·∫£o v·ªá ______ Ch·∫Øn:
üßô‚Äç‚ôÇÔ∏è Ph√π Th·ªßy _____ C·ª©u:
üßô‚Äç‚ôÇÔ∏è Ph√π Th·ªßy ____ Gi·∫øt:
üèπ Th·ª£ sƒÉn _____ Ng·∫Øm:
üíò Cupid _______ Gh√©p:
üë• Nh√¢n b·∫£n ____ Ch·ªçn:
üîá Nguy·ªát n·ªØ ____ C√¢m: `;
    notesEl.value = tpl;
    STATE.notes = tpl;
    save();
    autoGrowNotes();
    // ƒê∆∞a con tr·ªè v·ªÅ cu·ªëi cho ti·ªán ghi ti·∫øp
    notesEl.focus();
    try{
      notesEl.selectionStart = notesEl.selectionEnd = notesEl.value.length;
    }catch{}
  });

$.saveNotesBtn?.addEventListener('click', saveNotesSnapshot);
$.openArchiveBtn?.addEventListener('click', () => notesArchiveModal.open());

  // ====== INIT ======
  function init(){
    load();
    if (!Array.isArray(STATE.notesArchive)) STATE.notesArchive = [];
    if (!Number.isInteger(STATE.notesSaveSeq)) STATE.notesSaveSeq = 0;
    save();
    $.playerCount.value = STATE.playerCount;
    renderNames();

    ensureDefaultRoles();
    normalizeCustomRoles();
    renderRoles();

    if(STATE.assignments){ renderAssignments(); $.reshuffleBtn.disabled=false; $.revealAllBtn.disabled=false; $.copyBtn.disabled=false; $.sortBtn.disabled=false; }

    notesEl.value = STATE.notes||'';
    autoGrowNotes();

    $.timerMode.value = STATE.timer.mode||'down';
    $.timerMin.value = STATE.timer.min||0; $.timerSec.value = STATE.timer.sec||0;
    let remainingLocal = STATE.timer.left || (STATE.timer.mode==='down' ? (STATE.timer.min*60 + STATE.timer.sec): 0);
    remaining = remainingLocal;
    countingUp = STATE.timer.mode==='up'; $.soundToggle.checked = !!STATE.timer.sound;
    updateTimerDisplay();
    if(STATE.timer.running){ startPause(); }

    updateSlotsLeft();
  }

// ===== Modal 'Th·ª© t·ª± k√™u d·∫≠y' =====
const nightOrderModal = {
  wrap: document.getElementById('nightOrderModal'),
  body: document.getElementById('nightOrderBody'),
  btnClose: document.getElementById('nightOrderClose'),
  open(){
    this.render();
    this.wrap.classList.add('show');
    this.wrap.setAttribute('aria-hidden','false');
    this.btnClose?.focus();
  },
  close(){
    this.wrap.classList.remove('show');
    this.wrap.setAttribute('aria-hidden','true');
  },
  render(){
    this.body.innerHTML = `
      <p class="intro">‚Äî Th·ª© t·ª± k√™u d·∫≠y m·ªói ƒë√™m ‚Äî<br>
      <em>(Con ma ch·∫øt ngay ƒë√™m ƒë·∫ßu ti√™n)</em></p>

      <ol start="1">
        <li>Cupid          (1 l·∫ßn ƒë√™m ƒë·∫ßu ti√™n)</li>
        <li>S√≥i ƒë·∫°i ca     (1 l·∫ßn ƒë√™m ƒë·∫ßu ti√™n)</li>
        <li>ƒê·∫ßu g·∫•u</li>
        <li>B·∫ßy s√≥i g·ªìm: √Åc m·ªông + Ma s√≥i + Ph·∫£n b·ªôi + S√≥i con + S√≥i cu·ªìng + S√≥i ƒë·∫°i ca + S√≥i ƒë·∫ßu ƒë√†n + S√≥i tuy·∫øt + S√≥i tr·∫Øng
          <div class="sub">Th·ª© t·ª± h√†nh ƒë·ªông c·ªßa phe Ma s√≥i:</div>
          <div class="sub">√Åc m·ªông / S√≥i con / S√≥i cu·ªìng / S√≥i ƒë·∫ßu ƒë√†n / S√≥i tuy·∫øt</div>
        </li>
        <li>Ph√°p s∆∞ s√≥i</li>
        <li>S√≥i tr·∫Øng</li>
        <li>Ma c√† r·ªìng</li>
        <li>Gi√°o ch·ªß</li>
        <li>Hi·ªáp sƒ©</li>
        <li>B·∫£o v·ªá</li>
        <li>Ph√π th·ªßy</li>
        <li>Thi√™n vƒÉn</li>
        <li>Th·ª£ sƒÉn</li>
        <li>Th√°m t·ª≠</li>
        <li>Ti√™n tri</li>
        <li>Ti√™n tri_H√†o quang</li>
        <li>Ti√™n tri_Huy·ªÅn b√≠</li>
        <li>Gi√°o s∆∞</li>
        <li>Nguy·ªát n·ªØ</li>
        <li>B√°o l√†ng</li>
      </ol>

      <div class="section">K√™u d·∫≠y 1 l·∫ßn ƒë√™m ƒë·∫ßu ti√™n</div>

      <ol start="21">
        <li>L√≠nh g√°c</li>
        <li>Ho√†ng t·ª≠</li>
        <li>Th·ªã tr∆∞·ªüng</li>
        <li>H√≤a b√¨nh</li>
        <li>Ng∆∞·ªùi b·ªánh</li>
        <li>L·ª±c sƒ©</li>
        <li>Ti√™n tri_T·∫≠p s·ª±</li>
        <li>D√¢n l√†ng</li>
        <li>Gi√† l√†ng</li>
        <li>Nh√¢n b·∫£n</li>
        <li>B·ªã nguy·ªÅn</li>
        <li>ƒê√°nh bom</li>
        <li>Ch√°n ƒë·ªùi</li>
      </ol>`;
  }
};

// m·ªü/ƒë√≥ng + h√†nh vi gi·ªëng c√°c modal kh√°c
document.getElementById('nightOrderBtn')?.addEventListener('click', () => nightOrderModal.open());
nightOrderModal.btnClose?.addEventListener('click', ()=> nightOrderModal.close());
nightOrderModal.wrap?.addEventListener('click', (e)=>{ if(e.target===nightOrderModal.wrap) nightOrderModal.close(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') nightOrderModal.close(); });

  init();
})();
</script>
</body>
</html>